<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ìŠ¹ì¸ì œ WebRTC (ë°©ì†¡/ë¯¸íŒ…)</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    html,body{overflow:visible;min-width:100vw;min-height:100vh}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1000px 700px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:12px 20px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;border-bottom:1px solid #2a3a77}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr 360px}
    .card{background:rgba(16,24,58,.8);border:1px solid #22306b;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block;margin-top:8px;font-size:14px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2b5bd1,#2048a8)}
    button.danger{background:linear-gradient(180deg,#c24,#932)}
    small{color:var(--muted)}
    video{width:100%;background:#000;border-radius:12px}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li{padding:10px;border:1px solid #2a3a77;border-radius:12px;background:#0f173b;display:flex;justify-content:space-between;align-items:center}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#1b285c;color:#cfe0ff;border:1px solid #2a3a77}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#a7b3d4}
    footer{padding:10px 16px;color:#a7b3d4;font-size:12px;text-align:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid-2h{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .meeting-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(225px, 1fr));gap:8px}
    .remote-video-wrapper{position:relative;min-height:150px}
    .remote-video-wrapper small{position:absolute;top:4px;left:4px;background:rgba(0,0,0,.6);padding:3px 6px;border-radius:4px;z-index:1;font-size:11px}
    .remote-video-wrapper video{width:100%;height:auto;min-height:150px;background:#000;border-radius:8px;object-fit:cover}
    .local-preview-wrapper{position:relative;min-height:150px}
    .local-preview-wrapper video{width:100%;height:auto;min-height:150px;background:#000;border-radius:8px;object-fit:cover}
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0d1433;border:1px solid #2a3a77;color:#eaf0ff;padding:10px 14px;border-radius:12px;display:none}
    .hidden{display:none!important}
    .fullscreen-video{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none}
    .fullscreen-video.show{display:block}
    .fullscreen-video video{width:100%;height:100%;object-fit:contain}
    .fullscreen-video .fs-close{position:absolute;top:20px;right:20px;width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,106,106,.9);color:#fff;cursor:pointer;font-size:20px;z-index:2001;display:flex;align-items:center;justify-content:center}
    .fullscreen-video .fs-close:hover{background:rgba(255,74,74,.9)}
    .video-fullscreen-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.6);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;z-index:2}
    .video-fullscreen-btn:hover{background:rgba(0,0,0,.8)}
    .video-question-btn{position:absolute;bottom:8px;right:8px;background:rgba(106,166,255,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-question-btn:hover{background:rgba(106,166,255,1)}
    .fullscreen-video .video-question-btn{position:absolute;bottom:20px;right:20px;z-index:2002}
    .video-unmute-btn{position:absolute;bottom:8px;left:8px;background:rgba(255,106,106,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-unmute-btn:hover{background:rgba(255,74,74,1)}
    .video-unmute-btn.muted{background:rgba(100,100,100,.8)}
    .video-unmute-btn.muted:hover{background:rgba(120,120,120,1)}
    .video-question-allow-btn{position:absolute;top:8px;left:8px;background:rgba(76,175,80,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-question-allow-btn:hover{background:rgba(69,160,73,1)}
    .video-question-end-btn{position:absolute;top:8px;left:8px;background:rgba(244,67,54,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-question-end-btn:hover{background:rgba(229,57,53,1)}
    .question-request-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(76,175,80,.9);color:#fff;padding:12px 20px;border-radius:12px;font-size:16px;font-weight:bold;z-index:10;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    .question-request-indicator.blink{animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .chat-container{display:flex;flex-direction:column;height:300px}
    .chat-messages{flex:1;overflow-y:auto;padding:8px;background:#0d1433;border-radius:8px;margin-bottom:8px;max-height:250px}
    .chat-message{padding:6px 8px;margin-bottom:6px;border-radius:6px;font-size:13px;word-wrap:break-word}
    .chat-message.own{background:#1b285c;text-align:right}
    .chat-message.other{background:#0f173b}
    .chat-message .sender{font-size:11px;color:#a7b3d4;margin-bottom:2px}
    .chat-message .time{font-size:10px;color:#6aa6ff;margin-left:6px}
    .chat-input-row{display:flex;gap:6px}
    .chat-input-row input{flex:1;padding:8px;border-radius:8px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff;font-size:13px}
    .chat-input-row button{padding:8px 12px}
    .modal{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.7);z-index:3000;display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:rgba(16,24,58,.95);border:1px solid #22306b;border-radius:16px;padding:20px;max-width:500px;max-height:80vh;width:90%;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,.5)}
    #pendingModal{justify-content:flex-end;align-items:flex-start;padding:20px}
    #pendingModal .modal-content{margin-right:0;margin-top:20px;max-width:400px;width:auto;min-width:300px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #2a3a77}
    .modal-header h3{margin:0;font-size:18px}
    .modal-close{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,106,106,.8);color:#fff;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:rgba(255,74,74,1)}
    #info{font-size:12px;color:var(--muted);padding:8px 12px;background:rgba(16,24,58,.6);border-radius:8px;border:1px solid #2a3a77}
    #logBtn{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;border:none;background:rgba(106,166,255,.8);color:#fff;cursor:pointer;font-size:20px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    #logBtn:hover{background:rgba(106,166,255,1)}
  </style>
</head>
<body>
<header>
  <h1 style="margin:0;font-size:18px;margin-right:auto">ê¹€ì²œëŒ€ ë³¸ê´€ 6ì¸µ ì‚¬ë¬´ì—˜ì‹¤</h1>
  
  <div class="row" style="gap:8px;align-items:center">
    <label style="margin:0;display:flex;align-items:center;gap:6px">
      <span style="font-size:14px;color:var(--muted)">ì—­í• :</span>
      <label style="margin:0"><input type="radio" name="role" value="host" checked> êµìˆ˜</label>
      <label style="margin:0"><input type="radio" name="role" value="guest"> í•™ìƒ</label>
    </label>
  </div>
  
  <div class="row" style="gap:6px;align-items:center;flex-wrap:wrap">
    <label style="margin:0;display:flex;align-items:center;gap:6px">
      <span style="font-size:14px;color:var(--muted)">ë°©ì½”ë“œ:</span>
      <input id="roomId" type="text" placeholder="RM-20241225" style="width:120px;padding:6px 8px;font-size:13px" />
    </label>
    <label id="studentNameLabel" style="margin:0;display:flex;align-items:center;gap:6px">
      <span style="font-size:14px;color:var(--muted)">ì´ë¦„:</span>
      <input id="studentName" type="text" placeholder="ì´ë¦„ ì…ë ¥" style="width:100px;padding:6px 8px;font-size:13px" maxlength="20" />
    </label>
  </div>
  
  <div class="row" style="gap:6px;align-items:center">
    <button id="audioToggleBtn" style="display:none;padding:6px 12px;font-size:13px">ğŸ”Š ì†Œë¦¬ ON</button>
    <button id="muteCamBtn" style="display:none;padding:6px 12px;font-size:13px">ğŸ“¹ ì¹´ë©”ë¼ ON</button>
    <button id="shareScreenBtn" style="display:none;padding:6px 12px;font-size:13px">ğŸ–¥ï¸ í™”ë©´ê³µìœ  ON</button>
    <button id="openCameraPiPBtn" style="display:none;padding:6px 12px;font-size:13px" title="êµìˆ˜ ì¹´ë©”ë¼ Picture-in-Picture ëª¨ë“œ">ğŸ–¼ï¸ PiP</button>
    <button class="primary" id="startBtn" type="button" style="padding:6px 12px;font-size:13px;cursor:pointer;position:relative;z-index:10">ì…ì‹¤</button>
    <button class="danger" id="stopBtn" type="button" disabled style="padding:6px 12px;font-size:13px;cursor:pointer;position:relative;z-index:10">í‡´ì‹¤</button>
  </div>
  
  <div class="row" style="gap:6px;align-items:center;flex-wrap:wrap">
    <small id="status" class="muted" style="font-size:12px">ëŒ€ê¸° ì¤‘â€¦</small>
    <small id="info" class="hint" style="font-size:12px">-</small>
    <div id="presenterHints" style="display:none">
      <small class="hint" style="font-size:11px">* iPadëŠ” ì²« ì¬ìƒ ì‹œ ğŸ”Š ë²„íŠ¼(ë˜ëŠ” í™”ë©´ íƒ­)ìœ¼ë¡œ ìŒì†Œê±° í•´ì œê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <!-- ë¯¸íŒ… ëª¨ë“œ: ë‹¤ìê°„ ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ -->
    <div id="meetingVideos">
      <div class="meeting-grid" id="remoteVideosGrid">
        <!-- êµìˆ˜ ë¯¸ë¦¬ë³´ê¸° í™”ë©´ (ì‹œì²­ì í™”ë©´ê³¼ ë™ì¼í•œ í¬ê¸°ë¡œ í‘œì‹œ) -->
        <div class="local-preview-wrapper remote-video-wrapper" id="localPreviewWrapper" style="display:none">
          <small class="muted">ë‚˜(ë¯¸ë¦¬ë³´ê¸° Â· í•­ìƒ ìŒì†Œê±°)</small>
          <video id="localPreview" autoplay playsinline webkit-playsinline muted controls></video>
        </div>
      </div>
    </div>

    <!-- ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ -->
    <div id="fullscreenVideo" class="fullscreen-video">
      <button class="fs-close" id="fsCloseBtn">Ã—</button>
      <video id="fsVideo" autoplay playsinline webkit-playsinline controls></video>
      <!-- ì‹œì²­ì ì „ìš© ì§ˆë¬¸ ë²„íŠ¼ (ì „ì²´í™”ë©´ ëª¨ë“œ) -->
      <button id="fullscreenQuestionBtn" class="video-question-btn" style="display:none">â“ ì§ˆë¬¸í•˜ê¸°</button>
    </div>

    <audio id="audiomirror" autoplay playsinline webkit-playsinline style="display:none"></audio>

    <!-- ê¸°íƒ€ ì¹´ë©”ë¼ ì œì–´ ë²„íŠ¼ -->
    <div class="row" id="cameraCtrl" style="margin-top:10px; display:none;gap:6px;flex-wrap:wrap">
      <button id="openBrowserWindowBtn" style="display:none" class="primary" title="ë‹¤ë¥¸ ë¸Œë¼ìš°ì € ì°½/íƒ­ì—ì„œ ì¹´ë©”ë¼ ì˜ìƒ ì—´ê¸°">ğŸŒ ìƒˆ ì°½</button>
      <button id="togglePreviewBtn" style="display:none">ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°</button>
    </div>
  </section>

  <aside class="card">
    <div>
      <h3 style="margin:0 0 8px 0">ì±„íŒ…</h3>
      <div class="chat-container">
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-row">
          <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="200" />
          <button id="chatSendBtn">ì „ì†¡</button>
        </div>
        <!-- ì‹œì²­ì ì „ìš© ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ -->
        <div id="questionBtnWrapper" style="margin-top:8px; display:none">
          <button id="questionBtn" class="primary" style="width:100%">â“ êµìˆ˜ì—ê²Œ ì§ˆë¬¸í•˜ê¸°</button>
        </div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ë¡œê·¸</h3>
      <pre id="log" class="hint" style="white-space:pre-wrap;max-height:150px;overflow:auto"></pre>
    </div>
  </aside>
</main>

<footer>
  ëŒ€ê·œëª¨/ë‹¤ìê°„ì€ SFU ê¶Œì¥(LiveKit/Janus/mediasoup). TURN ì¶”ê°€ ì‹œ ì—°ê²°ë¥ â†‘
</footer>

<div id="toast"></div>

<!-- ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ ëª¨ë‹¬ -->
<div id="pendingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ (êµìˆ˜ ì „ìš©)</h3>
      <button class="modal-close" id="pendingModalClose">Ã—</button>
    </div>
    <ul id="pending"></ul>
  </div>
</div>

<!-- ì±„íŒ… ëª¨ë‹¬ -->
<div id="chatModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ì±„íŒ…</h3>
      <button class="modal-close" id="chatModalClose">Ã—</button>
    </div>
    <div class="chat-container">
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-row">
        <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="200" />
        <button id="chatSendBtn">ì „ì†¡</button>
      </div>
      <!-- ì‹œì²­ì ì „ìš© ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ -->
      <div id="questionBtnWrapper" style="margin-top:8px; display:none">
        <button id="questionBtn" class="primary" style="width:100%">â“ ì†¡ì¶œìì—ê²Œ ì§ˆë¬¸í•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ ëª¨ë‹¬ -->
<div id="logModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ë¡œê·¸</h3>
      <button class="modal-close" id="logModalClose">Ã—</button>
    </div>
    <pre id="log" class="hint" style="white-space:pre-wrap;max-height:60vh;overflow:auto;margin:0"></pre>
  </div>
</div>

<!-- ë¡œê·¸ ë²„íŠ¼ -->
<button id="logBtn" title="ë¡œê·¸ ë³´ê¸°">ğŸ“‹</button>

<!-- iOSìš© ì–¸ë®¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
<div id="tapUnmuteOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center;">
  <button id="tapUnmuteBtn" style="font-size:18px;padding:14px 18px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer">
    ğŸ”Š íƒ­í•˜ì—¬ ì†Œë¦¬ ì¼œê¸°
  </button>
</div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-007jMq4dO7M6t6wn5vR_PZW9Gg1n0LM",
  authDomain: "webboard-ea2c4.firebaseapp.com",
  databaseURL: "https://webboard-ea2c4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webboard-ea2c4",
  storageBucket: "webboard-ea2c4.firebasestorage.app",
  messagingSenderId: "1063560565058",
  appId: "1:1063560565058:web:bd9b57bef6dd649f67f8db",
  measurementId: "G-NTQGQJVW8E"
};
firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously().catch(err=>{ console.error('Auth failed:', err); alert('Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message); });
const db = firebase.database();

/* ---------------- UI refs ---------------- */
const meetingVideos = document.getElementById('meetingVideos');   // ë¯¸íŒ… ëª¨ë“œ ì»¨í…Œì´ë„ˆ
const localPreview = document.getElementById('localPreview');
const audioMirror = document.getElementById('audiomirror');
const roomIdInput = document.getElementById('roomId');
const studentNameInput = document.getElementById('studentName');
const studentNameLabel = document.getElementById('studentNameLabel');
const statusEl = document.getElementById('status');
const pendingEl = document.getElementById('pending');
const infoEl = document.getElementById('info');
const logEl = document.getElementById('log');
const presenterHints = document.getElementById('presenterHints');
const unmuteBtn = document.getElementById('unmuteBtn');
const audioToggleBtn = document.getElementById('audioToggleBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const genRoom  = document.getElementById('genRoom');
const toastEl  = document.getElementById('toast');
const tapUnmuteOverlay = document.getElementById('tapUnmuteOverlay');
const tapUnmuteBtn = document.getElementById('tapUnmuteBtn');
const gainRow    = document.getElementById('gainRow');
const gainSlider = document.getElementById('gainSlider');
const gainVal    = document.getElementById('gainVal');
const switchCamBtn = document.getElementById('switchCamBtn');
const muteMicBtn   = document.getElementById('muteMicBtn');
const muteCamBtn   = document.getElementById('muteCamBtn');
const shareScreenBtn = document.getElementById('shareScreenBtn');
const openBrowserWindowBtn = document.getElementById('openBrowserWindowBtn');
const openCameraPiPBtn = document.getElementById('openCameraPiPBtn');
const cameraCtrl   = document.getElementById('cameraCtrl');
const sourceWrap   = document.getElementById('sourceWrap');
const remoteVideosGrid = document.getElementById('remoteVideosGrid');
const localPreviewWrapper = document.getElementById('localPreviewWrapper');
const togglePreviewBtn = document.getElementById('togglePreviewBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const fullscreenVideo = document.getElementById('fullscreenVideo');
const fsVideo = document.getElementById('fsVideo');
const fsCloseBtn = document.getElementById('fsCloseBtn');
const fullscreenQuestionBtn = document.getElementById('fullscreenQuestionBtn');
const questionBtnWrapper = document.getElementById('questionBtnWrapper');
const questionBtn = document.getElementById('questionBtn');
const pendingModal = document.getElementById('pendingModal');
const pendingModalClose = document.getElementById('pendingModalClose');
const chatModal = document.getElementById('chatModal');
const chatModalClose = document.getElementById('chatModalClose');
const logModal = document.getElementById('logModal');
const logModalClose = document.getElementById('logModalClose');
const logBtn = document.getElementById('logBtn');

/* ---------------- Modal Controls ---------------- */
function showPendingModal() {
  // addPending()ì´ í˜¸ì¶œë˜ì—ˆë‹¤ëŠ” ê²ƒì€ êµìˆ˜ê°€ í•™ìƒì˜ ì˜¤í¼ë¥¼ ë°›ì•˜ë‹¤ëŠ” ì˜ë¯¸
  // isRunningì´ trueì´ë©´ êµìˆ˜ê°€ ë°©ì„ ë§Œë“  ìƒíƒœì´ë¯€ë¡œ ëª¨ë‹¬ í‘œì‹œ
  if (pendingModal && isRunning) {
    pendingModal.classList.add('show');
  }
}
function hidePendingModal() {
  if (pendingModal) pendingModal.classList.remove('show');
}
function showChatModal() {
  if (chatModal) {
    chatModal.classList.add('show');
    // ì±„íŒ… ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
    setTimeout(() => {
      if (chatInput) chatInput.focus();
    }, 100);
  }
}
function hideChatModal() {
  if (chatModal) chatModal.classList.remove('show');
}
function showLogModal() {
  if (logModal) logModal.classList.add('show');
}
function hideLogModal() {
  if (logModal) logModal.classList.remove('show');
}

// ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
if (pendingModalClose) pendingModalClose.addEventListener('click', hidePendingModal);
if (chatModalClose) chatModalClose.addEventListener('click', hideChatModal);
if (logModalClose) logModalClose.addEventListener('click', hideLogModal);
if (logBtn) logBtn.addEventListener('click', showLogModal);

// ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
if (pendingModal) pendingModal.addEventListener('click', (e) => {
  if (e.target === pendingModal) hidePendingModal();
});
if (chatModal) chatModal.addEventListener('click', (e) => {
  if (e.target === chatModal) hideChatModal();
});
if (logModal) logModal.addEventListener('click', (e) => {
  if (e.target === logModal) hideLogModal();
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (pendingModal && pendingModal.classList.contains('show')) hidePendingModal();
    if (chatModal && chatModal.classList.contains('show')) hideChatModal();
    if (logModal && logModal.classList.contains('show')) hideLogModal();
  }
});

/* ---------------- State ---------------- */
let role = 'host';                 // 'host' | 'guest'
let comm = 'meeting';              // ë¯¸íŒ… ëª¨ë“œë§Œ ì‚¬ìš©
let facingMode = 'user';           // ì¹´ë©”ë¼ ì „/í›„ë©´
let roomId = '';
let viewerId = '';
let isRunning = false;
let pc = null;                      // ê²ŒìŠ¤íŠ¸ìš© ë‹¨ì¼ ì—°ê²°
let peerConnections = new Map();    // êµìˆ˜ìš©: í•™ìƒ ID -> PeerConnection
let remoteVideos = new Map();       // ê²ŒìŠ¤íŠ¸ ID -> video ì—˜ë¦¬ë¨¼íŠ¸
let guestAudioTracks = new Map();   // ê²ŒìŠ¤íŠ¸ ID -> ì˜¤ë””ì˜¤ íŠ¸ë™ (ìŒì†Œê±° ì œì–´ìš©)
let localStream = null;            // ë‚´ê°€ ë³´ë‚´ëŠ” ìŠ¤íŠ¸ë¦¼(ëª¨ë“œë³„ êµ¬ì„±)
let audioCtx = null, gainNode = null, viewerAudioCtx = null;
let showLocalPreview = true;        // ë‚´ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì—¬ë¶€ (ê¸°ë³¸ê°’: í‘œì‹œ)
let isScreenSharing = false;       // í™”ë©´ê³µìœ  ì¤‘ ì—¬ë¶€
let screenShareStream = null;       // í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ (ì¢…ë£Œ ê°ì§€ìš©)
let hostCameraStream = null;        // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ (ë³„ë„ ì°½ìš©/PiPìš©)
let hostCameraWindow = null;        // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ ë³„ë„ ì°½
let hostCameraPiPVideo = null;      // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸
let guestQuestionPiPVideo = null;  // ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸
let currentQuestionGuestId = null;  // í˜„ì¬ ì§ˆë¬¸ ì¤‘ì¸ ê²ŒìŠ¤íŠ¸ ID
let hostPiPWasActiveBeforeQuestion = false;  // ì§ˆë¬¸ ì‹œì‘ ì „ êµìˆ˜ PiP í™œì„±í™” ì—¬ë¶€
let isQuestionRequestActive = false;  // ì§ˆë¬¸ ìš”ì²­ í™œì„±í™” ì—¬ë¶€ (í† ê¸€ìš©)
let broadcastVideoTracks = [];      // ë°©ì†¡ ëª¨ë“œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì 
let broadcastScreenTrack = null;    // ë°©ì†¡ ëª¨ë“œ í™”ë©´ê³µìœ  íŠ¸ë™
let broadcastCameraTrack = null;    // ë°©ì†¡ ëª¨ë“œ ì¹´ë©”ë¼ íŠ¸ë™
let meetingScreenTrack = null;      // ë¯¸íŒ… ëª¨ë“œ í™”ë©´ê³µìœ  íŠ¸ë™ (í•™ìƒìš©)
let meetingCameraTrack = null;      // ë¯¸íŒ… ëª¨ë“œ ì¹´ë©”ë¼ íŠ¸ë™ (í•™ìƒìš©)
let firebaseListeners = {           // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ë¥¼ ìœ„í•œ ì°¸ì¡°
  offers: null,
  answers: null,
  candidates: {},
  chat: null,
  questionRequest: null  // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
};
let myUserId = '';                  // ë‚´ ì‚¬ìš©ì ID (ì±„íŒ…ìš©)
let studentName = '';               // í•™ìƒ ì´ë¦„ (ì…ë ¥í•œ ì´ë¦„)

/* ---------------- Utils ---------------- */
// ê°•ì œ ì¬ìƒ ë³´ì¡°(ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ ìš°íšŒ)
async function forcePlay(el){
  if(!el) return;
  try{
    el.muted = true;                    // ìë™ì¬ìƒ ë³´ì¡°
    el.setAttribute('muted','');        // iOS ë³´ì¡°
    el.setAttribute('playsinline','');  // iOS ë³´ì¡°
    el.setAttribute('webkit-playsinline','');
    await el.play();
  }catch(e){
    console.warn('forcePlay blocked:', e);
  }
}

function logStatus(msg){ if (statusEl) statusEl.textContent = msg; }
function log(msg){ console.log(msg); if (logEl) { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; } }
function toast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1800); }
function randomId(len=10){ const c='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789'; let s=''; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function generateRoomId(){ const d=new Date(); const year=d.getFullYear(); const month=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `RM-${year}${month}${day}`; }
const isiOS = (() => { const ua = navigator.userAgent||''; const iOS=/iPad|iPhone|iPod/.test(ua); const iPadOS13Plus=navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1; return iOS||iPadOS13Plus; })();

/* ---------------- UI bindings ---------------- */
const roleInputs = document.querySelectorAll('input[name="role"]');
if (roleInputs.length > 0) {
  roleInputs.forEach(r=>{
    r.addEventListener('change', ()=>{
      const checked = document.querySelector('input[name="role"]:checked');
      if (checked) role = checked.value;
      refreshUIByMode();
    });
  });
}

// í•™ìƒ ì´ë¦„ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ í•™ìƒ ì—­í•  ì„ íƒ
if (studentNameInput) {
  if (studentNameInput) studentNameInput.addEventListener('input', ()=>{
    if (studentNameInput.value.trim().length > 0) {
      const guestInput = document.querySelector('input[name="role"][value="guest"]');
      if (guestInput && !guestInput.checked) {
        guestInput.checked = true;
        role = 'guest';
        refreshUIByMode();
      }
    }
  });
}
function refreshUIByMode(){
  const isHost = role==='host';
  const isGuest = role==='guest';

  // ì—­í•  ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼: êµìˆ˜ê°€ ë°©ì„ ë§Œë“  í›„ì—ëŠ” ë¹„í™œì„±í™”í•˜ê³  í•™ìƒìœ¼ë¡œ ê³ ì •
  if (roleInputs.length > 0) {
    roleInputs.forEach(r => {
      // êµìˆ˜ê°€ ë°©ì„ ë§Œë“  í›„(isRunning && roleì´ guestë¡œ ë³€ê²½ë¨)ì—ëŠ” ë¹„í™œì„±í™”
      if (isRunning && role === 'guest') {
        r.disabled = true;
      } else {
        r.disabled = false;
      }
    });
  }

  // êµìˆ˜ì™€ í•™ìƒ ëª¨ë‘ ì‚¬ìš©í•˜ëŠ” UI ìš”ì†Œ (ì†Œë¦¬, ì¹´ë©”ë¼, í™”ë©´ê³µìœ )
  if (audioToggleBtn) audioToggleBtn.style.display = isRunning ? 'inline-block' : 'none';
  if (muteCamBtn) muteCamBtn.style.display = isRunning ? 'inline-block' : 'none';
  if (shareScreenBtn) shareScreenBtn.style.display = isRunning ? 'inline-block' : 'none';
  
  // êµìˆ˜ ì „ìš© UI ìš”ì†Œ
  if (openCameraPiPBtn) {
    if (isHost && isRunning && role === 'host') {
      const hasCameraForPiP = (hostCameraStream) || (localStream && localStream.getVideoTracks().length > 0);
      const isPiPSupported = document.pictureInPictureEnabled !== undefined;
      openCameraPiPBtn.style.display = (hasCameraForPiP && isPiPSupported) ? 'inline-block' : 'none';
    } else {
      openCameraPiPBtn.style.display = 'none';
    }
  }
  if (muteMicBtn) muteMicBtn.style.display = 'none'; // ê¸°ì¡´ ë§ˆì´í¬ ë²„íŠ¼ì€ ìˆ¨ê¹€ (audioToggleBtn ì‚¬ìš©)
  if (openBrowserWindowBtn) openBrowserWindowBtn.style.display = 'none';
  if (togglePreviewBtn) togglePreviewBtn.style.display = isRunning ? 'inline-block' : 'none';
  
  // ê²ŒìŠ¤íŠ¸ ì „ìš© UI ìš”ì†Œ (êµìˆ˜ê°€ ë°©ì„ ë§Œë“  í›„ì—ë„ ì‹¤ì œë¡œëŠ” êµìˆ˜ì´ë¯€ë¡œ peerConnections í™•ì¸)
  if (questionBtnWrapper) {
    const isActuallyGuest = isGuest && isRunning && !(isRunning && peerConnections.size > 0);
    questionBtnWrapper.style.display = isActuallyGuest ? 'block' : 'none';
  }

  if (presenterHints) presenterHints.style.display = (isHost && !isRunning) ? 'block' : 'none';
  
  // ë¯¸íŒ… ëª¨ë“œ: ì‹œì‘ í›„ì—ëŠ” í•­ìƒ ì¹´ë©”ë¼/ë§ˆì´í¬ ì»¨íŠ¸ë¡¤ í‘œì‹œ
  if (meetingVideos) meetingVideos.classList.remove('hidden');
  if (cameraCtrl) cameraCtrl.style.display = isRunning ? 'flex' : 'none';
}
refreshUIByMode();

if (switchCamBtn) switchCamBtn.addEventListener('click', async ()=>{
  facingMode = (facingMode==='user')?'environment':'user';
  toast(`ì¹´ë©”ë¼ ì „í™˜: ${facingMode==='user'?'ì „ë©´':'í›„ë©´'}`);
  if (!localStream) return;
  await replaceVideoTrack();
});

if (muteMicBtn) muteMicBtn.addEventListener('click', ()=>{
  const t = localStream?.getAudioTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  muteMicBtn.textContent = t.enabled ? 'ë§ˆì´í¬ ìŒì†Œê±°' : 'ë§ˆì´í¬ ì¼œê¸°';
});

// ì†Œë¦¬ ON/OFF ë²„íŠ¼ (ì›ê²© ì˜¤ë””ì˜¤ ì œì–´)
if (audioToggleBtn) {
  if (audioToggleBtn) audioToggleBtn.addEventListener('click', async ()=>{
    let isCurrentlyMuted = true;
    
    if (comm === 'meeting') {
      // ë¯¸íŒ… ëª¨ë“œ: ì›ê²© ë¹„ë””ì˜¤ì˜ ìŒì†Œê±° ìƒíƒœ í™•ì¸ ë° í† ê¸€
      remoteVideos.forEach(video => {
        if (video) {
          if (!video.muted) isCurrentlyMuted = false;
        }
      });
      
      // í† ê¸€: í˜„ì¬ ìŒì†Œê±°ë©´ í•´ì œ, ì•„ë‹ˆë©´ ìŒì†Œê±°
      remoteVideos.forEach(video => {
        if (video) {
          video.muted = !isCurrentlyMuted;
          if (!isCurrentlyMuted) {
            video.setAttribute('muted', '');
          } else {
            video.removeAttribute('muted');
            video.volume = 1.0;
            video.play().catch(e => {});
          }
        }
      });
      
      if (audioMirror && audioMirror.srcObject) {
        audioMirror.muted = !isCurrentlyMuted;
        if (isCurrentlyMuted) {
          audioMirror.removeAttribute('muted');
        } else {
          audioMirror.setAttribute('muted', '');
        }
      }
    } else {
      // ë°©ì†¡ ëª¨ë“œ
      if (player) {
        isCurrentlyMuted = player.muted;
        player.muted = !isCurrentlyMuted;
        if (isCurrentlyMuted) {
          player.removeAttribute('muted');
          player.volume = 1.0;
          player.play().catch(e => {});
        } else {
          player.setAttribute('muted', '');
        }
      }
      if (audioMirror) {
        audioMirror.muted = !isCurrentlyMuted;
        if (isCurrentlyMuted) {
          audioMirror.removeAttribute('muted');
        } else {
          audioMirror.setAttribute('muted', '');
        }
      }
    }
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    audioToggleBtn.textContent = isCurrentlyMuted ? 'ğŸ”Š ì†Œë¦¬ ON' : 'ğŸ”‡ ì†Œë¦¬ OFF';
    
    // iOS ì˜¤ë””ì˜¤ í™œì„±í™”
    if (isiOS && isCurrentlyMuted) {
      if (!viewerAudioCtx) viewerAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (viewerAudioCtx.state !== 'running') {
        try { await viewerAudioCtx.resume(); } catch(_) {}
      }
    }
  });
  // ì´ˆê¸° ìƒíƒœ ì„¤ì •
  audioToggleBtn.textContent = 'ğŸ”‡ ì†Œë¦¬ OFF';
}

if (muteCamBtn) muteCamBtn.addEventListener('click', ()=>{
  const t = localStream?.getVideoTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  muteCamBtn.textContent = t.enabled ? 'ğŸ“¹ ì¹´ë©”ë¼ ON' : 'ğŸ“¹ ì¹´ë©”ë¼ OFF';
});

// í™”ë©´ê³µìœ  ì‹œì‘/ì¢…ë£Œ
if (shareScreenBtn) {
  shareScreenBtn.addEventListener('click', async ()=>{
    if (isScreenSharing) {
      await stopScreenShare();
      shareScreenBtn.textContent = 'ğŸ–¥ï¸ í™”ë©´ê³µìœ  ON';
    } else {
      await startScreenShare();
      shareScreenBtn.textContent = 'ğŸ–¥ï¸ í™”ë©´ê³µìœ  OFF';
    }
  });
  // ì´ˆê¸° ìƒíƒœ ì„¤ì •
  shareScreenBtn.textContent = 'ğŸ–¥ï¸ í™”ë©´ê³µìœ  ON';
}

// ì¹´ë©”ë¼ PiP ì‹œì‘ í•¨ìˆ˜
async function startCameraPiP(cameraStreamToUse) {
  if (!cameraStreamToUse) {
    // hostCameraStreamì´ ì—†ìœ¼ë©´ localStreamì—ì„œ ì¹´ë©”ë¼ íŠ¸ë™ ì¶”ì¶œ
    if (localStream) {
      const videoTrack = localStream.getVideoTracks()[0];
      if (videoTrack) {
        cameraStreamToUse = new MediaStream([videoTrack]);
      }
    }
  }
  
  if (!cameraStreamToUse) {
    console.warn('[êµìˆ˜] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì—†ìŒ', { hostCameraStream, localStream });
    return;
  }
  
  try {
    // PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± (ìˆ¨ê¹€)
    if (!hostCameraPiPVideo) {
      hostCameraPiPVideo = document.createElement('video');
      hostCameraPiPVideo.style.position = 'fixed';
      hostCameraPiPVideo.style.top = '-9999px';
      hostCameraPiPVideo.style.width = '1px';
      hostCameraPiPVideo.style.height = '1px';
      hostCameraPiPVideo.autoplay = true;
      hostCameraPiPVideo.muted = true;
      hostCameraPiPVideo.playsInline = true;
      document.body.appendChild(hostCameraPiPVideo);
    }
    
    // ìŠ¤íŠ¸ë¦¼ ì„¤ì •
    hostCameraPiPVideo.srcObject = cameraStreamToUse;
    await hostCameraPiPVideo.play();
    
    // Picture-in-Picture ëª¨ë“œ ì§„ì…
    if (!document.pictureInPictureElement) {
      await hostCameraPiPVideo.requestPictureInPicture();
      log('[êµìˆ˜] Picture-in-Picture ëª¨ë“œ ì‹œì‘ (í™”ë©´ê³µìœ  ì‹œ ìë™)');
      
      // PiP ì°½ì„ ê³µìœ  í™”ë©´ì˜ ìš°ì¸¡ ìƒë‹¨ì— ë°°ì¹˜í•˜ë ¤ê³  ì‹œë„
      // ì°¸ê³ : ë¸Œë¼ìš°ì €ê°€ PiP ìœ„ì¹˜ë¥¼ ì œì–´í•˜ë¯€ë¡œ ì™„ì „í•œ ì œì–´ëŠ” ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ,
      // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìš°ì¸¡ ìƒë‹¨ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    }
  } catch(e) {
    console.error('Picture-in-Picture ì‹¤íŒ¨:', e);
    log('[êµìˆ˜] Picture-in-Picture ì‹¤íŒ¨: ' + e.message);
  }
}

// êµìˆ˜ ì¹´ë©”ë¼ Picture-in-Picture ëª¨ë“œ (ìˆ˜ë™ ë²„íŠ¼)
if (openCameraPiPBtn) {
  openCameraPiPBtn.addEventListener('click', async () => {
    const cameraStreamToUse = hostCameraStream || (localStream ? new MediaStream([localStream.getVideoTracks()[0]]) : null);
    
    if (!cameraStreamToUse) {
      toast('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    try {
      if (document.pictureInPictureElement) {
        // ì´ë¯¸ PiP ëª¨ë“œë©´ ì¢…ë£Œ
        await document.exitPictureInPicture();
        toast('Picture-in-Picture ëª¨ë“œ ì¢…ë£Œ');
        log('[êµìˆ˜] Picture-in-Picture ëª¨ë“œ ì¢…ë£Œ');
      } else {
        await startCameraPiP(cameraStreamToUse);
        toast('Picture-in-Picture ëª¨ë“œ ì‹œì‘');
      }
    } catch(e) {
      console.error('Picture-in-Picture ì‹¤íŒ¨:', e);
      toast('Picture-in-Pictureë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message);
    }
  });
}

// PiP ì¢…ë£Œ ê°ì§€
if (document.pictureInPictureEnabled) {
  document.addEventListener('leavepictureinpicture', () => {
    // êµìˆ˜ ì¹´ë©”ë¼ PiP ì¢…ë£Œ ê°ì§€
    if (hostCameraPiPVideo && document.pictureInPictureElement === hostCameraPiPVideo) {
      hostCameraPiPVideo.srcObject = null;
      log('[êµìˆ˜] Picture-in-Picture ëª¨ë“œ ì¢…ë£Œë¨');
    }
    // ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ PiP ì¢…ë£Œ ê°ì§€
    if (guestQuestionPiPVideo && document.pictureInPictureElement === guestQuestionPiPVideo) {
      if (currentQuestionGuestId) {
        // ì§ˆë¬¸ ì™„ë£Œ ì²˜ë¦¬
        endGuestQuestion(currentQuestionGuestId);
      }
    }
  });
}

// ìƒˆ ë¸Œë¼ìš°ì € ì°½/íƒ­ì—ì„œ ì¹´ë©”ë¼ ì˜ìƒ ì—´ê¸°
if (openBrowserWindowBtn) {
  openBrowserWindowBtn.addEventListener('click', () => {
    // hostCameraStreamì´ ì—†ìœ¼ë©´ localStream ì‚¬ìš©
    const streamToUse = hostCameraStream || (localStream ? localStream : null);
    
    if (!streamToUse || !roomId) {
      toast('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤');
      console.warn('[êµìˆ˜] ìŠ¤íŠ¸ë¦¼ ì—†ìŒ', { hostCameraStream, localStream, sourceMode, roomId });
      return;
    }
    
    try {
      // í˜„ì¬ URLì„ ê¸°ë°˜ìœ¼ë¡œ viewer ëª¨ë“œ URL ìƒì„±
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('mode', 'viewer');
      currentUrl.searchParams.set('room', roomId);
      currentUrl.searchParams.set('type', 'camera');
      
      // ìƒˆ ë¸Œë¼ìš°ì € ì°½/íƒ­ ì—´ê¸°
      const newWindow = window.open(currentUrl.toString(), '_blank', 'width=1280,height=720');
      
      if (!newWindow) {
        toast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      log('[êµìˆ˜] ìƒˆ ë¸Œë¼ìš°ì € ì°½ ì—´ê¸°: ' + currentUrl.toString());
      toast('ìƒˆ ë¸Œë¼ìš°ì € ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë””ìŠ¤í”Œë ˆì´ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    } catch(e) {
      console.error('ìƒˆ ë¸Œë¼ìš°ì € ì°½ ì—´ê¸° ì‹¤íŒ¨:', e);
      toast('ìƒˆ ë¸Œë¼ìš°ì € ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  });
}

if (gainSlider) {
  if (gainSlider) gainSlider.addEventListener('input', () => {
    if (gainNode) {
      const v = parseFloat(gainSlider.value);
      gainNode.gain.value = v;
      gainVal.textContent = v.toFixed(1);
    }
  });
}

/* ---------------- WebRTC helpers ---------------- */
const iceServers = [{ urls: ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] }];
function createPeer(customHandlers = {}){
  const _pc = new RTCPeerConnection({ iceServers });
  _pc.oniceconnectionstatechange = customHandlers.oniceconnectionstatechange || (() => { 
    if (infoEl) infoEl.textContent = 'ICE: ' + _pc.iceConnectionState; 
  });
  _pc.onconnectionstatechange = customHandlers.onconnectionstatechange || (() => { 
    if (infoEl) infoEl.textContent += ' | PC: ' + _pc.connectionState; 
  });
  return _pc;
}
function preferH264(pc){
  try{
    const txs = typeof pc.getTransceivers === 'function' ? pc.getTransceivers() : [];
    const caps = RTCRtpSender.getCapabilities ? RTCRtpSender.getCapabilities('video') : null;
    if (!caps || !caps.codecs) return;
    const h264 = caps.codecs.filter(c => /H264/i.test(c.mimeType));
    if (!h264.length) return;
    txs.forEach(t => {
      const kind = t?.sender?.track?.kind || t?.kind;
      if (kind === 'video' && typeof t.setCodecPreferences === 'function') {
        const others = caps.codecs.filter(c => !/H264/i.test(c.mimeType));
        t.setCodecPreferences(h264.concat(others));
      }
    });
  }catch(e){ console.warn('preferH264 failed:', e); }
}
async function enableAudioPlayback(){
  try{
    if (comm==='meeting') {
      // ë¯¸íŒ… ëª¨ë“œ: ëª¨ë“  ì›ê²© ë¹„ë””ì˜¤ì˜ ìŒì†Œê±° í•´ì œ
      remoteVideos.forEach(video => {
        if (video) {
          video.muted = false;
          video.removeAttribute('muted');
          video.volume = 1.0;
          video.setAttribute('playsinline','');
          video.setAttribute('webkit-playsinline','');
          video.play().catch(e => {});
        }
      });
      if (audioMirror && audioMirror.srcObject) {
        audioMirror.muted = false;
        audioMirror.removeAttribute('muted');
      }
    } else {
      // ë°©ì†¡ ëª¨ë“œ
      if (player) {
        player.muted = false;
        player.removeAttribute('muted');
        player.volume = 1.0;
        player.setAttribute('playsinline','');
        player.setAttribute('webkit-playsinline','');
      }
      if (audioMirror) {
        audioMirror.muted = false;
        audioMirror.removeAttribute('muted');
      }
    }
    
    // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„ (iOSì™€ ì¼ë°˜ ëª¨ë‘ ë™ì¼)
    if (comm==='meeting') {
      remoteVideos.forEach(video => {
        if (video) video.play().catch(e => {});
      });
    } else {
      if (player) player.play().catch(e => {});
    }
    
    // iOS íŠ¹ë³„ ì²˜ë¦¬: Audio Context í™œì„±í™”
    if (isiOS){
      if (!viewerAudioCtx) viewerAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (viewerAudioCtx.state!=='running'){ try{ await viewerAudioCtx.resume(); }catch(_){} }
      // iOSì—ì„œëŠ” audioMirrorë¥¼ í†µí•´ ì˜¤ë””ì˜¤ ì¬ìƒ ë³´ì¡°
      if (audioMirror && audioMirror.srcObject && viewerAudioCtx.state==='running'){
        try{
          const src = viewerAudioCtx.createMediaStreamSource(audioMirror.srcObject);
          const gain = viewerAudioCtx.createGain(); gain.gain.value = 1.0;
          src.connect(gain).connect(viewerAudioCtx.destination);
        }catch(_){}
      }
    }
    unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
  }catch(e){ console.warn('enableAudioPlayback failed:', e); }
}
function showIOSUnmuteOverlayIfNeeded() {
  if (isiOS) {
    tapUnmuteOverlay.style.display = 'flex';
    unmuteBtn.style.display = 'none';
  }
}
if (tapUnmuteBtn) tapUnmuteBtn.addEventListener('click', enableAudioPlayback);
if (unmuteBtn) unmuteBtn.addEventListener('click', enableAudioPlayback);

// ë‚´ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
if (togglePreviewBtn) togglePreviewBtn.addEventListener('click', ()=>{
  showLocalPreview = !showLocalPreview;
  if (showLocalPreview) {
    localPreviewWrapper.style.display = 'block';
    togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
  } else {
    localPreviewWrapper.style.display = 'none';
    togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ë³´ê¸°';
  }
});

/* ---------------- Chat Functions ---------------- */
function formatTime(timestamp){
  const d = new Date(timestamp);
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function addChatMessage(senderId, senderName, message, timestamp, isOwn = false){
  if (!chatMessages) return;
  
  const msgDiv = document.createElement('div');
  msgDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;
  
  const senderSpan = document.createElement('div');
  senderSpan.className = 'sender';
  senderSpan.textContent = isOwn ? 'ë‚˜' : (senderName || (senderId ? senderId.substring(0,6) : 'ì•Œ ìˆ˜ ì—†ìŒ'));
  
  const timeSpan = document.createElement('span');
  timeSpan.className = 'time';
  timeSpan.textContent = formatTime(timestamp || Date.now());
  
  const msgText = document.createElement('div');
  msgText.textContent = message || '';
  msgText.style.marginTop = '2px';
  msgText.style.wordBreak = 'break-word';
  
  // ì§ˆë¬¸ ë©”ì‹œì§€ëŠ” ë°ì€ ì ìƒ‰ìœ¼ë¡œ í‘œì‹œ
  if (message && message.includes('ì§ˆë¬¸ìˆìŒ')) {
    msgText.style.color = '#ff4444';
    msgText.style.fontWeight = 'bold';
    msgText.style.fontSize = '14px';
  }
  
  senderSpan.appendChild(timeSpan);
  msgDiv.appendChild(senderSpan);
  msgDiv.appendChild(msgText);
  
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // ìƒˆ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì±„íŒ… ëª¨ë‹¬ ìë™ í‘œì‹œ (ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ˆê³ , ì§ˆë¬¸ ë©”ì‹œì§€ê°€ ì•„ë‹ ë•Œë§Œ)
  // ì§ˆë¬¸ ë©”ì‹œì§€ëŠ” ì±„íŒ…ì°½ì—ë§Œ í‘œì‹œí•˜ê³  ëª¨ë‹¬ì€ ë„ìš°ì§€ ì•ŠìŒ
  const isQuestionMessage = message.includes('ì§ˆë¬¸ìˆìŒ') || message.includes('ì§ˆë¬¸');
  if (!isOwn && !isQuestionMessage) {
    showChatModal();
  }
  
  // ë©”ì‹œì§€ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±° (ë©”ëª¨ë¦¬ ê´€ë¦¬)
  const maxMessages = 100;
  while (chatMessages.children.length > maxMessages) {
    chatMessages.removeChild(chatMessages.firstChild);
  }
}

async function sendChatMessage(){
  const message = chatInput.value.trim();
  if (!message || !roomId || !myUserId || !isRunning) {
    if (!isRunning) toast('ë¨¼ì € ë°©ì— ì°¸ì—¬í•˜ì„¸ìš”');
    return;
  }
  
  // ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ (200ì)
  const trimmedMessage = message.substring(0, 200);
  
  const chatData = {
    senderId: myUserId,
    senderName: role === 'host' ? 'êµìˆ˜' : (studentName ? studentName : `í•™ìƒ ${myUserId.substring(0,6)}`),
    message: trimmedMessage,
    timestamp: Date.now()
  };
  
  try {
    await db.ref(`rooms/${roomId}/chat`).push(chatData);
    chatInput.value = '';
  } catch(e) {
    log('[Chat] ì „ì†¡ ì‹¤íŒ¨: ' + e.message);
    toast('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
    console.error('Chat send error:', e);
  }
}

// ì§ˆë¬¸ ì•Œë¦¼ ì „ì†¡/ì·¨ì†Œ í•¨ìˆ˜ (ì‹œì²­ì ì „ìš©, í† ê¸€ ê¸°ëŠ¥)
async function sendQuestionNotification(){
  if (!isRunning || role !== 'guest' || !roomId || !myUserId) {
    toast('ë¨¼ì € ë°©ì— ì°¸ì—¬í•˜ì„¸ìš”');
    return;
  }
  
  const guestName = studentName ? studentName : `í•™ìƒ ${myUserId.substring(0,6)}`;
  
  try {
    if (isQuestionRequestActive) {
      // ì§ˆë¬¸ ìš”ì²­ ì·¨ì†Œ
      await db.ref(`rooms/${roomId}/questionRequests/${myUserId}`).remove();
      isQuestionRequestActive = false;
      toast('ì§ˆë¬¸ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
      log('[Guest] ì§ˆë¬¸ ìš”ì²­ ì·¨ì†Œ');
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateQuestionButtonState(false);
    } else {
      // ì§ˆë¬¸ ìš”ì²­ ì „ì†¡
      const questionMessage = `${guestName}ê°€ ì§ˆë¬¸ìˆìŒ`;
      
      const chatData = {
        senderId: myUserId,
        senderName: guestName,
        message: questionMessage,
        timestamp: Date.now()
      };
      
      // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
      await db.ref(`rooms/${roomId}/chat`).push(chatData);
      
      // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœë¥¼ Firebaseì— ì €ì¥ (êµìˆ˜ê°€ ê¹œë°•ì„ í‘œì‹œë¥¼ ìœ„í•´)
      await db.ref(`rooms/${roomId}/questionRequests/${myUserId}`).set({
        timestamp: Date.now(),
        status: 'pending'
      });
      
      isQuestionRequestActive = true;
      toast('ì§ˆë¬¸ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤');
      log('[Guest] ì§ˆë¬¸ ì•Œë¦¼ ì „ì†¡: ' + questionMessage);
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateQuestionButtonState(true);
    }
  } catch(e) {
    log('[Chat] ì§ˆë¬¸ ì•Œë¦¼ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message);
    toast('ì§ˆë¬¸ ì•Œë¦¼ ì²˜ë¦¬ ì‹¤íŒ¨');
    console.error('Question notification error:', e);
  }
}

// ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateQuestionButtonState(isActive) {
  // ì±„íŒ… ì„¹ì…˜ ë²„íŠ¼
  if (questionBtn) {
    if (isActive) {
      questionBtn.textContent = 'âŒ ì§ˆë¬¸ ìš”ì²­ ì·¨ì†Œ';
      questionBtn.classList.add('danger');
      questionBtn.classList.remove('primary');
    } else {
      questionBtn.textContent = 'â“ ì†¡ì¶œìì—ê²Œ ì§ˆë¬¸í•˜ê¸°';
      questionBtn.classList.remove('danger');
      questionBtn.classList.add('primary');
    }
  }
  
  // ë¹„ë””ì˜¤ í™”ë©´ ë²„íŠ¼ë“¤
  document.querySelectorAll('.video-question-btn').forEach(btn => {
    if (isActive) {
      btn.textContent = 'âŒ ì§ˆë¬¸ ì·¨ì†Œ';
      btn.style.background = 'rgba(244,67,54,.8)';
    } else {
      btn.textContent = 'â“ ì§ˆë¬¸í•˜ê¸°';
      btn.style.background = 'rgba(106,166,255,.8)';
    }
  });
}

function initChat(){
  if (!roomId) return;
  
  // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
  if (firebaseListeners.chat) {
    firebaseListeners.chat.off();
  }
  
  // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
  const chatRef = db.ref(`rooms/${roomId}/chat`);
  firebaseListeners.chat = chatRef;
  
  chatRef.on('child_added', snap => {
    try {
      const data = snap.val();
      if (!data || !data.message || typeof data.message !== 'string') return;
      if (!data.senderId || !data.timestamp) return;
      const isOwn = data.senderId === myUserId;
      addChatMessage(data.senderId, data.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ', data.message, data.timestamp, isOwn);
    } catch(e) {
      console.warn('[Chat] ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
    }
  });
}

if (chatSendBtn) chatSendBtn.addEventListener('click', sendChatMessage);
if (chatInput) {
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendChatMessage();
    }
  });
}

// ì‹œì²­ì ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼
if (questionBtn) {
  if (questionBtn) questionBtn.addEventListener('click', () => {
    // ë¹„ë””ì˜¤ í™”ë©´ì˜ ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ ì‘ë™ (í† ê¸€ ê¸°ëŠ¥)
    sendQuestionNotification();
  });
}

// ì „ì²´í™”ë©´ ë‹«ê¸° ë²„íŠ¼
if (fsCloseBtn) fsCloseBtn.addEventListener('click', () => {
  try {
    fullscreenVideo.classList.remove('show');
    fsVideo.srcObject = null;
    fsVideo.pause();
  } catch(e) {
    console.error('Fullscreen close error:', e);
  }
});

// ì „ì²´í™”ë©´ ì§ˆë¬¸ ë²„íŠ¼
if (fullscreenQuestionBtn) {
  if (fullscreenQuestionBtn) fullscreenQuestionBtn.addEventListener('click', () => {
    sendQuestionNotification();
  });
}

// ESC í‚¤ë¡œ ì „ì²´í™”ë©´ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && fullscreenVideo.classList.contains('show')) {
    fsCloseBtn.click();
  }
});


/* ---------------- Media Builders ---------------- */
async function getCameraStream(){
  try {
    return await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode,
        width:  { ideal: 1280, max: 1920 },
        height: { ideal: 720,  max: 1080 },
        frameRate: { ideal: 30, max: 60 }
      },
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
  } catch(e) {
    log('[Camera] ì¹´ë©”ë¼/ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: ' + e.message);
    toast('ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
    throw e;
  }
}

async function getScreenStream(){
  try{
    return await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch(e){
    log('[êµìˆ˜] getDisplayMedia with audio failed, retry video-only');
    try {
      return await navigator.mediaDevices.getDisplayMedia({ video:true }); // ì¬ì‹œë„
    } catch(e2) {
      log('[êµìˆ˜] í™”ë©´ê³µìœ  ì‹¤íŒ¨: ' + e2.message);
      toast('í™”ë©´ê³µìœ  ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
      throw e2;
    }
  }
}

async function makeAmplifiedStreamFrom(sourceStream, fallbackUseMic=true){
  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  const initialGain = parseFloat(gainSlider?.value || '2') || 2.0;
  gainNode.gain.value = initialGain;
  if (gainVal) gainVal.textContent = initialGain.toFixed(1);

  const videoTracks = sourceStream.getVideoTracks();
  const inAudioTracks = sourceStream.getAudioTracks();
  let outputAudioTrack = null;

  if (inAudioTracks.length){
    const src = audioCtx.createMediaStreamSource(sourceStream);
    const dest = audioCtx.createMediaStreamDestination();
    src.connect(gainNode).connect(dest);
    outputAudioTrack = dest.stream.getAudioTracks()[0];
  } else if (fallbackUseMic){
    try{
      const mic = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } });
      const src = audioCtx.createMediaStreamSource(mic);
      const dest = audioCtx.createMediaStreamDestination();
      src.connect(gainNode).connect(dest);
      outputAudioTrack = dest.stream.getAudioTracks()[0];
    }catch(e){ log('[Audio] ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: '+e.message); }
  }

  return outputAudioTrack ? new MediaStream([...videoTracks, outputAudioTrack]) : new MediaStream([...videoTracks]);
}

/* ---------------- êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ---------------- */
function openHostCameraWindow(cameraStream, isScreenShareMode = false, screenInfo = null) {
  if (!cameraStream || !cameraStream.getVideoTracks()[0]) {
    log('[êµìˆ˜] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ì–´ ë³„ë„ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ê¸°ì¡´ ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  if (hostCameraWindow && !hostCameraWindow.closed) {
    hostCameraWindow.close();
  }
  
  try {
    let windowLeft = 100;
    let windowTop = 100;
    let windowWidth = 800;
    let windowHeight = 600;
    
    // Screen API ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if (window.screen && window.screen.availWidth) {
      const availWidth = window.screen.availWidth;
      const availHeight = window.screen.availHeight;
      
      if (isScreenShareMode && screenInfo) {
        // í™”ë©´ê³µìœ  ëª¨ë“œ: ê³µìœ ë˜ëŠ” í™”ë©´ì˜ í¬ê¸° ì •ë³´ ì‚¬ìš©
        const sharedScreenWidth = screenInfo.screenWidth || window.screen.width;
        const sharedScreenHeight = screenInfo.screenHeight || window.screen.height;
        
        // ê°€ë¡œëŠ” ê³µìœ  í™”ë©´ì˜ 1/6, ì„¸ë¡œëŠ” ê³µìœ  í™”ë©´ì˜ 1/4 í¬ê¸°ë¡œ ì„¤ì •
        windowWidth = Math.floor(sharedScreenWidth / 6);
        windowHeight = Math.floor(sharedScreenHeight / 4);
        
        // ê³µìœ  í™”ë©´ì˜ ìš°ì¸¡ì— ë°°ì¹˜
        // ê³µìœ  í™”ë©´ì˜ í•´ìƒë„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìš°ì¸¡ì— ë°°ì¹˜
        const margin = 20;
        
        // ê³µìœ  í™”ë©´ì˜ ìš°ì¸¡ì— ë°°ì¹˜ (ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬)
        windowLeft = sharedScreenWidth - windowWidth - margin;
        // ì„¸ë¡œ ì¤‘ì•™ì— ë°°ì¹˜
        windowTop = Math.floor((sharedScreenHeight - windowHeight) / 2);
        
        log(`[Host] í™”ë©´ê³µìœ  ëª¨ë“œ: ê³µìœ  í™”ë©´ í¬ê¸° ${sharedScreenWidth}x${sharedScreenHeight}, ì°½ í¬ê¸° ${windowWidth}x${windowHeight}, ìœ„ì¹˜: ${windowLeft},${windowTop} (ìš°ì¸¡ ì¤‘ì•™)`);
      } else {
        // ì¼ë°˜ ëª¨ë“œ: ê¸°ì¡´ ë¡œì§ ìœ ì§€
        const primaryScreenWidth = window.screen.width;
        const primaryScreenHeight = window.screen.height;
        
        // ë‘ ë²ˆì§¸ ë””ìŠ¤í”Œë ˆì´ ìœ„ì¹˜ ì¶”ì • (ì£¼ ë””ìŠ¤í”Œë ˆì´ ë„ˆë¹„ + ì˜¤í”„ì…‹)
        windowLeft = primaryScreenWidth + 50;
        windowTop = 50;
        
        // ì°½ í¬ê¸°ë¥¼ ë” í¬ê²Œ ì„¤ì • (í”„ë ˆì  í…Œì´ì…˜ìš©)
        windowWidth = Math.min(1280, availWidth * 0.8);
        windowHeight = Math.min(720, availHeight * 0.8);
        
        log(`[Host] ë””ìŠ¤í”Œë ˆì´ ì •ë³´: ${primaryScreenWidth}x${primaryScreenHeight}, ì°½ ìœ„ì¹˜: ${windowLeft},${windowTop}`);
      }
    }
    
    // ìƒˆ ì°½ ì—´ê¸° - CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™”
    // ì°¸ê³ : ìµœì‹  ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ì£¼ì†Œì°½ì„ ì™„ì „íˆ ì œê±°í•˜ëŠ” ê²ƒì€ ì œí•œì ì¼ ìˆ˜ ìˆìŒ
    // í•˜ì§€ë§Œ ê°€ëŠ¥í•œ ëª¨ë“  UI ìš”ì†Œë¥¼ ì œê±°í•˜ì—¬ CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
    const windowFeatures = `width=${windowWidth},height=${windowHeight},left=${windowLeft},top=${windowTop},resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,directories=no,titlebar=no`;
    hostCameraWindow = window.open('about:blank', 'hostCameraWindow', windowFeatures);
    
    if (!hostCameraWindow) {
      toast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
      log('[Host] íŒì—… ì°½ ì—´ê¸° ì‹¤íŒ¨ (íŒì—… ì°¨ë‹¨)');
      return;
    }
    
    // ì°½ HTML ì‘ì„± - CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™”
    // ì£¼ì†Œì°½ì´ ë³´ì´ë”ë¼ë„ ìµœì†Œí•œì˜ ê³µê°„ë§Œ ì‚¬ìš©í•˜ê³  ë¹„ë””ì˜¤ ì˜ì—­ì„ ìµœëŒ€í™”
    const windowHTML = `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      background: #000;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: ui-sans-serif, system-ui, sans-serif;
      /* ì£¼ì†Œì°½ ì˜ì—­ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•œ ì„¤ì • */
      position: fixed;
      top: 0;
      left: 0;
    }
    .drag-header {
      /* êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ì—ì„œëŠ” ì˜ìƒë§Œ ë³´ì´ë„ë¡ í—¤ë”ë¥¼ ì™„ì „íˆ ìˆ¨ê¹€ */
      display: none !important;
    }
    .drag-header .title {
      color: #fff;
      font-size: 12px;
      font-weight: bold;
      flex: 1;
      pointer-events: none;
      opacity: 0.9;
    }
    .drag-header .header-buttons {
      display: flex;
      gap: 6px;
      align-items: center;
      -webkit-app-region: no-drag;
    }
    .video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      /* CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™” */
      margin: 0;
      padding: 0;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      /* ë¹„ë””ì˜¤ê°€ ì „ì²´ CONTENT AREAë¥¼ ì‚¬ìš©í•˜ë„ë¡ */
      display: block;
      margin: 0;
      padding: 0;
    }
    .title {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 10;
      font-weight: bold;
      display: none;
    }
    .header-btn {
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      min-width: 70px;
      opacity: 0.9;
    }
    .header-btn:hover {
      background: rgba(0,0,0,0.8);
      border-color: rgba(255,255,255,0.5);
      opacity: 1;
    }
    .close-btn {
      background: rgba(255,106,106,0.7);
      color: #fff;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all 0.2s;
      opacity: 0.9;
    }
    .close-btn:hover {
      background: rgba(255,106,106,1);
      opacity: 1;
      transform: scale(1.1);
    }
    .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    .control-btn {
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    .control-btn:hover {
      background: rgba(0,0,0,0.9);
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="cameraVideo" autoplay playsinline muted></video>
    <div class="drag-header" id="dragHeader">
      <div class="title">êµìˆ˜ ì¹´ë©”ë¼</div>
      <div class="header-buttons">
        <button class="header-btn" id="fullscreenBtn">â›¶ ì „ì²´í™”ë©´</button>
        <button class="close-btn" id="closeBtn" title="ë‹«ê¸°">Ã—</button>
      </div>
    </div>
  </div>
</body>
</html>`;
    
    hostCameraWindow.document.write(windowHTML);
    
    // ìŠ¤íŠ¸ë¦¼ì„ ìƒˆ ì°½ì— ì „ë‹¬
    hostCameraWindow.document.close();
    
    // CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™”
    // ì£¼ì†Œì°½ì´ ë³´ì´ë”ë¼ë„ ë¹„ë””ì˜¤ ì˜ì—­ì„ ìµœëŒ€í™”í•˜ê¸° ìœ„í•œ ì‹œë„
    try {
      const optimizeContentArea = () => {
        try {
          if (hostCameraWindow && !hostCameraWindow.closed) {
            // ì£¼ì†Œì°½ ë†’ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì°½ í¬ê¸° ì¡°ì •
            // ì£¼ì†Œì°½ ë†’ì´ëŠ” ë¸Œë¼ìš°ì €ë§ˆë‹¤ ë‹¤ë¥´ì§€ë§Œ ì•½ 40-60px ì •ë„
            const addressBarHeight = 60;
            const adjustedHeight = windowHeight + addressBarHeight;
            
            // ì°½ í¬ê¸° ì¡°ì •
            hostCameraWindow.resizeTo(windowWidth, adjustedHeight);
            
            // ì°½ ë‚´ë¶€ì˜ bodyê°€ ì „ì²´ CONTENT AREAë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
            const doc = hostCameraWindow.document;
            if (doc && doc.body) {
              doc.body.style.margin = '0';
              doc.body.style.padding = '0';
              doc.body.style.width = '100vw';
              doc.body.style.height = '100vh';
              doc.body.style.overflow = 'hidden';
              doc.body.style.position = 'fixed';
              doc.body.style.top = '0';
              doc.body.style.left = '0';
            }
            
            // html ìš”ì†Œë„ ìµœì í™”
            if (doc && doc.documentElement) {
              doc.documentElement.style.margin = '0';
              doc.documentElement.style.padding = '0';
              doc.documentElement.style.width = '100vw';
              doc.documentElement.style.height = '100vh';
              doc.documentElement.style.overflow = 'hidden';
            }
          }
        } catch(e) {
          // ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìŒ
          console.warn('[êµìˆ˜] CONTENT AREA ìµœì í™” ì‹¤íŒ¨:', e);
        }
      };
      
      if (hostCameraWindow.document.readyState === 'complete') {
        setTimeout(optimizeContentArea, 100);
        setTimeout(optimizeContentArea, 500); // ì¬ì‹œë„
      } else {
        hostCameraWindow.addEventListener('load', () => {
          setTimeout(optimizeContentArea, 100);
          setTimeout(optimizeContentArea, 500); // ì¬ì‹œë„
        });
      }
    } catch(e) {
      console.warn('[êµìˆ˜] CONTENT AREA ìµœì í™” ì„¤ì • ì‹¤íŒ¨:', e);
    }
    
    // ìŠ¤íŠ¸ë¦¼ ì„¤ì • (ë¬¸ì„œ ë¡œë“œ í›„)
    const setStream = () => {
      try {
        const video = hostCameraWindow.document.getElementById('cameraVideo');
        if (video && cameraStream) {
          video.srcObject = cameraStream;
          video.play().catch(e => {
            console.warn('[êµìˆ˜] ë³„ë„ ì°½ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', e);
          });
        }
      } catch(e) {
        console.error('[êµìˆ˜] ë³„ë„ ì°½ ìŠ¤íŠ¸ë¦¼ ì„¤ì • ì‹¤íŒ¨:', e);
      }
    };
    
    // ì°½ì´ ë¡œë“œëœ í›„ ìŠ¤íŠ¸ë¦¼ ì„¤ì • ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
    const setupWindow = () => {
      setStream();
      
      // ë“œë˜ê·¸ ê¸°ëŠ¥ êµ¬í˜„ (ì°½ ì´ë™)
      try {
        const dragHeader = hostCameraWindow.document.getElementById('dragHeader');
        if (dragHeader) {
          let isDragging = false;
          let startX, startY, startLeft, startTop;
          
          const startDrag = (clientX, clientY) => {
            // ë²„íŠ¼ í´ë¦­ì€ ë“œë˜ê·¸ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            const target = hostCameraWindow.document.elementFromPoint(clientX, clientY);
            if (target && (target.tagName === 'BUTTON' || target.closest('.header-buttons'))) {
              return false;
            }
            
            startX = clientX;
            startY = clientY;
            startLeft = hostCameraWindow.screenX;
            startTop = hostCameraWindow.screenY;
            isDragging = true;
            dragHeader.style.cursor = 'grabbing';
            dragHeader.style.opacity = '0.95';
            return true;
          };
          
          const doDrag = (clientX, clientY) => {
            if (!isDragging) return;
            
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;
            
            try {
              const newLeft = startLeft + deltaX;
              const newTop = startTop + deltaY;
              
              // ì°½ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì‘ë™)
              hostCameraWindow.moveTo(newLeft, newTop);
            } catch(err) {
              // ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì°½ ì´ë™ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ
              // ì´ ê²½ìš° ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ë“œë˜ê·¸ ë™ì‘ì„ ì‚¬ìš©
              console.warn('ì°½ ì´ë™ ì œí•œ (ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ì‚¬ìš©):', err);
            }
          };
          
          const stopDrag = () => {
            if (isDragging) {
              isDragging = false;
              dragHeader.style.cursor = 'move';
              dragHeader.style.opacity = '1';
            }
          };
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
          dragHeader.addEventListener('mousedown', (e) => {
            if (startDrag(e.clientX, e.clientY)) {
              e.preventDefault();
            }
          });
          
          hostCameraWindow.addEventListener('mousemove', (e) => {
            if (isDragging) {
              e.preventDefault();
              doDrag(e.clientX, e.clientY);
            }
          });
          
          hostCameraWindow.addEventListener('mouseup', stopDrag);
          hostCameraWindow.addEventListener('mouseleave', stopDrag);
          
          // í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì› (ëª¨ë°”ì¼)
          dragHeader.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            if (startDrag(touch.clientX, touch.clientY)) {
              e.preventDefault();
            }
          }, { passive: false });
          
          hostCameraWindow.addEventListener('touchmove', (e) => {
            if (isDragging) {
              e.preventDefault();
              const touch = e.touches[0];
              doDrag(touch.clientX, touch.clientY);
            }
          }, { passive: false });
          
          hostCameraWindow.addEventListener('touchend', stopDrag);
          hostCameraWindow.addEventListener('touchcancel', stopDrag);
        }
      } catch(e) {
        console.warn('[êµìˆ˜] ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì • ì‹¤íŒ¨:', e);
      }
      
      // ì „ì²´í™”ë©´ ë²„íŠ¼ ê¸°ëŠ¥
      try {
        const fullscreenBtn = hostCameraWindow.document.getElementById('fullscreenBtn');
        if (fullscreenBtn) {
          fullscreenBtn.addEventListener('click', () => {
            const video = hostCameraWindow.document.getElementById('cameraVideo');
            if (video) {
              if (video.requestFullscreen) {
                video.requestFullscreen();
              } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
              } else if (video.mozRequestFullScreen) {
                video.mozRequestFullScreen();
              } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
              } else if (hostCameraWindow.document.documentElement.requestFullscreen) {
                hostCameraWindow.document.documentElement.requestFullscreen();
              }
            }
          });
        }
      } catch(e) {
        console.warn('[êµìˆ˜] ì „ì²´í™”ë©´ ë²„íŠ¼ ì„¤ì • ì‹¤íŒ¨:', e);
      }
      
      // ë‹«ê¸° ë²„íŠ¼ ê¸°ëŠ¥
      try {
        const closeBtn = hostCameraWindow.document.getElementById('closeBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            if (hostCameraWindow && !hostCameraWindow.closed) {
              hostCameraWindow.close();
            }
          });
        }
      } catch(e) {
        console.warn('[êµìˆ˜] ë‹«ê¸° ë²„íŠ¼ ì„¤ì • ì‹¤íŒ¨:', e);
      }
      
      // ì°½ì´ ë‹«í ë•Œ ë¶€ëª¨ ì°½ì— ì•Œë¦¼
      try {
        hostCameraWindow.addEventListener('beforeunload', function() {
          if (window.opener && !window.opener.closed) {
            try {
              window.opener.postMessage({ type: 'cameraWindowClosed' }, '*');
            } catch(err) {}
          }
        });
      } catch(e) {
        console.warn('[êµìˆ˜] beforeunload ì´ë²¤íŠ¸ ì„¤ì • ì‹¤íŒ¨:', e);
      }
    };
    
    // ì°½ì´ ë¡œë“œëœ í›„ ì„¤ì •
    if (hostCameraWindow.document.readyState === 'complete') {
      setupWindow();
    } else {
      hostCameraWindow.addEventListener('load', setupWindow);
    }
    
    // íƒ€ì„ì•„ì›ƒìœ¼ë¡œë„ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
    setTimeout(setupWindow, 200);
    
    // ì°½ì´ ë‹«í ë•Œ ê°ì§€
    const checkClosed = setInterval(() => {
      if (hostCameraWindow && hostCameraWindow.closed) {
        clearInterval(checkClosed);
        hostCameraWindow = null;
        log('[êµìˆ˜] ì¹´ë©”ë¼ ë³„ë„ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤');
      }
    }, 500);
    
    log('[êµìˆ˜] êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ì—´ë¦¼');
  } catch(e) {
    console.error('[êµìˆ˜] ë³„ë„ ì°½ ì—´ê¸° ì‹¤íŒ¨:', e);
    log('[êµìˆ˜] ë³„ë„ ì°½ ì—´ê¸° ì‹¤íŒ¨: ' + e.message);
    toast('ë³„ë„ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
}

function closeHostCameraWindow() {
  if (hostCameraWindow && !hostCameraWindow.closed) {
    hostCameraWindow.close();
    hostCameraWindow = null;
    log('[êµìˆ˜] êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ë‹«ìŒ');
  }
}

// ë³„ë„ ì°½ ë‹«ê¸° ë©”ì‹œì§€ ìˆ˜ì‹ 
window.addEventListener('message', (e) => {
  if (e.data && e.data.type === 'cameraWindowClosed') {
    hostCameraWindow = null;
    log('[êµìˆ˜] ì¹´ë©”ë¼ ë³„ë„ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤ (ë©”ì‹œì§€ ìˆ˜ì‹ )');
  }
});

async function buildLocalStreamForCurrentMode(){
  try {
    // ë¯¸íŒ… ëª¨ë“œ: ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‚¬ìš©
    const cam = await getCameraStream();
    return cam;
  } catch(e) {
    log('[Stream] ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì‹¤íŒ¨: ' + e.message);
    throw e;
  }
}
async function replaceVideoTrack(){
  if (!localStream) return;

  // ìƒˆ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
  const newStream = await getCameraStream();
  const newTrack = newStream.getVideoTracks()[0];

  // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ê°±ì‹ 
  localStream.getVideoTracks().forEach(t=>t.stop());
  localStream = new MediaStream([ newTrack, ...localStream.getAudioTracks() ]);

  if (role === 'host' && comm === 'meeting') {
    // êµìˆ˜ ë¯¸íŒ… ëª¨ë“œ: ëª¨ë“  í•™ìƒ ì—°ê²°ì— íŠ¸ë™ êµì²´
    peerConnections.forEach((_pc, vid) => {
      const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender && newTrack) {
        sender.replaceTrack(newTrack).catch(e => {
          console.warn(`[êµìˆ˜] replaceTrack failed for ${vid}:`, e);
        });
      }
    });
  } else if (pc) {
    // í•™ìƒ ë˜ëŠ” êµìˆ˜ ë°©ì†¡ ëª¨ë“œ
    const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
    if (sender && newTrack){
      try{
        await sender.replaceTrack(newTrack);
      }catch(e){
        console.warn('replaceTrack failed, renegotiate fallback:', e);
        try{
          const old = sender.track;
          if (old) old.stop();
          await sender.replaceTrack(null);
          pc.addTrack(newTrack, localStream);
        }catch(e2){ console.warn('fallback failed:', e2); }
      }
    }
  }

  // í”„ë¦¬ë·° ê°±ì‹ 
  if (showLocalPreview) {
    localPreview.srcObject = localStream;
    await forcePlay(localPreview);
  }
}

// í™”ë©´ê³µìœ  ì‹œì‘
async function startScreenShare(){
  if (!localStream) {
    toast('ë¨¼ì € ë°©ì†¡ì„ ì‹œì‘í•˜ì„¸ìš”');
    return;
  }
  
  
  if (isScreenSharing) {
    log('[Screen] ì´ë¯¸ í™”ë©´ê³µìœ  ì¤‘ì…ë‹ˆë‹¤');
    return;
  }
  
  try {
    const screenStream = await getScreenStream();
    const screenTrack = screenStream.getVideoTracks()[0];
    
    if (!screenTrack) {
      toast('í™”ë©´ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      log('[Screen] í™”ë©´ê³µìœ  íŠ¸ë™ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    // í™”ë©´ê³µìœ  ì¢…ë£Œ ê°ì§€
    screenTrack.onended = async () => {
      log('[Screen] í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
      toast('í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤');
      await stopScreenShare();
    };
    
    screenShareStream = screenStream;
    isScreenSharing = true;
    
    // ê¸°ì¡´ ë¹„ë””ì˜¤ íŠ¸ë™ ì €ì¥
    const oldVideoTrack = localStream.getVideoTracks()[0];
    let cameraTrackForPip = null;
    
    if (oldVideoTrack && role === 'host') {
      // ë°©ì†¡ ëª¨ë“œ: ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ì„ ìœ ì§€í•˜ê³  í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
      if (comm === 'broadcast' && sourceMode === 'camera') {
        // ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ì„ ë³„ë„ ì°½ìš©ìœ¼ë¡œ ìœ ì§€
        cameraTrackForPip = oldVideoTrack;
        hostCameraStream = new MediaStream([cameraTrackForPip]);
        
        // Picture-in-Picture ëª¨ë“œ ìë™ ì‹œì‘
        await startCameraPiP(hostCameraStream);
        
        // í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ (ì¹´ë©”ë¼ íŠ¸ë™ê³¼ í•¨ê»˜)
        localStream.addTrack(screenTrack);
        
        // ëª¨ë“  ê²ŒìŠ¤íŠ¸ ì—°ê²°ì— í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
        peerConnections.forEach((_pc, vid) => {
          try {
            // í™”ë©´ê³µìœ  íŠ¸ë™ì„ ìƒˆ íŠ¸ëœì‹œë²„ë¡œ ì¶”ê°€
            const screenStream = new MediaStream([screenTrack]);
            _pc.addTrack(screenTrack, screenStream);
            
            // ê¸°ì¡´ ê²ŒìŠ¤íŠ¸ ì—°ê²°ì—ë„ ì¹´ë©”ë¼ íŠ¸ë™ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
            const existingSenders = _pc.getSenders();
            const hasCameraTrack = existingSenders.some(s => {
              const t = s.track;
              if (!t || t.kind !== 'video') return false;
              const label = t.label.toLowerCase();
              return !label.includes('screen') && !label.includes('í™”ë©´') && 
                     !label.includes('display') && !label.includes('monitor') &&
                     !label.includes('window');
            });
            
            if (!hasCameraTrack && cameraTrackForPip) {
              const cameraStream = new MediaStream([cameraTrackForPip]);
              _pc.addTrack(cameraTrackForPip, cameraStream);
              log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ ì¹´ë©”ë¼ íŠ¸ë™ë„ ì¶”ê°€`);
            }
            
            log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ (ì¹´ë©”ë¼ ìœ ì§€)`);
          } catch(e) {
            console.warn(`[êµìˆ˜] í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨ (${vid}):`, e);
            log(`[êµìˆ˜] í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨ (${vid}): ` + e.message);
          }
        });
      } else {
        // ë¯¸íŒ… ëª¨ë“œ: í™”ë©´ê³µìœ  íŠ¸ë™ê³¼ ì¹´ë©”ë¼ íŠ¸ë™ì„ í•¨ê»˜ ì „ì†¡ (ì¹´ë©”ë¼ ì˜ìƒì´ ë©ˆì¶”ì§€ ì•Šë„ë¡)
        
        // ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ì„ ì¤‘ì§€í•˜ê¸° ì „ì— ë³„ë„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“
        let cameraTrackForPip = null;
        try {
          const cameraStream = await getCameraStream();
          cameraTrackForPip = cameraStream.getVideoTracks()[0];
          if (cameraTrackForPip) {
            hostCameraStream = new MediaStream([cameraTrackForPip]);
            log('[êµìˆ˜] í™”ë©´ê³µìœ  ëª¨ë“œ: ë³„ë„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì™„ë£Œ');
            
            // í™”ë©´ê³µìœ  íŠ¸ë™ì—ì„œ ê³µìœ ë˜ëŠ” í™”ë©´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const screenSettings = screenTrack.getSettings();
            const sharedScreenWidth = screenSettings.width || window.screen.width;
            const sharedScreenHeight = screenSettings.height || window.screen.height;
            
            // Picture-in-Picture ëª¨ë“œ ìë™ ì‹œì‘ (ê³µìœ  í™”ë©´ì˜ ìš°ì¸¡ ìƒë‹¨ì— ë°°ì¹˜)
            await startCameraPiP(hostCameraStream);
          }
        } catch(e) {
          console.warn('[êµìˆ˜] í™”ë©´ê³µìœ  ì¤‘ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì‹¤íŒ¨:', e);
          log('[êµìˆ˜] í™”ë©´ê³µìœ  ì¤‘ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì‹¤íŒ¨: ' + e.message);
        }
        
        // ê¸°ì¡´ íŠ¸ë™ ì œê±°
        oldVideoTrack.stop();
        localStream.removeTrack(oldVideoTrack);
        
        // í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
        localStream.addTrack(screenTrack);
        
        // ì¹´ë©”ë¼ íŠ¸ë™ë„ localStreamì— ì¶”ê°€ (ë¯¸ë¦¬ë³´ê¸°ìš©)
        if (cameraTrackForPip) {
          localStream.addTrack(cameraTrackForPip);
        }
        
        // ëª¨ë“  ì—°ê²°ì— í™”ë©´ê³µìœ  íŠ¸ë™ê³¼ ì¹´ë©”ë¼ íŠ¸ë™ì„ í•¨ê»˜ ì „ì†¡
        peerConnections.forEach((_pc, vid) => {
          try {
            // ê¸°ì¡´ ë¹„ë””ì˜¤ íŠ¸ë™ ì°¾ê¸°
            const existingSenders = _pc.getSenders();
            const videoSender = existingSenders.find(s => s.track && s.track.kind === 'video');
            
            if (videoSender && videoSender.track) {
              // ê¸°ì¡´ íŠ¸ë™ì„ í™”ë©´ê³µìœ  íŠ¸ë™ìœ¼ë¡œ êµì²´
              videoSender.replaceTrack(screenTrack).then(() => {
                log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì™„ë£Œ`);
                
                // ì¹´ë©”ë¼ íŠ¸ë™ë„ ë³„ë„ë¡œ ì¶”ê°€ (í•™ìƒì´ ë‘ ê°œì˜ ë¹„ë””ì˜¤ íŠ¸ë™ì„ ë°›ì„ ìˆ˜ ìˆë„ë¡)
                if (cameraTrackForPip) {
                  const cameraStream = new MediaStream([cameraTrackForPip]);
                  _pc.addTrack(cameraTrackForPip, cameraStream);
                  log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ ì¹´ë©”ë¼ íŠ¸ë™ë„ ì¶”ê°€ (í™”ë©´ê³µìœ ì™€ í•¨ê»˜)`);
                }
              }).catch(e => {
                console.warn(`[êµìˆ˜] í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì‹¤íŒ¨ (${vid}):`, e);
                // êµì²´ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„: íŠ¸ë™ ì œê±° í›„ ì¶”ê°€
                try {
                  videoSender.track.stop();
                  const screenStream = new MediaStream([screenTrack]);
                  _pc.addTrack(screenTrack, screenStream);
                  
                  // ì¹´ë©”ë¼ íŠ¸ë™ë„ ì¶”ê°€
                  if (cameraTrackForPip) {
                    const cameraStream = new MediaStream([cameraTrackForPip]);
                    _pc.addTrack(cameraTrackForPip, cameraStream);
                  }
                  
                  log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  ë° ì¹´ë©”ë¼ íŠ¸ë™ ì¬ì‹œë„ ì™„ë£Œ`);
                } catch(e2) {
                  console.error(`[êµìˆ˜] í™”ë©´ê³µìœ  íŠ¸ë™ ì¬ì‹œë„ ì‹¤íŒ¨ (${vid}):`, e2);
                }
              });
            } else {
              // íŠ¸ë™ì´ ì—†ìœ¼ë©´ í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
              const screenStream = new MediaStream([screenTrack]);
              _pc.addTrack(screenTrack, screenStream);
              
              // ì¹´ë©”ë¼ íŠ¸ë™ë„ ì¶”ê°€
              if (cameraTrackForPip) {
                const cameraStream = new MediaStream([cameraTrackForPip]);
                _pc.addTrack(cameraTrackForPip, cameraStream);
                log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ ì¹´ë©”ë¼ íŠ¸ë™ë„ ì¶”ê°€ (í™”ë©´ê³µìœ ì™€ í•¨ê»˜)`);
              }
              
              log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ ì™„ë£Œ`);
            }
          } catch(e) {
            console.warn(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨:`, e);
            log(`[êµìˆ˜] í•™ìƒ ${vid}ì—ê²Œ íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨: ` + e.message);
          }
        });
      }
    } else if (oldVideoTrack) {
      // ê²ŒìŠ¤íŠ¸ì¸ ê²½ìš°
      oldVideoTrack.stop();
      localStream.removeTrack(oldVideoTrack);
      localStream.addTrack(screenTrack);
      
      if (pc) {
        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender && screenTrack) {
          try {
            await sender.replaceTrack(screenTrack);
          } catch(e) {
            console.warn('í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì‹¤íŒ¨:', e);
          }
        }
      }
    } else {
      // ê¸°ì¡´ íŠ¸ë™ì´ ì—†ëŠ” ê²½ìš° (ë°©ì†¡ ëª¨ë“œì—ì„œ í™”ë©´ê³µìœ  íŠ¸ë™ë§Œ ì¶”ê°€)
      localStream.addTrack(screenTrack);
    }
    
    // í”„ë¦¬ë·° ê°±ì‹ 
    if (showLocalPreview) {
      localPreview.srcObject = localStream;
      await forcePlay(localPreview);
    }
    
    // ë°©ì†¡ ëª¨ë“œ: sourceMode ì—…ë°ì´íŠ¸ ë° UI ê°±ì‹ 
    if (comm === 'broadcast' && role === 'host') {
      sourceMode = 'screen';
      // ë¼ë””ì˜¤ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      const screenRadio = document.querySelector('input[name="source"][value="screen"]');
      if (screenRadio) screenRadio.checked = true;
      // UI ê°±ì‹ 
      refreshUIByMode();
    }
    
    shareScreenBtn.textContent = 'ğŸ–¥ï¸ í™”ë©´ê³µìœ  OFF';
    shareScreenBtn.style.background = 'linear-gradient(180deg,#c24,#932)';
    toast('í™”ë©´ê³µìœ ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
    log('[Screen] í™”ë©´ê³µìœ  ì‹œì‘');
  } catch(e) {
    log('[Screen] í™”ë©´ê³µìœ  ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('í™”ë©´ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    console.error('Screen share error:', e);
  }
}

// í™”ë©´ê³µìœ  ì¢…ë£Œ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
async function stopScreenShare(){
  if (!isScreenSharing || !localStream) return;
  
  // ì¬ê·€ í˜¸ì¶œ ë°©ì§€
  isScreenSharing = false;
  
  try {
    // í™”ë©´ê³µìœ  íŠ¸ë™ ì œê±° (label ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ í™•ì¸)
    const screenTrack = localStream.getVideoTracks().find(t => {
      const label = (t.label || '').toLowerCase();
      return label.includes('screen') || label.includes('í™”ë©´') ||
             label.includes('display') || label.includes('monitor') ||
             label.includes('window') || label.includes('desktop');
    });
    if (screenTrack) {
      // onended í•¸ë“¤ëŸ¬ ì œê±° (ì¬ê·€ í˜¸ì¶œ ë°©ì§€)
      screenTrack.onended = null;
      screenTrack.stop();
      localStream.removeTrack(screenTrack);
    }
    
    // í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
    if (screenShareStream) {
      screenShareStream.getTracks().forEach(t => {
        t.onended = null; // í•¸ë“¤ëŸ¬ ì œê±°
        t.stop();
      });
      screenShareStream = null;
    }
    
    // êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ë‹«ê¸°
    closeHostCameraWindow();
    
    // PiP ì •ë¦¬
    if (hostCameraStream) {
      hostCameraStream.getTracks().forEach(t => t.stop());
      hostCameraStream = null;
    }
    
    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“
    try {
      const cameraStream = await getCameraStream();
      const cameraTrack = cameraStream.getVideoTracks()[0];
      
      if (cameraTrack) {
        localStream.addTrack(cameraTrack);
        
        // ëª¨ë“  ì—°ê²°ì— ì¹´ë©”ë¼ íŠ¸ë™ êµì²´
        if (role === 'host' && comm === 'meeting') {
          peerConnections.forEach((_pc, vid) => {
            const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender && cameraTrack) {
              sender.replaceTrack(cameraTrack).catch(e => {
                console.warn(`[êµìˆ˜] ì¹´ë©”ë¼ íŠ¸ë™ êµì²´ ì‹¤íŒ¨ (${vid}):`, e);
              });
            }
          });
        } else if (pc) {
          const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
          if (sender && cameraTrack) {
            try {
              await sender.replaceTrack(cameraTrack);
            } catch(e) {
              console.warn('ì¹´ë©”ë¼ íŠ¸ë™ êµì²´ ì‹¤íŒ¨:', e);
            }
          }
        }
        
        // í”„ë¦¬ë·° ê°±ì‹ 
        if (showLocalPreview) {
          localPreview.srcObject = localStream;
          await forcePlay(localPreview);
        }
        
        shareScreenBtn.textContent = 'ğŸ–¥ï¸ í™”ë©´ê³µìœ  ON';
        shareScreenBtn.style.background = '';
        toast('ì¹´ë©”ë¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
        log('[Screen] í™”ë©´ê³µìœ  ì¢…ë£Œ, ì¹´ë©”ë¼ë¡œ ë³µê·€');
      } else {
        throw new Error('ì¹´ë©”ë¼ íŠ¸ë™ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    } catch(e) {
      log('[Screen] ì¹´ë©”ë¼ë¡œ ì „í™˜ ì‹¤íŒ¨: ' + e.message);
      toast('ì¹´ë©”ë¼ë¡œ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
      console.error('Camera switch error:', e);
      // UIëŠ” ë³µêµ¬
      shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
      shareScreenBtn.style.background = '';
    }
  } catch(e) {
    log('[Screen] í™”ë©´ê³µìœ  ì¢…ë£Œ ì‹¤íŒ¨: ' + e.message);
    toast('ì¹´ë©”ë¼ë¡œ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    console.error('Stop screen share error:', e);
  }
}


/* ---------------- Signaling: Host / Guest ---------------- */
function addPending(vid, data){
  // ì´ë¯¸ pending ëª©ë¡ì— ìˆê±°ë‚˜ ì´ë¯¸ ì—°ê²°ëœ ê²ŒìŠ¤íŠ¸ëŠ” ë¬´ì‹œ
  if (document.getElementById(`pending-${vid}`)) {
    log(`[êµìˆ˜] ${vid}ëŠ” ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤`);
    return;
  }
  if (peerConnections.has(vid)) {
    log(`[êµìˆ˜] ${vid}ëŠ” ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤`);
    return;
  }
  // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (offer ë°ì´í„°ì—ì„œ)
  const pendingStudentName = (data && data.studentName) ? data.studentName : '';
  // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì—ì„œëŠ” "í•™ìƒ" ë¼ë²¨ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ì˜†ì— í•™ìƒì´ ì…ë ¥í•œ ì´ë¦„ì„ í‘œì‹œ
  const nameSuffix = pendingStudentName ? ` (${pendingStudentName})` : '';
  
  const li = document.createElement('li');
  li.id = `pending-${vid}`;
  li.innerHTML = `
    <div>
      <div><b>í•™ìƒ</b>${nameSuffix} <span class="tag">${vid.substring(0,6)}</span></div>
      <div class="muted" style="font-size:12px">ì˜¤í¼ ìˆ˜ì‹ </div>
    </div>
    <div class="row">
      <button class="primary">í—ˆìš©</button>
      <button class="danger">ê±°ì ˆ</button>
    </div>
  `;
  const [allowBtn, denyBtn] = li.querySelectorAll('button');
  allowBtn.onclick = () => acceptGuest(vid, data, li);
  denyBtn.onclick  = () => denyGuest(vid, li);
  pendingEl.appendChild(li);
  // ìƒˆ ìŠ¹ì¸ ìš”ì²­ì´ ì˜¤ë©´ ëª¨ë‹¬ ìë™ í‘œì‹œ
  showPendingModal();
}
function denyGuest(vid, li){
  // Firebase ë°ì´í„° ì •ë¦¬
  db.ref(`rooms/${roomId}/offers/${vid}`).remove().catch(() => {});
  db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(() => {});
  db.ref(`rooms/${roomId}/answers/${vid}`).remove().catch(() => {});
  
  // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
  if (firebaseListeners.candidates[vid]) {
    try {
      firebaseListeners.candidates[vid].off();
    } catch(e) {}
    delete firebaseListeners.candidates[vid];
  }
  
  // ì—°ê²°ì´ ì´ë¯¸ ë˜ì–´ìˆë‹¤ë©´ ì •ë¦¬
  const _pc = peerConnections.get(vid);
  if (_pc) {
    try {
      _pc.getSenders().forEach(s => {
        if (s.track) s.track.stop();
      });
      _pc.close();
    } catch(e) {}
    peerConnections.delete(vid);
  }
  removeRemoteVideoElement(vid);
  if (li && li.parentNode) {
    li.remove();
  }
  // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
  if (pendingEl && pendingEl.children.length === 0) {
    hidePendingModal();
  }
}

async function startHost(){
  try {
    roomId = (roomIdInput ? roomIdInput.value||'' : '').replace(/\s+/g,''); if(!roomId){ roomId=generateRoomId(); if(roomIdInput) roomIdInput.value=roomId; }
    
    // ë°©ì´ ì‹œì‘ë  ë•Œ ê¸°ì¡´ ë°ì´í„° ëª¨ë‘ ì´ˆê¸°í™” (ê³¼ê±°ì— ì‚¬ìš©ëœ ë°© ì½”ë“œë¼ë„ ìƒˆë¡œ ì‹œì‘)
    try {
      await db.ref(`rooms/${roomId}`).remove();
      log('[êµìˆ˜] ê¸°ì¡´ ë°© ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
    } catch(e) {
      console.warn('[êµìˆ˜] ë°© ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
      // ì´ˆê¸°í™” ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }
    
    // ì‹œì‘ ì‹œ ë‚´ í™”ë©´(ë¯¸ë¦¬ë³´ê¸°) í‘œì‹œ
    showLocalPreview = true;
    if (localPreviewWrapper) {
      localPreviewWrapper.style.display = 'block';
    }
    if (togglePreviewBtn) {
      togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
    }
    
    myUserId = 'host-' + randomId(6);
    localStream = await buildLocalStreamForCurrentMode();
    
    if (!localStream && role==='host') {
      throw new Error('ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // êµìˆ˜ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ìŒì†Œê±°í•˜ì§€ ì•ŠìŒ)
    if (localStream && localPreview) {
      localPreview.srcObject = localStream;
      try {
        localPreview.setAttribute('playsinline', '');
        localPreview.setAttribute('webkit-playsinline', '');
        await localPreview.play();
      } catch(e) {
        console.warn('ë¯¸ë¦¬ë³´ê¸° ì¬ìƒ ì‹¤íŒ¨:', e);
      }
    }
    
    // êµìˆ˜(í˜¸ìŠ¤íŠ¸)ì˜ ë§ˆì´í¬ëŠ” í•­ìƒ ì¼œì ¸ ìˆì–´ì•¼ í•¨
    if (localStream) {
      const hostAudioTrack = localStream.getAudioTracks()[0];
      if (hostAudioTrack) {
        hostAudioTrack.enabled = true; // í•­ìƒ í™œì„±í™”
        log('[êµìˆ˜] êµìˆ˜ ë§ˆì´í¬ í•­ìƒ í™œì„±í™” ìƒíƒœ ìœ ì§€');
      }
    }
    
    const vTrack = localStream?.getVideoTracks?.()[0];
    if (vTrack) {
      vTrack.onended = () => {
        log('[êµìˆ˜] video track ended (ì°½ ë‹«í˜/ìµœì†Œí™” ë“±). ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
        toast('ê³µìœ  í™”ë©´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. [ì‹œì‘]ìœ¼ë¡œ ë‹¤ì‹œ ê³µìœ í•˜ì„¸ìš”.');
        // í•„ìš”í•˜ë©´ ìë™ ì¬ì‹œì‘:
        // startBtn.click();
      };
    }

    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì„¤ì • (ë³„ë„ ì°½ ì—´ê¸° ë²„íŠ¼ìš©)
    if (localStream) {
      const cameraTrack = localStream.getVideoTracks()[0];
      if (cameraTrack) {
        hostCameraStream = new MediaStream([cameraTrack]);
        log('[êµìˆ˜] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼: hostCameraStream ì„¤ì •ë¨');
        console.log('[êµìˆ˜] hostCameraStream ì„¤ì • ì™„ë£Œ', hostCameraStream);
      }
    }
    
    // ë¯¸ë¦¬ë³´ê¸° UIëŠ” ì‹œì‘ ì‹œ í‘œì‹œë¨ (showLocalPreview = true)
    // ì‚¬ìš©ìê°€ "ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ë¨

    // ê²ŒìŠ¤íŠ¸ ì˜¤í¼ ëŒ€ê¸°
    const offersRef = db.ref(`rooms/${roomId}/offers`);
    firebaseListeners.offers = offersRef;
    offersRef.on('child_added', async snap=>{
      const vid = snap.key; const data = snap.val();
      if(!data || !data.sdp) return;
      
      // ì´ë¯¸ ë‹µë³€ì´ ìˆëŠ” ê²ŒìŠ¤íŠ¸(ì´ë¯¸ ìŠ¹ì¸ëœ ê²ŒìŠ¤íŠ¸)ëŠ” pending ëª©ë¡ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      const answerRef = db.ref(`rooms/${roomId}/answers/${vid}`);
      answerRef.once('value', (answerSnap) => {
        try {
          if (answerSnap.exists()) {
            log(`[Host] ${vid}ëŠ” ì´ë¯¸ ìŠ¹ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
            return;
          }
          // ë‹µë³€ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ pending ëª©ë¡ì— ì¶”ê°€
          addPending(vid, data);
          log('[Host] offer arrived from: ' + vid);
        } catch(e) {
          console.error('[Host] answerRef.once error:', e);
          // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ pending ëª©ë¡ì— ì¶”ê°€ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
          addPending(vid, data);
        }
      }).catch((e) => {
        console.error('[Host] answerRef.once failed:', e);
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ pending ëª©ë¡ì— ì¶”ê°€ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
        addPending(vid, data);
      });
    });

    startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
    
    // êµìˆ˜ì˜ ë§ˆì´í¬ê°€ í•­ìƒ ì¼œì ¸ ìˆë„ë¡ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸
    let ensureHostMicEnabled = null;
    if (localStream) {
      ensureHostMicEnabled = setInterval(() => {
        if (localStream && isRunning) {
          const hostAudioTrack = localStream.getAudioTracks()[0];
          if (hostAudioTrack && !hostAudioTrack.enabled) {
            hostAudioTrack.enabled = true;
            console.log('[Host] êµìˆ˜ ë§ˆì´í¬ê°€ êº¼ì ¸ ìˆì–´ì„œ ë‹¤ì‹œ ì¼°ìŠµë‹ˆë‹¤');
          }
        } else if (!isRunning) {
          if (ensureHostMicEnabled) clearInterval(ensureHostMicEnabled);
        }
      }, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸
    }
    
    // í˜¸ìŠ¤íŠ¸ê°€ ë°©ì„ ë§Œë“  í›„ ì—­í• ì„ ê²ŒìŠ¤íŠ¸ë¡œ ë³€ê²½
    role = 'guest';
    const guestInput = document.querySelector('input[name="role"][value="guest"]');
    if (guestInput) {
      guestInput.checked = true;
    }
    
    // ì‹œì‘ í›„ UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í‘œì‹œ ë“±)
    refreshUIByMode();
    
    // hostCameraStreamì´ ì„¤ì •ëœ í›„ ë²„íŠ¼ ë‹¤ì‹œ ì—…ë°ì´íŠ¸ (ì¹´ë©”ë¼ ëª¨ë“œ)
    if (comm === 'broadcast' && sourceMode === 'camera') {
      setTimeout(() => {
        console.log('[Host] UI ì—…ë°ì´íŠ¸ ì¬ì‹œë„', { isRunning, comm, sourceMode, hostCameraStream, localStream });
        refreshUIByMode();
      }, 200);
    }
    
    logStatus(`í˜¸ìŠ¤íŠ¸ ëŒ€ê¸°/ì†¡ì¶œ ì¤‘â€¦ ë°© ì½”ë“œ: ${roomId} Â· ëª¨ë“œ: ${comm}`);
    toast('í•™ìƒì—ê²Œ ë°© ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”');
    
    // ì±„íŒ… ì´ˆê¸°í™”
    chatMessages.innerHTML = '';
    initChat();
  } catch(e) {
    log('[Host] ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('êµìˆ˜ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    isRunning = false;
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    throw e;
  }
}

// ì›ê²© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
function createRemoteVideoElement(vid, label=''){
  const wrapper = document.createElement('div');
  wrapper.className = 'remote-video-wrapper';
  wrapper.id = `remote-video-${vid}`;
  
  const labelEl = document.createElement('small');
  labelEl.className = 'muted';
  labelEl.textContent = label || `ì°¸ê°€ì ${vid.substring(0,6)}`;
  
  const video = document.createElement('video');
  video.id = `video-${vid}`;
  video.autoplay = true;
  video.playsInline = true;
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.controls = true;
  
  // ì „ì²´í™”ë©´ ë²„íŠ¼ ì¶”ê°€
  const fullscreenBtn = document.createElement('button');
  fullscreenBtn.className = 'video-fullscreen-btn';
  fullscreenBtn.textContent = 'â›¶ ì „ì²´í™”ë©´';
  fullscreenBtn.onclick = () => {
    try {
      if (!video.srcObject) {
        toast('ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      fsVideo.srcObject = video.srcObject;
      fullscreenVideo.classList.add('show');
      
      // ì‹œì²­ìì¼ ë•Œë§Œ ì „ì²´í™”ë©´ ì§ˆë¬¸ ë²„íŠ¼ í‘œì‹œ (êµìˆ˜ê°€ ë°©ì„ ë§Œë“  í›„ì—ë„ ì‹¤ì œë¡œëŠ” êµìˆ˜ì´ë¯€ë¡œ peerConnections í™•ì¸)
      if (fullscreenQuestionBtn) {
        const isActuallyGuest = role === 'guest' && isRunning && !(isRunning && peerConnections.size > 0);
        fullscreenQuestionBtn.style.display = isActuallyGuest ? 'block' : 'none';
      }
      
      fsVideo.play().catch(e => {
        console.warn('Fullscreen video play failed:', e);
      });
      
    } catch(e) {
      console.error('Fullscreen error:', e);
      toast('ì „ì²´í™”ë©´ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  };
  
  wrapper.appendChild(labelEl);
  wrapper.appendChild(video);
  wrapper.appendChild(fullscreenBtn);
  
  // ì‹œì²­ì(ê²ŒìŠ¤íŠ¸) ì „ìš© ì§ˆë¬¸ ë²„íŠ¼ ì¶”ê°€ (êµìˆ˜ê°€ ë°©ì„ ë§Œë“  í›„ì—ë„ ì‹¤ì œë¡œëŠ” êµìˆ˜ì´ë¯€ë¡œ peerConnections í™•ì¸)
  const isActuallyGuest = role === 'guest' && !(isRunning && peerConnections.size > 0);
  if (isActuallyGuest) {
    const questionBtn = document.createElement('button');
    questionBtn.className = 'video-question-btn';
    questionBtn.textContent = 'â“ ì§ˆë¬¸í•˜ê¸°';
    questionBtn.onclick = () => {
      sendQuestionNotification();
    };
    wrapper.appendChild(questionBtn);
  }
  
  // êµìˆ˜ ì „ìš© ë²„íŠ¼ ì¶”ê°€ (êµìˆ˜ê°€ ë°©ì„ ë§Œë“  í›„ì—ë„ ì‹¤ì œë¡œëŠ” êµìˆ˜ì´ë¯€ë¡œ isRunning ìƒíƒœ í™•ì¸)
  const isActuallyHost = isRunning && peerConnections.size > 0;
  if (role === 'host' || isActuallyHost) {
    // ì§ˆë¬¸ ìš”ì²­ í‘œì‹œê¸° (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
    const questionIndicator = document.createElement('div');
    questionIndicator.className = 'question-request-indicator blink';
    questionIndicator.id = `question-indicator-${vid}`;
    questionIndicator.textContent = 'â“ ì§ˆë¬¸í•˜ê¸°';
    questionIndicator.style.display = 'none';
    wrapper.appendChild(questionIndicator);
    
    // ì§ˆë¬¸ í—ˆë½ ë²„íŠ¼
    const questionAllowBtn = document.createElement('button');
    questionAllowBtn.className = 'video-question-allow-btn';
    questionAllowBtn.textContent = 'âœ… ì§ˆë¬¸ í—ˆë½';
    questionAllowBtn.id = `question-allow-btn-${vid}`;
    questionAllowBtn.onclick = () => {
      allowGuestQuestion(vid);
    };
    wrapper.appendChild(questionAllowBtn);
    
    // ì§ˆë¬¸ ì™„ë£Œ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
    const questionEndBtn = document.createElement('button');
    questionEndBtn.className = 'video-question-end-btn';
    questionEndBtn.textContent = 'âŒ ì§ˆë¬¸ ì™„ë£Œ';
    questionEndBtn.id = `question-end-btn-${vid}`;
    questionEndBtn.style.display = 'none';
    questionEndBtn.onclick = () => {
      endGuestQuestion(vid);
    };
    wrapper.appendChild(questionEndBtn);
    
    // ìŒì†Œê±° í•´ì œ ë²„íŠ¼
    const unmuteBtn = document.createElement('button');
    unmuteBtn.className = 'video-unmute-btn muted';
    unmuteBtn.textContent = 'ğŸ”‡ ìŒì†Œê±°';
    unmuteBtn.id = `unmute-btn-${vid}`;
    unmuteBtn.onclick = () => {
      toggleGuestAudio(vid, unmuteBtn);
    };
    wrapper.appendChild(unmuteBtn);
    
    // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (Firebase ë¦¬ìŠ¤ë„ˆ)
    if (roomId) {
      const questionRequestRef = db.ref(`rooms/${roomId}/questionRequests/${vid}`);
      questionRequestRef.on('value', (snap) => {
        const data = snap.val();
        if (data && data.status === 'pending') {
          // ì§ˆë¬¸ ìš”ì²­ì´ ìˆìœ¼ë©´ í‘œì‹œê¸° í‘œì‹œ
          questionIndicator.style.display = 'block';
        } else {
          // ì§ˆë¬¸ ìš”ì²­ì´ ì—†ìœ¼ë©´ í‘œì‹œê¸° ìˆ¨ê¹€
          questionIndicator.style.display = 'none';
        }
      });
    }
  }
  
  remoteVideosGrid.appendChild(wrapper);
  
  return video;
}

// ì›ê²© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì œê±°
function removeRemoteVideoElement(vid){
  // ì˜¤ë””ì˜¤ íŠ¸ë™ ë§µì—ì„œë„ ì œê±°
  guestAudioTracks.delete(vid);
  
  const wrapper = document.getElementById(`remote-video-${vid}`);
  if (wrapper) {
    const video = wrapper.querySelector('video');
    if (video && video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    wrapper.remove();
  }
  remoteVideos.delete(vid);
}

// ê²ŒìŠ¤íŠ¸ ì˜¤ë””ì˜¤ ìŒì†Œê±°/í•´ì œ í† ê¸€ í•¨ìˆ˜ (í˜¸ìŠ¤íŠ¸ ì „ìš©)
function toggleGuestAudio(guestId, btnElement) {
  const audioTrack = guestAudioTracks.get(guestId);
  if (!audioTrack) {
    toast('ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  if (audioTrack.enabled) {
    // ìŒì†Œê±°
    audioTrack.enabled = false;
    btnElement.textContent = 'ğŸ”‡ ìŒì†Œê±°';
    btnElement.classList.add('muted');
    log(`[Host] ê²ŒìŠ¤íŠ¸ ${guestId.substring(0,6)} ìŒì†Œê±°`);
    toast(`í•™ìƒ ${guestId.substring(0,6)} ìŒì†Œê±°ë¨`);
  } else {
    // ìŒì†Œê±° í•´ì œ
    audioTrack.enabled = true;
    btnElement.textContent = 'ğŸ”Š ìŒì†Œê±° í•´ì œ';
    btnElement.classList.remove('muted');
    log(`[Host] ê²ŒìŠ¤íŠ¸ ${guestId.substring(0,6)} ìŒì†Œê±° í•´ì œ`);
    toast(`í•™ìƒ ${guestId.substring(0,6)} ìŒì†Œê±° í•´ì œë¨`);
  }
}

// ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ í—ˆë½ í•¨ìˆ˜ (í˜¸ìŠ¤íŠ¸ ì „ìš©)
async function allowGuestQuestion(guestId) {
  if (currentQuestionGuestId && currentQuestionGuestId !== guestId) {
    // ë‹¤ë¥¸ ê²ŒìŠ¤íŠ¸ê°€ ì´ë¯¸ ì§ˆë¬¸ ì¤‘ì´ë©´ ë¨¼ì € ì¢…ë£Œ
    await endGuestQuestion(currentQuestionGuestId);
  }
  
  const guestVideo = remoteVideos.get(guestId);
  if (!guestVideo || !guestVideo.srcObject) {
    toast('ê²ŒìŠ¤íŠ¸ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  try {
    // ê²ŒìŠ¤íŠ¸ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì—ì„œ ì¹´ë©”ë¼ íŠ¸ë™ ì¶”ì¶œ
    const videoTracks = guestVideo.srcObject.getVideoTracks();
    if (videoTracks.length === 0) {
      toast('ê²ŒìŠ¤íŠ¸ ë¹„ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    // ê²ŒìŠ¤íŠ¸ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìƒì„±
    const guestCameraStream = new MediaStream([videoTracks[0]]);
    
    // ê²ŒìŠ¤íŠ¸ PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    if (!guestQuestionPiPVideo) {
      guestQuestionPiPVideo = document.createElement('video');
      guestQuestionPiPVideo.style.position = 'fixed';
      guestQuestionPiPVideo.style.top = '-9999px';
      guestQuestionPiPVideo.style.width = '1px';
      guestQuestionPiPVideo.style.height = '1px';
      guestQuestionPiPVideo.autoplay = true;
      guestQuestionPiPVideo.muted = false; // ì˜¤ë””ì˜¤ë„ ì¬ìƒ
      guestQuestionPiPVideo.playsInline = true;
      document.body.appendChild(guestQuestionPiPVideo);
    }
    
    // ìŠ¤íŠ¸ë¦¼ ì„¤ì •
    guestQuestionPiPVideo.srcObject = guestVideo.srcObject;
    await guestQuestionPiPVideo.play();
    
    // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiPê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const hostPiPActive = document.pictureInPictureElement === hostCameraPiPVideo;
    
    // í˜¸ìŠ¤íŠ¸ PiPê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¢…ë£Œí•˜ê³  ìƒíƒœ ì €ì¥ (ê²ŒìŠ¤íŠ¸ PiPë¡œ ëŒ€ì²´)
    if (hostPiPActive) {
      hostPiPWasActiveBeforeQuestion = true;
      try {
        await document.exitPictureInPicture();
        log('[Host] í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiP ì¢…ë£Œ (ê²ŒìŠ¤íŠ¸ PiPë¡œ ëŒ€ì²´)');
      } catch(e) {
        console.warn('í˜¸ìŠ¤íŠ¸ PiP ì¢…ë£Œ ì‹¤íŒ¨:', e);
      }
    } else {
      hostPiPWasActiveBeforeQuestion = false;
    }
    
    // ê²ŒìŠ¤íŠ¸ PiP ì‹œì‘ (í˜¸ìŠ¤íŠ¸ PiPë¥¼ ëŒ€ì²´)
    if (!document.pictureInPictureElement || document.pictureInPictureElement !== guestQuestionPiPVideo) {
      await guestQuestionPiPVideo.requestPictureInPicture();
      log(`[Host] ê²ŒìŠ¤íŠ¸ ${guestId.substring(0,6)} ì§ˆë¬¸ í—ˆë½ - PiP ì‹œì‘ (í˜¸ìŠ¤íŠ¸ PiP ëŒ€ì²´)`);
    }
    
    // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ì œê±°
    try {
      await db.ref(`rooms/${roomId}/questionRequests/${guestId}`).remove();
    } catch(e) {
      console.warn('ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ì œê±° ì‹¤íŒ¨:', e);
    }
    
    // ê²ŒìŠ¤íŠ¸ ì˜¤ë””ì˜¤ ìë™ í™œì„±í™”
    const audioTrack = guestAudioTracks.get(guestId);
    if (audioTrack) {
      audioTrack.enabled = true;
      log(`[Host] ê²ŒìŠ¤íŠ¸ ${guestId.substring(0,6)} ì˜¤ë””ì˜¤ ìë™ í™œì„±í™”`);
    }
    
    // ìŒì†Œê±° í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const unmuteBtn = document.getElementById(`unmute-btn-${guestId}`);
    if (unmuteBtn) {
      unmuteBtn.textContent = 'ğŸ”Š ìŒì†Œê±° í•´ì œ';
      unmuteBtn.classList.remove('muted');
    }
    
    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    const allowBtn = document.getElementById(`question-allow-btn-${guestId}`);
    const endBtn = document.getElementById(`question-end-btn-${guestId}`);
    if (allowBtn) allowBtn.style.display = 'none';
    if (endBtn) endBtn.style.display = 'block';
    
    currentQuestionGuestId = guestId;
    toast(`í•™ìƒ ${guestId.substring(0,6)}ì—ê²Œ ì§ˆë¬¸ í—ˆë½ë¨`);
    
  } catch(e) {
    console.error('ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ í—ˆë½ ì‹¤íŒ¨:', e);
    log('[Host] ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ í—ˆë½ ì‹¤íŒ¨: ' + e.message);
    toast('í•™ìƒ ì§ˆë¬¸ í—ˆë½ ì‹¤íŒ¨: ' + e.message);
  }
}

// ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ ì™„ë£Œ í•¨ìˆ˜ (í˜¸ìŠ¤íŠ¸ ì „ìš©)
async function endGuestQuestion(guestId) {
  if (currentQuestionGuestId !== guestId) {
    return; // í˜„ì¬ ì§ˆë¬¸ ì¤‘ì¸ ê²ŒìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
  }
  
  try {
    // ê²ŒìŠ¤íŠ¸ PiP ì¢…ë£Œ
    if (guestQuestionPiPVideo && document.pictureInPictureElement === guestQuestionPiPVideo) {
      await document.exitPictureInPicture();
      log(`[Host] ê²ŒìŠ¤íŠ¸ ${guestId.substring(0,6)} ì§ˆë¬¸ ì™„ë£Œ - PiP ì¢…ë£Œ`);
    }
    
    // ê²ŒìŠ¤íŠ¸ PiP ë¹„ë””ì˜¤ ì •ë¦¬
    if (guestQuestionPiPVideo) {
      guestQuestionPiPVideo.srcObject = null;
    }
    
    // ê²ŒìŠ¤íŠ¸ ì˜¤ë””ì˜¤ ë‹¤ì‹œ ìŒì†Œê±°
    const audioTrack = guestAudioTracks.get(guestId);
    if (audioTrack) {
      audioTrack.enabled = false;
      log(`[Host] ê²ŒìŠ¤íŠ¸ ${guestId.substring(0,6)} ì˜¤ë””ì˜¤ ìŒì†Œê±° ë³µê·€`);
    }
    
    // ìŒì†Œê±° í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const unmuteBtn = document.getElementById(`unmute-btn-${guestId}`);
    if (unmuteBtn) {
      unmuteBtn.textContent = 'ğŸ”‡ ìŒì†Œê±°';
      unmuteBtn.classList.add('muted');
    }
    
    // ë²„íŠ¼ ìƒíƒœ ë³µê·€
    const allowBtn = document.getElementById(`question-allow-btn-${guestId}`);
    const endBtn = document.getElementById(`question-end-btn-${guestId}`);
    if (allowBtn) allowBtn.style.display = 'block';
    if (endBtn) endBtn.style.display = 'none';
    
    // ì§ˆë¬¸ ì‹œì‘ ì „ì— í˜¸ìŠ¤íŠ¸ PiPê°€ í™œì„±í™”ë˜ì–´ ìˆì—ˆìœ¼ë©´ ë‹¤ì‹œ ì‹œì‘
    if (hostPiPWasActiveBeforeQuestion && hostCameraPiPVideo && hostCameraPiPVideo.srcObject) {
      try {
        // ì•½ê°„ì˜ ì§€ì—° í›„ í˜¸ìŠ¤íŠ¸ PiP ë‹¤ì‹œ ì‹œì‘
        setTimeout(async () => {
          try {
            await hostCameraPiPVideo.play();
            await hostCameraPiPVideo.requestPictureInPicture();
            log('[Host] í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiP ì¬ì‹œì‘ (ì§ˆë¬¸ ì™„ë£Œ í›„)');
            toast('í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiPê°€ ë‹¤ì‹œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch(e) {
            console.warn('í˜¸ìŠ¤íŠ¸ PiP ì¬ì‹œì‘ ì‹¤íŒ¨:', e);
            toast('í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiP ì¬ì‹œì‘ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”.');
          }
        }, 300);
      } catch(e) {
        console.warn('í˜¸ìŠ¤íŠ¸ PiP ì¬ì‹œì‘ ì¤€ë¹„ ì‹¤íŒ¨:', e);
      }
    }
    
    // ìƒíƒœ ì´ˆê¸°í™”
    hostPiPWasActiveBeforeQuestion = false;
    currentQuestionGuestId = null;
    toast(`í•™ìƒ ${guestId.substring(0,6)} ì§ˆë¬¸ ì™„ë£Œ`);
    
  } catch(e) {
    console.error('ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ ì™„ë£Œ ì‹¤íŒ¨:', e);
    log('[Host] ê²ŒìŠ¤íŠ¸ ì§ˆë¬¸ ì™„ë£Œ ì‹¤íŒ¨: ' + e.message);
    toast('í•™ìƒ ì§ˆë¬¸ ì™„ë£Œ ì‹¤íŒ¨: ' + e.message);
  }
}

async function acceptGuest(vid, data, li){
  let remoteCandidatesRef = null;
  let myCandidatesRef = null;
  
  try{
    // ì—°ê²° ì¢…ë£Œ í•¸ë“¤ëŸ¬
    const connectionStateHandler = () => {
      if (_pc.connectionState === 'closed' || _pc.connectionState === 'failed' || _pc.connectionState === 'disconnected') {
        log(`[Host] ì—°ê²° ì¢…ë£Œ: ${vid}`);
        removeRemoteVideoElement(vid);
        peerConnections.delete(vid);
        // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        if (remoteCandidatesRef) {
          remoteCandidatesRef.off();
          remoteCandidatesRef = null;
        }
        if (myCandidatesRef) {
          myCandidatesRef.off();
          myCandidatesRef = null;
        }
        if (firebaseListeners.candidates[vid]) {
          delete firebaseListeners.candidates[vid];
        }
      }
      // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
      if (infoEl) infoEl.textContent += ' | PC: ' + _pc.connectionState;
    };

    const _pc = createPeer({ onconnectionstatechange: connectionStateHandler });
    peerConnections.set(vid, _pc);

    // ë‚´ íŠ¸ë™ ì¶”ê°€(ë°©ì†¡: í˜¸ìŠ¤íŠ¸ íŠ¸ë™ë§Œ / ë¯¸íŒ…: í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼)
    if (localStream) {
      const videoTracks = localStream.getVideoTracks();
      const audioTracks = localStream.getAudioTracks();
      
      // ë°©ì†¡ ëª¨ë“œì—ì„œ í™”ë©´ê³µìœ  + ì¹´ë©”ë¼ì¸ ê²½ìš° (ì‹œì‘ ì‹œ ë˜ëŠ” ì‹¤í–‰ ì¤‘ ì¶”ê°€), ê° íŠ¸ë™ì„ ë³„ë„ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì¶”ê°€
      if (comm === 'broadcast' && videoTracks.length >= 2) {
        // íŠ¸ë™ labelë¡œ í™”ë©´ê³µìœ ì™€ ì¹´ë©”ë¼ êµ¬ë¶„
        const track0Label = videoTracks[0].label.toLowerCase();
        const track1Label = videoTracks[1].label.toLowerCase();
        const track0IsScreen = track0Label.includes('screen') || track0Label.includes('í™”ë©´') || 
                               track0Label.includes('display') || track0Label.includes('monitor') ||
                               track0Label.includes('window') || track0Label.includes('desktop');
        const track1IsScreen = track1Label.includes('screen') || track1Label.includes('í™”ë©´') || 
                               track1Label.includes('display') || track1Label.includes('monitor') ||
                               track1Label.includes('window') || track1Label.includes('desktop');
        
        let screenTrack = null;
        let cameraTrack = null;
        
        if (track0IsScreen && !track1IsScreen) {
          screenTrack = videoTracks[0];
          cameraTrack = videoTracks[1];
        } else if (!track0IsScreen && track1IsScreen) {
          cameraTrack = videoTracks[0];
          screenTrack = videoTracks[1];
        } else {
          // labelë¡œ êµ¬ë¶„ì´ ì•ˆ ë˜ëŠ” ê²½ìš°: ì²« ë²ˆì§¸ëŠ” í™”ë©´ê³µìœ , ë‘ ë²ˆì§¸ëŠ” ì¹´ë©”ë¼ë¡œ ê°€ì •
          screenTrack = videoTracks[0];
          cameraTrack = videoTracks[1];
        }
        
        // í™”ë©´ê³µìœ  íŠ¸ë™ (ì˜¤ë””ì˜¤ì™€ í•¨ê»˜)
        const screenStream = new MediaStream([screenTrack]);
        if (audioTracks.length > 0) {
          screenStream.addTrack(audioTracks[0]);
        }
        _pc.addTrack(screenTrack, screenStream);
        
        // ì¹´ë©”ë¼ íŠ¸ë™ (ë³„ë„ ìŠ¤íŠ¸ë¦¼)
        const cameraStream = new MediaStream([cameraTrack]);
        _pc.addTrack(cameraTrack, cameraStream);
        log(`[Host] ê²ŒìŠ¤íŠ¸ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  ë° ì¹´ë©”ë¼ íŠ¸ë™ ì „ì†¡ (ë³„ë„ ìŠ¤íŠ¸ë¦¼)`);
      } else {
        // ì¼ë°˜ì ì¸ ê²½ìš°: ëª¨ë“  íŠ¸ë™ì„ ê°™ì€ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì¶”ê°€
        localStream.getTracks().forEach(t=>_pc.addTrack(t, localStream));
      }
    }
    preferH264(_pc);

    // remote ICE (guest)
    remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/guest`);
    firebaseListeners.candidates[vid] = remoteCandidatesRef;
    remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) _pc.addIceCandidate(new RTCIceCandidate(c)); });

    // my ICE (host)
    myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/host`);
    _pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };

    // ì›ê²© íŠ¸ë™ ìˆ˜ì‹  ì²˜ë¦¬
    _pc.ontrack = (ev)=>{
      const stream = ev.streams[0];
      const track = ev.track;
      
      // ì˜¤ë””ì˜¤ íŠ¸ë™ì¸ ê²½ìš° ì €ì¥ (ìŒì†Œê±° ì œì–´ìš©)
      if (track.kind === 'audio') {
        guestAudioTracks.set(vid, track);
        // ê²ŒìŠ¤íŠ¸ ì…ì¥ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ìŒì†Œê±° ìƒíƒœ
        track.enabled = false;
        log(`[Host] ê²ŒìŠ¤íŠ¸ ${vid.substring(0,6)} ì˜¤ë””ì˜¤ íŠ¸ë™ ìˆ˜ì‹  (ìŒì†Œê±° ìƒíƒœ)`);
      }
      
      if (comm==='broadcast'){
        // ë°©ì†¡ì—ì„œ í˜¸ìŠ¤íŠ¸ëŠ” ê²ŒìŠ¤íŠ¸ ì˜ìƒì„ êµ³ì´ ë³¼ í•„ìš” ì—†ìŒ
      }else{
        // ë¯¸íŒ…: ê° ê²ŒìŠ¤íŠ¸ë§ˆë‹¤ ë³„ë„ ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        let videoEl = remoteVideos.get(vid);
        if (!videoEl) {
          // ìŠ¹ì¸ ì‹œì—ë„ "í•™ìƒ" ë¼ë²¨ì€ ìœ ì§€í•˜ê³ , í•™ìƒì´ ì…ì‹¤í•  ë•Œ ì…ë ¥í•œ ì´ë¦„ì„ í•¨ê»˜ í‘œê¸°
          const guestStudentName = (data && data.studentName) ? data.studentName : '';
          const guestLabel = guestStudentName
            ? `í•™ìƒ (${guestStudentName})`
            : `í•™ìƒ ${vid.substring(0,6)}`;
          videoEl = createRemoteVideoElement(vid, guestLabel);
          remoteVideos.set(vid, videoEl);
        }
        
        // ìŠ¤íŠ¸ë¦¼ì´ ë³€ê²½ë˜ì—ˆê±°ë‚˜ íŠ¸ë™ì´ ì—…ë°ì´íŠ¸ëœ ê²½ìš°
        const currentStream = videoEl.srcObject;
        const needsUpdate = !currentStream || currentStream !== stream;
        
        if (needsUpdate) {
          videoEl.srcObject = stream;
        } else if (track.kind === 'video') {
          // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ì´ì§€ë§Œ íŠ¸ë™ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆì„ ìˆ˜ ìˆìŒ
          const existingTracks = currentStream.getVideoTracks();
          const hasThisTrack = existingTracks.some(t => t.id === track.id);
          if (!hasThisTrack) {
            // ìƒˆ íŠ¸ë™ì´ ìŠ¤íŠ¸ë¦¼ì— ì—†ìœ¼ë©´ ì¶”ê°€
            currentStream.addTrack(track);
            // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ê°•ì œ ì—…ë°ì´íŠ¸
            videoEl.srcObject = null;
            videoEl.srcObject = currentStream;
          }
        }
        
        // ë¹„ë””ì˜¤ ì¬ìƒ (í•­ìƒ ì¬ìƒ ìƒíƒœ ìœ ì§€)
        (async ()=>{ 
          try{ 
            videoEl.setAttribute('playsinline',''); 
            videoEl.setAttribute('webkit-playsinline',''); 
            videoEl.muted = false;
            if (videoEl.paused || needsUpdate) {
              await videoEl.play();
            }
          }catch(e){
            console.warn(`[êµìˆ˜] í•™ìƒ ${vid.substring(0,6)} ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:`, e);
            // ì¬ì‹œë„
            setTimeout(async () => {
              try {
                if (videoEl && !videoEl.paused) return;
                await videoEl.play();
              } catch(e2) {
                console.warn(`[êµìˆ˜] í•™ìƒ ${vid.substring(0,6)} ë¹„ë””ì˜¤ ì¬ìƒ ì¬ì‹œë„ ì‹¤íŒ¨:`, e2);
              }
            }, 500);
          }
        })();
      }
    };

    // SDP ì²˜ë¦¬
    await _pc.setRemoteDescription(new RTCSessionDescription({ type:'offer', sdp:data.sdp }));
    const answer = await _pc.createAnswer();
    await _pc.setLocalDescription(answer);
    await db.ref(`rooms/${roomId}/answers/${vid}`).set({ sdp: answer.sdp, ts: Date.now() });

    // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ì—ì„œ ì œê±°
    if (li && li.parentNode) {
      li.remove();
    }
    // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
    if (pendingEl && pendingEl.children.length === 0) {
      hidePendingModal();
    }
    log('[Host] answered to ' + vid);
  }catch(e){ 
    log('[Host] ê²ŒìŠ¤íŠ¸ ìŠ¹ì¸ ì‹¤íŒ¨: ' + e.message);
    toast('ì—°ê²° ì‹¤íŒ¨: ' + e.message);
    
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    if (remoteCandidatesRef) {
      try {
        remoteCandidatesRef.off();
      } catch(e2) {}
      remoteCandidatesRef = null;
    }
    if (myCandidatesRef) {
      try {
        myCandidatesRef.off();
      } catch(e2) {}
      myCandidatesRef = null;
    }
    if (firebaseListeners.candidates[vid]) {
      delete firebaseListeners.candidates[vid];
    }
    
    const _pc = peerConnections.get(vid);
    if (_pc) {
      try {
        _pc.getSenders().forEach(s => {
          if (s.track) s.track.stop();
        });
        _pc.close();
      } catch(e2) {}
      peerConnections.delete(vid);
    }
    removeRemoteVideoElement(vid);
    
    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ pending ëª©ë¡ì—ì„œ ì œê±°
    if (li && li.parentNode) {
      li.remove();
    }
    
    // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
    if (pendingEl && pendingEl.children.length === 0) {
      hidePendingModal();
    }
    
    // Firebase ë°ì´í„° ì •ë¦¬
    db.ref(`rooms/${roomId}/answers/${vid}`).remove().catch(() => {});
    db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(() => {});
  }
}

async function startGuest(){
  try {
    roomId = (roomIdInput ? roomIdInput.value||'' : '').replace(/\s+/g,''); if(!roomId){ roomId=generateRoomId(); if(roomIdInput) roomIdInput.value=roomId; }
    viewerId = randomId(8);
    myUserId = viewerId;
    
    // í•™ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    if (studentNameInput && studentNameInput.value.trim()) {
      studentName = studentNameInput.value.trim();
      log(`[Guest] í•™ìƒ ì´ë¦„: ${studentName}`);
    } else {
      studentName = ''; // ì´ë¦„ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
    }
    
    pc = createPeer();

    // íŠ¸ëœì‹œë²„/ë¡œì»¬ íŠ¸ë™ êµ¬ì„±
    if (comm==='broadcast'){
      // ìˆ˜ì‹  ì „ìš© (í™”ë©´ê³µìœ  + ì¹´ë©”ë¼ ë‘ ê°œì˜ ë¹„ë””ì˜¤ íŠ¸ë™ì„ ë°›ê¸° ìœ„í•´ ë‘ ê°œì˜ íŠ¸ëœì‹œë²„ ìƒì„±)
      pc.addTransceiver('video', { direction:'recvonly' });
      pc.addTransceiver('video', { direction:'recvonly' });
      pc.addTransceiver('audio', { direction:'recvonly' });
    }else{
      // ë¯¸íŒ…: ë¡œì»¬ ì¹´ë©”ë¼ ìº¡ì²˜ í›„ ì „ì†¡
      localStream = await getCameraStream();
      if (!localStream) {
        throw new Error('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
      // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ)
      showLocalPreview = true;
      if (localPreviewWrapper) {
        localPreviewWrapper.style.display = 'block';
      }
      if (localStream) {
        localPreview.srcObject = localStream;
        try{ localPreview.setAttribute('playsinline',''); localPreview.setAttribute('webkit-playsinline',''); await localPreview.play(); }catch(e){}
      }
      // ê²ŒìŠ¤íŠ¸ ì…ì¥ ì‹œ ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ìŒì†Œê±° ìƒíƒœë¡œ ì„¤ì •
      localStream.getTracks().forEach(t => {
        if (t.kind === 'audio') {
          t.enabled = false; // ì˜¤ë””ì˜¤ íŠ¸ë™ ë¹„í™œì„±í™” (ìŒì†Œê±°)
          log('[Guest] ì˜¤ë””ì˜¤ íŠ¸ë™ ìŒì†Œê±° ìƒíƒœë¡œ ì…ì¥');
        }
        pc.addTrack(t, localStream);
      });
    }

  // ë°©ì†¡ ëª¨ë“œì—ì„œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì  ì´ˆê¸°í™”
  broadcastVideoTracks = [];
  broadcastScreenTrack = null;
  broadcastCameraTrack = null;
  
  // ë¯¸íŒ… ëª¨ë“œì—ì„œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì  ì´ˆê¸°í™”
  meetingScreenTrack = null;
  meetingCameraTrack = null;
  
  pc.ontrack = (ev)=>{
    const stream = ev.streams[0];
    const track = ev.track;
    
    // ë””ë²„ê¹…: ëª¨ë“  íŠ¸ë™ ìˆ˜ì‹  ë¡œê·¸
    log(`[Guest] íŠ¸ë™ ìˆ˜ì‹ : kind=${track.kind}, label=${track.label}, id=${track.id}`);
    console.log('[Guest] Track received:', { kind: track.kind, label: track.label, id: track.id, enabled: track.enabled });
    
    if (comm==='broadcast'){
      // ë°©ì†¡ ëª¨ë“œ: playerê°€ í‘œì‹œë˜ì–´ì•¼ í•¨
      player.classList.remove('hidden');
      meetingVideos.classList.add('hidden');
      
      // ë¹„ë””ì˜¤ íŠ¸ë™ì¸ ê²½ìš° ì¶”ì 
      if (track.kind === 'video') {
        // íŠ¸ë™ labelë¡œ í™”ë©´ê³µìœ ì™€ ì¹´ë©”ë¼ êµ¬ë¶„
        const trackLabel = track.label.toLowerCase();
        const isScreenTrack = trackLabel.includes('screen') || 
                              trackLabel.includes('í™”ë©´') ||
                              trackLabel.includes('display') ||
                              trackLabel.includes('monitor') ||
                              trackLabel.includes('window') ||
                              trackLabel.includes('desktop');
        
        log(`[Guest] ë¹„ë””ì˜¤ íŠ¸ë™ ë¶„ì„: label="${track.label}", isScreenTrack=${isScreenTrack}, screenTrack=${!!broadcastScreenTrack}, cameraTrack=${!!broadcastCameraTrack}, enabled=${track.enabled}`);
        
        // íŠ¸ë™ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¬´ì‹œ
        if (!track.enabled) {
          log(`[Guest] íŠ¸ë™ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ: ${track.label}`);
          return;
        }
        
        if (isScreenTrack && !broadcastScreenTrack) {
          // í™”ë©´ê³µìœ  íŠ¸ë™ (ë©”ì¸ í”Œë ˆì´ì–´)
          broadcastScreenTrack = track;
          const mainStream = new MediaStream([track]);
          if (player.srcObject !== mainStream) {
            player.srcObject = mainStream;
            (async ()=>{ try{ 
              player.setAttribute('playsinline',''); 
              player.setAttribute('webkit-playsinline',''); 
              await player.play(); 
            }catch(e){} })();
          }
          // ì˜¤ë””ì˜¤ íŠ¸ë™ë„ í•¨ê»˜ ì²˜ë¦¬
          const audioTracks = stream.getAudioTracks();
          if (audioTracks.length > 0) {
            audioMirror.srcObject = stream;
          }
          log('[Guest] í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ë° í‘œì‹œ');
          
          // ì¹´ë©”ë¼ íŠ¸ë™ì´ ì´ë¯¸ ìˆ˜ì‹ ëœ ê²½ìš° PiP í‘œì‹œ
          if (broadcastCameraTrack) {
            log('[Guest] í™”ë©´ê³µìœ  ìˆ˜ì‹  - ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ìœ¼ë¡œ PiP í‘œì‹œ ì‹œì‘');
            const cameraStream = new MediaStream([broadcastCameraTrack]);
            pipVideo.srcObject = cameraStream;
            pipOverlay.classList.add('show');
            log('[Guest] PiP ì˜¤ë²„ë ˆì´ í‘œì‹œë¨');
            
            // ì „ì²´í™”ë©´ PiPë„ ì„¤ì •
            if (fullscreenPipVideo) {
              const fullscreenCameraStream = new MediaStream([broadcastCameraTrack]);
              fullscreenPipVideo.srcObject = fullscreenCameraStream;
              if (fullscreenVideo.classList.contains('show')) {
                fullscreenPipOverlay.classList.add('show');
              }
            }
            
            // PiP ë¹„ë””ì˜¤ ì¬ìƒ
            const playPipVideo = async () => {
              try {
                pipVideo.setAttribute('playsinline', '');
                pipVideo.setAttribute('webkit-playsinline', '');
                pipVideo.muted = true;
                await pipVideo.play();
                log('[Guest] PiP ë¹„ë””ì˜¤ ì¬ìƒ ì„±ê³µ');
                
                if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                  fullscreenPipVideo.setAttribute('playsinline', '');
                  fullscreenPipVideo.setAttribute('webkit-playsinline', '');
                  fullscreenPipVideo.muted = true;
                  await fullscreenPipVideo.play();
                }
                
                log('[Guest] í™”ë©´ê³µìœ  ìˆ˜ì‹  í›„ ì¹´ë©”ë¼ PiP í‘œì‹œ ì™„ë£Œ');
              } catch(e) {
                console.warn('PiP video play failed:', e);
                log('[Guest] PiP ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ' + e.message + ' (ì¬ì‹œë„ ì¤‘...)');
                setTimeout(() => {
                  if (pipVideo.srcObject && broadcastCameraTrack) {
                    pipVideo.play().catch(e2 => {
                      console.warn('PiP video play retry failed:', e2);
                    });
                  }
                  if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                    fullscreenPipVideo.play().catch(e2 => {});
                  }
                }, 500);
              }
            };
            playPipVideo();
          } else {
            log('[Guest] í™”ë©´ê³µìœ  ìˆ˜ì‹  - ì¹´ë©”ë¼ íŠ¸ë™ì´ ì•„ì§ ì—†ìŒ');
          }
        } else if (!isScreenTrack && !broadcastCameraTrack) {
          // ì¹´ë©”ë¼ íŠ¸ë™ (PiP) - í™”ë©´ê³µìœ  íŠ¸ë™ì´ ìˆìœ¼ë©´ PiPë¡œ, ì—†ìœ¼ë©´ ì„ì‹œ ì €ì¥
          broadcastCameraTrack = track;
          log(`[Guest] ì¹´ë©”ë¼ íŠ¸ë™ ìˆ˜ì‹ : label="${track.label}", screenTrack=${!!broadcastScreenTrack}`);
          
          // í™”ë©´ê³µìœ  íŠ¸ë™ì´ ì´ë¯¸ ìˆìœ¼ë©´ PiP í‘œì‹œ, ì—†ìœ¼ë©´ ë‚˜ì¤‘ì— í‘œì‹œ
          if (broadcastScreenTrack) {
            log('[Guest] í™”ë©´ê³µìœ  íŠ¸ë™ì´ ì´ë¯¸ ìˆìŒ, ì¹´ë©”ë¼ PiP í‘œì‹œ ì‹œì‘');
            const cameraStream = new MediaStream([track]);
            
            // ì¼ë°˜ PiP ì„¤ì •
            pipVideo.srcObject = cameraStream;
            pipOverlay.classList.add('show');
            
            // ì „ì²´í™”ë©´ PiPë„ ì„¤ì •
            if (fullscreenPipVideo) {
              // ê°™ì€ íŠ¸ë™ì„ ì‚¬ìš©í•˜ëŠ” ìƒˆ ìŠ¤íŠ¸ë¦¼ ìƒì„±
              const fullscreenCameraStream = new MediaStream([track]);
              fullscreenPipVideo.srcObject = fullscreenCameraStream;
              // ì „ì²´í™”ë©´ì´ ì—´ë ¤ìˆìœ¼ë©´ ì „ì²´í™”ë©´ PiPë„ í‘œì‹œ
              if (fullscreenVideo.classList.contains('show')) {
                fullscreenPipOverlay.classList.add('show');
              }
            }
            
            // PiP ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„ (ì¬ì‹œë„ í¬í•¨)
            const playPipVideo = async () => {
              try {
                pipVideo.setAttribute('playsinline', '');
                pipVideo.setAttribute('webkit-playsinline', '');
                pipVideo.muted = true; // ìë™ì¬ìƒì„ ìœ„í•´ ìŒì†Œê±°
                await pipVideo.play();
                
                // ì „ì²´í™”ë©´ PiPë„ ì¬ìƒ
                if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                  fullscreenPipVideo.setAttribute('playsinline', '');
                  fullscreenPipVideo.setAttribute('webkit-playsinline', '');
                  fullscreenPipVideo.muted = true;
                  await fullscreenPipVideo.play();
                }
                
                log('[Guest] í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiP í‘œì‹œ ë° ì¬ìƒ ì„±ê³µ');
              } catch(e) {
                console.warn('PiP video play failed:', e);
                log('[Guest] PiP ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ' + e.message + ' (ì¬ì‹œë„ ì¤‘...)');
                // ì¬ì‹œë„
                setTimeout(() => {
                  if (pipVideo.srcObject && broadcastCameraTrack) {
                    pipVideo.play().catch(e2 => {
                      console.warn('PiP video play retry failed:', e2);
                    });
                  }
                  if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                    fullscreenPipVideo.play().catch(e2 => {
                      console.warn('Fullscreen PiP video play retry failed:', e2);
                    });
                  }
                }, 500);
              }
            };
            playPipVideo();
          } else {
            // í™”ë©´ê³µìœ  íŠ¸ë™ì´ ì•„ì§ ì—†ìœ¼ë©´ ë‚˜ì¤‘ì— PiP í‘œì‹œí•˜ë„ë¡ ëŒ€ê¸°
            log('[Guest] ì¹´ë©”ë¼ íŠ¸ë™ ìˆ˜ì‹  (í™”ë©´ê³µìœ  ëŒ€ê¸° ì¤‘) - PiPëŠ” í™”ë©´ê³µìœ  ìˆ˜ì‹  í›„ í‘œì‹œë¨');
          }
          
          // íŠ¸ë™ ì¢…ë£Œ ì‹œ PiP ë‹«ê¸°
          track.onended = () => {
            pipOverlay.classList.remove('show');
            pipVideo.srcObject = null;
            if (fullscreenPipOverlay) {
              fullscreenPipOverlay.classList.remove('show');
              if (fullscreenPipVideo) fullscreenPipVideo.srcObject = null;
            }
            broadcastCameraTrack = null;
            log('[Guest] í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ ì¢…ë£Œ, PiP ë‹«í˜');
          };
        } else if (!broadcastScreenTrack && !broadcastCameraTrack) {
          // labelë¡œ êµ¬ë¶„ì´ ì•ˆ ë˜ëŠ” ê²½ìš° ìˆœì„œ ê¸°ë°˜ ì²˜ë¦¬ (ì²« ë²ˆì§¸ëŠ” í™”ë©´ê³µìœ ë¡œ ê°€ì •)
          broadcastScreenTrack = track;
          const mainStream = new MediaStream([track]);
          if (player.srcObject !== mainStream) {
            player.srcObject = mainStream;
            (async ()=>{ try{ 
              player.setAttribute('playsinline',''); 
              player.setAttribute('webkit-playsinline',''); 
              await player.play(); 
            }catch(e){} })();
          }
          const audioTracks = stream.getAudioTracks();
          if (audioTracks.length > 0) {
            audioMirror.srcObject = stream;
          }
          log('[Guest] ì²« ë²ˆì§¸ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  (í™”ë©´ê³µìœ ë¡œ ê°€ì •, label: ' + track.label + ')');
          
          // ì¹´ë©”ë¼ íŠ¸ë™ì´ ì´ë¯¸ ìˆ˜ì‹ ëœ ê²½ìš° PiP í‘œì‹œ
          if (broadcastCameraTrack) {
            const cameraStream = new MediaStream([broadcastCameraTrack]);
            pipVideo.srcObject = cameraStream;
            pipOverlay.classList.add('show');
            
            if (fullscreenPipVideo) {
              const fullscreenCameraStream = new MediaStream([broadcastCameraTrack]);
              fullscreenPipVideo.srcObject = fullscreenCameraStream;
              if (fullscreenVideo.classList.contains('show')) {
                fullscreenPipOverlay.classList.add('show');
              }
            }
            
            const playPipVideo = async () => {
              try {
                pipVideo.setAttribute('playsinline', '');
                pipVideo.setAttribute('webkit-playsinline', '');
                pipVideo.muted = true;
                await pipVideo.play();
                
                if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                  fullscreenPipVideo.setAttribute('playsinline', '');
                  fullscreenPipVideo.setAttribute('webkit-playsinline', '');
                  fullscreenPipVideo.muted = true;
                  await fullscreenPipVideo.play();
                }
                
                log('[Guest] í™”ë©´ê³µìœ  ìˆ˜ì‹  í›„ ì¹´ë©”ë¼ PiP í‘œì‹œ (ìˆœì„œ ê¸°ë°˜)');
              } catch(e) {
                console.warn('PiP video play failed:', e);
                setTimeout(() => {
                  if (pipVideo.srcObject && broadcastCameraTrack) {
                    pipVideo.play().catch(e2 => {});
                  }
                  if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                    fullscreenPipVideo.play().catch(e2 => {});
                  }
                }, 500);
              }
            };
            playPipVideo();
          }
        } else if (!broadcastCameraTrack && broadcastScreenTrack) {
          // ë‘ ë²ˆì§¸ ë¹„ë””ì˜¤ íŠ¸ë™ì€ ì¹´ë©”ë¼ë¡œ ì²˜ë¦¬
          broadcastCameraTrack = track;
          const cameraStream = new MediaStream([track]);
          
          // ì¼ë°˜ PiP ì„¤ì •
          pipVideo.srcObject = cameraStream;
          pipOverlay.classList.add('show');
          
          // ì „ì²´í™”ë©´ PiPë„ ì„¤ì •
          if (fullscreenPipVideo) {
            // ê°™ì€ íŠ¸ë™ì„ ì‚¬ìš©í•˜ëŠ” ìƒˆ ìŠ¤íŠ¸ë¦¼ ìƒì„±
            const fullscreenCameraStream = new MediaStream([track]);
            fullscreenPipVideo.srcObject = fullscreenCameraStream;
            // ì „ì²´í™”ë©´ì´ ì—´ë ¤ìˆìœ¼ë©´ ì „ì²´í™”ë©´ PiPë„ í‘œì‹œ
            if (fullscreenVideo.classList.contains('show')) {
              fullscreenPipOverlay.classList.add('show');
            }
          }
          
          // PiP ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„ (ì¬ì‹œë„ í¬í•¨)
          const playPipVideo = async () => {
            try {
              pipVideo.setAttribute('playsinline', '');
              pipVideo.setAttribute('webkit-playsinline', '');
              pipVideo.muted = true; // ìë™ì¬ìƒì„ ìœ„í•´ ìŒì†Œê±°
              await pipVideo.play();
              
              // ì „ì²´í™”ë©´ PiPë„ ì¬ìƒ
              if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                fullscreenPipVideo.setAttribute('playsinline', '');
                fullscreenPipVideo.setAttribute('webkit-playsinline', '');
                fullscreenPipVideo.muted = true;
                await fullscreenPipVideo.play();
              }
              
              log('[Guest] ë‘ ë²ˆì§¸ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  (í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiP í‘œì‹œ, label: ' + track.label + ')');
            } catch(e) {
              console.warn('PiP video play failed:', e);
              log('[Guest] PiP ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ' + e.message + ' (ì¬ì‹œë„ ì¤‘...)');
              // ì¬ì‹œë„
              setTimeout(() => {
                if (pipVideo.srcObject && broadcastCameraTrack) {
                  pipVideo.play().catch(e2 => {
                    console.warn('PiP video play retry failed:', e2);
                  });
                }
                if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                  fullscreenPipVideo.play().catch(e2 => {
                    console.warn('Fullscreen PiP video play retry failed:', e2);
                  });
                }
              }, 500);
            }
          };
          playPipVideo();
          
          track.onended = () => {
            pipOverlay.classList.remove('show');
            pipVideo.srcObject = null;
            if (fullscreenPipOverlay) {
              fullscreenPipOverlay.classList.remove('show');
              if (fullscreenPipVideo) fullscreenPipVideo.srcObject = null;
            }
            broadcastCameraTrack = null;
            log('[Guest] í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ ì¢…ë£Œ, PiP ë‹«í˜');
          };
        } else {
          log(`[Guest] ë¹„ë””ì˜¤ íŠ¸ë™ ë¬´ì‹œë¨ (ì´ë¯¸ ì²˜ë¦¬ë¨): label=${track.label}`);
        }
      } else if (track.kind === 'audio') {
        // ì˜¤ë””ì˜¤ íŠ¸ë™ ì²˜ë¦¬
        if (player.srcObject) {
          // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ì— ì˜¤ë””ì˜¤ íŠ¸ë™ ì¶”ê°€
          const currentStream = player.srcObject;
          if (!currentStream.getAudioTracks().length) {
            currentStream.addTrack(track);
            audioMirror.srcObject = currentStream;
          }
        } else {
          audioMirror.srcObject = stream;
        }
      }
      
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }else{
      // ë¯¸íŒ… ëª¨ë“œ: êµìˆ˜ì˜ ìŠ¤íŠ¸ë¦¼ì„ í‘œì‹œ
      // í™”ë©´ê³µìœ  íŠ¸ë™ê³¼ ì¹´ë©”ë¼ íŠ¸ë™ì„ ëª¨ë‘ ì²˜ë¦¬ (ì¹´ë©”ë¼ ì˜ìƒì´ ë©ˆì¶”ì§€ ì•Šë„ë¡)
      const hostVideoId = 'host';
      let videoEl = remoteVideos.get(hostVideoId);
      if (!videoEl) {
        videoEl = createRemoteVideoElement(hostVideoId, 'êµìˆ˜');
        remoteVideos.set(hostVideoId, videoEl);
      }
      
      // íŠ¸ë™ labelë¡œ í™”ë©´ê³µìœ ì™€ ì¹´ë©”ë¼ êµ¬ë¶„
      const isScreenTrack = track.label && (
        track.label.toLowerCase().includes('screen') || 
        track.label.toLowerCase().includes('í™”ë©´') ||
        track.label.toLowerCase().includes('display') ||
        track.label.toLowerCase().includes('monitor') ||
        track.label.toLowerCase().includes('window') ||
        track.label.toLowerCase().includes('desktop')
      );
      
      if (track.kind === 'video') {
        // ë¹„ë””ì˜¤ íŠ¸ë™ ì²˜ë¦¬
        if (isScreenTrack) {
          // í™”ë©´ê³µìœ  íŠ¸ë™: ë©”ì¸ ë¹„ë””ì˜¤ë¡œ í‘œì‹œ
          meetingScreenTrack = track;
          const screenStream = new MediaStream([track]);
          
          // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ í™•ì¸
          const currentStream = videoEl.srcObject;
          if (!currentStream || currentStream !== screenStream) {
            videoEl.srcObject = screenStream;
            (async ()=>{ 
              try{ 
                videoEl.setAttribute('playsinline',''); 
                videoEl.setAttribute('webkit-playsinline',''); 
                await videoEl.play();
                log('[Guest] êµìˆ˜ í™”ë©´ê³µìœ  ìˆ˜ì‹  ë° í‘œì‹œ');
              }catch(e){
                console.warn('[Guest] í™”ë©´ê³µìœ  ì¬ìƒ ì‹¤íŒ¨:', e);
                setTimeout(async () => {
                  try {
                    await videoEl.play();
                  } catch(e2) {
                    console.warn('[Guest] í™”ë©´ê³µìœ  ì¬ìƒ ì¬ì‹œë„ ì‹¤íŒ¨:', e2);
                  }
                }, 500);
              }
            })();
          }
          
          // ì¹´ë©”ë¼ íŠ¸ë™ì´ ì´ë¯¸ ìˆìœ¼ë©´ ê³„ì† ì¬ìƒë˜ë„ë¡ ìœ ì§€
          if (meetingCameraTrack && meetingCameraTrack.readyState === 'live') {
            // ì¹´ë©”ë¼ íŠ¸ë™ì€ ë³„ë„ë¡œ ìœ ì§€ (PiPë‚˜ ë³„ë„ í‘œì‹œìš©)
            log('[Guest] í™”ë©´ê³µìœ  ìˆ˜ì‹  - ì¹´ë©”ë¼ íŠ¸ë™ì€ ê³„ì† ìœ ì§€ë¨');
          }
        } else {
          // ì¹´ë©”ë¼ íŠ¸ë™: ë³„ë„ë¡œ ì €ì¥í•˜ê³  ê³„ì† ì¬ìƒ
          meetingCameraTrack = track;
          const cameraStream = new MediaStream([track]);
          
          // í™”ë©´ê³µìœ  íŠ¸ë™ì´ ì—†ìœ¼ë©´ ë©”ì¸ ë¹„ë””ì˜¤ë¡œ í‘œì‹œ
          if (!meetingScreenTrack) {
            if (videoEl.srcObject !== cameraStream) {
              videoEl.srcObject = cameraStream;
              (async ()=>{ 
                try{ 
                  videoEl.setAttribute('playsinline',''); 
                  videoEl.setAttribute('webkit-playsinline',''); 
                  await videoEl.play();
                  log('[Guest] êµìˆ˜ ì¹´ë©”ë¼ ìˆ˜ì‹  ë° í‘œì‹œ');
                }catch(e){
                  console.warn('[Guest] ì¹´ë©”ë¼ ì¬ìƒ ì‹¤íŒ¨:', e);
                  setTimeout(async () => {
                    try {
                      await videoEl.play();
                    } catch(e2) {
                      console.warn('[Guest] ì¹´ë©”ë¼ ì¬ìƒ ì¬ì‹œë„ ì‹¤íŒ¨:', e2);
                    }
                  }, 500);
                }
              })();
            }
          } else {
            // í™”ë©´ê³µìœ  íŠ¸ë™ì´ ìˆìœ¼ë©´ ì¹´ë©”ë¼ëŠ” ë³„ë„ë¡œ ìœ ì§€ (PiPë‚˜ ë³„ë„ í‘œì‹œ ê°€ëŠ¥)
            log('[Guest] êµìˆ˜ ì¹´ë©”ë¼ íŠ¸ë™ ìˆ˜ì‹  (í™”ë©´ê³µìœ ì™€ í•¨ê»˜)');
            
            // ì¹´ë©”ë¼ íŠ¸ë™ì´ ê³„ì† ì¬ìƒë˜ë„ë¡ ë³„ë„ ìŠ¤íŠ¸ë¦¼ ìœ ì§€
            // í•„ìš”ì‹œ PiPë¡œ í‘œì‹œí•  ìˆ˜ ìˆìŒ
          }
          
          // ì¹´ë©”ë¼ íŠ¸ë™ ì¢…ë£Œ ê°ì§€
          track.onended = () => {
            if (meetingCameraTrack === track) {
              meetingCameraTrack = null;
              log('[Guest] êµìˆ˜ ì¹´ë©”ë¼ íŠ¸ë™ ì¢…ë£Œ');
            }
          };
        }
      } else if (track.kind === 'audio') {
        // ì˜¤ë””ì˜¤ íŠ¸ë™ ì²˜ë¦¬
        audioMirror.srcObject = stream;
      }
      
      // í•™ìƒì´ ì…ì‹¤ í—ˆìš©ë˜ë©´ êµìˆ˜ í™”ë©´ì„ ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ
      if (fullscreenVideo && fsVideo) {
        if (needsUpdate || fsVideo.srcObject !== stream) {
          fsVideo.srcObject = stream;
        }
        fullscreenVideo.classList.add('show');
        (async () => {
          try {
            fsVideo.setAttribute('playsinline','');
            fsVideo.setAttribute('webkit-playsinline','');
            await fsVideo.play();
            if (isScreenTrack) {
              log('[Guest] êµìˆ˜ í™”ë©´ê³µìœ  ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ');
            }
          } catch(e) {
            console.warn('ì „ì²´í™”ë©´ ì¬ìƒ ì‹¤íŒ¨:', e);
            // ì¬ì‹œë„
            setTimeout(async () => {
              try {
                await fsVideo.play();
              } catch(e2) {
                console.warn('ì „ì²´í™”ë©´ ì¬ìƒ ì¬ì‹œë„ ì‹¤íŒ¨:', e2);
              }
            }, 500);
          }
        })();
      }
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }
    log(`[${role}] tracks: ` + stream.getTracks().map(t=>t.kind).join(', '));
  };

  // ICE
  const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/guest`);
  pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };
  const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/host`);
  firebaseListeners.candidates[viewerId] = remoteCandidatesRef;
  remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)); });

  // SDP
  preferH264(pc);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  const offerRef = db.ref(`rooms/${roomId}/offers/${viewerId}`);
  await offerRef.set({ 
    sdp: offer.sdp, 
    ts: Date.now(),
    studentName: studentName || '' // í•™ìƒ ì´ë¦„ í¬í•¨
  }).catch(e=>{ alert('ì˜¤í¼ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message); });

  const answersRef = db.ref(`rooms/${roomId}/answers/${viewerId}`);
  firebaseListeners.answers = answersRef;
  answersRef.on('value', async snap=>{
    const val = snap.val();
    if(val && val.sdp && pc.signalingState === 'have-local-offer'){
      await pc.setRemoteDescription(new RTCSessionDescription({ type:'answer', sdp: val.sdp }));
      logStatus(comm==='broadcast' ? 'ì‹œì²­ ì¤‘â€¦' : 'ë¯¸íŒ… ì—°ê²°ë¨');
      toast('ì—°ê²° ì„±ê³µ. ì†Œë¦¬ê°€ ì•ˆ ë“¤ë¦¬ë©´ ğŸ”Š ë²„íŠ¼ ë˜ëŠ” í™”ë©´ íƒ­');
    }
  });

    startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
    
    // ì‹œì‘ í›„ UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í‘œì‹œ ë“±)
    refreshUIByMode();
    
    logStatus(`ì ‘ì† ìš”ì²­ ì™„ë£Œ. í˜¸ìŠ¤íŠ¸ ìŠ¹ì¸ ëŒ€ê¸°â€¦ (ë‚´ ID: ${viewerId})`);
    
    // ì±„íŒ… ì´ˆê¸°í™”
    chatMessages.innerHTML = '';
    initChat();
  } catch(e) {
    log('[Guest] ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('í•™ìƒ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    isRunning = false;
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    if (pc) {
      try {
        pc.close();
      } catch(e2) {}
      pc = null;
    }
    throw e;
  }
}

/* ---------------- Controls ---------------- */
// ì…ì‹¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
if (startBtn) {
  startBtn.onclick = async function() {
    try{
      console.log('[Button] ì…ì‹¤ ë²„íŠ¼ í´ë¦­ë¨', { role, isRunning, disabled: this.disabled });
      if (this.disabled) {
        console.log('[Button] ì…ì‹¤ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ');
        return false;
      }
      if (role==='host') {
        await startHost();
      } else {
        await startGuest();
      }
    }catch(e){ 
      console.error('[Button] ì…ì‹¤ ì‹¤íŒ¨:', e);
      alert('ì…ì‹¤ ì‹¤íŒ¨: '+e.message); 
    }
    return false;
  };
  console.log('[Button] ì…ì‹¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
} else {
  console.error('[Button] ì…ì‹¤ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
}

// í‡´ì‹¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
if (stopBtn) {
  stopBtn.onclick = async function() {
    try{
      console.log('[Button] í‡´ì‹¤ ë²„íŠ¼ í´ë¦­ë¨', { disabled: this.disabled });
      if (this.disabled) {
        console.log('[Button] í‡´ì‹¤ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ');
        return false;
      }
      await cleanup();
    }catch(e){
      console.error('[Button] í‡´ì‹¤ ì‹¤íŒ¨:', e);
      alert('í‡´ì‹¤ ì‹¤íŒ¨: '+e.message);
    }
    return false;
  };
  console.log('[Button] í‡´ì‹¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
} else {
  console.error('[Button] í‡´ì‹¤ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
}
if (genRoom && roomIdInput) genRoom.addEventListener('click', ()=>{ roomIdInput.value = generateRoomId(); });
window.addEventListener('DOMContentLoaded', ()=>{
  const p = new URLSearchParams(location.search);
  const mode = p.get('mode');
  const r = p.get('role'), c=p.get('comm'), room=p.get('room'), a=p.get('autostart');
  
  // Viewer ëª¨ë“œ: ì¹´ë©”ë¼ ì˜ìƒë§Œ í‘œì‹œí•˜ëŠ” ê°„ë‹¨í•œ ë·°ì–´
  if (mode === 'viewer') {
    const viewerRoomId = p.get('room');
    const viewerType = p.get('type'); // 'camera' or 'screen'
    
    // UI ìˆ¨ê¸°ê¸°
    document.querySelector('header').style.display = 'none';
    document.querySelector('main').style.display = 'none';
    document.querySelector('footer').style.display = 'none';
    document.querySelector('aside').style.display = 'none';
    
    // Viewer ì „ìš© ìŠ¤íƒ€ì¼
    document.body.style.background = '#000';
    document.body.style.margin = '0';
    document.body.style.padding = '0';
    document.body.style.overflow = 'hidden';
    
    // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ë¥¼ ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ
    player.style.position = 'fixed';
    player.style.top = '0';
    player.style.left = '0';
    player.style.width = '100vw';
    player.style.height = '100vh';
    player.style.objectFit = 'contain';
    player.style.background = '#000';
    player.classList.remove('hidden');
    player.controls = true;
    
    // Viewer ëª¨ë“œë¡œ ê²ŒìŠ¤íŠ¸ ì—°ê²°
    if (viewerRoomId) {
      role = 'guest';
      comm = 'broadcast';
      if (roomIdInput) roomIdInput.value = viewerRoomId;
      
      // ìë™ìœ¼ë¡œ ê²ŒìŠ¤íŠ¸ ì—°ê²° ì‹œì‘
      setTimeout(async () => {
        try {
          await startGuest();
          log('[Viewer] Viewer ëª¨ë“œë¡œ ì—°ê²° ì‹œì‘');
        } catch(e) {
          console.error('Viewer ì—°ê²° ì‹¤íŒ¨:', e);
          log('[Viewer] ì—°ê²° ì‹¤íŒ¨: ' + e.message);
        }
      }, 500);
    }
    
    return; // Viewer ëª¨ë“œì—ì„œëŠ” ì¼ë°˜ ì´ˆê¸°í™” ìŠ¤í‚µ
  }
  
  // ì¼ë°˜ ëª¨ë“œ
  if (r && ['host','guest'].includes(r)) { const roleInput = document.querySelector(`input[name="role"][value="${r}"]`); if(roleInput) roleInput.checked=true; role=r; }
  if (c && ['broadcast','meeting'].includes(c)) { const commInput = document.querySelector(`input[name="comm"][value="${c}"]`); if(commInput) commInput.checked=true; comm=c; }
  if (room && roomIdInput) roomIdInput.value=room;
  refreshUIByMode();
  if (a==='1' && startBtn) setTimeout(()=>startBtn.click(), 400);
});

/* ---------------- Cleanup ---------------- */
async function cleanup(){
  try{
    // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
    if (firebaseListeners.offers) {
      firebaseListeners.offers.off();
      firebaseListeners.offers = null;
    }
    if (firebaseListeners.answers) {
      firebaseListeners.answers.off();
      firebaseListeners.answers = null;
    }
    if (firebaseListeners.chat) {
      firebaseListeners.chat.off();
      firebaseListeners.chat = null;
    }
    Object.values(firebaseListeners.candidates).forEach(ref => {
      if (ref) ref.off();
    });
    firebaseListeners.candidates = {};

    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    if(pc){ 
      pc.getSenders().forEach(s=>s.track && s.track.stop()); 
      pc.close(); 
      pc=null; 
    }
    
    // í˜¸ìŠ¤íŠ¸: ëª¨ë“  ê²ŒìŠ¤íŠ¸ ì—°ê²° ì •ë¦¬
    if (role==='host' && roomId) {
      peerConnections.forEach((_pc, vid) => {
        try {
          _pc.getSenders().forEach(s => s.track && s.track.stop());
          _pc.close();
          // Firebase ë°ì´í„° ì •ë¦¬
          db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(e => {});
          db.ref(`rooms/${roomId}/offers/${vid}`).remove().catch(e => {});
          db.ref(`rooms/${roomId}/answers/${vid}`).remove().catch(e => {});
        } catch(e) {}
      });
      peerConnections.clear();
      
      // ëª¨ë“  ì›ê²© ë¹„ë””ì˜¤ ì œê±°
      remoteVideos.forEach((video, vid) => {
        removeRemoteVideoElement(vid);
      });
    }
    
    // ê²ŒìŠ¤íŠ¸: ìì‹ ì˜ ë°ì´í„°ë§Œ ì •ë¦¬
    if(roomId && role==='guest' && viewerId){
      await db.ref(`rooms/${roomId}/offers/${viewerId}`).remove().catch(e => {});
      await db.ref(`rooms/${roomId}/answers/${viewerId}`).remove().catch(e => {});
      await db.ref(`rooms/${roomId}/candidates/${viewerId}`).remove().catch(e => {});
    }
  }catch(e){
    console.error('Cleanup error:', e);
    log('[Error] Cleanup: ' + e.message);
  }
  isRunning=false; startBtn.disabled=false; stopBtn.disabled=true;
  player.srcObject=null; localPreview.srcObject=null;
  remoteVideosGrid.innerHTML='';
  remoteVideos.clear();
  pendingEl.innerHTML=''; logStatus('ëŒ€ê¸° ì¤‘â€¦'); if(unmuteBtn) unmuteBtn.style.display='none'; if(tapUnmuteOverlay) tapUnmuteOverlay.style.display='none';
  showLocalPreview = true;  // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ (í‘œì‹œ)
  if (localPreviewWrapper) {
    localPreviewWrapper.style.display = 'block';
  }
  if (togglePreviewBtn) togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
  if (chatMessages) chatMessages.innerHTML = '';
  if (chatInput) chatInput.value = '';
  myUserId = '';
  viewerId = '';  // ê²ŒìŠ¤íŠ¸ ID ë¦¬ì…‹
  roomId = '';  // ë°© ì½”ë“œ ë¦¬ì…‹
  role = 'host';  // ì—­í•  ì´ˆê¸°í™” (í˜¸ìŠ¤íŠ¸ë¡œ ë¦¬ì…‹)
  const hostInput = document.querySelector('input[name="role"][value="host"]');
  if (hostInput) hostInput.checked = true;
  if (roleInputs.length > 0) {
    roleInputs.forEach(r => r.disabled = false);
  }
  if (infoEl) infoEl.textContent = '-';  // ì—°ê²° ì •ë³´ ì´ˆê¸°í™”
  
  // í™”ë©´ê³µìœ  ì •ë¦¬
  if (isScreenSharing) {
    if (screenShareStream) {
      screenShareStream.getTracks().forEach(t => t.stop());
      screenShareStream = null;
    }
    isScreenSharing = false;
    if (shareScreenBtn) {
      shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
      shareScreenBtn.style.background = '';
    }
  }
  
  // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ ë³„ë„ ì°½ ë‹«ê¸°
  closeHostCameraWindow();
  
  // PiP ì •ë¦¬
  if (hostCameraStream) {
    hostCameraStream.getTracks().forEach(t => t.stop());
    hostCameraStream = null;
  }
  showHostCameraPip = false;
  pipOverlay.classList.remove('show');
  pipVideo.srcObject = null;
  
  // ë°©ì†¡ ëª¨ë“œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì  ì´ˆê¸°í™”
  broadcastVideoTracks = [];
  broadcastScreenTrack = null;
  broadcastCameraTrack = null;
  
  // ì „ì²´í™”ë©´ ì •ë¦¬
  fullscreenVideo.classList.remove('show');
  fsVideo.srcObject = null;
  if (fullscreenPipOverlay) {
    fullscreenPipOverlay.classList.remove('show');
    if (fullscreenPipVideo) fullscreenPipVideo.srcObject = null;
  }
  
  // Audio Context ì •ë¦¬
  if (audioCtx && audioCtx.state !== 'closed') {
    try {
      audioCtx.close().catch(() => {});
    } catch(e) {}
    audioCtx = null;
    gainNode = null;
  }
  if (viewerAudioCtx && viewerAudioCtx.state !== 'closed') {
    try {
      viewerAudioCtx.close().catch(() => {});
    } catch(e) {}
    viewerAudioCtx = null;
  }
}

/* ---------------- Error log ---------------- */
window.addEventListener('error', e=> log('[Error] ' + e.message));
</script>
</body>
</html>ìŠ¹ì¸
