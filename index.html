<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ê¹€ì²œëŒ€ ë³¸ê´€ 6ì¸µ ì‚¬ë¬´ì—˜ì‹¤</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    html,body{overflow:visible;min-width:100vw;min-height:100vh}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1000px 700px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:10px 20px;display:flex;flex-direction:column;gap:8px;position:relative;min-height:80px}
    .header-top{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .header-left{display:flex;flex-direction:column;gap:4px;flex:1}
    .header-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .header-right{display:flex;align-items:center;gap:8px;margin-left:auto}
    .header-status-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .control-buttons{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:1000;background:rgba(16,24,58,.9);padding:10px;border-radius:12px;border:1px solid #2a3a77}
    h1{margin:0;font-size:18px}
    main{padding:16px}
    .card{background:rgba(16,24,58,.8);border:1px solid #22306b;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block;margin-top:8px;font-size:14px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2b5bd1,#2048a8)}
    button.danger{background:linear-gradient(180deg,#c24,#932)}
    small{color:var(--muted)}
    video{width:100%;background:#000;border-radius:12px}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li{padding:10px;border:1px solid #2a3a77;border-radius:12px;background:#0f173b;display:flex;justify-content:space-between;align-items:center}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#1b285c;color:#cfe0ff;border:1px solid #2a3a77}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#a7b3d4}
    footer{padding:10px 16px;color:#a7b3d4;font-size:12px;text-align:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid-2h{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .meeting-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(225px, 1fr));gap:8px;margin-top:10px}
    .remote-video-wrapper{position:relative;min-height:150px}
    .remote-video-wrapper small{position:absolute;top:4px;left:4px;background:rgba(0,0,0,.6);padding:3px 6px;border-radius:4px;z-index:1;font-size:11px}
    .remote-video-wrapper video{width:100%;height:auto;min-height:150px;background:#000;border-radius:8px;object-fit:cover}
    .local-preview-wrapper{position:relative;min-height:150px}
    .local-preview-wrapper video{width:100%;height:auto;min-height:150px;background:#000;border-radius:8px;object-fit:cover}
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0d1433;border:1px solid #2a3a77;color:#eaf0ff;padding:10px 14px;border-radius:12px;display:none}
    .hidden{display:none!important}
    .fullscreen-video{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none}
    .fullscreen-video.show{display:block}
    .fullscreen-video video{width:100%;height:100%;object-fit:contain}
    .fullscreen-video .fs-close{position:absolute;top:20px;right:20px;width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,106,106,.9);color:#fff;cursor:pointer;font-size:20px;z-index:2001;display:flex;align-items:center;justify-content:center}
    .fullscreen-video .fs-close:hover{background:rgba(255,74,74,.9)}
    .video-fullscreen-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.6);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;z-index:2}
    .video-fullscreen-btn:hover{background:rgba(0,0,0,.8)}
    .video-question-btn{position:absolute;bottom:8px;right:8px;background:rgba(106,166,255,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-question-btn:hover{background:rgba(106,166,255,1)}
    .fullscreen-video .video-question-btn{position:fixed;bottom:20px;right:20px;z-index:2002;padding:12px 20px;font-size:14px;font-weight:bold;background:rgba(106,166,255,.9);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .fullscreen-video .video-question-btn:hover{background:rgba(106,166,255,1);transform:scale(1.05)}
    .video-unmute-btn{position:absolute;bottom:8px;left:8px;background:rgba(255,106,106,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-unmute-btn:hover{background:rgba(255,74,74,1)}
    .video-unmute-btn.muted{background:rgba(100,100,100,.8)}
    .video-unmute-btn.muted:hover{background:rgba(120,120,120,1)}
    .video-question-allow-btn{position:absolute;top:8px;left:8px;background:rgba(76,175,80,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-question-allow-btn:hover{background:rgba(69,160,73,1)}
    .video-question-end-btn{position:absolute;top:8px;left:8px;background:rgba(244,67,54,.8);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;z-index:2;font-weight:bold}
    .video-question-end-btn:hover{background:rgba(229,57,53,1)}
    .question-request-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(76,175,80,.9);color:#fff;padding:12px 20px;border-radius:12px;font-size:16px;font-weight:bold;z-index:10;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    .question-request-indicator.blink{animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .chat-container{display:flex;flex-direction:column;height:300px}
    .chat-messages{flex:1;overflow-y:auto;padding:8px;background:#0d1433;border-radius:8px;margin-bottom:8px;max-height:250px}
    .chat-message{padding:6px 8px;margin-bottom:6px;border-radius:6px;font-size:13px;word-wrap:break-word}
    .chat-message.own{background:#1b285c;text-align:right}
    .chat-message.other{background:#0f173b}
    .chat-message .sender{font-size:11px;color:#a7b3d4;margin-bottom:2px}
    .chat-message .time{font-size:10px;color:#6aa6ff;margin-left:6px}
    .chat-input-row{display:flex;gap:6px}
    .chat-input-row input{flex:1;padding:8px;border-radius:8px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff;font-size:13px}
    .chat-input-row button{padding:8px 12px}
    .modal{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.7);z-index:3000;display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:rgba(16,24,58,.95);border:1px solid #22306b;border-radius:16px;padding:20px;max-width:500px;max-height:80vh;width:90%;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,.5)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #2a3a77}
    .modal-header h3{margin:0;font-size:18px}
    .modal-close{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,106,106,.8);color:#fff;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:rgba(255,74,74,1)}
    #info{position:fixed;top:10px;right:10px;font-size:11px;color:var(--muted);padding:6px 10px;background:rgba(16,24,58,.8);border-radius:8px;border:1px solid #2a3a77;z-index:1000}
    #logBtn{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;border:none;background:rgba(106,166,255,.8);color:#fff;cursor:pointer;font-size:20px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    #logBtn:hover{background:rgba(106,166,255,1)}
  </style>
</head>
<body>
<header>
  <div class="header-top">
    <div class="header-left">
      <h1 style="margin:0;font-size:18px">ê¹€ì²œëŒ€ ë³¸ê´€ 6ì¸µ ì‚¬ë¬´ì—˜ì‹¤</h1>
      <div id="status" class="muted" style="font-size:12px">ëŒ€ê¸° ì¤‘â€¦</div>
    </div>
    <div class="header-right">
      <div class="header-controls">
        <div>
          <label style="font-size:12px;margin:0">ì—­í• </label>
          <div class="row" style="gap:4px">
            <label class="row" style="margin:0;gap:4px"><input type="radio" name="role" value="professor"> êµìˆ˜</label>
            <label class="row" style="margin:0;gap:4px"><input type="radio" name="role" value="student" checked> í•™ìƒ</label>
          </div>
        </div>
        <div>
          <label style="font-size:12px;margin:0">ì´ë¦„</label>
          <input id="userName" type="text" placeholder="ì´ë¦„ ì…ë ¥" style="width:120px;padding:6px 8px;font-size:12px" />
        </div>
        <div id="professorIdSection" style="display:none">
          <label style="font-size:12px;margin:0">ì‚¬ë²ˆ</label>
          <input id="professorId" type="text" placeholder="ì‚¬ë²ˆ ì…ë ¥" style="width:100px;padding:6px 8px;font-size:12px" />
        </div>
        <div>
          <label style="font-size:12px;margin:0">ê³¼ëª©ëª…</label>
          <input id="roomId" type="text" placeholder="ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:150px;padding:6px 8px;font-size:12px" />
        </div>
      </div>
      <button class="primary" id="startBtn" style="padding:8px 16px">ì…ì‹¤</button>
      <button class="danger" id="stopBtn" disabled style="padding:8px 16px">í‡´ì‹¤</button>
      <!-- êµìˆ˜ ì „ìš© ë²„íŠ¼ -->
      <button class="primary" id="classStartBtn" style="padding:8px 16px;display:none">ìˆ˜ì—…ì‹œì‘</button>
      <button class="danger" id="classEndBtn" style="padding:8px 16px;display:none">ìˆ˜ì—…ì¢…ë£Œ</button>
      <!-- ìˆ˜ê°•ìƒ ë²„íŠ¼ -->
      <button id="studentListBtn" style="padding:8px 16px;display:none;background:#6aa6ff">ìˆ˜ê°•ìƒ</button>
      <!-- ì¶œì„í™•ì¸ ë²„íŠ¼ -->
      <button id="attendanceCheckBtn" style="padding:8px 16px;display:none;background:#4cd97b">ì¶œì„í™•ì¸</button>
    </div>
  </div>
  <div id="info" class="hint" style="font-size:11px; display:none">-</div>
</header>

<main>
  <section class="card">
    <!-- ë°©ì†¡ ëª¨ë“œ: ë©”ì¸ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ -->
    <video id="player" class="hidden" autoplay playsinline webkit-playsinline controls style="width:100%;max-height:70vh;background:#000;border-radius:8px"></video>
    
    <!-- ë¯¸íŒ… ëª¨ë“œ: ë‹¤ìê°„ ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ -->
    <div id="meetingVideos">
      <div class="meeting-grid" id="remoteVideosGrid">
        <!-- êµìˆ˜ ë¯¸ë¦¬ë³´ê¸° í™”ë©´ (í•™ìƒ í™”ë©´ê³¼ ë™ì¼í•œ í¬ê¸°ë¡œ í‘œì‹œ) -->
        <div class="local-preview-wrapper remote-video-wrapper" id="localPreviewWrapper" style="display:none">
          <small class="muted">ë‚˜(ë¯¸ë¦¬ë³´ê¸° Â· í•­ìƒ ìŒì†Œê±°)</small>
          <video id="localPreview" autoplay playsinline webkit-playsinline muted controls></video>
        </div>
      </div>
    </div>

    <!-- ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ -->
    <div id="fullscreenVideo" class="fullscreen-video">
      <button class="fs-close" id="fsCloseBtn">Ã—</button>
      <video id="fsVideo" autoplay playsinline webkit-playsinline controls></video>
      <!-- í•™ìƒ ì „ìš© ì§ˆë¬¸ ë²„íŠ¼ (ì „ì²´í™”ë©´ ëª¨ë“œ) -->
      <button id="fullscreenQuestionBtn" class="video-question-btn" style="display:none">â“ ì§ˆë¬¸í•˜ê¸°</button>
    </div>

    <audio id="audiomirror" autoplay playsinline webkit-playsinline style="display:none"></audio>
  </section>

  <!-- ì…ì‹¤ í›„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ (í™”ë©´ í•˜ë‹¨ ì¤‘ì•™) -->
  <div class="control-buttons" id="controlButtons" style="display:none">
    <button id="muteMicBtn" style="display:none">ë§ˆì´í¬ ìŒì†Œê±°</button>
    <button id="muteCamBtn" style="display:none">ì¹´ë©”ë¼ ë„ê¸°</button>
    <button id="shareScreenBtn" style="display:none">í™”ë©´ê³µìœ </button>
    <button id="openCameraPiPBtn" style="display:none">ì¹´ë©”ë¼ PiP</button>
    <button id="unmuteBtn" style="display:none">ğŸ”Š ì†Œë¦¬ ì¼œê¸°</button>
  </div>
  
  <!-- ì±„íŒ… ë²„íŠ¼ (ê³ ì • ìœ„ì¹˜) -->
  <button id="showChatBtn" style="position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;border:none;background:rgba(106,166,255,.8);color:#fff;cursor:pointer;font-size:20px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3)">ğŸ’¬</button>
</main>

<div id="toast"></div>

<!-- í•™ìƒëª…ë‹¨ ê´€ë¦¬ ëª¨ë‹¬ (êµìˆ˜ ì „ìš©) -->
<div id="pendingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>í•™ìƒëª…ë‹¨ ê´€ë¦¬ (êµìˆ˜ ì „ìš©)</h3>
      <button class="modal-close" id="pendingModalClose">Ã—</button>
    </div>
    <!-- í•™ìƒëª…ë‹¨ ì…ë ¥ ì˜ì—­ (êµìˆ˜ ì „ìš©) -->
    <div id="studentListSection" style="margin-bottom:16px;padding:12px;background:rgba(13,20,51,0.6);border-radius:8px;border:1px solid #2a3a77;display:none">
      <label style="display:block;margin-bottom:8px;font-size:14px;color:#eaf0ff;font-weight:bold">í•™ìƒëª…ë‹¨ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
      <textarea id="studentListInput" placeholder="í•™ìƒ1&#10;í•™ìƒ2&#10;í•™ìƒ3" style="width:100%;min-height:100px;padding:8px;font-size:12px;background:rgba(16,24,58,0.8);border:1px solid #2a3a77;border-radius:6px;color:#eaf0ff;resize:vertical;font-family:inherit"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="saveStudentListBtn" class="primary" style="padding:6px 12px;font-size:12px">ëª…ë‹¨ ì €ì¥</button>
        <button id="clearStudentListBtn" class="danger" style="padding:6px 12px;font-size:12px">ëª…ë‹¨ ì´ˆê¸°í™”</button>
      </div>
      <div id="studentListStatus" style="margin-top:8px;font-size:11px;color:var(--muted)"></div>
    </div>
    <ul id="pending" style="display:none"></ul>
  </div>
</div>

<!-- ì±„íŒ… ëª¨ë‹¬ -->
<div id="chatModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ì±„íŒ…</h3>
      <button class="modal-close" id="chatModalClose">Ã—</button>
    </div>
    <div class="chat-container">
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-row">
        <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="200" />
        <button id="chatSendBtn">ì „ì†¡</button>
      </div>
      <!-- í•™ìƒ ì „ìš© ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ -->
      <div id="questionBtnWrapper" style="margin-top:8px; display:none">
        <button id="questionBtn" class="primary" style="width:100%">â“ êµìˆ˜ì—ê²Œ ì§ˆë¬¸í•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ ëª¨ë‹¬ -->
<div id="logModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ë¡œê·¸</h3>
      <button class="modal-close" id="logModalClose">Ã—</button>
    </div>
    <pre id="log" class="hint" style="white-space:pre-wrap;max-height:60vh;overflow:auto;margin:0"></pre>
  </div>
</div>

<!-- ì¶œì„í™•ì¸ ëª¨ë‹¬ -->
<div id="attendanceModal" class="modal">
  <div class="modal-content" style="max-width:800px">
    <div class="modal-header">
      <h3>ì¶œì„ í˜„í™©</h3>
      <button class="modal-close" id="attendanceModalClose">Ã—</button>
    </div>
    <div style="margin-bottom:16px">
      <label style="display:block;margin-bottom:8px">ë‚ ì§œ ì„ íƒ</label>
      <input type="date" id="attendanceDateInput" style="width:200px;padding:8px;border-radius:8px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff" />
    </div>
    <div id="attendanceList" style="max-height:60vh;overflow-y:auto">
      <p class="hint">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
    </div>
  </div>
</div>

<!-- ë¡œê·¸ ë²„íŠ¼ -->
<button id="logBtn" title="ë¡œê·¸ ë³´ê¸°">ğŸ“‹</button>

<!-- iOSìš© ì–¸ë®¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
<div id="tapUnmuteOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center;">
  <button id="tapUnmuteBtn" style="font-size:18px;padding:14px 18px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer">
    ğŸ”Š íƒ­í•˜ì—¬ ì†Œë¦¬ ì¼œê¸°
  </button>
</div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-007jMq4dO7M6t6wn5vR_PZW9Gg1n0LM",
  authDomain: "webboard-ea2c4.firebaseapp.com",
  databaseURL: "https://webboard-ea2c4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webboard-ea2c4",
  storageBucket: "webboard-ea2c4.firebasestorage.app",
  messagingSenderId: "1063560565058",
  appId: "1:1063560565058:web:bd9b57bef6dd649f67f8db",
  measurementId: "G-NTQGQJVW8E"
};
firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously().catch(err=>{ console.error('Auth failed:', err); alert('Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message); });
const db = firebase.database();

/* ---------------- UI refs ---------------- */
const player = document.getElementById('player');               // ë°©ì†¡ ëª¨ë“œ ë©”ì¸ ë¹„ë””ì˜¤
const meetingVideos = document.getElementById('meetingVideos');   // ë¯¸íŒ… ëª¨ë“œ ì»¨í…Œì´ë„ˆ
const localPreview = document.getElementById('localPreview');
const audioMirror = document.getElementById('audiomirror');
const roomIdInput = document.getElementById('roomId');
const userNameInput = document.getElementById('userName');
const statusEl = document.getElementById('status');
const controlButtons = document.getElementById('controlButtons');
const pendingEl = document.getElementById('pending');
const infoEl = document.getElementById('info');
const logEl = document.getElementById('log');
const presenterHints = document.getElementById('presenterHints');
const unmuteBtn = document.getElementById('unmuteBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const toastEl  = document.getElementById('toast');
const tapUnmuteOverlay = document.getElementById('tapUnmuteOverlay');
const tapUnmuteBtn = document.getElementById('tapUnmuteBtn');
const gainRow    = document.getElementById('gainRow');
const gainSlider = document.getElementById('gainSlider');
const gainVal    = document.getElementById('gainVal');
const muteMicBtn   = document.getElementById('muteMicBtn');
const muteCamBtn   = document.getElementById('muteCamBtn');
const shareScreenBtn = document.getElementById('shareScreenBtn');
const openBrowserWindowBtn = document.getElementById('openBrowserWindowBtn');
const openCameraPiPBtn = document.getElementById('openCameraPiPBtn');
const cameraCtrl   = document.getElementById('cameraCtrl');
const sourceWrap   = document.getElementById('sourceWrap');
const remoteVideosGrid = document.getElementById('remoteVideosGrid');
const localPreviewWrapper = document.getElementById('localPreviewWrapper');
const togglePreviewBtn = document.getElementById('togglePreviewBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const fullscreenVideo = document.getElementById('fullscreenVideo');
const fsVideo = document.getElementById('fsVideo');
const fsCloseBtn = document.getElementById('fsCloseBtn');
const fullscreenQuestionBtn = document.getElementById('fullscreenQuestionBtn');
const questionBtnWrapper = document.getElementById('questionBtnWrapper');
const questionBtn = document.getElementById('questionBtn');
const pendingModal = document.getElementById('pendingModal');
const pendingModalClose = document.getElementById('pendingModalClose');
const studentListSection = document.getElementById('studentListSection');
const studentListInput = document.getElementById('studentListInput');
const saveStudentListBtn = document.getElementById('saveStudentListBtn');
const clearStudentListBtn = document.getElementById('clearStudentListBtn');
const classStartBtn = document.getElementById('classStartBtn');
const classEndBtn = document.getElementById('classEndBtn');
const studentListBtn = document.getElementById('studentListBtn');
const attendanceCheckBtn = document.getElementById('attendanceCheckBtn');
const attendanceModal = document.getElementById('attendanceModal');
const attendanceModalClose = document.getElementById('attendanceModalClose');
const attendanceDateInput = document.getElementById('attendanceDateInput');
const attendanceList = document.getElementById('attendanceList');
const studentListStatus = document.getElementById('studentListStatus');
const chatModal = document.getElementById('chatModal');
const chatModalClose = document.getElementById('chatModalClose');
const logModal = document.getElementById('logModal');
const logModalClose = document.getElementById('logModalClose');
const logBtn = document.getElementById('logBtn');

/* ---------------- Modal Controls ---------------- */
function showPendingModal() {
  if (pendingModal && role === 'professor') {
    pendingModal.classList.add('show');
    // í•™ìƒëª…ë‹¨ ì„¹ì…˜ í‘œì‹œ
    if (studentListSection) {
      studentListSection.style.display = 'block';
    }
    // ì €ì¥ëœ í•™ìƒëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
    loadStudentList();
  }
}
function hidePendingModal() {
  if (pendingModal) pendingModal.classList.remove('show');
}
function showChatModal() {
  if (chatModal) {
    chatModal.classList.add('show');
    // ì±„íŒ… ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
    setTimeout(() => {
      if (chatInput) chatInput.focus();
    }, 100);
  }
}
function hideChatModal() {
  if (chatModal) chatModal.classList.remove('show');
}
function showLogModal() {
  if (logModal) logModal.classList.add('show');
}
function hideLogModal() {
  if (logModal) logModal.classList.remove('show');
}

// ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
if (pendingModalClose) pendingModalClose.addEventListener('click', hidePendingModal);
if (chatModalClose) chatModalClose.addEventListener('click', hideChatModal);
if (logModalClose) logModalClose.addEventListener('click', hideLogModal);
if (logBtn) logBtn.addEventListener('click', showLogModal);

// ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
if (pendingModal) pendingModal.addEventListener('click', (e) => {
  if (e.target === pendingModal) hidePendingModal();
});
if (chatModal) chatModal.addEventListener('click', (e) => {
  if (e.target === chatModal) hideChatModal();
});
if (logModal) logModal.addEventListener('click', (e) => {
  if (e.target === logModal) hideLogModal();
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (pendingModal && pendingModal.classList.contains('show')) hidePendingModal();
    if (chatModal && chatModal.classList.contains('show')) hideChatModal();
    if (logModal && logModal.classList.contains('show')) hideLogModal();
  }
});

/* ---------------- State ---------------- */
let role = 'student';                 // 'professor' | 'student' (ê¸°ë³¸ê°’: í•™ìƒ)

// ìŠ¹ì¸ëœ êµìˆ˜ ëª…ë‹¨ (ì´ë¦„, ì‚¬ë²ˆ)
const AUTHORIZED_PROFESSORS = [
  { name: 'ìµœì¤€ì¼', id: '19930007' },
  { name: 'ê¹€í–¥ë¯¸', id: '20250101' },
  { name: 'ì¶”êµí˜„', id: '20250101' },
  { name: 'ë°•ì„±ì£¼', id: '20250101' }
];

// êµìˆ˜ ì¸ì¦ í•¨ìˆ˜
function verifyProfessor(name, professorId) {
  if (!name || !professorId) return false;
  const normalizedName = name.trim();
  const normalizedId = professorId.trim();
  return AUTHORIZED_PROFESSORS.some(p => 
    p.name === normalizedName && p.id === normalizedId
  );
}
let comm = 'meeting';              // ë¯¸íŒ… ëª¨ë“œë§Œ ì‚¬ìš©
let facingMode = 'user';           // ì¹´ë©”ë¼ ì „/í›„ë©´
let roomId = '';
let viewerId = '';
let isRunning = false;
let classStartTime = null;              // ìˆ˜ì—… ì‹œì‘ ì‹œê°„
let classEndTime = null;                // ìˆ˜ì—… ì¢…ë£Œ ì‹œê°„
let studentEntryTime = null;            // í•™ìƒ ì…ì‹¤ ì‹œê°„
let studentExitTime = null;             // í•™ìƒ í‡´ì‹¤ ì‹œê°„
let pc = null;                      // í•™ìƒìš© ë‹¨ì¼ ì—°ê²°
let peerConnections = new Map();    // êµìˆ˜ìš©: í•™ìƒ ID -> PeerConnection
let remoteVideos = new Map();       // í•™ìƒ ID -> video ì—˜ë¦¬ë¨¼íŠ¸
let studentAudioTracks = new Map();   // í•™ìƒ ID -> ì˜¤ë””ì˜¤ íŠ¸ë™ (ìŒì†Œê±° ì œì–´ìš©)
let localStream = null;            // ë‚´ê°€ ë³´ë‚´ëŠ” ìŠ¤íŠ¸ë¦¼(ëª¨ë“œë³„ êµ¬ì„±)
let audioCtx = null, gainNode = null, viewerAudioCtx = null;
let showLocalPreview = true;        // ë‚´ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì—¬ë¶€ (ê¸°ë³¸ê°’: í‘œì‹œ)
let isScreenSharing = false;       // í™”ë©´ê³µìœ  ì¤‘ ì—¬ë¶€
let screenShareStream = null;       // í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ (ì¢…ë£Œ ê°ì§€ìš©)
let professorCameraStream = null;        // êµìˆ˜ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ (ë³„ë„ ì°½ìš©/PiPìš©)
let professorCameraWindow = null;        // êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½
let professorCameraPiPVideo = null;      // êµìˆ˜ ì¹´ë©”ë¼ PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸
let studentQuestionPiPVideo = null;  // í•™ìƒ ì§ˆë¬¸ PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸
let currentQuestionStudentId = null;  // í˜„ì¬ ì§ˆë¬¸ ì¤‘ì¸ í•™ìƒ ID
let professorPiPWasActiveBeforeQuestion = false;  // ì§ˆë¬¸ ì‹œì‘ ì „ êµìˆ˜ PiP í™œì„±í™” ì—¬ë¶€
let isQuestionRequestActive = false;  // ì§ˆë¬¸ ìš”ì²­ í™œì„±í™” ì—¬ë¶€ (í† ê¸€ìš©)
let wasFullscreenBeforeQuestion = false;  // ì§ˆë¬¸ ì‹œì‘ ì „ ì „ì²´í™”ë©´ ìƒíƒœ
let questionFullscreenStudentId = null;  // ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ ì¤‘ì¸ ì§ˆë¬¸ í•™ìƒ ID
let allCameraStreams = new Map();     // ëª¨ë“  ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì €ì¥ (deviceId -> stream)
let allCameraVideos = new Map();      // ëª¨ë“  ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì €ì¥ (deviceId -> video element)
let ipCameraUrls = new Set();         // IP ì¹´ë©”ë¼ URL ì €ì¥
let ipCameraStreams = new Map();      // IP ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì €ì¥ (url -> {stream, videoElement})
let broadcastVideoTracks = [];        // ë°©ì†¡ ëª¨ë“œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì 
let broadcastScreenTrack = null;      // ë°©ì†¡ ëª¨ë“œ í™”ë©´ê³µìœ  íŠ¸ë™
let broadcastCameraTrack = null;      // ë°©ì†¡ ëª¨ë“œ ì¹´ë©”ë¼ íŠ¸ë™ (ì²« ë²ˆì§¸)
let broadcastAllCameras = new Map();  // í•™ìƒì´ ìˆ˜ì‹ í•œ ëª¨ë“  êµìˆ˜ ì¹´ë©”ë¼ íŠ¸ë™ ì €ì¥ (trackId -> {track, label})
let firebaseListeners = {           // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ë¥¼ ìœ„í•œ ì°¸ì¡°
  offers: null,
  answers: null,
  questionActive: null,
  candidates: {},
  chat: null,
  questionRequest: null  // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
};
let myUserId = '';                  // ë‚´ ì‚¬ìš©ì ID (ì±„íŒ…ìš©)

/* ---------------- Utils ---------------- */
// ê°•ì œ ì¬ìƒ ë³´ì¡°(ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ ìš°íšŒ)
async function forcePlay(el){
  if(!el) return;
  try{
    el.muted = true;                    // ìë™ì¬ìƒ ë³´ì¡°
    el.setAttribute('muted','');        // iOS ë³´ì¡°
    el.setAttribute('playsinline','');  // iOS ë³´ì¡°
    el.setAttribute('webkit-playsinline','');
    await el.play();
  }catch(e){
    console.warn('forcePlay blocked:', e);
  }
}

function logStatus(msg){ if (statusEl) statusEl.textContent = msg; }
function log(msg){ console.log(msg); if (logEl) { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; } }
function toast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1800); }
function randomId(len=10){ const c='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789'; let s=''; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
// generateRoomId í•¨ìˆ˜ ì œê±° - ê³¼ëª©ëª…ì€ ìˆ˜ë™ ì…ë ¥ë§Œ ê°€ëŠ¥
const isiOS = (() => { const ua = navigator.userAgent||''; const iOS=/iPad|iPhone|iPod/.test(ua); const iPadOS13Plus=navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1; return iOS||iPadOS13Plus; })();

/* ---------------- UI bindings ---------------- */
const roleInputs = document.querySelectorAll('input[name="role"]');
const professorIdSection = document.getElementById('professorIdSection');
const professorIdInput = document.getElementById('professorId');

if (roleInputs.length > 0) {
  roleInputs.forEach(r=>{
    r.addEventListener('change', ()=>{
      const checked = document.querySelector('input[name="role"]:checked');
      if (checked) role = checked.value;
      
      // êµìˆ˜ ì„ íƒ ì‹œ ì‚¬ë²ˆ ì…ë ¥ í•„ë“œ í‘œì‹œ
      if (professorIdSection) {
        professorIdSection.style.display = (role === 'professor') ? 'block' : 'none';
      }
      
      refreshUIByMode();
    });
  });
}

// ì´ˆê¸° ìƒíƒœì—ì„œ ì‚¬ë²ˆ í•„ë“œ ìˆ¨ê¹€ (í•™ìƒì´ ê¸°ë³¸ê°’ì´ë¯€ë¡œ)
if (professorIdSection) {
  professorIdSection.style.display = 'none';
}
function refreshUIByMode(){
  const isProfessor = role==='professor';

  if (presenterHints) presenterHints.style.display = isProfessor ? 'block' : 'none';
  
  // ë¯¸íŒ… ëª¨ë“œ: ì‹œì‘ í›„ì—ëŠ” í•­ìƒ ì¹´ë©”ë¼/ë§ˆì´í¬ ì»¨íŠ¸ë¡¤ í‘œì‹œ
  if (meetingVideos) meetingVideos.classList.remove('hidden');
  
  // ì…ì‹¤ í›„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì˜ì—­ í‘œì‹œ
  if (controlButtons) {
    controlButtons.style.display = isRunning ? 'flex' : 'none';
  }
  
  // ë§ˆì´í¬/ì¹´ë©”ë¼ ë²„íŠ¼ í‘œì‹œ
  if (muteMicBtn) {
    muteMicBtn.style.display = isRunning ? 'inline-block' : 'none';
  }
  if (muteCamBtn) {
    muteCamBtn.style.display = isRunning ? 'inline-block' : 'none';
  }
  
  // í™”ë©´ê³µìœ  ë²„íŠ¼: êµìˆ˜ì™€ í•™ìƒ ëª¨ë‘ ì‹œì‘ í›„ì— í‘œì‹œ
  if (shareScreenBtn) {
    shareScreenBtn.style.display = isRunning ? 'inline-block' : 'none';
    // í™”ë©´ê³µìœ  ì¤‘ì´ ì•„ë‹ ë•ŒëŠ” ê¸°ë³¸ í…ìŠ¤íŠ¸ë¡œ ì„¤ì •
    if (!isScreenSharing && shareScreenBtn.textContent === 'í™”ë©´ê³µìœ  ì¢…ë£Œ') {
      shareScreenBtn.textContent = 'í™”ë©´ê³µìœ ';
      shareScreenBtn.style.background = '';
    }
  }
  
  // êµìˆ˜ ì¹´ë©”ë¼ PiP ë²„íŠ¼ (êµìˆ˜ë§Œ, ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ìˆì„ ë•Œ, PiP ì§€ì› ë¸Œë¼ìš°ì €)
  if (isProfessor && openCameraPiPBtn) {
    const hasCameraForPiP = (isRunning && professorCameraStream) || (isRunning && localStream && localStream.getVideoTracks().length > 0);
    const isPiPSupported = document.pictureInPictureEnabled !== undefined;
    openCameraPiPBtn.style.display = (hasCameraForPiP && isPiPSupported && isRunning) ? 'inline-block' : 'none';
  }
  
  if (openBrowserWindowBtn) {
    openBrowserWindowBtn.style.display = 'none';
  }
  
  // í•™ìƒ ì „ìš© ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ í‘œì‹œ
  if (questionBtnWrapper) {
    questionBtnWrapper.style.display = (!isProfessor && isRunning) ? 'block' : 'none';
  }
}
refreshUIByMode();


if (muteMicBtn) muteMicBtn.addEventListener('click', ()=>{
  const t = localStream?.getAudioTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  if (muteMicBtn) muteMicBtn.textContent = t.enabled ? 'ë§ˆì´í¬ ìŒì†Œê±°' : 'ë§ˆì´í¬ ì¼œê¸°';
});

if (muteCamBtn) muteCamBtn.addEventListener('click', ()=>{
  const t = localStream?.getVideoTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  if (muteCamBtn) muteCamBtn.textContent = t.enabled ? 'ì¹´ë©”ë¼ ë„ê¸°' : 'ì¹´ë©”ë¼ ì¼œê¸°';
});

// í™”ë©´ê³µìœ  ì‹œì‘/ì¢…ë£Œ
if (shareScreenBtn) shareScreenBtn.addEventListener('click', async ()=>{
  if (isScreenSharing) {
    await stopScreenShare();
  } else {
    await startScreenShare();
  }
});

// ì¹´ë©”ë¼ PiP ì‹œì‘ í•¨ìˆ˜ (ë³„ë„ íŒì—… ì°½ ì‚¬ìš©)
async function startCameraPiP(cameraStreamToUse) {
  if (!cameraStreamToUse) {
    // professorCameraStreamì´ ì—†ìœ¼ë©´ localStreamì—ì„œ ì¹´ë©”ë¼ íŠ¸ë™ ì¶”ì¶œ
    if (localStream) {
      const videoTrack = localStream.getVideoTracks()[0];
      if (videoTrack) {
        cameraStreamToUse = new MediaStream([videoTrack]);
      }
    }
  }
  
  if (!cameraStreamToUse) {
    console.warn('[Professor] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì—†ìŒ', { professorCameraStream, localStream });
    toast('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  try {
    // ë³„ë„ ì°½ìœ¼ë¡œ ì¹´ë©”ë¼ PiP í‘œì‹œ
    const screenInfo = {
      screenWidth: window.screen.width,
      screenHeight: window.screen.height
    };
    openProfessorCameraWindow(cameraStreamToUse, false, screenInfo);
    log('[Professor] ì¹´ë©”ë¼ PiP ì°½ ì—´ë¦¼');
  } catch(e) {
    console.error('ì¹´ë©”ë¼ PiP ì‹¤íŒ¨:', e);
    log('[Professor] ì¹´ë©”ë¼ PiP ì‹¤íŒ¨: ' + e.message);
    toast('ì¹´ë©”ë¼ PiP ì‹¤íŒ¨: ' + e.message);
  }
}

// êµìˆ˜ ì¹´ë©”ë¼ PiP ëª¨ë“œ (ìˆ˜ë™ ë²„íŠ¼) - ë³„ë„ ì°½ ì‚¬ìš©
if (openCameraPiPBtn) {
  openCameraPiPBtn.addEventListener('click', async () => {
    const cameraStreamToUse = professorCameraStream || (localStream ? new MediaStream([localStream.getVideoTracks()[0]]) : null);
    
    if (!cameraStreamToUse) {
      toast('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    try {
      // ì´ë¯¸ ì¹´ë©”ë¼ ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
      if (professorCameraWindow && !professorCameraWindow.closed) {
        professorCameraWindow.close();
        professorCameraWindow = null;
        toast('ì¹´ë©”ë¼ PiP ì°½ ë‹«í˜');
        log('[Professor] ì¹´ë©”ë¼ PiP ì°½ ë‹«í˜');
      } else {
        await startCameraPiP(cameraStreamToUse);
        toast('ì¹´ë©”ë¼ PiP ì°½ ì—´ë¦¼');
      }
    } catch(e) {
      console.error('ì¹´ë©”ë¼ PiP ì‹¤íŒ¨:', e);
      toast('ì¹´ë©”ë¼ PiPë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message);
    }
  });
}

// PiP ì¢…ë£Œ ê°ì§€
if (document.pictureInPictureEnabled) {
  document.addEventListener('leavepictureinpicture', () => {
    // êµìˆ˜ ì¹´ë©”ë¼ PiP ì¢…ë£Œ ê°ì§€
    if (professorCameraPiPVideo && document.pictureInPictureElement === professorCameraPiPVideo) {
      professorCameraPiPVideo.srcObject = null;
      log('[Professor] Picture-in-Picture ëª¨ë“œ ì¢…ë£Œë¨');
    }
    // í•™ìƒ ì§ˆë¬¸ PiP ì¢…ë£Œ ê°ì§€
    if (studentQuestionPiPVideo && document.pictureInPictureElement === studentQuestionPiPVideo) {
      if (currentQuestionStudentId) {
        // ì§ˆë¬¸ ì™„ë£Œ ì²˜ë¦¬
        endStudentQuestion(currentQuestionStudentId);
      }
    }
  });
}

// ìƒˆ ë¸Œë¼ìš°ì € ì°½/íƒ­ì—ì„œ ì¹´ë©”ë¼ ì˜ìƒ ì—´ê¸°
if (openBrowserWindowBtn) {
  openBrowserWindowBtn.addEventListener('click', () => {
    // professorCameraStreamì´ ì—†ìœ¼ë©´ localStream ì‚¬ìš©
    const streamToUse = professorCameraStream || (localStream ? localStream : null);
    
    if (!streamToUse || !roomId) {
      toast('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤');
      console.warn('[Professor] ìŠ¤íŠ¸ë¦¼ ì—†ìŒ', { professorCameraStream, localStream, sourceMode, roomId });
      return;
    }
    
    try {
      // í˜„ì¬ URLì„ ê¸°ë°˜ìœ¼ë¡œ viewer ëª¨ë“œ URL ìƒì„±
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('mode', 'viewer');
      currentUrl.searchParams.set('room', roomId);
      currentUrl.searchParams.set('type', 'camera');
      
      // ìƒˆ ë¸Œë¼ìš°ì € ì°½/íƒ­ ì—´ê¸°
      const newWindow = window.open(currentUrl.toString(), '_blank', 'width=1280,height=720');
      
      if (!newWindow) {
        toast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      log('[Professor] ìƒˆ ë¸Œë¼ìš°ì € ì°½ ì—´ê¸°: ' + currentUrl.toString());
      toast('ìƒˆ ë¸Œë¼ìš°ì € ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë””ìŠ¤í”Œë ˆì´ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    } catch(e) {
      console.error('ìƒˆ ë¸Œë¼ìš°ì € ì°½ ì—´ê¸° ì‹¤íŒ¨:', e);
      toast('ìƒˆ ë¸Œë¼ìš°ì € ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  });
}

if (gainSlider) {
  gainSlider.addEventListener('input', () => {
    if (gainNode) {
      const v = parseFloat(gainSlider.value);
      gainNode.gain.value = v;
      if (gainVal) gainVal.textContent = v.toFixed(1);
    }
  });
}

/* ---------------- WebRTC helpers ---------------- */
// ì—¬ëŸ¬ STUN ì„œë²„ë¡œ ì•ˆì •ì„± ë° ì†ë„ í–¥ìƒ
const iceServers = [
  { urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302'] },
  { urls: 'stun:stun2.l.google.com:19302' },
  { urls: 'stun:stun3.l.google.com:19302' }
];

// RTCPeerConnection ì„¤ì • ìµœì í™”
const rtcConfig = {
  iceServers,
  iceCandidatePoolSize: 10, // ICE í›„ë³´ ë¯¸ë¦¬ ìˆ˜ì§‘ (ì—°ê²° ì‹œê°„ ë‹¨ì¶•)
  bundlePolicy: 'max-bundle', // ëª¨ë“  ë¯¸ë””ì–´ë¥¼ í•˜ë‚˜ì˜ ì—°ê²°ë¡œ (íš¨ìœ¨ì„±)
  rtcpMuxPolicy: 'require' // RTCP ë©€í‹°í”Œë ‰ì‹± (í¬íŠ¸ ì‚¬ìš© ìµœì†Œí™”)
};

function createPeer(customHandlers = {}){
  const _pc = new RTCPeerConnection(rtcConfig);
  _pc.oniceconnectionstatechange = customHandlers.oniceconnectionstatechange || (() => { 
    // ICE ì—°ê²° ìƒíƒœ í‘œì‹œ ìˆ¨ê¹€
    // if (infoEl) infoEl.textContent = 'ICE: ' + _pc.iceConnectionState; 
  });
  _pc.onconnectionstatechange = customHandlers.onconnectionstatechange || (() => { 
    // PC ì—°ê²° ìƒíƒœ í‘œì‹œ ìˆ¨ê¹€
    // if (infoEl) infoEl.textContent += ' | PC: ' + _pc.connectionState; 
  });
  return _pc;
}
function preferH264(pc){
  try{
    const txs = typeof pc.getTransceivers === 'function' ? pc.getTransceivers() : [];
    const caps = RTCRtpSender.getCapabilities ? RTCRtpSender.getCapabilities('video') : null;
    if (!caps || !caps.codecs) return;
    const h264 = caps.codecs.filter(c => /H264/i.test(c.mimeType));
    if (!h264.length) return;
    txs.forEach(t => {
      const kind = t?.sender?.track?.kind || t?.kind;
      if (kind === 'video' && typeof t.setCodecPreferences === 'function') {
        const others = caps.codecs.filter(c => !/H264/i.test(c.mimeType));
        t.setCodecPreferences(h264.concat(others));
      }
    });
  }catch(e){ console.warn('preferH264 failed:', e); }
}
async function enableAudioPlayback(){
  try{
    if (comm==='meeting') {
      // ë¯¸íŒ… ëª¨ë“œ: ëª¨ë“  ì›ê²© ë¹„ë””ì˜¤ì˜ ìŒì†Œê±° í•´ì œ
      remoteVideos.forEach(video => {
        if (video) {
          video.muted = false;
          video.removeAttribute('muted');
          video.volume = 1.0;
          video.setAttribute('playsinline','');
          video.setAttribute('webkit-playsinline','');
          video.play().catch(e => {});
        }
      });
      if (audioMirror && audioMirror.srcObject) {
        audioMirror.muted = false;
        audioMirror.removeAttribute('muted');
      }
    } else {
      // ë°©ì†¡ ëª¨ë“œ
      if (player) {
        player.muted = false;
        player.removeAttribute('muted');
        player.volume = 1.0;
        player.setAttribute('playsinline','');
        player.setAttribute('webkit-playsinline','');
      }
      if (audioMirror) {
        audioMirror.muted = false;
        audioMirror.removeAttribute('muted');
      }
    }
    
    // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„ (iOSì™€ ì¼ë°˜ ëª¨ë‘ ë™ì¼)
    if (comm==='meeting') {
      remoteVideos.forEach(video => {
        if (video) video.play().catch(e => {});
      });
    } else {
      if (player) player.play().catch(e => {});
    }
    
    // iOS íŠ¹ë³„ ì²˜ë¦¬: Audio Context í™œì„±í™”
    if (isiOS){
      if (!viewerAudioCtx) viewerAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (viewerAudioCtx.state!=='running'){ try{ await viewerAudioCtx.resume(); }catch(_){} }
      // iOSì—ì„œëŠ” audioMirrorë¥¼ í†µí•´ ì˜¤ë””ì˜¤ ì¬ìƒ ë³´ì¡°
      if (audioMirror && audioMirror.srcObject && viewerAudioCtx.state==='running'){
        try{
          const src = viewerAudioCtx.createMediaStreamSource(audioMirror.srcObject);
          const gain = viewerAudioCtx.createGain(); gain.gain.value = 1.0;
          src.connect(gain).connect(viewerAudioCtx.destination);
        }catch(_){}
      }
    }
    unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
  }catch(e){ console.warn('enableAudioPlayback failed:', e); }
}
function showIOSUnmuteOverlayIfNeeded() {
  if (isiOS) {
    tapUnmuteOverlay.style.display = 'flex';
    unmuteBtn.style.display = 'none';
  }
}
tapUnmuteBtn.addEventListener('click', enableAudioPlayback);
unmuteBtn.addEventListener('click', enableAudioPlayback);

// ë‚´ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
if (togglePreviewBtn) togglePreviewBtn.addEventListener('click', ()=>{
  showLocalPreview = !showLocalPreview;
  if (showLocalPreview) {
    localPreviewWrapper.style.display = 'block';
    togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
  } else {
    localPreviewWrapper.style.display = 'none';
    togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ë³´ê¸°';
  }
});

/* ---------------- Chat Functions ---------------- */
function formatTime(timestamp){
  const d = new Date(timestamp);
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function addChatMessage(senderId, senderName, message, timestamp, isOwn = false){
  if (!chatMessages) return;
  
  const msgDiv = document.createElement('div');
  msgDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;
  
  const senderSpan = document.createElement('div');
  senderSpan.className = 'sender';
  senderSpan.textContent = isOwn ? 'ë‚˜' : (senderName || (senderId ? senderId.substring(0,6) : 'ì•Œ ìˆ˜ ì—†ìŒ'));
  
  const timeSpan = document.createElement('span');
  timeSpan.className = 'time';
  timeSpan.textContent = formatTime(timestamp || Date.now());
  
  const msgText = document.createElement('div');
  msgText.textContent = message || '';
  msgText.style.marginTop = '2px';
  msgText.style.wordBreak = 'break-word';
  
  // ì§ˆë¬¸ ë©”ì‹œì§€ëŠ” ë°ì€ ì ìƒ‰ìœ¼ë¡œ í‘œì‹œ
  if (message && message.includes('ì§ˆë¬¸ìˆìŒ')) {
    msgText.style.color = '#ff4444';
    msgText.style.fontWeight = 'bold';
    msgText.style.fontSize = '14px';
  }
  
  senderSpan.appendChild(timeSpan);
  msgDiv.appendChild(senderSpan);
  msgDiv.appendChild(msgText);
  
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // ìƒˆ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì±„íŒ… ëª¨ë‹¬ ìë™ í‘œì‹œ (ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ ë•Œë§Œ)
  if (!isOwn) {
    showChatModal();
  }
  
  // ë©”ì‹œì§€ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±° (ë©”ëª¨ë¦¬ ê´€ë¦¬)
  const maxMessages = 100;
  while (chatMessages.children.length > maxMessages) {
    chatMessages.removeChild(chatMessages.firstChild);
  }
}

async function sendChatMessage(){
  const message = chatInput.value.trim();
  if (!message || !roomId || !myUserId || !isRunning) {
    if (!isRunning) toast('ë¨¼ì € ê°•ì˜ì‹¤ì— ì°¸ì—¬í•˜ì„¸ìš”');
    return;
  }
  
  // ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ (200ì)
  const trimmedMessage = message.substring(0, 200);
  
  const chatData = {
    senderId: myUserId,
    senderName: role === 'professor' ? 'êµìˆ˜' : `í•™ìƒ ${myUserId.substring(0,6)}`,
    message: trimmedMessage,
    timestamp: Date.now()
  };
  
  try {
    await db.ref(`rooms/${roomId}/chat`).push(chatData);
    chatInput.value = '';
  } catch(e) {
    log('[Chat] ì „ì†¡ ì‹¤íŒ¨: ' + e.message);
    toast('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
    console.error('Chat send error:', e);
  }
}

// ì§ˆë¬¸ ì•Œë¦¼ ì „ì†¡/ì·¨ì†Œ í•¨ìˆ˜ (í•™ìƒ ì „ìš©, í† ê¸€ ê¸°ëŠ¥)
async function sendQuestionNotification(){
  if (!isRunning || role !== 'student' || !roomId || !myUserId) {
    toast('ë¨¼ì € ê°•ì˜ì‹¤ì— ì°¸ì—¬í•˜ì„¸ìš”');
    return;
  }
  
  const studentName = `í•™ìƒ ${myUserId.substring(0,6)}`;
  
  try {
    if (isQuestionRequestActive) {
      // ì§ˆë¬¸ ìš”ì²­ ì·¨ì†Œ
      await db.ref(`rooms/${roomId}/questionRequests/${myUserId}`).remove();
      isQuestionRequestActive = false;
      toast('ì§ˆë¬¸ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
      log('[Student] ì§ˆë¬¸ ìš”ì²­ ì·¨ì†Œ');
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateQuestionButtonState(false);
    } else {
      // ì§ˆë¬¸ ìš”ì²­ ì „ì†¡
      const questionMessage = `${studentName}ê°€ ì§ˆë¬¸ìˆìŒ`;
      
      const chatData = {
        senderId: myUserId,
        senderName: studentName,
        message: questionMessage,
        timestamp: Date.now()
      };
      
      // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
      await db.ref(`rooms/${roomId}/chat`).push(chatData);
      
      // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœë¥¼ Firebaseì— ì €ì¥ (êµìˆ˜ê°€ ê¹œë°•ì„ í‘œì‹œë¥¼ ìœ„í•´)
      await db.ref(`rooms/${roomId}/questionRequests/${myUserId}`).set({
        timestamp: Date.now(),
        status: 'pending'
      });
      
      isQuestionRequestActive = true;
      toast('ì§ˆë¬¸ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤');
      log('[Student] ì§ˆë¬¸ ì•Œë¦¼ ì „ì†¡: ' + questionMessage);
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateQuestionButtonState(true);
    }
  } catch(e) {
    log('[Chat] ì§ˆë¬¸ ì•Œë¦¼ ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message);
    toast('ì§ˆë¬¸ ì•Œë¦¼ ì²˜ë¦¬ ì‹¤íŒ¨');
    console.error('Question notification error:', e);
  }
}

// ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateQuestionButtonState(isActive) {
  // ì±„íŒ… ì„¹ì…˜ ë²„íŠ¼
  if (questionBtn) {
    if (isActive) {
      questionBtn.textContent = 'âŒ ì§ˆë¬¸ ìš”ì²­ ì·¨ì†Œ';
      questionBtn.classList.add('danger');
      questionBtn.classList.remove('primary');
    } else {
      questionBtn.textContent = 'â“ êµìˆ˜ì—ê²Œ ì§ˆë¬¸í•˜ê¸°';
      questionBtn.classList.remove('danger');
      questionBtn.classList.add('primary');
    }
  }
  
  // ë¹„ë””ì˜¤ í™”ë©´ ë²„íŠ¼ë“¤
  document.querySelectorAll('.video-question-btn').forEach(btn => {
    if (isActive) {
      btn.textContent = 'âŒ ì§ˆë¬¸ ì·¨ì†Œ';
      btn.style.background = 'rgba(244,67,54,.8)';
    } else {
      btn.textContent = 'â“ ì§ˆë¬¸í•˜ê¸°';
      btn.style.background = 'rgba(106,166,255,.8)';
    }
  });
}

function initChat(){
  if (!roomId) return;
  
  // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
  if (firebaseListeners.chat) {
    firebaseListeners.chat.off();
  }
  
  // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
  const chatRef = db.ref(`rooms/${roomId}/chat`);
  firebaseListeners.chat = chatRef;
  
  chatRef.on('child_added', snap => {
    try {
      const data = snap.val();
      if (!data || !data.message || typeof data.message !== 'string') return;
      if (!data.senderId || !data.timestamp) return;
      const isOwn = data.senderId === myUserId;
      addChatMessage(data.senderId, data.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ', data.message, data.timestamp, isOwn);
    } catch(e) {
      console.warn('[Chat] ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
    }
  });
}

if (chatSendBtn) chatSendBtn.addEventListener('click', sendChatMessage);
if (chatInput) {
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendChatMessage();
    }
  });
}

// í•™ìƒ ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼
if (questionBtn) {
  questionBtn.addEventListener('click', () => {
    // ë¹„ë””ì˜¤ í™”ë©´ì˜ ì§ˆë¬¸í•˜ê¸° ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ ì‘ë™ (í† ê¸€ ê¸°ëŠ¥)
    sendQuestionNotification();
  });
}

// ì „ì²´í™”ë©´ ë‹«ê¸° ë²„íŠ¼
fsCloseBtn.addEventListener('click', () => {
  try {
    fullscreenVideo.classList.remove('show');
    fsVideo.srcObject = null;
    fsVideo.pause();
  } catch(e) {
    console.error('Fullscreen close error:', e);
  }
});

// ì „ì²´í™”ë©´ ì§ˆë¬¸ ë²„íŠ¼
if (fullscreenQuestionBtn) {
  fullscreenQuestionBtn.addEventListener('click', () => {
    sendQuestionNotification();
  });
}

// ESC í‚¤ë¡œ ì „ì²´í™”ë©´ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && fullscreenVideo.classList.contains('show')) {
    fsCloseBtn.click();
  }
});


/* ---------------- Media Builders ---------------- */
async function getCameraStream(deviceId = null){
  try {
    const videoConstraints = {
      width:  { ideal: 1280, max: 1920 },
      height: { ideal: 720,  max: 1080 },
      frameRate: { ideal: 30, max: 60 }
    };
    
    // íŠ¹ì • deviceIdê°€ ì œê³µë˜ë©´ í•´ë‹¹ ì¹´ë©”ë¼ ì‚¬ìš©
    if (deviceId) {
      videoConstraints.deviceId = { exact: deviceId };
    } else {
      // deviceIdê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ facingMode ì‚¬ìš©
      videoConstraints.facingMode = facingMode;
    }
    
    return await navigator.mediaDevices.getUserMedia({
      video: videoConstraints,
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
  } catch(e) {
    log('[Camera] ì¹´ë©”ë¼/ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: ' + e.message);
    toast('ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
    throw e;
  }
}

// ëª¨ë“  ì¹´ë©”ë¼ ë””ë°”ì´ìŠ¤ ê°ì§€
async function enumerateAllCameras(){
  try {
    // ë¨¼ì € ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ (enumerateDevicesëŠ” ê¶Œí•œì´ ìˆì–´ì•¼ deviceIdë¥¼ ë°˜í™˜)
    await navigator.mediaDevices.getUserMedia({ video: true });
    
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    
    log(`[Camera] ê°ì§€ëœ ì¹´ë©”ë¼ ìˆ˜: ${videoDevices.length}`);
    videoDevices.forEach((device, index) => {
      log(`[Camera] ${index + 1}. ${device.label || `ì¹´ë©”ë¼ ${index + 1}`} (ID: ${device.deviceId.substring(0, 20)}...)`);
    });
    
    return videoDevices;
  } catch(e) {
    log('[Camera] ì¹´ë©”ë¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + e.message);
    console.error('ì¹´ë©”ë¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', e);
    return [];
  }
}

// íŠ¹ì • ì¹´ë©”ë¼ì—ì„œ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
async function getCameraStreamByDeviceId(deviceId, deviceLabel){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        deviceId: { exact: deviceId },
        width:  { ideal: 1280, max: 1920 },
        height: { ideal: 720,  max: 1080 },
        frameRate: { ideal: 30, max: 60 }
      },
      audio: false  // ê° ì¹´ë©”ë¼ë§ˆë‹¤ ì˜¤ë””ì˜¤ëŠ” ì œì™¸ (ì¤‘ë³µ ë°©ì§€)
    });
    
    log(`[Camera] ${deviceLabel || 'ì¹´ë©”ë¼'} ìŠ¤íŠ¸ë¦¼ íšë“ ì„±ê³µ`);
    return stream;
  } catch(e) {
    log(`[Camera] ${deviceLabel || 'ì¹´ë©”ë¼'} ìŠ¤íŠ¸ë¦¼ íšë“ ì‹¤íŒ¨: ${e.message}`);
    console.error(`ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì˜¤ë¥˜ (${deviceLabel}):`, e);
    throw e;
  }
}

// IP ì¹´ë©”ë¼ ì¶”ê°€ (íœ´ëŒ€í° WiFi ì¹´ë©”ë¼ìš©)
async function addIPCamera(ipUrl){
  try {
    if (ipCameraUrls.has(ipUrl)) {
      toast('ì´ë¯¸ ì¶”ê°€ëœ IP ì¹´ë©”ë¼ì…ë‹ˆë‹¤');
      return;
    }
    
    ipCameraUrls.add(ipUrl);
    log(`[IP Camera] IP ì¹´ë©”ë¼ ì¶”ê°€: ${ipUrl}`);
    
    // DroidCam URL í˜•ì‹ ì§€ì›
    // DroidCam ê¸°ë³¸ í¬íŠ¸: 4747
    // í˜•ì‹: http://IPì£¼ì†Œ:4747/video ë˜ëŠ” http://IPì£¼ì†Œ:4747/mjpegfeed?640x480
    let finalUrl = ipUrl;
    if (!ipUrl.includes('://')) {
      // URL í˜•ì‹ì´ ì•„ë‹ˆë©´ http:// ì¶”ê°€
      finalUrl = 'http://' + ipUrl;
    }
    if (!finalUrl.includes('/video') && !finalUrl.includes('/mjpegfeed')) {
      // ê²½ë¡œê°€ ì—†ìœ¼ë©´ /video ì¶”ê°€ (DroidCam ê¸°ë³¸)
      if (finalUrl.endsWith('/')) {
        finalUrl += 'video';
      } else {
        finalUrl += '/video';
      }
    }
    
    // IP ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìƒì„±
    const video = document.createElement('video');
    video.crossOrigin = 'anonymous';
    video.autoplay = true;
    video.playsInline = true;
    video.muted = true;
    video.src = finalUrl;
    
    // canvasë¥¼ ì‚¬ìš©í•˜ì—¬ MediaStream ìƒì„±
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 640;
    canvas.height = 480;
    
    let stream = null;
    
    video.onloadedmetadata = () => {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
    };
    
    const drawFrame = () => {
      if (video.readyState >= 2 && video.videoWidth > 0) {
        try {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        } catch(e) {
          console.warn('Canvas drawImage ì˜¤ë¥˜:', e);
        }
      }
      requestAnimationFrame(drawFrame);
    };
    
    video.onplay = () => {
      drawFrame();
    };
    
    // canvasì—ì„œ MediaStream ìƒì„±
    stream = canvas.captureStream(30);
    
    // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
    try {
      await video.play();
    } catch(e) {
      console.warn('IP ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', e);
      log(`[IP Camera] ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨: ${e.message}`);
    }
    
    ipCameraStreams.set(ipUrl, { stream, videoElement: video, canvas, finalUrl });
    
    // ì¹´ë©”ë¼ ê·¸ë¦¬ë“œì— ì¶”ê°€
    const camerasGrid = document.getElementById('allCamerasGrid');
    if (camerasGrid) {
      const videoWrapper = document.createElement('div');
      videoWrapper.className = 'camera-video-wrapper';
      videoWrapper.style.cssText = 'position: relative; background: #000; border-radius: 8px; overflow: hidden; min-height: 200px;';
      videoWrapper.dataset.ipUrl = ipUrl;
      
      const displayVideo = document.createElement('video');
      displayVideo.autoplay = true;
      displayVideo.playsInline = true;
      displayVideo.muted = true;
      displayVideo.style.cssText = 'width: 100%; height: auto; display: block;';
      displayVideo.srcObject = stream;
      
      const label = document.createElement('small');
      const displayUrl = finalUrl.length > 50 ? finalUrl.substring(0, 47) + '...' : finalUrl;
      label.textContent = `WiFi ì¹´ë©”ë¼ (${displayUrl})`;
      label.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; z-index: 10;';
      
      // ì „ì²´í™”ë©´ ë²„íŠ¼
      const fullscreenBtn = document.createElement('button');
      fullscreenBtn.textContent = 'â›¶';
      fullscreenBtn.className = 'camera-fullscreen-btn';
      fullscreenBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: #fff; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; z-index: 10;';
      fullscreenBtn.title = 'ì „ì²´í™”ë©´';
      fullscreenBtn.addEventListener('click', () => {
        if (fsVideo) {
          fsVideo.srcObject = stream;
          fullscreenVideo.classList.add('show');
          // í•™ìƒì¼ ë•Œë§Œ ì „ì²´í™”ë©´ ì§ˆë¬¸ ë²„íŠ¼ í‘œì‹œ
          if (fullscreenQuestionBtn) {
            fullscreenQuestionBtn.style.display = (role === 'student') ? 'block' : 'none';
          }
          fsVideo.setAttribute('playsinline', '');
          fsVideo.setAttribute('webkit-playsinline', '');
          fsVideo.play().catch(e => {
            console.warn('IP ì¹´ë©”ë¼ ì „ì²´í™”ë©´ ì¬ìƒ ì‹¤íŒ¨:', e);
          });
        }
      });
      
      // ì‚­ì œ ë²„íŠ¼
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Ã—';
      deleteBtn.style.cssText = 'position: absolute; top: 8px; right: 40px; background: rgba(255,106,106,0.8); color: #fff; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; z-index: 10;';
      deleteBtn.title = 'ì‚­ì œ';
      deleteBtn.addEventListener('click', () => {
        removeIPCamera(ipUrl);
      });
      
      videoWrapper.appendChild(displayVideo);
      videoWrapper.appendChild(label);
      videoWrapper.appendChild(fullscreenBtn);
      videoWrapper.appendChild(deleteBtn);
      camerasGrid.appendChild(videoWrapper);
      
      // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
      try {
        await displayVideo.play();
      } catch(playError) {
        console.warn(`IP ì¹´ë©”ë¼ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:`, playError);
      }
    }
    
    // allCameraStreamsì—ë„ ì¶”ê°€ (í•™ìƒì—ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•´)
    allCameraStreams.set(`ip-${ipUrl}`, stream);
    
    log(`[IP Camera] DroidCam/IP ì¹´ë©”ë¼ ì¶”ê°€ ì™„ë£Œ: ${finalUrl}`);
    toast('WiFi ì¹´ë©”ë¼(DroidCam)ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    
    // ê¸°ì¡´ í•™ìƒ ì—°ê²°ì—ë„ IP ì¹´ë©”ë¼ ì¶”ê°€
    if (role === 'professor' && peerConnections.size > 0) {
      peerConnections.forEach((_pc, vid) => {
        try {
          const videoTrack = stream.getVideoTracks()[0];
          if (videoTrack) {
            const cameraMediaStream = new MediaStream([videoTrack]);
            _pc.addTrack(videoTrack, cameraMediaStream);
            log(`[Professor] ê¸°ì¡´ í•™ìƒ ${vid.substring(0,6)}ì—ê²Œ IP ì¹´ë©”ë¼ ì¶”ê°€: ${ipUrl}`);
          }
        } catch(e) {
          console.warn(`[Professor] í•™ìƒ ${vid}ì—ê²Œ IP ì¹´ë©”ë¼ ì¶”ê°€ ì‹¤íŒ¨:`, e);
        }
      });
    }
    
  } catch(e) {
    log(`[IP Camera] IP ì¹´ë©”ë¼ ì¶”ê°€ ì‹¤íŒ¨: ${e.message}`);
    console.error('IP ì¹´ë©”ë¼ ì¶”ê°€ ì˜¤ë¥˜:', e);
    toast('IP ì¹´ë©”ë¼ ì¶”ê°€ ì‹¤íŒ¨: ' + e.message);
    ipCameraUrls.delete(ipUrl);
  }
}

// IP ì¹´ë©”ë¼ ì œê±°
function removeIPCamera(ipUrl){
  const ipCamera = ipCameraStreams.get(ipUrl);
  if (ipCamera) {
    if (ipCamera.videoElement) {
      ipCamera.videoElement.pause();
      ipCamera.videoElement.src = '';
    }
    if (ipCamera.stream) {
      ipCamera.stream.getTracks().forEach(track => track.stop());
    }
    ipCameraStreams.delete(ipUrl);
  }
  
  allCameraStreams.delete(`ip-${ipUrl}`);
  ipCameraUrls.delete(ipUrl);
  
  // UIì—ì„œ ì œê±°
  const videoWrapper = document.querySelector(`[data-ip-url="${ipUrl}"]`);
  if (videoWrapper) {
    videoWrapper.remove();
  }
  
  log(`[IP Camera] IP ì¹´ë©”ë¼ ì œê±°: ${ipUrl}`);
  toast('WiFi ì¹´ë©”ë¼ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ëª¨ë“  ì¹´ë©”ë¼ ì˜ìƒ í‘œì‹œ
async function displayAllCameras(){
  try {
    // ê¸°ì¡´ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
    cleanupAllCameras();
    
    // ëª¨ë“  ì¹´ë©”ë¼ ê°ì§€
    const cameras = await enumerateAllCameras();
    
    // DroidCam ì¤‘ë³µ ì œê±°: IP ì¹´ë©”ë¼ë¡œ ì¶”ê°€ëœ DroidCamì€ ì¼ë°˜ ì¹´ë©”ë¼ ëª©ë¡ì—ì„œ ì œì™¸
    // Prezi Camera ì œê±°
    const filteredCameras = cameras.filter(camera => {
      const label = (camera.label || '').toLowerCase();
      const isDroidCam = label.includes('droidcam');
      const isPrezi = label.includes('prezi');
      
      // Prezi Camera ì œì™¸
      if (isPrezi) {
        log(`[Camera] Prezi Camera ì œê±°: ${camera.label}`);
        return false;
      }
      
      if (isDroidCam && ipCameraUrls.size > 0) {
        // DroidCamì´ê³  IP ì¹´ë©”ë¼ê°€ ì¶”ê°€ëœ ê²½ìš°, IP ì¹´ë©”ë¼ë¡œ ì¶”ê°€ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ì œì™¸
        log(`[Camera] DroidCam ì¤‘ë³µ ì œê±°: ${camera.label} (IP ì¹´ë©”ë¼ë¡œ ì´ë¯¸ ì¶”ê°€ë¨)`);
        return false;
      }
      return true;
    });
    
    if (filteredCameras.length === 0 && ipCameraUrls.size === 0) {
      log('[Camera] ê°ì§€ëœ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤');
      toast('ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    // ì¹´ë©”ë¼ ì˜ìƒì„ í‘œì‹œí•  ì»¨í…Œì´ë„ˆ ìƒì„± ë˜ëŠ” ì°¾ê¸°
    let camerasContainer = document.getElementById('allCamerasContainer');
    if (!camerasContainer) {
      camerasContainer = document.createElement('div');
      camerasContainer.id = 'allCamerasContainer';
      camerasContainer.className = 'all-cameras-container';
      camerasContainer.style.cssText = 'margin-top: 16px; padding: 16px; background: rgba(13,20,51,0.6); border-radius: 12px; border: 1px solid #2a3a77;';
      
      const title = document.createElement('h3');
      title.textContent = 'ì—°ê²°ëœ ëª¨ë“  ì¹´ë©”ë¼';
      title.style.cssText = 'margin: 0 0 12px 0; font-size: 16px; color: #eaf0ff;';
      camerasContainer.appendChild(title);
      
      // IP ì¹´ë©”ë¼ ì¶”ê°€ ë²„íŠ¼
      const addIPCameraBtn = document.createElement('button');
      addIPCameraBtn.textContent = '+ WiFi ì¹´ë©”ë¼ ì¶”ê°€';
      addIPCameraBtn.className = 'primary';
      addIPCameraBtn.style.cssText = 'margin-bottom: 12px; padding: 6px 12px; font-size: 12px;';
      addIPCameraBtn.addEventListener('click', () => {
        const ipUrl = prompt('íœ´ëŒ€í° ì¹´ë©”ë¼ URLì„ ì…ë ¥í•˜ì„¸ìš”\n\nDroidCam ì‚¬ìš© ì‹œ:\n- WiFi: http://IPì£¼ì†Œ:4747/video\n- ì˜ˆ: http://192.168.0.100:4747/video\n\nIP Webcam ì‚¬ìš© ì‹œ:\n- ì˜ˆ: http://192.168.0.100:8080/video\n\në˜ëŠ” DroidCamì´ ê°€ìƒ ì›¹ìº ìœ¼ë¡œ ì¸ì‹ë˜ë©´ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤.');
        if (ipUrl && ipUrl.trim()) {
          addIPCamera(ipUrl.trim());
        }
      });
      camerasContainer.appendChild(addIPCameraBtn);
      
      const camerasGrid = document.createElement('div');
      camerasGrid.id = 'allCamerasGrid';
      camerasGrid.className = 'all-cameras-grid';
      camerasGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;';
      camerasContainer.appendChild(camerasGrid);
      
      // meetingVideos ì„¹ì…˜ì— ì¶”ê°€
      if (meetingVideos) {
        meetingVideos.appendChild(camerasContainer);
      }
    }
    
    const camerasGrid = document.getElementById('allCamerasGrid');
    if (!camerasGrid) {
      throw new Error('ì¹´ë©”ë¼ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // ê° ì¹´ë©”ë¼ì— ëŒ€í•´ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° ë° í‘œì‹œ
    for (const camera of filteredCameras) {
      try {
        // ì¤‘ë³µ ì²´í¬: ì´ë¯¸ ì¶”ê°€ëœ ì¹´ë©”ë¼ëŠ” ìŠ¤í‚µ
        if (allCameraStreams.has(camera.deviceId)) {
          log(`[Camera] ì¤‘ë³µ ì¹´ë©”ë¼ ìŠ¤í‚µ: ${camera.label} (deviceId: ${camera.deviceId})`);
          continue;
        }
        
        // ê·¸ë¦¬ë“œì— ì´ë¯¸ í•´ë‹¹ ì¹´ë©”ë¼ê°€ ìˆëŠ”ì§€ í™•ì¸
        const existingWrapper = document.querySelector(`[data-device-id="${camera.deviceId}"]`);
        if (existingWrapper) {
          log(`[Camera] ê·¸ë¦¬ë“œì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´ë©”ë¼ ìŠ¤í‚µ: ${camera.label}`);
          continue;
        }
        
        const stream = await getCameraStreamByDeviceId(camera.deviceId, camera.label);
        allCameraStreams.set(camera.deviceId, stream);
        
        // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        const videoWrapper = document.createElement('div');
        videoWrapper.className = 'camera-video-wrapper';
        videoWrapper.dataset.deviceId = camera.deviceId; // ì¤‘ë³µ ì²´í¬ìš© data ì†ì„± ì¶”ê°€
        videoWrapper.style.cssText = 'position: relative; background: #000; border-radius: 6px; overflow: hidden; min-height: 100px;';
        
        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;
        video.style.cssText = 'width: 100%; height: auto; display: block;';
        video.srcObject = stream;
        
        const label = document.createElement('small');
        label.textContent = camera.label || `ì¹´ë©”ë¼ ${filteredCameras.indexOf(camera) + 1}`;
        label.style.cssText = 'position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; z-index: 10;';
        
        videoWrapper.appendChild(video);
        videoWrapper.appendChild(label);
        camerasGrid.appendChild(videoWrapper);
        
        allCameraVideos.set(camera.deviceId, video);
        
        // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
        try {
          await video.play();
        } catch(playError) {
          console.warn(`ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨ (${camera.label}):`, playError);
        }
        
        // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ê°ì§€
        stream.getVideoTracks().forEach(track => {
          track.onended = () => {
            log(`[Camera] ${camera.label || 'ì¹´ë©”ë¼'} ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œë¨`);
            cleanupCamera(camera.deviceId);
          };
        });
        
      } catch(cameraError) {
        console.error(`ì¹´ë©”ë¼ ${camera.label} ì²˜ë¦¬ ì‹¤íŒ¨:`, cameraError);
        log(`[Camera] ${camera.label || 'ì¹´ë©”ë¼'} ì²˜ë¦¬ ì‹¤íŒ¨: ${cameraError.message}`);
      }
    }
    
    log(`[Camera] ì´ ${allCameraStreams.size}ê°œì˜ ì¹´ë©”ë¼ ì˜ìƒ í‘œì‹œ ì™„ë£Œ`);
    toast(`${allCameraStreams.size}ê°œì˜ ì¹´ë©”ë¼ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤`);
    
    // ê¸°ì¡´ í•™ìƒ ì—°ê²°ì—ë„ ëª¨ë“  ì¹´ë©”ë¼ ì¶”ê°€
    if (role === 'professor' && peerConnections.size > 0) {
      peerConnections.forEach((_pc, vid) => {
        allCameraStreams.forEach((cameraStream, deviceId) => {
          const videoTrack = cameraStream.getVideoTracks()[0];
          if (videoTrack && videoTrack.readyState === 'live') {
            try {
              const cameraLabel = videoTrack.label || `ì¹´ë©”ë¼ ${Array.from(allCameraStreams.keys()).indexOf(deviceId) + 1}`;
              const cameraMediaStream = new MediaStream([videoTrack]);
              _pc.addTrack(videoTrack, cameraMediaStream);
              log(`[Professor] ê¸°ì¡´ í•™ìƒ ${vid.substring(0,6)}ì—ê²Œ ì¹´ë©”ë¼ ì¶”ê°€: ${cameraLabel}`);
            } catch(e) {
              console.warn(`[Professor] í•™ìƒ ${vid}ì—ê²Œ ì¹´ë©”ë¼ ì¶”ê°€ ì‹¤íŒ¨:`, e);
            }
          }
        });
      });
    }
    
  } catch(e) {
    log('[Camera] ëª¨ë“  ì¹´ë©”ë¼ í‘œì‹œ ì‹¤íŒ¨: ' + e.message);
    console.error('ëª¨ë“  ì¹´ë©”ë¼ í‘œì‹œ ì˜¤ë¥˜:', e);
    toast('ì¹´ë©”ë¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
  }
}

// íŠ¹ì • ì¹´ë©”ë¼ ì •ë¦¬
function cleanupCamera(deviceId){
  const stream = allCameraStreams.get(deviceId);
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    allCameraStreams.delete(deviceId);
  }
  
  const video = allCameraVideos.get(deviceId);
  if (video) {
    video.srcObject = null;
    video.parentElement?.remove();
    allCameraVideos.delete(deviceId);
  }
}

// ëª¨ë“  ì¹´ë©”ë¼ ì •ë¦¬
function cleanupAllCameras(){
  allCameraStreams.forEach((stream, deviceId) => {
    stream.getTracks().forEach(track => track.stop());
  });
  allCameraStreams.clear();
  
  allCameraVideos.forEach((video) => {
    video.srcObject = null;
    video.parentElement?.remove();
  });
  allCameraVideos.clear();
  
  // IP ì¹´ë©”ë¼ ì •ë¦¬
  ipCameraStreams.forEach((ipCamera, ipUrl) => {
    if (ipCamera.videoElement) {
      ipCamera.videoElement.pause();
      ipCamera.videoElement.src = '';
    }
    if (ipCamera.stream) {
      ipCamera.stream.getTracks().forEach(track => track.stop());
    }
  });
  ipCameraStreams.clear();
  ipCameraUrls.clear();
  
  const camerasContainer = document.getElementById('allCamerasContainer');
  if (camerasContainer) {
    camerasContainer.remove();
  }
}

// í•™ìƒ: êµìˆ˜ì˜ ëª¨ë“  ì¹´ë©”ë¼ë¥¼ ê·¸ë¦¬ë“œë¡œ í‘œì‹œ (ë¹„í™œì„±í™”ë¨)
function displayStudentAllCameras(){
  // ê¸°ëŠ¥ ë¹„í™œì„±í™” - í•™ìƒ í™”ë©´ì—ì„œ ì—°ê²°ëœ ëª¨ë“  ì¹´ë©”ë¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
  // ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì œê±°
  const studentCamerasContainer = document.getElementById('studentAllCamerasContainer');
  if (studentCamerasContainer) {
    studentCamerasContainer.remove();
  }
  return;
}

async function getScreenStream(){
  try{
    return await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch(e){
    log('[Professor] getDisplayMedia with audio failed, retry video-only');
    try {
      return await navigator.mediaDevices.getDisplayMedia({ video:true }); // ì¬ì‹œë„
    } catch(e2) {
      log('[Professor] í™”ë©´ê³µìœ  ì‹¤íŒ¨: ' + e2.message);
      toast('í™”ë©´ê³µìœ  ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
      throw e2;
    }
  }
}

async function makeAmplifiedStreamFrom(sourceStream, fallbackUseMic=true){
  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  const initialGain = parseFloat(gainSlider?.value || '2') || 2.0;
  gainNode.gain.value = initialGain;
  if (gainVal) gainVal.textContent = initialGain.toFixed(1);

  const videoTracks = sourceStream.getVideoTracks();
  const inAudioTracks = sourceStream.getAudioTracks();
  let outputAudioTrack = null;

  if (inAudioTracks.length){
    const src = audioCtx.createMediaStreamSource(sourceStream);
    const dest = audioCtx.createMediaStreamDestination();
    src.connect(gainNode).connect(dest);
    outputAudioTrack = dest.stream.getAudioTracks()[0];
  } else if (fallbackUseMic){
    try{
      const mic = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } });
      const src = audioCtx.createMediaStreamSource(mic);
      const dest = audioCtx.createMediaStreamDestination();
      src.connect(gainNode).connect(dest);
      outputAudioTrack = dest.stream.getAudioTracks()[0];
    }catch(e){ log('[Audio] ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: '+e.message); }
  }

  return outputAudioTrack ? new MediaStream([...videoTracks, outputAudioTrack]) : new MediaStream([...videoTracks]);
}

/* ---------------- êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ---------------- */
function openProfessorCameraWindow(cameraStream, isScreenShareMode = false, screenInfo = null) {
  if (!cameraStream || !cameraStream.getVideoTracks()[0]) {
    log('[Professor] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ì–´ ë³„ë„ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // ê¸°ì¡´ ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  if (professorCameraWindow && !professorCameraWindow.closed) {
    professorCameraWindow.close();
  }
  
  try {
    let windowLeft = 100;
    let windowTop = 100;
    let windowWidth = 800;
    let windowHeight = 600;
    
    // Screen API ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if (window.screen && window.screen.availWidth) {
      const availWidth = window.screen.availWidth;
      const availHeight = window.screen.availHeight;
      
      if (isScreenShareMode && screenInfo) {
        // í™”ë©´ê³µìœ  ëª¨ë“œ: ê³µìœ ë˜ëŠ” í™”ë©´ì˜ í¬ê¸° ì •ë³´ ì‚¬ìš©
        const sharedScreenWidth = screenInfo.screenWidth || window.screen.width;
        const sharedScreenHeight = screenInfo.screenHeight || window.screen.height;
        
        // ê°€ë¡œëŠ” ê³µìœ  í™”ë©´ì˜ 1/6, ì„¸ë¡œëŠ” ê³µìœ  í™”ë©´ì˜ 1/4 í¬ê¸°ë¡œ ì„¤ì •
        windowWidth = Math.floor(sharedScreenWidth / 6);
        windowHeight = Math.floor(sharedScreenHeight / 4);
        
        // ê³µìœ  í™”ë©´ì˜ ì¤‘ì•™ì— ë°°ì¹˜
        windowLeft = Math.floor((sharedScreenWidth - windowWidth) / 2);
        windowTop = Math.floor((sharedScreenHeight - windowHeight) / 2);
        
        log(`[Professor] í™”ë©´ê³µìœ  ëª¨ë“œ: ê³µìœ  í™”ë©´ í¬ê¸° ${sharedScreenWidth}x${sharedScreenHeight}, ì°½ í¬ê¸° ${windowWidth}x${windowHeight}, ìœ„ì¹˜: ${windowLeft},${windowTop} (ì¤‘ì•™)`);
      } else {
        // ì¼ë°˜ ëª¨ë“œ: ê¸°ì¡´ ë¡œì§ ìœ ì§€
        const primaryScreenWidth = window.screen.width;
        const primaryScreenHeight = window.screen.height;
        
        // ë‘ ë²ˆì§¸ ë””ìŠ¤í”Œë ˆì´ ìœ„ì¹˜ ì¶”ì • (ì£¼ ë””ìŠ¤í”Œë ˆì´ ë„ˆë¹„ + ì˜¤í”„ì…‹)
        windowLeft = primaryScreenWidth + 50;
        windowTop = 50;
        
        // ì°½ í¬ê¸°ë¥¼ ë” í¬ê²Œ ì„¤ì • (í”„ë ˆì  í…Œì´ì…˜ìš©)
        windowWidth = Math.min(1280, availWidth * 0.8);
        windowHeight = Math.min(720, availHeight * 0.8);
        
        log(`[Professor] ë””ìŠ¤í”Œë ˆì´ ì •ë³´: ${primaryScreenWidth}x${primaryScreenHeight}, ì°½ ìœ„ì¹˜: ${windowLeft},${windowTop}`);
      }
    }
    
    // ìƒˆ ì°½ ì—´ê¸° - CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™”
    // ì°¸ê³ : ìµœì‹  ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ì£¼ì†Œì°½ì„ ì™„ì „íˆ ì œê±°í•˜ëŠ” ê²ƒì€ ì œí•œì ì¼ ìˆ˜ ìˆìŒ
    // í•˜ì§€ë§Œ ê°€ëŠ¥í•œ ëª¨ë“  UI ìš”ì†Œë¥¼ ì œê±°í•˜ì—¬ CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
    const windowFeatures = `width=${windowWidth},height=${windowHeight},left=${windowLeft},top=${windowTop},resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,directories=no,titlebar=no`;
    professorCameraWindow = window.open('about:blank', 'professorCameraWindow', windowFeatures);
    
    if (!professorCameraWindow) {
      toast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
      log('[Professor] íŒì—… ì°½ ì—´ê¸° ì‹¤íŒ¨ (íŒì—… ì°¨ë‹¨)');
      return;
    }
    
    // ì°½ HTML ì‘ì„± - CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™”
    // ì£¼ì†Œì°½ì´ ë³´ì´ë”ë¼ë„ ìµœì†Œí•œì˜ ê³µê°„ë§Œ ì‚¬ìš©í•˜ê³  ë¹„ë””ì˜¤ ì˜ì—­ì„ ìµœëŒ€í™”
    const windowHTML = `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      background: #000;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: ui-sans-serif, system-ui, sans-serif;
      /* ì£¼ì†Œì°½ ì˜ì—­ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•œ ì„¤ì • */
      position: fixed;
      top: 0;
      left: 0;
    }
    .drag-header {
      /* êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ì—ì„œëŠ” ì˜ìƒë§Œ ë³´ì´ë„ë¡ í—¤ë”ë¥¼ ì™„ì „íˆ ìˆ¨ê¹€ */
      display: none !important;
    }
    .drag-header .title {
      color: #fff;
      font-size: 12px;
      font-weight: bold;
      flex: 1;
      pointer-events: none;
      opacity: 0.9;
    }
    .drag-header .header-buttons {
      display: flex;
      gap: 6px;
      align-items: center;
      -webkit-app-region: no-drag;
    }
    .video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      /* CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™” */
      margin: 0;
      padding: 0;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      /* ë¹„ë””ì˜¤ê°€ ì „ì²´ CONTENT AREAë¥¼ ì‚¬ìš©í•˜ë„ë¡ */
      display: block;
      margin: 0;
      padding: 0;
    }
    .title {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 10;
      font-weight: bold;
      display: none;
    }
    .header-btn {
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
      min-width: 70px;
      opacity: 0.9;
    }
    .header-btn:hover {
      background: rgba(0,0,0,0.8);
      border-color: rgba(255,255,255,0.5);
      opacity: 1;
    }
    .close-btn {
      background: rgba(255,106,106,0.7);
      color: #fff;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all 0.2s;
      opacity: 0.9;
    }
    .close-btn:hover {
      background: rgba(255,106,106,1);
      opacity: 1;
      transform: scale(1.1);
    }
    .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    .control-btn {
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    .control-btn:hover {
      background: rgba(0,0,0,0.9);
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="cameraVideo" autoplay playsinline muted></video>
    <div class="drag-header" id="dragHeader">
      <div class="title">êµìˆ˜ ì¹´ë©”ë¼</div>
      <div class="header-buttons">
        <button class="header-btn" id="fullscreenBtn">â›¶ ì „ì²´í™”ë©´</button>
        <button class="close-btn" id="closeBtn" title="ë‹«ê¸°">Ã—</button>
      </div>
    </div>
  </div>
</body>
</html>`;
    
    professorCameraWindow.document.write(windowHTML);
    
    // ìŠ¤íŠ¸ë¦¼ì„ ìƒˆ ì°½ì— ì „ë‹¬
    professorCameraWindow.document.close();
    
    // CONTENT AREAë§Œ ì‚¬ìš©í•˜ë„ë¡ ìµœì í™”
    // ì£¼ì†Œì°½ì´ ë³´ì´ë”ë¼ë„ ë¹„ë””ì˜¤ ì˜ì—­ì„ ìµœëŒ€í™”í•˜ê¸° ìœ„í•œ ì‹œë„
    try {
      const optimizeContentArea = () => {
        try {
          if (professorCameraWindow && !professorCameraWindow.closed) {
            // ì£¼ì†Œì°½ ë†’ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì°½ í¬ê¸° ì¡°ì •
            // ì£¼ì†Œì°½ ë†’ì´ëŠ” ë¸Œë¼ìš°ì €ë§ˆë‹¤ ë‹¤ë¥´ì§€ë§Œ ì•½ 40-60px ì •ë„
            const addressBarHeight = 60;
            const adjustedHeight = windowHeight + addressBarHeight;
            
            // ì°½ í¬ê¸° ì¡°ì •
            professorCameraWindow.resizeTo(windowWidth, adjustedHeight);
            
            // ì°½ ë‚´ë¶€ì˜ bodyê°€ ì „ì²´ CONTENT AREAë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
            const doc = professorCameraWindow.document;
            if (doc && doc.body) {
              doc.body.style.margin = '0';
              doc.body.style.padding = '0';
              doc.body.style.width = '100vw';
              doc.body.style.height = '100vh';
              doc.body.style.overflow = 'hidden';
              doc.body.style.position = 'fixed';
              doc.body.style.top = '0';
              doc.body.style.left = '0';
            }
            
            // html ìš”ì†Œë„ ìµœì í™”
            if (doc && doc.documentElement) {
              doc.documentElement.style.margin = '0';
              doc.documentElement.style.padding = '0';
              doc.documentElement.style.width = '100vw';
              doc.documentElement.style.height = '100vh';
              doc.documentElement.style.overflow = 'hidden';
            }
          }
        } catch(e) {
          // ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìŒ
          console.warn('[Professor] CONTENT AREA ìµœì í™” ì‹¤íŒ¨:', e);
        }
      };
      
      if (professorCameraWindow.document.readyState === 'complete') {
        setTimeout(optimizeContentArea, 100);
        setTimeout(optimizeContentArea, 500); // ì¬ì‹œë„
      } else {
        professorCameraWindow.addEventListener('load', () => {
          setTimeout(optimizeContentArea, 100);
          setTimeout(optimizeContentArea, 500); // ì¬ì‹œë„
        });
      }
    } catch(e) {
      console.warn('[Professor] CONTENT AREA ìµœì í™” ì„¤ì • ì‹¤íŒ¨:', e);
    }
    
    // ìŠ¤íŠ¸ë¦¼ ì„¤ì • (ë¬¸ì„œ ë¡œë“œ í›„)
    const setStream = () => {
      try {
        const video = professorCameraWindow.document.getElementById('cameraVideo');
        if (video && cameraStream) {
          video.srcObject = cameraStream;
          video.play().catch(e => {
            console.warn('[Professor] ë³„ë„ ì°½ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', e);
          });
        }
      } catch(e) {
        console.error('[Professor] ë³„ë„ ì°½ ìŠ¤íŠ¸ë¦¼ ì„¤ì • ì‹¤íŒ¨:', e);
      }
    };
    
    // ì°½ì´ ë¡œë“œëœ í›„ ìŠ¤íŠ¸ë¦¼ ì„¤ì • ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
    const setupWindow = () => {
      setStream();
      
      // ë“œë˜ê·¸ ê¸°ëŠ¥ êµ¬í˜„ (ì°½ ì´ë™)
      try {
        const dragHeader = professorCameraWindow.document.getElementById('dragHeader');
        if (dragHeader) {
          let isDragging = false;
          let startX, startY, startLeft, startTop;
          
          const startDrag = (clientX, clientY) => {
            // ë²„íŠ¼ í´ë¦­ì€ ë“œë˜ê·¸ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            const target = professorCameraWindow.document.elementFromPoint(clientX, clientY);
            if (target && (target.tagName === 'BUTTON' || target.closest('.header-buttons'))) {
              return false;
            }
            
            startX = clientX;
            startY = clientY;
            startLeft = professorCameraWindow.screenX;
            startTop = professorCameraWindow.screenY;
            isDragging = true;
            dragHeader.style.cursor = 'grabbing';
            dragHeader.style.opacity = '0.95';
            return true;
          };
          
          const doDrag = (clientX, clientY) => {
            if (!isDragging) return;
            
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;
            
            try {
              const newLeft = startLeft + deltaX;
              const newTop = startTop + deltaY;
              
              // ì°½ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì‘ë™)
              professorCameraWindow.moveTo(newLeft, newTop);
            } catch(err) {
              // ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì°½ ì´ë™ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ
              // ì´ ê²½ìš° ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ë“œë˜ê·¸ ë™ì‘ì„ ì‚¬ìš©
              console.warn('ì°½ ì´ë™ ì œí•œ (ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ì‚¬ìš©):', err);
            }
          };
          
          const stopDrag = () => {
            if (isDragging) {
              isDragging = false;
              dragHeader.style.cursor = 'move';
              dragHeader.style.opacity = '1';
            }
          };
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
          dragHeader.addEventListener('mousedown', (e) => {
            if (startDrag(e.clientX, e.clientY)) {
              e.preventDefault();
            }
          });
          
          professorCameraWindow.addEventListener('mousemove', (e) => {
            if (isDragging) {
              e.preventDefault();
              doDrag(e.clientX, e.clientY);
            }
          });
          
          professorCameraWindow.addEventListener('mouseup', stopDrag);
          professorCameraWindow.addEventListener('mouseleave', stopDrag);
          
          // í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì› (ëª¨ë°”ì¼)
          dragHeader.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            if (startDrag(touch.clientX, touch.clientY)) {
              e.preventDefault();
            }
          }, { passive: false });
          
          professorCameraWindow.addEventListener('touchmove', (e) => {
            if (isDragging) {
              e.preventDefault();
              const touch = e.touches[0];
              doDrag(touch.clientX, touch.clientY);
            }
          }, { passive: false });
          
          professorCameraWindow.addEventListener('touchend', stopDrag);
          professorCameraWindow.addEventListener('touchcancel', stopDrag);
        }
      } catch(e) {
        console.warn('[Professor] ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì • ì‹¤íŒ¨:', e);
      }
      
      // ì „ì²´í™”ë©´ ë²„íŠ¼ ê¸°ëŠ¥
      try {
        const fullscreenBtn = professorCameraWindow.document.getElementById('fullscreenBtn');
        if (fullscreenBtn) {
          fullscreenBtn.addEventListener('click', () => {
            const video = professorCameraWindow.document.getElementById('cameraVideo');
            if (video) {
              if (video.requestFullscreen) {
                video.requestFullscreen();
              } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
              } else if (video.mozRequestFullScreen) {
                video.mozRequestFullScreen();
              } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
              } else if (professorCameraWindow.document.documentElement.requestFullscreen) {
                professorCameraWindow.document.documentElement.requestFullscreen();
              }
            }
          });
        }
      } catch(e) {
        console.warn('[Professor] ì „ì²´í™”ë©´ ë²„íŠ¼ ì„¤ì • ì‹¤íŒ¨:', e);
      }
      
      // ë‹«ê¸° ë²„íŠ¼ ê¸°ëŠ¥
      try {
        const closeBtn = professorCameraWindow.document.getElementById('closeBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            if (professorCameraWindow && !professorCameraWindow.closed) {
              professorCameraWindow.close();
            }
          });
        }
      } catch(e) {
        console.warn('[Professor] ë‹«ê¸° ë²„íŠ¼ ì„¤ì • ì‹¤íŒ¨:', e);
      }
      
      // ì°½ì´ ë‹«í ë•Œ ë¶€ëª¨ ì°½ì— ì•Œë¦¼
      try {
        professorCameraWindow.addEventListener('beforeunload', function() {
          if (window.opener && !window.opener.closed) {
            try {
              window.opener.postMessage({ type: 'cameraWindowClosed' }, '*');
            } catch(err) {}
          }
        });
      } catch(e) {
        console.warn('[Professor] beforeunload ì´ë²¤íŠ¸ ì„¤ì • ì‹¤íŒ¨:', e);
      }
    };
    
    // ì°½ì´ ë¡œë“œëœ í›„ ì„¤ì •
    if (professorCameraWindow.document.readyState === 'complete') {
      setupWindow();
    } else {
      professorCameraWindow.addEventListener('load', setupWindow);
    }
    
    // íƒ€ì„ì•„ì›ƒìœ¼ë¡œë„ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
    setTimeout(setupWindow, 200);
    
    // ì°½ì´ ë‹«í ë•Œ ê°ì§€
    const checkClosed = setInterval(() => {
      if (professorCameraWindow && professorCameraWindow.closed) {
        clearInterval(checkClosed);
        professorCameraWindow = null;
        log('[Professor] ì¹´ë©”ë¼ ë³„ë„ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤');
      }
    }, 500);
    
    log('[Professor] êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ì—´ë¦¼');
  } catch(e) {
    console.error('[Professor] ë³„ë„ ì°½ ì—´ê¸° ì‹¤íŒ¨:', e);
    log('[Professor] ë³„ë„ ì°½ ì—´ê¸° ì‹¤íŒ¨: ' + e.message);
    toast('ë³„ë„ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
}

function closeProfessorCameraWindow() {
  if (professorCameraWindow && !professorCameraWindow.closed) {
    professorCameraWindow.close();
    professorCameraWindow = null;
    log('[Professor] êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ë‹«ìŒ');
  }
}

// ë³„ë„ ì°½ ë‹«ê¸° ë©”ì‹œì§€ ìˆ˜ì‹ 
window.addEventListener('message', (e) => {
  if (e.data && e.data.type === 'cameraWindowClosed') {
    professorCameraWindow = null;
    log('[Professor] ì¹´ë©”ë¼ ë³„ë„ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤ (ë©”ì‹œì§€ ìˆ˜ì‹ )');
  }
});

async function buildLocalStreamForCurrentMode(){
  try {
    // ë¯¸íŒ… ëª¨ë“œ: ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‚¬ìš©
    const cam = await getCameraStream();
    return cam;
  } catch(e) {
    log('[Stream] ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì‹¤íŒ¨: ' + e.message);
    throw e;
  }
}
async function replaceVideoTrack(){
  if (!localStream) return;

  // ìƒˆ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
  const newStream = await getCameraStream();
  const newTrack = newStream.getVideoTracks()[0];

  // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ê°±ì‹ 
  localStream.getVideoTracks().forEach(t=>t.stop());
  localStream = new MediaStream([ newTrack, ...localStream.getAudioTracks() ]);

  if (role === 'professor' && comm === 'meeting') {
    // êµìˆ˜ ë¯¸íŒ… ëª¨ë“œ: ëª¨ë“  í•™ìƒ ì—°ê²°ì— íŠ¸ë™ êµì²´
    peerConnections.forEach((_pc, vid) => {
      const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender && newTrack) {
        sender.replaceTrack(newTrack).catch(e => {
          console.warn(`[Professor] replaceTrack failed for ${vid}:`, e);
        });
      }
    });
  } else if (pc) {
    // í•™ìƒ ë˜ëŠ” êµìˆ˜ ë°©ì†¡ ëª¨ë“œ
    const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
    if (sender && newTrack){
      try{
        await sender.replaceTrack(newTrack);
      }catch(e){
        console.warn('replaceTrack failed, renegotiate fallback:', e);
        try{
          const old = sender.track;
          if (old) old.stop();
          await sender.replaceTrack(null);
          pc.addTrack(newTrack, localStream);
        }catch(e2){ console.warn('fallback failed:', e2); }
      }
    }
  }

  // í”„ë¦¬ë·° ê°±ì‹ 
  if (showLocalPreview) {
    localPreview.srcObject = localStream;
    await forcePlay(localPreview);
  }
}

// í™”ë©´ê³µìœ  ì‹œì‘
async function startScreenShare(){
  if (!localStream) {
    toast('ë¨¼ì € ì…ì‹¤í•˜ì„¸ìš”');
    return;
  }
  
  
  if (isScreenSharing) {
    log('[Screen] ì´ë¯¸ í™”ë©´ê³µìœ  ì¤‘ì…ë‹ˆë‹¤');
    return;
  }
  
  try {
    const screenStream = await getScreenStream();
    const screenTrack = screenStream.getVideoTracks()[0];
    
    if (!screenTrack) {
      toast('í™”ë©´ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      log('[Screen] í™”ë©´ê³µìœ  íŠ¸ë™ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    // í™”ë©´ê³µìœ  ì¢…ë£Œ ê°ì§€
    screenTrack.onended = async () => {
      log('[Screen] í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
      toast('í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤');
      await stopScreenShare();
    };
    
    screenShareStream = screenStream;
    isScreenSharing = true;
    
    // ê¸°ì¡´ ë¹„ë””ì˜¤ íŠ¸ë™ ì €ì¥
    const oldVideoTrack = localStream.getVideoTracks()[0];
    let cameraTrackForPip = null;
    
    if (oldVideoTrack && role === 'professor') {
      // ë°©ì†¡ ëª¨ë“œ: ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ì„ ìœ ì§€í•˜ê³  í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
      if (comm === 'broadcast' && sourceMode === 'camera') {
        // ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ì„ ë³„ë„ ì°½ìš©ìœ¼ë¡œ ìœ ì§€
        cameraTrackForPip = oldVideoTrack;
        professorCameraStream = new MediaStream([cameraTrackForPip]);
        
        // Picture-in-Picture ëª¨ë“œ ìë™ ì‹œì‘
        await startCameraPiP(professorCameraStream);
        
        // í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ (ì¹´ë©”ë¼ íŠ¸ë™ê³¼ í•¨ê»˜)
        localStream.addTrack(screenTrack);
        
        // ëª¨ë“  í•™ìƒ ì—°ê²°ì— í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
        peerConnections.forEach((_pc, vid) => {
          try {
            // í™”ë©´ê³µìœ  íŠ¸ë™ì„ ìƒˆ íŠ¸ëœì‹œë²„ë¡œ ì¶”ê°€
            const screenStream = new MediaStream([screenTrack]);
            _pc.addTrack(screenTrack, screenStream);
            
            // ê¸°ì¡´ í•™ìƒ ì—°ê²°ì—ë„ ì¹´ë©”ë¼ íŠ¸ë™ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
            const existingSenders = _pc.getSenders();
            const hasCameraTrack = existingSenders.some(s => {
              const t = s.track;
              if (!t || t.kind !== 'video') return false;
              const label = t.label.toLowerCase();
              return !label.includes('screen') && !label.includes('í™”ë©´') && 
                     !label.includes('display') && !label.includes('monitor') &&
                     !label.includes('window');
            });
            
            if (!hasCameraTrack && cameraTrackForPip) {
              const cameraStream = new MediaStream([cameraTrackForPip]);
              _pc.addTrack(cameraTrackForPip, cameraStream);
              log(`[Professor] í•™ìƒ ${vid}ì—ê²Œ ì¹´ë©”ë¼ íŠ¸ë™ë„ ì¶”ê°€`);
            }
            
            log(`[Professor] í•™ìƒ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ (ì¹´ë©”ë¼ ìœ ì§€)`);
          } catch(e) {
            console.warn(`[Professor] í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨ (${vid}):`, e);
            log(`[Professor] í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨ (${vid}): ` + e.message);
          }
        });
      } else {
        // ë¯¸íŒ… ëª¨ë“œ: ê¸°ì¡´ íŠ¸ë™ì„ í™”ë©´ê³µìœ ë¡œ êµì²´
        
        // ê¸°ì¡´ ì¹´ë©”ë¼ íŠ¸ë™ì„ ì¤‘ì§€í•˜ê¸° ì „ì— ë³„ë„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“
        try {
          const cameraStream = await getCameraStream();
          const cameraTrack = cameraStream.getVideoTracks()[0];
          if (cameraTrack) {
            professorCameraStream = new MediaStream([cameraTrack]);
            log('[Professor] í™”ë©´ê³µìœ  ëª¨ë“œ: ë³„ë„ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì™„ë£Œ');
            
            // í™”ë©´ê³µìœ  íŠ¸ë™ì—ì„œ ê³µìœ ë˜ëŠ” í™”ë©´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const screenSettings = screenTrack.getSettings();
            const sharedScreenWidth = screenSettings.width || window.screen.width;
            const sharedScreenHeight = screenSettings.height || window.screen.height;
            
            // Picture-in-Picture ëª¨ë“œ ìë™ ì‹œì‘ (ê³µìœ  í™”ë©´ì˜ ìš°ì¸¡ ìƒë‹¨ì— ë°°ì¹˜)
            await startCameraPiP(professorCameraStream);
          }
        } catch(e) {
          console.warn('[Professor] í™”ë©´ê³µìœ  ì¤‘ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì‹¤íŒ¨:', e);
          log('[Professor] í™”ë©´ê³µìœ  ì¤‘ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì‹¤íŒ¨: ' + e.message);
        }
        
        // ê¸°ì¡´ íŠ¸ë™ ì œê±°
        oldVideoTrack.stop();
        localStream.removeTrack(oldVideoTrack);
        
        // í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
        localStream.addTrack(screenTrack);
        
        // ëª¨ë“  ì—°ê²°ì— íŠ¸ë™ êµì²´
        peerConnections.forEach((_pc, vid) => {
          const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
          if (sender && screenTrack) {
            sender.replaceTrack(screenTrack).catch(e => {
              console.warn(`[Professor] í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì‹¤íŒ¨ (${vid}):`, e);
            });
          }
        });
      }
    } else if (oldVideoTrack) {
      // í•™ìƒì¸ ê²½ìš°
      oldVideoTrack.stop();
      localStream.removeTrack(oldVideoTrack);
      localStream.addTrack(screenTrack);
      
      if (pc) {
        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender && screenTrack) {
          try {
            await sender.replaceTrack(screenTrack);
          } catch(e) {
            console.warn('í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì‹¤íŒ¨:', e);
          }
        }
      }
    } else {
      // ê¸°ì¡´ íŠ¸ë™ì´ ì—†ëŠ” ê²½ìš° (ë°©ì†¡ ëª¨ë“œì—ì„œ í™”ë©´ê³µìœ  íŠ¸ë™ë§Œ ì¶”ê°€)
      localStream.addTrack(screenTrack);
    }
    
    // í”„ë¦¬ë·° ê°±ì‹ 
    if (showLocalPreview) {
      localPreview.srcObject = localStream;
      await forcePlay(localPreview);
    }
    
    // ë°©ì†¡ ëª¨ë“œ: sourceMode ì—…ë°ì´íŠ¸ ë° UI ê°±ì‹ 
    if (comm === 'broadcast' && role === 'professor') {
      sourceMode = 'screen';
      // ë¼ë””ì˜¤ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      const screenRadio = document.querySelector('input[name="source"][value="screen"]');
      if (screenRadio) screenRadio.checked = true;
      // UI ê°±ì‹ 
      refreshUIByMode();
    }
    
    shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì¢…ë£Œ';
    shareScreenBtn.style.background = 'linear-gradient(180deg,#c24,#932)';
    toast('í™”ë©´ê³µìœ ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
    log('[Screen] í™”ë©´ê³µìœ  ì‹œì‘');
  } catch(e) {
    log('[Screen] í™”ë©´ê³µìœ  ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('í™”ë©´ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    console.error('Screen share error:', e);
  }
}

// í™”ë©´ê³µìœ  ì¢…ë£Œ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
async function stopScreenShare(){
  if (!isScreenSharing || !localStream) return;
  
  // ì¬ê·€ í˜¸ì¶œ ë°©ì§€
  isScreenSharing = false;
  
  try {
    // í™”ë©´ê³µìœ  íŠ¸ë™ ì œê±°
    const screenTrack = localStream.getVideoTracks().find(t => t.label.includes('screen') || t.label.includes('í™”ë©´'));
    if (screenTrack) {
      // onended í•¸ë“¤ëŸ¬ ì œê±° (ì¬ê·€ í˜¸ì¶œ ë°©ì§€)
      screenTrack.onended = null;
      screenTrack.stop();
      localStream.removeTrack(screenTrack);
    }
    
    // í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
    if (screenShareStream) {
      screenShareStream.getTracks().forEach(t => {
        t.onended = null; // í•¸ë“¤ëŸ¬ ì œê±°
        t.stop();
      });
      screenShareStream = null;
    }
    
    // êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ë‹«ê¸°
    closeProfessorCameraWindow();
    
    // í™”ë©´ê³µìœ  ì¤‘ ì¹´ë©”ë¼ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
    const cameraOverlay = document.getElementById('professorCameraOverlay');
    if (cameraOverlay) {
      cameraOverlay.style.display = 'none';
      const overlayVideo = document.getElementById('professorCameraOverlayVideo');
      if (overlayVideo) {
        overlayVideo.srcObject = null;
      }
    }
    
    // PiP ì •ë¦¬
    if (professorCameraStream) {
      professorCameraStream.getTracks().forEach(t => t.stop());
      professorCameraStream = null;
    }
    
    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“
    try {
      const cameraStream = await getCameraStream();
      const cameraTrack = cameraStream.getVideoTracks()[0];
      
      if (cameraTrack) {
        localStream.addTrack(cameraTrack);
        
        // ëª¨ë“  ì—°ê²°ì— ì¹´ë©”ë¼ íŠ¸ë™ êµì²´
        if (role === 'professor' && comm === 'meeting') {
          peerConnections.forEach((_pc, vid) => {
            const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender && cameraTrack) {
              sender.replaceTrack(cameraTrack).catch(e => {
                console.warn(`[Professor] ì¹´ë©”ë¼ íŠ¸ë™ êµì²´ ì‹¤íŒ¨ (${vid}):`, e);
              });
            }
          });
        } else if (pc) {
          const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
          if (sender && cameraTrack) {
            try {
              await sender.replaceTrack(cameraTrack);
            } catch(e) {
              console.warn('ì¹´ë©”ë¼ íŠ¸ë™ êµì²´ ì‹¤íŒ¨:', e);
            }
          }
        }
        
        // í”„ë¦¬ë·° ê°±ì‹ 
        if (showLocalPreview) {
          localPreview.srcObject = localStream;
          await forcePlay(localPreview);
        }
        
        shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
        shareScreenBtn.style.background = '';
        toast('ì¹´ë©”ë¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
        log('[Screen] í™”ë©´ê³µìœ  ì¢…ë£Œ, ì¹´ë©”ë¼ë¡œ ë³µê·€');
      } else {
        throw new Error('ì¹´ë©”ë¼ íŠ¸ë™ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    } catch(e) {
      log('[Screen] ì¹´ë©”ë¼ë¡œ ì „í™˜ ì‹¤íŒ¨: ' + e.message);
      toast('ì¹´ë©”ë¼ë¡œ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
      console.error('Camera switch error:', e);
      // UIëŠ” ë³µêµ¬
      shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
      shareScreenBtn.style.background = '';
    }
  } catch(e) {
    log('[Screen] í™”ë©´ê³µìœ  ì¢…ë£Œ ì‹¤íŒ¨: ' + e.message);
    toast('ì¹´ë©”ë¼ë¡œ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    console.error('Stop screen share error:', e);
  }
}


/* ---------------- í•™ìƒëª…ë‹¨ ê´€ë¦¬ ---------------- */
// í•™ìƒëª…ë‹¨ì€ ë³„ë„ ê²½ë¡œ(studentLists)ì— ì €ì¥í•˜ì—¬ room ì´ˆê¸°í™”ì™€ ë¶„ë¦¬
async function saveStudentList() {
  const targetRoomId = roomId || (roomIdInput ? roomIdInput.value.trim() : '');
  if (!targetRoomId) {
    toast('ê³¼ëª©ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  if (role !== 'professor') return;
  
  const studentListText = studentListInput ? studentListInput.value.trim() : '';
  const studentNames = studentListText.split('\n')
    .map(name => name.trim())
    .filter(name => name.length > 0);
  
  try {
    // ë³„ë„ ê²½ë¡œì— ì €ì¥í•˜ì—¬ room ì´ˆê¸°í™” ì‹œì—ë„ ìœ ì§€ë¨
    await db.ref(`studentLists/${targetRoomId}`).set({
      names: studentNames,
      timestamp: Date.now()
    });
    
    // localStorageì—ë„ ë°±ì—… ì €ì¥ (ì˜¤í”„ë¼ì¸ ì‹œ ì‚¬ìš©)
    localStorage.setItem(`studentList_${targetRoomId}`, JSON.stringify(studentNames));
    
    if (studentListStatus) {
      studentListStatus.textContent = `ëª…ë‹¨ ì €ì¥ ì™„ë£Œ (${studentNames.length}ëª…)`;
      studentListStatus.style.color = '#4cd97b';
    }
    toast(`í•™ìƒëª…ë‹¨ ì €ì¥ ì™„ë£Œ (${studentNames.length}ëª…)`);
    log(`[Professor] í•™ìƒëª…ë‹¨ ì €ì¥: ${studentNames.length}ëª… - ê³¼ëª©: ${targetRoomId}`);
  } catch(e) {
    console.error('í•™ìƒëª…ë‹¨ ì €ì¥ ì‹¤íŒ¨:', e);
    if (studentListStatus) {
      studentListStatus.textContent = 'ëª…ë‹¨ ì €ì¥ ì‹¤íŒ¨';
      studentListStatus.style.color = '#ff6a6a';
    }
    toast('í•™ìƒëª…ë‹¨ ì €ì¥ ì‹¤íŒ¨');
  }
}

async function loadStudentList(targetRoomIdOverride) {
  const targetRoomId = targetRoomIdOverride || roomId || (roomIdInput ? roomIdInput.value.trim() : '');
  if (!targetRoomId) return;
  
  try {
    // ë³„ë„ ê²½ë¡œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    const snapshot = await db.ref(`studentLists/${targetRoomId}`).once('value');
    const data = snapshot.val();
    
    if (data && data.names && Array.isArray(data.names)) {
      if (studentListInput && role === 'professor') {
        studentListInput.value = data.names.join('\n');
      }
      if (studentListStatus && role === 'professor') {
        studentListStatus.textContent = `ì €ì¥ëœ ëª…ë‹¨: ${data.names.length}ëª…`;
        studentListStatus.style.color = 'var(--muted)';
      }
      log(`[StudentList] í•™ìƒëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°: ${data.names.length}ëª… - ê³¼ëª©: ${targetRoomId}`);
      return data.names;
    } else {
      // Firebaseì— ì—†ìœ¼ë©´ localStorageì—ì„œ ì‹œë„
      const localData = localStorage.getItem(`studentList_${targetRoomId}`);
      if (localData) {
        const names = JSON.parse(localData);
        if (studentListInput && role === 'professor') {
          studentListInput.value = names.join('\n');
        }
        if (studentListStatus && role === 'professor') {
          studentListStatus.textContent = `ì €ì¥ëœ ëª…ë‹¨ (ë¡œì»¬): ${names.length}ëª…`;
          studentListStatus.style.color = 'var(--muted)';
        }
        log(`[StudentList] í•™ìƒëª…ë‹¨ ë¡œì»¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°: ${names.length}ëª… - ê³¼ëª©: ${targetRoomId}`);
        return names;
      }
      
      if (studentListInput && role === 'professor') {
        studentListInput.value = '';
      }
      if (studentListStatus && role === 'professor') {
        studentListStatus.textContent = 'ì €ì¥ëœ ëª…ë‹¨ ì—†ìŒ';
        studentListStatus.style.color = 'var(--muted)';
      }
      return [];
    }
  } catch(e) {
    console.error('í•™ìƒëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    // Firebase ì‹¤íŒ¨ ì‹œ localStorageì—ì„œ ì‹œë„
    try {
      const localData = localStorage.getItem(`studentList_${targetRoomId}`);
      if (localData) {
        const names = JSON.parse(localData);
        if (studentListInput && role === 'professor') {
          studentListInput.value = names.join('\n');
        }
        if (studentListStatus && role === 'professor') {
          studentListStatus.textContent = `ì €ì¥ëœ ëª…ë‹¨ (ë¡œì»¬): ${names.length}ëª…`;
          studentListStatus.style.color = '#ffcc00';
        }
        return names;
      }
    } catch(e2) {}
    
    if (studentListStatus && role === 'professor') {
      studentListStatus.textContent = 'ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
      studentListStatus.style.color = '#ff6a6a';
    }
    return [];
  }
}

async function clearStudentList() {
  const targetRoomId = roomId || (roomIdInput ? roomIdInput.value.trim() : '');
  if (!targetRoomId) {
    toast('ê³¼ëª©ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  if (role !== 'professor') return;
  
  if (!confirm('í•™ìƒëª…ë‹¨ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  try {
    await db.ref(`studentLists/${targetRoomId}`).remove();
    localStorage.removeItem(`studentList_${targetRoomId}`);
    
    if (studentListInput) {
      studentListInput.value = '';
    }
    if (studentListStatus) {
      studentListStatus.textContent = 'ëª…ë‹¨ ì´ˆê¸°í™” ì™„ë£Œ';
      studentListStatus.style.color = 'var(--muted)';
    }
    toast('í•™ìƒëª…ë‹¨ ì´ˆê¸°í™” ì™„ë£Œ');
    log(`[Professor] í•™ìƒëª…ë‹¨ ì´ˆê¸°í™” - ê³¼ëª©: ${targetRoomId}`);
  } catch(e) {
    console.error('í•™ìƒëª…ë‹¨ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
    toast('í•™ìƒëª…ë‹¨ ì´ˆê¸°í™” ì‹¤íŒ¨');
  }
}

async function checkStudentInList(studentName) {
  const targetRoomId = roomId || (roomIdInput ? roomIdInput.value.trim() : '');
  if (!targetRoomId) return true; // ê³¼ëª©ëª…ì´ ì—†ìœ¼ë©´ ëª¨ë‘ í—ˆìš©
  
  try {
    // ë³„ë„ ê²½ë¡œì—ì„œ í™•ì¸
    const snapshot = await db.ref(`studentLists/${targetRoomId}`).once('value');
    const data = snapshot.val();
    
    if (!data || !data.names || !Array.isArray(data.names) || data.names.length === 0) {
      // Firebaseì— ì—†ìœ¼ë©´ localStorageì—ì„œ í™•ì¸
      const localData = localStorage.getItem(`studentList_${targetRoomId}`);
      if (localData) {
        const names = JSON.parse(localData);
        if (names.length === 0) return true; // ëª…ë‹¨ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‘ í—ˆìš©
        const normalizedName = studentName.trim().toLowerCase();
        return names.some(name => name.trim().toLowerCase() === normalizedName);
      }
      return true; // ëª…ë‹¨ì´ ì—†ìœ¼ë©´ ëª¨ë‘ í—ˆìš©
    }
    
    // í•™ìƒ ì´ë¦„ì´ ëª…ë‹¨ì— ìˆëŠ”ì§€ í™•ì¸ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
    const normalizedName = studentName.trim().toLowerCase();
    return data.names.some(name => name.trim().toLowerCase() === normalizedName);
  } catch(e) {
    console.error('í•™ìƒëª…ë‹¨ í™•ì¸ ì‹¤íŒ¨:', e);
    // Firebase ì‹¤íŒ¨ ì‹œ localStorageì—ì„œ í™•ì¸
    try {
      const localData = localStorage.getItem(`studentList_${targetRoomId}`);
      if (localData) {
        const names = JSON.parse(localData);
        if (names.length === 0) return true;
        const normalizedName = studentName.trim().toLowerCase();
        return names.some(name => name.trim().toLowerCase() === normalizedName);
      }
    } catch(e2) {}
    return true; // í™•ì¸ ì‹¤íŒ¨ ì‹œ í—ˆìš© (ì•ˆì „ì¥ì¹˜)
  }
}

// í•´ë‹¹ ê³¼ëª©ì— í•™ìƒëª…ë‹¨ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ë¹ˆ ëª…ë‹¨ì´ ì•„ë‹Œ, ì‹¤ì œë¡œ ëª…ë‹¨ì´ ìˆëŠ”ì§€)
async function checkIfStudentListExists(targetRoomId) {
  if (!targetRoomId) return false;
  
  try {
    // Firebaseì—ì„œ í™•ì¸
    const snapshot = await db.ref(`studentLists/${targetRoomId}`).once('value');
    const data = snapshot.val();
    
    if (data && data.names && Array.isArray(data.names) && data.names.length > 0) {
      return true;
    }
    
    // Firebaseì— ì—†ìœ¼ë©´ localStorageì—ì„œ í™•ì¸
    const localData = localStorage.getItem(`studentList_${targetRoomId}`);
    if (localData) {
      const names = JSON.parse(localData);
      return names.length > 0;
    }
    
    return false;
  } catch(e) {
    console.error('í•™ìƒëª…ë‹¨ ì¡´ì¬ í™•ì¸ ì‹¤íŒ¨:', e);
    // Firebase ì‹¤íŒ¨ ì‹œ localStorageì—ì„œ í™•ì¸
    try {
      const localData = localStorage.getItem(`studentList_${targetRoomId}`);
      if (localData) {
        const names = JSON.parse(localData);
        return names.length > 0;
      }
    } catch(e2) {}
    return false;
  }
}

/* ---------------- ì¶œì„ ê´€ë¦¬ ---------------- */
async function startClass() {
  if (!roomId || role !== 'professor') return;
  
  classStartTime = Date.now();
  classEndTime = null;
  
  try {
    await db.ref(`rooms/${roomId}/classStatus`).set({
      startTime: classStartTime,
      endTime: null,
      isActive: true
    });
    
    toast('ìˆ˜ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
    log(`[Professor] ìˆ˜ì—… ì‹œì‘: ${new Date(classStartTime).toLocaleString()}`);
    
    if (classStartBtn) classStartBtn.disabled = true;
    if (classEndBtn) classEndBtn.disabled = false;
  } catch(e) {
    console.error('ìˆ˜ì—… ì‹œì‘ ì‹¤íŒ¨:', e);
    toast('ìˆ˜ì—… ì‹œì‘ ì‹¤íŒ¨');
  }
}

async function endClass() {
  if (!roomId || role !== 'professor') return;
  
  if (!confirm('ìˆ˜ì—…ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì¶œì„ ì¸ì •ì´ ì™„ë£Œë©ë‹ˆë‹¤.')) return;
  
  classEndTime = Date.now();
  
  try {
    await db.ref(`rooms/${roomId}/classStatus`).set({
      startTime: classStartTime,
      endTime: classEndTime,
      isActive: false
    });
    
    // ì¶œì„ ì¸ì • ì²˜ë¦¬
    await processAttendance();
    
    toast('ìˆ˜ì—…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¶œì„ ì¸ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    log(`[Professor] ìˆ˜ì—… ì¢…ë£Œ: ${new Date(classEndTime).toLocaleString()}`);
    
    if (classStartBtn) classStartBtn.disabled = false;
    if (classEndBtn) classEndBtn.disabled = true;
  } catch(e) {
    console.error('ìˆ˜ì—… ì¢…ë£Œ ì‹¤íŒ¨:', e);
    toast('ìˆ˜ì—… ì¢…ë£Œ ì‹¤íŒ¨');
  }
}

async function processAttendance() {
  if (!roomId || !classStartTime || !classEndTime) return;
  
  try {
    // ëª¨ë“  í•™ìƒì˜ ì…ì‹¤ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
    const attendanceRef = db.ref(`rooms/${roomId}/attendance`);
    const snapshot = await attendanceRef.once('value');
    const attendanceData = snapshot.val() || {};
    
    const today = new Date().toISOString().split('T')[0];
    
    for (const studentId in attendanceData) {
      const studentData = attendanceData[studentId];
      if (!studentData[today]) continue;
      
      const entryTime = studentData[today].entryTime;
      const exitTime = studentData[today].exitTime || Date.now();
      
      // ìˆ˜ì—… ì‹œì‘ ì „ì— ì…ì‹¤í•˜ê³  ìˆ˜ì—… ì¢…ë£Œ ì „ì— í‡´ì‹¤í•˜ì§€ ì•Šì€ ê²½ìš° ì¶œì„ ì¸ì •
      if (entryTime && entryTime <= classEndTime && (!exitTime || exitTime >= classStartTime)) {
        await db.ref(`rooms/${roomId}/attendance/${studentId}/${today}`).update({
          isAttended: true,
          classStartTime: classStartTime,
          classEndTime: classEndTime
        });
      }
    }
    
    log('[Professor] ì¶œì„ ì¸ì • ì²˜ë¦¬ ì™„ë£Œ');
  } catch(e) {
    console.error('ì¶œì„ ì¸ì • ì²˜ë¦¬ ì‹¤íŒ¨:', e);
  }
}

async function recordStudentEntry(studentName) {
  if (!roomId || !studentName) return;
  
  const today = new Date().toISOString().split('T')[0];
  const entryTime = Date.now();
  studentEntryTime = entryTime;
  
  try {
    await db.ref(`rooms/${roomId}/attendance/${myUserId}/${today}`).set({
      studentName: studentName,
      entryTime: entryTime,
      exitTime: null,
      isAttended: false
    });
    
    log(`[Student] ì…ì‹¤ ê¸°ë¡: ${new Date(entryTime).toLocaleString()}`);
  } catch(e) {
    console.error('ì…ì‹¤ ê¸°ë¡ ì‹¤íŒ¨:', e);
  }
}

async function recordStudentExit() {
  if (!roomId || !studentEntryTime) return;
  
  const today = new Date().toISOString().split('T')[0];
  const exitTime = Date.now();
  studentExitTime = exitTime;
  
  try {
    await db.ref(`rooms/${roomId}/attendance/${myUserId}/${today}`).update({
      exitTime: exitTime
    });
    
    log(`[Student] í‡´ì‹¤ ê¸°ë¡: ${new Date(exitTime).toLocaleString()}`);
  } catch(e) {
    console.error('í‡´ì‹¤ ê¸°ë¡ ì‹¤íŒ¨:', e);
  }
}

function showAttendanceModal() {
  if (attendanceModal) {
    attendanceModal.classList.add('show');
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
    if (attendanceDateInput) {
      attendanceDateInput.value = new Date().toISOString().split('T')[0];
      loadAttendanceData();
    }
  }
}

function hideAttendanceModal() {
  if (attendanceModal) {
    attendanceModal.classList.remove('show');
  }
}

async function loadAttendanceData() {
  if (!roomId || !attendanceDateInput || !attendanceList) return;
  
  const selectedDate = attendanceDateInput.value;
  if (!selectedDate) {
    attendanceList.innerHTML = '<p class="hint">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>';
    return;
  }
  
  try {
    const attendanceRef = db.ref(`rooms/${roomId}/attendance`);
    const snapshot = await attendanceRef.once('value');
    const attendanceData = snapshot.val() || {};
    
    let html = '<table style="width:100%;border-collapse:collapse;font-size:13px">';
    html += '<thead><tr style="background:#1b285c;border-bottom:2px solid #2a3a77">';
    html += '<th style="padding:10px;text-align:left">í•™ìƒëª…</th>';
    html += '<th style="padding:10px;text-align:left">ì…ì‹¤ì‹œê°„</th>';
    html += '<th style="padding:10px;text-align:left">í‡´ì‹¤ì‹œê°„</th>';
    html += '<th style="padding:10px;text-align:center">ì¶œì„ì¸ì •</th>';
    html += '</tr></thead><tbody>';
    
    const students = [];
    for (const studentId in attendanceData) {
      const studentData = attendanceData[studentId];
      if (studentData[selectedDate]) {
        students.push({
          id: studentId,
          name: studentData[selectedDate].studentName || studentId.substring(0, 6),
          entryTime: studentData[selectedDate].entryTime,
          exitTime: studentData[selectedDate].exitTime,
          isAttended: studentData[selectedDate].isAttended || false
        });
      }
    }
    
    // ì…ì‹¤ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
    students.sort((a, b) => (a.entryTime || 0) - (b.entryTime || 0));
    
    if (students.length === 0) {
      html += '<tr><td colspan="4" style="padding:20px;text-align:center;color:var(--muted)">í•´ë‹¹ ë‚ ì§œì— ì…ì‹¤í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    } else {
      students.forEach(student => {
        const entryTimeStr = student.entryTime ? new Date(student.entryTime).toLocaleTimeString('ko-KR') : '-';
        const exitTimeStr = student.exitTime ? new Date(student.exitTime).toLocaleTimeString('ko-KR') : '-';
        const attendedStatus = student.isAttended ? 'âœ… ì¸ì •' : 'âŒ ë¯¸ì¸ì •';
        const attendedColor = student.isAttended ? '#4cd97b' : '#ff6a6a';
        
        html += '<tr style="border-bottom:1px solid #2a3a77">';
        html += `<td style="padding:10px">${student.name}</td>`;
        html += `<td style="padding:10px">${entryTimeStr}</td>`;
        html += `<td style="padding:10px">${exitTimeStr}</td>`;
        html += `<td style="padding:10px;text-align:center;color:${attendedColor};font-weight:bold">${attendedStatus}</td>`;
        html += '</tr>';
      });
    }
    
    html += '</tbody></table>';
    attendanceList.innerHTML = html;
  } catch(e) {
    console.error('ì¶œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    attendanceList.innerHTML = '<p style="color:#ff6a6a">ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>';
  }
}

// ì¶œì„ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
if (classStartBtn) {
  classStartBtn.addEventListener('click', startClass);
}
if (classEndBtn) {
  classEndBtn.addEventListener('click', endClass);
}
if (attendanceCheckBtn) {
  attendanceCheckBtn.addEventListener('click', showAttendanceModal);
}
if (attendanceModalClose) {
  attendanceModalClose.addEventListener('click', hideAttendanceModal);
}
if (attendanceDateInput) {
  attendanceDateInput.addEventListener('change', loadAttendanceData);
}
if (attendanceModal) {
  attendanceModal.addEventListener('click', (e) => {
    if (e.target === attendanceModal) hideAttendanceModal();
  });
}

// í•™ìƒëª…ë‹¨ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
if (saveStudentListBtn) {
  saveStudentListBtn.addEventListener('click', saveStudentList);
}
if (clearStudentListBtn) {
  clearStudentListBtn.addEventListener('click', clearStudentList);
}

// ìˆ˜ê°•ìƒ ëª…ë‹¨ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
if (studentListBtn) {
  studentListBtn.addEventListener('click', () => {
    showPendingModal(); // í•™ìƒëª…ë‹¨ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
  });
}

// ê³¼ëª©ëª… ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì €ì¥ëœ í•™ìƒëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
let roomIdInputTimeout = null;
if (roomIdInput) {
  roomIdInput.addEventListener('input', () => {
    // ë””ë°”ìš´ìŠ¤: ì…ë ¥ ì¤‘ì—ëŠ” ë„ˆë¬´ ìì£¼ í˜¸ì¶œë˜ì§€ ì•Šë„ë¡
    if (roomIdInputTimeout) clearTimeout(roomIdInputTimeout);
    roomIdInputTimeout = setTimeout(async () => {
      const inputRoomId = roomIdInput.value.trim();
      if (inputRoomId && role === 'professor') {
        log(`[StudentList] ê³¼ëª©ëª… ì…ë ¥ë¨: ${inputRoomId} - ì €ì¥ëœ í•™ìƒëª…ë‹¨ í™•ì¸ ì¤‘...`);
        await loadStudentList(inputRoomId);
      }
    }, 500); // 500ms ë””ë°”ìš´ìŠ¤
  });
  
  // í¬ì»¤ìŠ¤ë¥¼ ìƒì„ ë•Œë„ ë¡œë“œ ì‹œë„
  roomIdInput.addEventListener('blur', async () => {
    const inputRoomId = roomIdInput.value.trim();
    if (inputRoomId && role === 'professor') {
      await loadStudentList(inputRoomId);
    }
  });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ê³¼ëª©ëª…ì´ ìˆìœ¼ë©´ í•™ìƒëª…ë‹¨ë„ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', async () => {
  // ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰ (Firebase ì´ˆê¸°í™” ëŒ€ê¸°)
  setTimeout(async () => {
    // "ì²­ì†Œë…„ë¬¸í™”" ê³¼ëª© í•™ìƒëª…ë‹¨ ì´ˆê¸°í™”
    const ì²­ì†Œë…„ë¬¸í™”_í•™ìƒëª…ë‹¨ = [
      'ìœ ì€í¬','ë°•ê²½í¬','ì°í›„í›™','ì¡°ê·œì›','ì •ì„ ìˆ™','ì´ë¯¸ì„ ','ìœ¤ìœ¤ì •','ì—„ì£¼ì˜',
      'ë°°ì€ì„±','ë°°ì˜í¬','ê¹€ì¢…ëª…','ìœ ì •ì—°','ì •ìœ ë¦¬','í™©ë¯¸ì˜','ê¹€í¬ì• ','ê¹€ë™í˜„',
      'ê¹€ëª…í¬','ê¹€ì„œì˜','ê¹€ìˆ˜ì§„','ì´ì„±í•™','ê²ŒìŠ¤íŠ¸'
    ];
    localStorage.setItem('studentList_ì²­ì†Œë…„ë¬¸í™”', JSON.stringify(ì²­ì†Œë…„ë¬¸í™”_í•™ìƒëª…ë‹¨));
    
    // Firebaseì—ë„ ì €ì¥ ì‹œë„
    try {
      await db.ref('studentLists/ì²­ì†Œë…„ë¬¸í™”').set({
        names: ì²­ì†Œë…„ë¬¸í™”_í•™ìƒëª…ë‹¨,
        timestamp: Date.now()
      });
      console.log('[Init] ì²­ì†Œë…„ë¬¸í™” í•™ìƒëª…ë‹¨ Firebase ì €ì¥ ì™„ë£Œ');
    } catch(e) {
      console.log('[Init] ì²­ì†Œë…„ë¬¸í™” í•™ìƒëª…ë‹¨ localStorageì—ë§Œ ì €ì¥ë¨');
    }
    
    if (roomIdInput && roomIdInput.value.trim() && role === 'professor') {
      await loadStudentList(roomIdInput.value.trim());
    }
  }, 1000);
});

/* ---------------- Signaling: Professor / Student ---------------- */
async function addPending(vid, data){
  // ì´ë¯¸ ì—°ê²°ëœ í•™ìƒì€ ë¬´ì‹œ
  if (peerConnections.has(vid)) {
    log(`[Professor] ${vid}ëŠ” ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤`);
    return;
  }
  
  // í•™ìƒëª…ë‹¨ í™•ì¸ (userName í•„ë“œ ì‚¬ìš©, ì—†ìœ¼ë©´ vid ì‚¬ìš©)
  const studentName = data.userName || vid.substring(0,6);
  const isInList = await checkStudentInList(studentName);
  
  if (!isInList) {
    // ëª…ë‹¨ì— ì—†ëŠ” í•™ìƒì€ ê±°ì ˆ
    log(`[Professor] ${studentName} (${vid})ëŠ” í•™ìƒëª…ë‹¨ì— ì—†ì–´ ì…ì‹¤ ê±°ì ˆ`);
    toast(`í•™ìƒëª…ë‹¨ì— ì—†ëŠ” í•™ìƒì…ë‹ˆë‹¤: ${studentName}`);
    // ì˜¤í¼ ì œê±°
    try {
      await db.ref(`rooms/${roomId}/offers/${vid}`).remove();
    } catch(e) {
      console.warn('ì˜¤í¼ ì œê±° ì‹¤íŒ¨:', e);
    }
    return;
  }
  
  // í•™ìƒëª…ë‹¨ì— ìˆëŠ” í•™ìƒì€ ìë™ ìŠ¹ì¸
  log(`[Professor] ${studentName} (${vid}) ìë™ ìŠ¹ì¸ ì²˜ë¦¬`);
  toast(`${studentName} í•™ìƒ ì…ì‹¤`);
  await acceptStudent(vid, data, null);
}
function denyStudent(vid, li){
  // Firebase ë°ì´í„° ì •ë¦¬
  db.ref(`rooms/${roomId}/offers/${vid}`).remove().catch(() => {});
  db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(() => {});
  db.ref(`rooms/${roomId}/answers/${vid}`).remove().catch(() => {});
  
  // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
  if (firebaseListeners.candidates[vid]) {
    try {
      firebaseListeners.candidates[vid].off();
    } catch(e) {}
    delete firebaseListeners.candidates[vid];
  }
  
  // ì—°ê²°ì´ ì´ë¯¸ ë˜ì–´ìˆë‹¤ë©´ ì •ë¦¬
  const _pc = peerConnections.get(vid);
  if (_pc) {
    try {
      _pc.getSenders().forEach(s => {
        if (s.track) s.track.stop();
      });
      _pc.close();
    } catch(e) {}
    peerConnections.delete(vid);
  }
  removeRemoteVideoElement(vid);
  if (li && li.parentNode) {
    li.remove();
  }
  // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
  if (pendingEl && pendingEl.children.length === 0) {
    hidePendingModal();
  }
}

async function startProfessor(){
  try {
    // êµìˆ˜ ì¸ì¦ í™•ì¸
    const professorName = userNameInput ? userNameInput.value.trim() : '';
    const professorId = professorIdInput ? professorIdInput.value.trim() : '';
    
    if (!professorName) {
      toast('êµìˆ˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      throw new Error('êµìˆ˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    if (!professorId) {
      toast('ì‚¬ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      throw new Error('ì‚¬ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    if (!verifyProfessor(professorName, professorId)) {
      toast('ì¸ì¦ë˜ì§€ ì•Šì€ êµìˆ˜ì…ë‹ˆë‹¤. êµìˆ˜ëª…ê³¼ ì‚¬ë²ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      log(`[Professor] ì¸ì¦ ì‹¤íŒ¨: ${professorName} / ${professorId}`);
      throw new Error('ì¸ì¦ë˜ì§€ ì•Šì€ êµìˆ˜ì…ë‹ˆë‹¤');
    }
    
    log(`[Professor] ì¸ì¦ ì„±ê³µ: ${professorName}`);
    
    roomId = (roomIdInput ? roomIdInput.value||'' : '').replace(/\s+/g,''); 
    if(!roomId){ 
      toast('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      throw new Error('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    // ê°•ì˜ì‹¤ì´ ì‹œì‘ë  ë•Œ ê¸°ì¡´ ë°ì´í„° ëª¨ë‘ ì´ˆê¸°í™” (ê³¼ê±°ì— ì‚¬ìš©ëœ ê³¼ëª©ëª…ë¼ë„ ìƒˆë¡œ ì‹œì‘)
    try {
      await db.ref(`rooms/${roomId}`).remove();
      log('[Professor] ê¸°ì¡´ ê°•ì˜ì‹¤ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
    } catch(e) {
      console.warn('[Professor] ê°•ì˜ì‹¤ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
      // ì´ˆê¸°í™” ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }
    
    // ì‹œì‘ ì‹œ ë‚´ í™”ë©´(ë¯¸ë¦¬ë³´ê¸°) í‘œì‹œ
    showLocalPreview = true;
    if (localPreviewWrapper) {
      localPreviewWrapper.style.display = 'block';
    }
    if (togglePreviewBtn) {
      togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
    }
    
    myUserId = 'professor-' + randomId(6);
    
    // êµìˆ˜ ì…ì‹¤ ì‹œ ì €ì¥ëœ í•™ìƒëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
    if (role === 'professor') {
      await loadStudentList();
    }
    
    localStream = await buildLocalStreamForCurrentMode();
    
    if (!localStream && role==='professor') {
      throw new Error('ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // êµìˆ˜ ë§ˆì´í¬ëŠ” ë””í´íŠ¸ë¡œ í•­ìƒ ì¼œì ¸ ìˆê²Œ ì„¤ì •
    if (localStream) {
      localStream.getAudioTracks().forEach(t => {
        t.enabled = true; // ì˜¤ë””ì˜¤ íŠ¸ë™ í™œì„±í™” (ë§ˆì´í¬ ì¼œì§)
        log('[Professor] ì˜¤ë””ì˜¤ íŠ¸ë™ í™œì„±í™” (ë””í´íŠ¸)');
      });
    }
    
    // êµìˆ˜ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ìŒì†Œê±°í•˜ì§€ ì•ŠìŒ)
    if (localStream && localPreview) {
      localPreview.srcObject = localStream;
      try {
        localPreview.setAttribute('playsinline', '');
        localPreview.setAttribute('webkit-playsinline', '');
        await localPreview.play();
      } catch(e) {
        console.warn('ë¯¸ë¦¬ë³´ê¸° ì¬ìƒ ì‹¤íŒ¨:', e);
      }
    }
    
    const vTrack = localStream?.getVideoTracks?.()[0];
    if (vTrack) {
      vTrack.onended = () => {
        log('[Professor] video track ended (ì°½ ë‹«í˜/ìµœì†Œí™” ë“±). ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
        toast('ê³µìœ  í™”ë©´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. [ì…ì‹¤]ìœ¼ë¡œ ë‹¤ì‹œ ê³µìœ í•˜ì„¸ìš”.');
        // í•„ìš”í•˜ë©´ ìë™ ì¬ì‹œì‘:
        // startBtn.click();
      };
    }

    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì„¤ì • (ë³„ë„ ì°½ ì—´ê¸° ë²„íŠ¼ìš©)
    if (localStream) {
      const cameraTrack = localStream.getVideoTracks()[0];
      if (cameraTrack) {
        professorCameraStream = new MediaStream([cameraTrack]);
        log('[Professor] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼: professorCameraStream ì„¤ì •ë¨');
        console.log('[Professor] professorCameraStream ì„¤ì • ì™„ë£Œ', professorCameraStream);
      }
    }
    
    // ë¯¸ë¦¬ë³´ê¸° UIëŠ” ì‹œì‘ ì‹œ í‘œì‹œë¨ (showLocalPreview = true)
    // ì‚¬ìš©ìê°€ "ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ë¨

    // í•™ìƒ ì˜¤í¼ ëŒ€ê¸°
    const offersRef = db.ref(`rooms/${roomId}/offers`);
    firebaseListeners.offers = offersRef;
    offersRef.on('child_added', async snap=>{
      const vid = snap.key; const data = snap.val();
      if(!data || !data.sdp) return;
      
      // ì´ë¯¸ ë‹µë³€ì´ ìˆëŠ” í•™ìƒ(ì´ë¯¸ ìŠ¹ì¸ëœ í•™ìƒ)ëŠ” pending ëª©ë¡ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      const answerRef = db.ref(`rooms/${roomId}/answers/${vid}`);
      answerRef.once('value', (answerSnap) => {
        try {
          if (answerSnap.exists()) {
            log(`[Professor] ${vid}ëŠ” ì´ë¯¸ ìŠ¹ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
            return;
          }
          // ë‹µë³€ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ pending ëª©ë¡ì— ì¶”ê°€
          addPending(vid, data);
          log('[Professor] offer arrived from: ' + vid);
        } catch(e) {
          console.error('[Professor] answerRef.once error:', e);
          // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ pending ëª©ë¡ì— ì¶”ê°€ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
          addPending(vid, data);
        }
      }).catch((e) => {
        console.error('[Professor] answerRef.once failed:', e);
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ pending ëª©ë¡ì— ì¶”ê°€ ì‹œë„ (ì•ˆì „ì¥ì¹˜)
        addPending(vid, data);
      });
    });

    startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
    
    // êµìˆ˜ ì…ì‹¤ ì‹œ ìˆ˜ì—…ì‹œì‘/ìˆ˜ì—…ì¢…ë£Œ/ìˆ˜ê°•ìƒëª…ë‹¨/ì¶œì„í™•ì¸ ë²„íŠ¼ í‘œì‹œ
    if (classStartBtn) {
      classStartBtn.style.display = 'inline-block';
      classStartBtn.disabled = false;
    }
    if (classEndBtn) {
      classEndBtn.style.display = 'inline-block';
      classEndBtn.disabled = true;
    }
    if (studentListBtn) {
      studentListBtn.style.display = 'inline-block';
    }
    if (attendanceCheckBtn) {
      attendanceCheckBtn.style.display = 'inline-block';
    }
    
    // êµìˆ˜ ì…ì‹¤ ì‹œ ëª¨ë“  ì¹´ë©”ë¼ ì˜ìƒ í‘œì‹œ
    try {
      await displayAllCameras();
    } catch(cameraError) {
      console.error('ëª¨ë“  ì¹´ë©”ë¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', cameraError);
      log('[Camera] ëª¨ë“  ì¹´ë©”ë¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ê³„ì† ì§„í–‰)');
    }
    
    // ì‹œì‘ í›„ UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í‘œì‹œ ë“±)
    refreshUIByMode();
    
    // professorCameraStreamì´ ì„¤ì •ëœ í›„ ë²„íŠ¼ ë‹¤ì‹œ ì—…ë°ì´íŠ¸ (ì¹´ë©”ë¼ ëª¨ë“œ)
    if (comm === 'broadcast' && sourceMode === 'camera') {
      setTimeout(() => {
        console.log('[Professor] UI ì—…ë°ì´íŠ¸ ì¬ì‹œë„', { isRunning, comm, sourceMode, professorCameraStream, localStream });
        refreshUIByMode();
      }, 200);
    }
    
    logStatus(`êµìˆ˜ ëŒ€ê¸°/ì†¡ì¶œ ì¤‘â€¦ ê³¼ëª©ëª…: ${roomId} Â· ëª¨ë“œ: ${comm}`);
    toast('í•™ìƒì—ê²Œ ê³¼ëª©ëª…ë¥¼ ê³µìœ í•˜ì„¸ìš”');
    
    // ì±„íŒ… ì´ˆê¸°í™”
    chatMessages.innerHTML = '';
    initChat();
  } catch(e) {
    log('[Professor] ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('êµìˆ˜ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    isRunning = false;
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    throw e;
  }
}

// ì›ê²© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
function createRemoteVideoElement(vid, label=''){
  const wrapper = document.createElement('div');
  wrapper.className = 'remote-video-wrapper';
  wrapper.id = `remote-video-${vid}`;
  
  const labelEl = document.createElement('small');
  labelEl.className = 'muted';
  labelEl.textContent = label || `ì°¸ê°€ì ${vid.substring(0,6)}`;
  
  const video = document.createElement('video');
  video.id = `video-${vid}`;
  video.autoplay = true;
  video.playsInline = true;
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.controls = true;
  
  // ì „ì²´í™”ë©´ ë²„íŠ¼ ì¶”ê°€
  const fullscreenBtn = document.createElement('button');
  fullscreenBtn.className = 'video-fullscreen-btn';
  fullscreenBtn.textContent = 'â›¶ ì „ì²´í™”ë©´';
  fullscreenBtn.onclick = () => {
    try {
      if (!video.srcObject) {
        toast('ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      fsVideo.srcObject = video.srcObject;
      fullscreenVideo.classList.add('show');
      
      // í•™ìƒì¼ ë•Œë§Œ ì „ì²´í™”ë©´ ì§ˆë¬¸ ë²„íŠ¼ í‘œì‹œ
      if (fullscreenQuestionBtn) {
        fullscreenQuestionBtn.style.display = (role === 'student') ? 'block' : 'none';
      }
      
      fsVideo.play().catch(e => {
        console.warn('Fullscreen video play failed:', e);
      });
      
    } catch(e) {
      console.error('Fullscreen error:', e);
      toast('ì „ì²´í™”ë©´ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  };
  
  wrapper.appendChild(labelEl);
  wrapper.appendChild(video);
  wrapper.appendChild(fullscreenBtn);
  
  // í•™ìƒ(í•™ìƒ) ì „ìš© ì§ˆë¬¸ ë²„íŠ¼ ì¶”ê°€
  if (role === 'student') {
    const questionBtn = document.createElement('button');
    questionBtn.className = 'video-question-btn';
    questionBtn.textContent = 'â“ ì§ˆë¬¸í•˜ê¸°';
    questionBtn.onclick = () => {
      sendQuestionNotification();
    };
    wrapper.appendChild(questionBtn);
  }
  
  // êµìˆ˜ ì „ìš© ë²„íŠ¼ ì¶”ê°€
  if (role === 'professor') {
    // ì§ˆë¬¸ ìš”ì²­ í‘œì‹œê¸° (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
    const questionIndicator = document.createElement('div');
    questionIndicator.className = 'question-request-indicator blink';
    questionIndicator.id = `question-indicator-${vid}`;
    questionIndicator.textContent = 'âœ… ì§ˆë¬¸í—ˆë½';
    questionIndicator.style.display = 'none';
    wrapper.appendChild(questionIndicator);
    
    // ì§ˆë¬¸ í—ˆë½ ë²„íŠ¼
    const questionAllowBtn = document.createElement('button');
    questionAllowBtn.className = 'video-question-allow-btn';
    questionAllowBtn.textContent = 'âœ… ì§ˆë¬¸ í—ˆë½';
    questionAllowBtn.id = `question-allow-btn-${vid}`;
    questionAllowBtn.onclick = () => {
      allowStudentQuestion(vid);
    };
    wrapper.appendChild(questionAllowBtn);
    
    // ì§ˆë¬¸ ì™„ë£Œ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
    const questionEndBtn = document.createElement('button');
    questionEndBtn.className = 'video-question-end-btn';
    questionEndBtn.textContent = 'âŒ ì§ˆë¬¸ ì™„ë£Œ';
    questionEndBtn.id = `question-end-btn-${vid}`;
    questionEndBtn.style.display = 'none';
    questionEndBtn.onclick = () => {
      endStudentQuestion(vid);
    };
    wrapper.appendChild(questionEndBtn);
    
    // ìŒì†Œê±° í•´ì œ ë²„íŠ¼
    const unmuteBtn = document.createElement('button');
    unmuteBtn.className = 'video-unmute-btn muted';
    unmuteBtn.textContent = 'ğŸ”‡ ìŒì†Œê±°';
    unmuteBtn.id = `unmute-btn-${vid}`;
    unmuteBtn.onclick = () => {
      toggleStudentAudio(vid, unmuteBtn);
    };
    wrapper.appendChild(unmuteBtn);
    
    // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (Firebase ë¦¬ìŠ¤ë„ˆ)
    if (roomId) {
      const questionRequestRef = db.ref(`rooms/${roomId}/questionRequests/${vid}`);
      questionRequestRef.on('value', (snap) => {
        const data = snap.val();
        if (data && data.status === 'pending') {
          // ì§ˆë¬¸ ìš”ì²­ì´ ìˆìœ¼ë©´ í‘œì‹œê¸° í‘œì‹œ
          questionIndicator.style.display = 'block';
        } else {
          // ì§ˆë¬¸ ìš”ì²­ì´ ì—†ìœ¼ë©´ í‘œì‹œê¸° ìˆ¨ê¹€
          questionIndicator.style.display = 'none';
        }
      });
    }
  }
  
  remoteVideosGrid.appendChild(wrapper);
  
  return video;
}

// ì›ê²© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì œê±°
function removeRemoteVideoElement(vid){
  // ì˜¤ë””ì˜¤ íŠ¸ë™ ë§µì—ì„œë„ ì œê±°
  studentAudioTracks.delete(vid);
  
  const wrapper = document.getElementById(`remote-video-${vid}`);
  if (wrapper) {
    const video = wrapper.querySelector('video');
    if (video && video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    wrapper.remove();
  }
  remoteVideos.delete(vid);
}

// í•™ìƒ ì˜¤ë””ì˜¤ ìŒì†Œê±°/í•´ì œ í† ê¸€ í•¨ìˆ˜ (êµìˆ˜ ì „ìš©)
function toggleStudentAudio(studentId, btnElement) {
  const audioTrack = studentAudioTracks.get(studentId);
  if (!audioTrack) {
    toast('ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  if (audioTrack.enabled) {
    // ìŒì†Œê±°
    audioTrack.enabled = false;
    btnElement.textContent = 'ğŸ”‡ ìŒì†Œê±°';
    btnElement.classList.add('muted');
    log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ìŒì†Œê±°`);
    toast(`í•™ìƒ ${studentId.substring(0,6)} ìŒì†Œê±°ë¨`);
  } else {
    // ìŒì†Œê±° í•´ì œ
    audioTrack.enabled = true;
    btnElement.textContent = 'ğŸ”Š ìŒì†Œê±° í•´ì œ';
    btnElement.classList.remove('muted');
    log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ìŒì†Œê±° í•´ì œ`);
    toast(`í•™ìƒ ${studentId.substring(0,6)} ìŒì†Œê±° í•´ì œë¨`);
  }
}

// í•™ìƒ ì§ˆë¬¸ í—ˆë½ í•¨ìˆ˜ (êµìˆ˜ ì „ìš©)
async function allowStudentQuestion(studentId) {
  if (currentQuestionStudentId && currentQuestionStudentId !== studentId) {
    // ë‹¤ë¥¸ í•™ìƒê°€ ì´ë¯¸ ì§ˆë¬¸ ì¤‘ì´ë©´ ë¨¼ì € ì¢…ë£Œ
    await endStudentQuestion(currentQuestionStudentId);
  }
  
  const studentVideo = remoteVideos.get(studentId);
  if (!studentVideo || !studentVideo.srcObject) {
    toast('í•™ìƒ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  try {
    // í•™ìƒ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì—ì„œ ì¹´ë©”ë¼ íŠ¸ë™ ì¶”ì¶œ
    const videoTracks = studentVideo.srcObject.getVideoTracks();
    if (videoTracks.length === 0) {
      toast('í•™ìƒ ë¹„ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    // í•™ìƒ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìƒì„±
    const studentCameraStream = new MediaStream([videoTracks[0]]);
    
    // í•™ìƒ PiPìš© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    if (!studentQuestionPiPVideo) {
      studentQuestionPiPVideo = document.createElement('video');
      studentQuestionPiPVideo.style.position = 'fixed';
      studentQuestionPiPVideo.style.top = '-9999px';
      studentQuestionPiPVideo.style.width = '1px';
      studentQuestionPiPVideo.style.height = '1px';
      studentQuestionPiPVideo.autoplay = true;
      studentQuestionPiPVideo.muted = false; // ì˜¤ë””ì˜¤ë„ ì¬ìƒ
      studentQuestionPiPVideo.playsInline = true;
      document.body.appendChild(studentQuestionPiPVideo);
    }
    
    // ìŠ¤íŠ¸ë¦¼ ì„¤ì •
    studentQuestionPiPVideo.srcObject = studentVideo.srcObject;
    await studentQuestionPiPVideo.play();
    
    // êµìˆ˜ ì¹´ë©”ë¼ PiPê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const professorPiPActive = document.pictureInPictureElement === professorCameraPiPVideo;
    
    // êµìˆ˜ PiPê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¢…ë£Œí•˜ê³  ìƒíƒœ ì €ì¥ (í•™ìƒ PiPë¡œ ëŒ€ì²´)
    if (professorPiPActive) {
      professorPiPWasActiveBeforeQuestion = true;
      try {
        await document.exitPictureInPicture();
        log('[Professor] êµìˆ˜ ì¹´ë©”ë¼ PiP ì¢…ë£Œ (í•™ìƒ PiPë¡œ ëŒ€ì²´)');
      } catch(e) {
        console.warn('êµìˆ˜ PiP ì¢…ë£Œ ì‹¤íŒ¨:', e);
      }
    } else {
      professorPiPWasActiveBeforeQuestion = false;
    }
    
    // êµìˆ˜ì¸¡: ì „ì²´í™”ë©´ ìƒíƒœ ì €ì¥ ë° í•™ìƒ ë¹„ë””ì˜¤ ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ
    wasFullscreenBeforeQuestion = fullscreenVideo.classList.contains('show');
    if (fsVideo && studentVideo.srcObject) {
      fsVideo.srcObject = studentVideo.srcObject;
      fullscreenVideo.classList.add('show');
      fsVideo.setAttribute('playsinline', '');
      fsVideo.setAttribute('webkit-playsinline', '');
      await fsVideo.play();
      log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ë¹„ë””ì˜¤ ì „ì²´í™”ë©´ í‘œì‹œ`);
    }
    
    // í•™ìƒ PiP ì‹œì‘ (êµìˆ˜ PiPë¥¼ ëŒ€ì²´)
    if (!document.pictureInPictureElement || document.pictureInPictureElement !== studentQuestionPiPVideo) {
      await studentQuestionPiPVideo.requestPictureInPicture();
      log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ì§ˆë¬¸ í—ˆë½ - PiP ì‹œì‘ (êµìˆ˜ PiP ëŒ€ì²´)`);
    }
    
    // Firebaseì— ì§ˆë¬¸ í™œì„±í™” ì‹ í˜¸ ì „ì†¡ (ëª¨ë“  í•™ìƒì—ê²Œ)
    try {
      await db.ref(`rooms/${roomId}/questionActive`).set({
        studentId: studentId,
        timestamp: Date.now(),
        active: true
      });
      log(`[Professor] ì§ˆë¬¸ í™œì„±í™” ì‹ í˜¸ ì „ì†¡: ${studentId}`);
    } catch(e) {
      console.warn('ì§ˆë¬¸ í™œì„±í™” ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨:', e);
    }
    
    // ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ì œê±°
    try {
      await db.ref(`rooms/${roomId}/questionRequests/${studentId}`).remove();
    } catch(e) {
      console.warn('ì§ˆë¬¸ ìš”ì²­ ìƒíƒœ ì œê±° ì‹¤íŒ¨:', e);
    }
    
    // í•™ìƒ ì˜¤ë””ì˜¤ ìë™ í™œì„±í™”
    const audioTrack = studentAudioTracks.get(studentId);
    if (audioTrack) {
      audioTrack.enabled = true;
      log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ì˜¤ë””ì˜¤ ìë™ í™œì„±í™”`);
    }
    
    // ìŒì†Œê±° í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const unmuteBtn = document.getElementById(`unmute-btn-${studentId}`);
    if (unmuteBtn) {
      unmuteBtn.textContent = 'ğŸ”Š ìŒì†Œê±° í•´ì œ';
      unmuteBtn.classList.remove('muted');
    }
    
    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    const allowBtn = document.getElementById(`question-allow-btn-${studentId}`);
    const endBtn = document.getElementById(`question-end-btn-${studentId}`);
    if (allowBtn) allowBtn.style.display = 'none';
    if (endBtn) endBtn.style.display = 'block';
    
    currentQuestionStudentId = studentId;
    questionFullscreenStudentId = studentId;
    toast(`í•™ìƒ ${studentId.substring(0,6)}ì—ê²Œ ì§ˆë¬¸ í—ˆë½ë¨`);
    
  } catch(e) {
    console.error('í•™ìƒ ì§ˆë¬¸ í—ˆë½ ì‹¤íŒ¨:', e);
    log('[Professor] í•™ìƒ ì§ˆë¬¸ í—ˆë½ ì‹¤íŒ¨: ' + e.message);
    toast('í•™ìƒ ì§ˆë¬¸ í—ˆë½ ì‹¤íŒ¨: ' + e.message);
  }
}

// í•™ìƒ ì§ˆë¬¸ ì™„ë£Œ í•¨ìˆ˜ (êµìˆ˜ ì „ìš©)
async function endStudentQuestion(studentId) {
  if (currentQuestionStudentId !== studentId) {
    return; // í˜„ì¬ ì§ˆë¬¸ ì¤‘ì¸ í•™ìƒê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ
  }
  
  try {
    // êµìˆ˜ì¸¡: ì „ì²´í™”ë©´ ë‹«ê¸° (ì´ì „ ìƒíƒœë¡œ ë³µê·€)
    if (fullscreenVideo.classList.contains('show') && questionFullscreenStudentId === studentId) {
      fullscreenVideo.classList.remove('show');
      if (fsVideo) {
        fsVideo.srcObject = null;
      }
      log(`[Professor] ì „ì²´í™”ë©´ ë‹«ê¸° (ì´ì „ ìƒíƒœë¡œ ë³µê·€)`);
    }
    
    // Firebaseì— ì§ˆë¬¸ ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡ (ëª¨ë“  í•™ìƒì—ê²Œ)
    try {
      await db.ref(`rooms/${roomId}/questionActive`).set({
        studentId: null,
        timestamp: Date.now(),
        active: false
      });
      log(`[Professor] ì§ˆë¬¸ ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡`);
    } catch(e) {
      console.warn('ì§ˆë¬¸ ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨:', e);
    }
    
    // í•™ìƒ PiP ì¢…ë£Œ
    if (studentQuestionPiPVideo && document.pictureInPictureElement === studentQuestionPiPVideo) {
      await document.exitPictureInPicture();
      log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ì§ˆë¬¸ ì™„ë£Œ - PiP ì¢…ë£Œ`);
    }
    
    // í•™ìƒ PiP ë¹„ë””ì˜¤ ì •ë¦¬
    if (studentQuestionPiPVideo) {
      studentQuestionPiPVideo.srcObject = null;
    }
    
    // í•™ìƒ ì˜¤ë””ì˜¤ ë‹¤ì‹œ ìŒì†Œê±°
    const audioTrack = studentAudioTracks.get(studentId);
    if (audioTrack) {
      audioTrack.enabled = false;
      log(`[Professor] í•™ìƒ ${studentId.substring(0,6)} ì˜¤ë””ì˜¤ ìŒì†Œê±° ë³µê·€`);
    }
    
    // ìŒì†Œê±° í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const unmuteBtn = document.getElementById(`unmute-btn-${studentId}`);
    if (unmuteBtn) {
      unmuteBtn.textContent = 'ğŸ”‡ ìŒì†Œê±°';
      unmuteBtn.classList.add('muted');
    }
    
    // ë²„íŠ¼ ìƒíƒœ ë³µê·€
    const allowBtn = document.getElementById(`question-allow-btn-${studentId}`);
    const endBtn = document.getElementById(`question-end-btn-${studentId}`);
    if (allowBtn) allowBtn.style.display = 'block';
    if (endBtn) endBtn.style.display = 'none';
    
    // ì§ˆë¬¸ ì‹œì‘ ì „ì— êµìˆ˜ PiPê°€ í™œì„±í™”ë˜ì–´ ìˆì—ˆìœ¼ë©´ ë‹¤ì‹œ ì‹œì‘
    if (professorPiPWasActiveBeforeQuestion && professorCameraPiPVideo && professorCameraPiPVideo.srcObject) {
      try {
        // ì•½ê°„ì˜ ì§€ì—° í›„ êµìˆ˜ PiP ë‹¤ì‹œ ì‹œì‘
        setTimeout(async () => {
          try {
            await professorCameraPiPVideo.play();
            await professorCameraPiPVideo.requestPictureInPicture();
            log('[Professor] êµìˆ˜ ì¹´ë©”ë¼ PiP ì¬ì‹œì‘ (ì§ˆë¬¸ ì™„ë£Œ í›„)');
            toast('êµìˆ˜ ì¹´ë©”ë¼ PiPê°€ ë‹¤ì‹œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch(e) {
            console.warn('êµìˆ˜ PiP ì¬ì‹œì‘ ì‹¤íŒ¨:', e);
            toast('êµìˆ˜ ì¹´ë©”ë¼ PiP ì¬ì‹œì‘ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”.');
          }
        }, 300);
      } catch(e) {
        console.warn('êµìˆ˜ PiP ì¬ì‹œì‘ ì¤€ë¹„ ì‹¤íŒ¨:', e);
      }
    }
    
    // ìƒíƒœ ì´ˆê¸°í™”
    professorPiPWasActiveBeforeQuestion = false;
    currentQuestionStudentId = null;
    toast(`í•™ìƒ ${studentId.substring(0,6)} ì§ˆë¬¸ ì™„ë£Œ`);
    
  } catch(e) {
    console.error('í•™ìƒ ì§ˆë¬¸ ì™„ë£Œ ì‹¤íŒ¨:', e);
    log('[Professor] í•™ìƒ ì§ˆë¬¸ ì™„ë£Œ ì‹¤íŒ¨: ' + e.message);
    toast('í•™ìƒ ì§ˆë¬¸ ì™„ë£Œ ì‹¤íŒ¨: ' + e.message);
  }
}

async function acceptStudent(vid, data, li){
  let remoteCandidatesRef = null;
  let myCandidatesRef = null;
  let disconnectTimer = null;
  
  try{
    // ì—°ê²° ì¢…ë£Œ í•¸ë“¤ëŸ¬
    const connectionStateHandler = () => {
      const state = _pc.connectionState;
      log(`[Professor] í•™ìƒ ${vid.substring(0,6)} ì—°ê²° ìƒíƒœ: ${state}`);
      
      if (state === 'connected') {
        // ì—°ê²° ì„±ê³µ - íƒ€ì´ë¨¸ ì·¨ì†Œ
        if (disconnectTimer) {
          clearTimeout(disconnectTimer);
          disconnectTimer = null;
        }
        log(`[Professor] í•™ìƒ ${vid.substring(0,6)} ì—°ê²° ì„±ê³µ`);
      } else if (state === 'disconnected') {
        // disconnectedëŠ” ì¼ì‹œì ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 5ì´ˆ ëŒ€ê¸°
        log(`[Professor] í•™ìƒ ${vid.substring(0,6)} ì¼ì‹œ ì—°ê²° ëŠê¹€ - 5ì´ˆ ëŒ€ê¸°`);
        if (!disconnectTimer) {
          disconnectTimer = setTimeout(() => {
            if (_pc.connectionState === 'disconnected' || _pc.connectionState === 'failed') {
              log(`[Professor] í•™ìƒ ${vid.substring(0,6)} ì—°ê²° ë³µêµ¬ ì‹¤íŒ¨ - ì •ë¦¬`);
              cleanupConnection();
            }
          }, 5000);
        }
      } else if (state === 'closed' || state === 'failed') {
        log(`[Professor] í•™ìƒ ${vid.substring(0,6)} ì—°ê²° ì¢…ë£Œ: ${state}`);
        cleanupConnection();
      }
    };
    
    const cleanupConnection = () => {
      if (disconnectTimer) {
        clearTimeout(disconnectTimer);
        disconnectTimer = null;
      }
      removeRemoteVideoElement(vid);
      peerConnections.delete(vid);
      // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
      if (remoteCandidatesRef) {
        remoteCandidatesRef.off();
        remoteCandidatesRef = null;
      }
      if (myCandidatesRef) {
        myCandidatesRef.off();
        myCandidatesRef = null;
      }
      if (firebaseListeners.candidates[vid]) {
        delete firebaseListeners.candidates[vid];
      }
    };

    const _pc = createPeer({ onconnectionstatechange: connectionStateHandler });
    peerConnections.set(vid, _pc);

    // ë‚´ íŠ¸ë™ ì¶”ê°€(ë°©ì†¡: êµìˆ˜ íŠ¸ë™ë§Œ / ë¯¸íŒ…: êµìˆ˜ ì¹´ë©”ë¼)
    if (localStream) {
      const videoTracks = localStream.getVideoTracks();
      const audioTracks = localStream.getAudioTracks();
      
      // ë°©ì†¡ ëª¨ë“œì—ì„œ í™”ë©´ê³µìœ  + ì¹´ë©”ë¼ì¸ ê²½ìš° (ì‹œì‘ ì‹œ ë˜ëŠ” ì‹¤í–‰ ì¤‘ ì¶”ê°€), ê° íŠ¸ë™ì„ ë³„ë„ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì¶”ê°€
      if (comm === 'broadcast' && videoTracks.length >= 2) {
        // íŠ¸ë™ labelë¡œ í™”ë©´ê³µìœ ì™€ ì¹´ë©”ë¼ êµ¬ë¶„
        const track0Label = videoTracks[0].label.toLowerCase();
        const track1Label = videoTracks[1].label.toLowerCase();
        const track0IsScreen = track0Label.includes('screen') || track0Label.includes('í™”ë©´') || 
                               track0Label.includes('display') || track0Label.includes('monitor') ||
                               track0Label.includes('window') || track0Label.includes('desktop');
        const track1IsScreen = track1Label.includes('screen') || track1Label.includes('í™”ë©´') || 
                               track1Label.includes('display') || track1Label.includes('monitor') ||
                               track1Label.includes('window') || track1Label.includes('desktop');
        
        let screenTrack = null;
        let cameraTrack = null;
        
        if (track0IsScreen && !track1IsScreen) {
          screenTrack = videoTracks[0];
          cameraTrack = videoTracks[1];
        } else if (!track0IsScreen && track1IsScreen) {
          cameraTrack = videoTracks[0];
          screenTrack = videoTracks[1];
        } else {
          // labelë¡œ êµ¬ë¶„ì´ ì•ˆ ë˜ëŠ” ê²½ìš°: ì²« ë²ˆì§¸ëŠ” í™”ë©´ê³µìœ , ë‘ ë²ˆì§¸ëŠ” ì¹´ë©”ë¼ë¡œ ê°€ì •
          screenTrack = videoTracks[0];
          cameraTrack = videoTracks[1];
        }
        
        // í™”ë©´ê³µìœ  íŠ¸ë™ (ì˜¤ë””ì˜¤ì™€ í•¨ê»˜)
        const screenStream = new MediaStream([screenTrack]);
        if (audioTracks.length > 0) {
          screenStream.addTrack(audioTracks[0]);
        }
        _pc.addTrack(screenTrack, screenStream);
        
        // ì¹´ë©”ë¼ íŠ¸ë™ (ë³„ë„ ìŠ¤íŠ¸ë¦¼)
        const cameraStream = new MediaStream([cameraTrack]);
        _pc.addTrack(cameraTrack, cameraStream);
        log(`[Professor] í•™ìƒ ${vid}ì—ê²Œ í™”ë©´ê³µìœ  ë° ì¹´ë©”ë¼ íŠ¸ë™ ì „ì†¡ (ë³„ë„ ìŠ¤íŠ¸ë¦¼)`);
      } else {
        // ì¼ë°˜ì ì¸ ê²½ìš°: ëª¨ë“  íŠ¸ë™ì„ ê°™ì€ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì¶”ê°€
        // ë‹¨, allCameraStreamsì— í¬í•¨ëœ ë¹„ë””ì˜¤ íŠ¸ë™ì€ ì œì™¸ (ì¤‘ë³µ ë°©ì§€)
        const localVideoTracks = localStream.getVideoTracks();
        const allCameraTrackLabels = new Set();
        allCameraStreams.forEach((cameraStream) => {
          const videoTrack = cameraStream.getVideoTracks()[0];
          if (videoTrack) {
            allCameraTrackLabels.add(videoTrack.label);
          }
        });
        
        localStream.getTracks().forEach(t => {
          // ë¹„ë””ì˜¤ íŠ¸ë™ì´ê³  allCameraStreamsì— í¬í•¨ëœ ê²½ìš° ì œì™¸
          if (t.kind === 'video' && allCameraTrackLabels.has(t.label)) {
            log(`[Professor] localStreamì˜ ì¹´ë©”ë¼ íŠ¸ë™ ì œì™¸ (allCameraStreamsì— í¬í•¨ë¨): ${t.label}`);
            return; // ì´ íŠ¸ë™ì€ ê±´ë„ˆë›°ê¸°
          }
          _pc.addTrack(t, localStream);
        });
      }
    }
    
    // ëª¨ë“  ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ í•™ìƒì—ê²Œ ì „ì†¡ (ë°©ì†¡ ëª¨ë“œì™€ ë¯¸íŒ… ëª¨ë“œ ëª¨ë‘)
    if (allCameraStreams.size > 0) {
      let cameraIndex = 0;
      allCameraStreams.forEach((cameraStream, deviceId) => {
        const videoTrack = cameraStream.getVideoTracks()[0];
        if (videoTrack && videoTrack.readyState === 'live') {
          try {
            const cameraLabel = videoTrack.label || `ì¹´ë©”ë¼ ${cameraIndex + 1}`;
            const cameraMediaStream = new MediaStream([videoTrack]);
            _pc.addTrack(videoTrack, cameraMediaStream);
            log(`[Professor] í•™ìƒ ${vid.substring(0,6)}ì—ê²Œ ì¹´ë©”ë¼ ì „ì†¡ (${comm} ëª¨ë“œ): ${cameraLabel}`);
            cameraIndex++;
          } catch(e) {
            console.warn(`[Professor] í•™ìƒ ${vid}ì—ê²Œ ì¹´ë©”ë¼ ì¶”ê°€ ì‹¤íŒ¨:`, e);
            log(`[Professor] í•™ìƒ ${vid.substring(0,6)}ì—ê²Œ ì¹´ë©”ë¼ ì „ì†¡ ì‹¤íŒ¨: ${e.message}`);
          }
        }
      });
      log(`[Professor] ì´ ${cameraIndex}ê°œì˜ ì¹´ë©”ë¼ë¥¼ í•™ìƒ ${vid.substring(0,6)}ì—ê²Œ ì „ì†¡ ì™„ë£Œ`);
    }
    preferH264(_pc);

    // remote ICE (student)
    remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/student`);
    firebaseListeners.candidates[vid] = remoteCandidatesRef;
    remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) _pc.addIceCandidate(new RTCIceCandidate(c)); });

    // my ICE (professor)
    myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/professor`);
    _pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };

    // ì›ê²© íŠ¸ë™ ìˆ˜ì‹  ì²˜ë¦¬
    _pc.ontrack = (ev)=>{
      const stream = ev.streams[0];
      const track = ev.track;
      
      // ì˜¤ë””ì˜¤ íŠ¸ë™ì¸ ê²½ìš° ì €ì¥ (ìŒì†Œê±° ì œì–´ìš©)
      if (track.kind === 'audio') {
        studentAudioTracks.set(vid, track);
        // í•™ìƒ ì…ì¥ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ìŒì†Œê±° ìƒíƒœ
        track.enabled = false;
        log(`[Professor] í•™ìƒ ${vid.substring(0,6)} ì˜¤ë””ì˜¤ íŠ¸ë™ ìˆ˜ì‹  (ìŒì†Œê±° ìƒíƒœ)`);
      }
      
      if (comm==='broadcast'){
        // ë°©ì†¡ì—ì„œ êµìˆ˜ëŠ” í•™ìƒ ì˜ìƒì„ êµ³ì´ ë³¼ í•„ìš” ì—†ìŒ
      }else{
        // ë¯¸íŒ…: ê° í•™ìƒë§ˆë‹¤ ë³„ë„ ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        let videoEl = remoteVideos.get(vid);
        if (!videoEl) {
          videoEl = createRemoteVideoElement(vid, `í•™ìƒ ${vid.substring(0,6)}`);
          remoteVideos.set(vid, videoEl);
        }
        if (videoEl.srcObject !== stream) {
          videoEl.srcObject = stream;
          // ë¹„ë””ì˜¤ëŠ” ìŒì†Œê±° ìƒíƒœë¡œ ì¬ìƒ (ì˜¤ë””ì˜¤ëŠ” íŠ¸ë™ ë ˆë²¨ì—ì„œ ì œì–´)
          videoEl.muted = false;
          (async ()=>{ 
            try{ 
              videoEl.setAttribute('playsinline',''); 
              videoEl.setAttribute('webkit-playsinline',''); 
              await videoEl.play(); 
            }catch(e){} 
          })();
        }
      }
    };

    // SDP ì²˜ë¦¬
    await _pc.setRemoteDescription(new RTCSessionDescription({ type:'offer', sdp:data.sdp }));
    const answer = await _pc.createAnswer();
    await _pc.setLocalDescription(answer);
    await db.ref(`rooms/${roomId}/answers/${vid}`).set({ sdp: answer.sdp, ts: Date.now() });

    // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ì—ì„œ ì œê±°
    if (li && li.parentNode) {
      li.remove();
    }
    // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
    if (pendingEl && pendingEl.children.length === 0) {
      hidePendingModal();
    }
    log('[Professor] answered to ' + vid);
  }catch(e){ 
    log('[Professor] í•™ìƒ ìŠ¹ì¸ ì‹¤íŒ¨: ' + e.message);
    toast('ì—°ê²° ì‹¤íŒ¨: ' + e.message);
    
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    if (remoteCandidatesRef) {
      try {
        remoteCandidatesRef.off();
      } catch(e2) {}
      remoteCandidatesRef = null;
    }
    if (myCandidatesRef) {
      try {
        myCandidatesRef.off();
      } catch(e2) {}
      myCandidatesRef = null;
    }
    if (firebaseListeners.candidates[vid]) {
      delete firebaseListeners.candidates[vid];
    }
    
    const _pc = peerConnections.get(vid);
    if (_pc) {
      try {
        _pc.getSenders().forEach(s => {
          if (s.track) s.track.stop();
        });
        _pc.close();
      } catch(e2) {}
      peerConnections.delete(vid);
    }
    removeRemoteVideoElement(vid);
    
    // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ pending ëª©ë¡ì—ì„œ ì œê±°
    if (li && li.parentNode) {
      li.remove();
    }
    
    // ìŠ¹ì¸ëŒ€ê¸°ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
    if (pendingEl && pendingEl.children.length === 0) {
      hidePendingModal();
    }
    
    // Firebase ë°ì´í„° ì •ë¦¬
    db.ref(`rooms/${roomId}/answers/${vid}`).remove().catch(() => {});
    db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(() => {});
  }
}

async function startStudent(){
  try {
    roomId = (roomIdInput ? roomIdInput.value||'' : '').replace(/\s+/g,''); 
    if(!roomId){ 
      toast('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      throw new Error('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    viewerId = randomId(8);
    myUserId = viewerId;
    
    // í•™ìƒ ì¸¡ ì—°ê²° ìƒíƒœ í•¸ë“¤ëŸ¬
    const studentConnectionHandler = () => {
      const state = pc.connectionState;
      log(`[Student] ì—°ê²° ìƒíƒœ: ${state}`);
      if (state === 'connected') {
        log('[Student] êµìˆ˜ì™€ ì—°ê²° ì„±ê³µ');
      } else if (state === 'disconnected') {
        log('[Student] ì—°ê²° ì¼ì‹œ ëŠê¹€ - ì¬ì—°ê²° ëŒ€ê¸° ì¤‘...');
        toast('ì—°ê²°ì´ ì¼ì‹œì ìœ¼ë¡œ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...');
      } else if (state === 'failed') {
        log('[Student] ì—°ê²° ì‹¤íŒ¨');
        toast('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ì‹¤í•´ ì£¼ì„¸ìš”.');
      }
    };
    
    pc = createPeer({ onconnectionstatechange: studentConnectionHandler });

    // íŠ¸ëœì‹œë²„/ë¡œì»¬ íŠ¸ë™ êµ¬ì„±
    if (comm==='broadcast'){
      // ìˆ˜ì‹  ì „ìš© (í™”ë©´ê³µìœ  + ì—¬ëŸ¬ ì¹´ë©”ë¼ë¥¼ ë°›ê¸° ìœ„í•´ ì—¬ëŸ¬ íŠ¸ëœì‹œë²„ ìƒì„±)
      // í™”ë©´ê³µìœ  1ê°œ + ìµœëŒ€ 10ê°œì˜ ì¹´ë©”ë¼ë¥¼ ì§€ì›
      pc.addTransceiver('video', { direction:'recvonly' }); // í™”ë©´ê³µìœ ìš©
      for (let i = 0; i < 10; i++) {
        pc.addTransceiver('video', { direction:'recvonly' }); // ì¹´ë©”ë¼ìš©
      }
      pc.addTransceiver('audio', { direction:'recvonly' });
    }else{
      // ë¯¸íŒ…: ë¡œì»¬ ì¹´ë©”ë¼ ìº¡ì²˜ í›„ ì „ì†¡ + êµìˆ˜ì˜ ëª¨ë“  ì¹´ë©”ë¼ ìˆ˜ì‹ 
      localStream = await getCameraStream();
      if (!localStream) {
        throw new Error('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
      // í•™ìƒ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ)
      showLocalPreview = true;
      if (localPreviewWrapper) {
        localPreviewWrapper.style.display = 'block';
      }
      if (showLocalPreview && localStream) {
        localPreview.srcObject = localStream;
        try{ localPreview.setAttribute('playsinline',''); localPreview.setAttribute('webkit-playsinline',''); await localPreview.play(); }catch(e){}
      }
      // í•™ìƒ ì…ì¥ ì‹œ ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ìŒì†Œê±° ìƒíƒœë¡œ ì„¤ì • (ë””í´íŠ¸ë¡œ í•­ìƒ êº¼ì§)
      localStream.getTracks().forEach(t => {
        if (t.kind === 'audio') {
          t.enabled = false; // ì˜¤ë””ì˜¤ íŠ¸ë™ ë¹„í™œì„±í™” (ìŒì†Œê±°)
          log('[Student] ì˜¤ë””ì˜¤ íŠ¸ë™ ìŒì†Œê±° ìƒíƒœë¡œ ì…ì¥ (ë””í´íŠ¸)');
        }
        pc.addTrack(t, localStream);
      });
      
      // êµìˆ˜ì˜ ëª¨ë“  ì¹´ë©”ë¼ë¥¼ ë°›ê¸° ìœ„í•´ ì¶”ê°€ íŠ¸ëœì‹œë²„ ìƒì„±
      // êµìˆ˜ê°€ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì¹´ë©”ë¼ ìˆ˜ë§Œí¼ íŠ¸ëœì‹œë²„ ìƒì„±
      for (let i = 0; i < 10; i++) {
        pc.addTransceiver('video', { direction:'recvonly' }); // êµìˆ˜ ì¹´ë©”ë¼ìš©
      }
      pc.addTransceiver('audio', { direction:'recvonly' }); // êµìˆ˜ ì˜¤ë””ì˜¤ìš©
    }

  // ë°©ì†¡ ëª¨ë“œì—ì„œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì  ì´ˆê¸°í™”
  broadcastVideoTracks = [];
  broadcastScreenTrack = null;
  broadcastCameraTrack = null;
  if (broadcastAllCameras) {
    broadcastAllCameras.clear();
  }
  
  // í•™ìƒ ì¹´ë©”ë¼ ì»¨í…Œì´ë„ˆ ì œê±°
  const studentCamerasContainer = document.getElementById('studentAllCamerasContainer');
  if (studentCamerasContainer) {
    studentCamerasContainer.remove();
  }
  broadcastAllCameras = new Map(); // ëª¨ë“  ì¹´ë©”ë¼ íŠ¸ë™ ì €ì¥ (trackId -> {track, label})
  
  pc.ontrack = (ev)=>{
    const stream = ev.streams[0];
    const track = ev.track;
    
    // ë””ë²„ê¹…: ëª¨ë“  íŠ¸ë™ ìˆ˜ì‹  ë¡œê·¸
    log(`[Student] íŠ¸ë™ ìˆ˜ì‹ : kind=${track.kind}, label=${track.label}, id=${track.id}`);
    console.log('[Student] Track received:', { kind: track.kind, label: track.label, id: track.id, enabled: track.enabled });
    
    if (comm==='broadcast'){
      // ë°©ì†¡ ëª¨ë“œ: playerê°€ í‘œì‹œë˜ì–´ì•¼ í•¨ (ì¹´ë©”ë¼ ê·¸ë¦¬ë“œëŠ” ë³„ë„ë¡œ í‘œì‹œ)
      player.classList.remove('hidden');
      // meetingVideosëŠ” ì¹´ë©”ë¼ ê·¸ë¦¬ë“œë¥¼ ìœ„í•´ ìˆ¨ê¸°ì§€ ì•ŠìŒ (displayStudentAllCamerasì—ì„œ ì²˜ë¦¬)
      
      // ë¹„ë””ì˜¤ íŠ¸ë™ì¸ ê²½ìš° ì¶”ì 
      if (track.kind === 'video') {
        // íŠ¸ë™ labelë¡œ í™”ë©´ê³µìœ ì™€ ì¹´ë©”ë¼ êµ¬ë¶„
        const trackLabel = track.label.toLowerCase();
        const isScreenTrack = trackLabel.includes('screen') || 
                              trackLabel.includes('í™”ë©´') ||
                              trackLabel.includes('display') ||
                              trackLabel.includes('monitor') ||
                              trackLabel.includes('window') ||
                              trackLabel.includes('desktop');
        
        log(`[Student] ë¹„ë””ì˜¤ íŠ¸ë™ ë¶„ì„: label="${track.label}", isScreenTrack=${isScreenTrack}, screenTrack=${!!broadcastScreenTrack}, cameraTrack=${!!broadcastCameraTrack}, enabled=${track.enabled}`);
        
        // íŠ¸ë™ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¬´ì‹œ
        if (!track.enabled) {
          log(`[Student] íŠ¸ë™ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ: ${track.label}`);
          return;
        }
        
        if (isScreenTrack && !broadcastScreenTrack) {
          // í™”ë©´ê³µìœ  íŠ¸ë™ (ë©”ì¸ í”Œë ˆì´ì–´)
          broadcastScreenTrack = track;
          const mainStream = new MediaStream([track]);
          if (player.srcObject !== mainStream) {
            player.srcObject = mainStream;
            (async ()=>{ try{ 
              player.setAttribute('playsinline',''); 
              player.setAttribute('webkit-playsinline',''); 
              await player.play(); 
            }catch(e){} })();
          }
          // ì˜¤ë””ì˜¤ íŠ¸ë™ë„ í•¨ê»˜ ì²˜ë¦¬
          const audioTracks = stream.getAudioTracks();
          if (audioTracks.length > 0) {
            audioMirror.srcObject = stream;
          }
          log('[Student] í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ë° í‘œì‹œ');
          
          // í™”ë©´ê³µìœ ê°€ ì‹œì‘ë˜ë©´ ìë™ìœ¼ë¡œ ì „ì²´í™”ë©´ í‘œì‹œ
          if (fsVideo && fullscreenVideo) {
            const fullscreenStream = new MediaStream([track]);
            fsVideo.srcObject = fullscreenStream;
            fullscreenVideo.classList.add('show');
            // í•™ìƒ ì§ˆë¬¸ ë²„íŠ¼ í‘œì‹œ
            if (fullscreenQuestionBtn) {
              fullscreenQuestionBtn.style.display = 'block';
            }
            fsVideo.setAttribute('playsinline', '');
            fsVideo.setAttribute('webkit-playsinline', '');
            fsVideo.play().catch(e => {
              console.warn('ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', e);
            });
            log('[Student] í™”ë©´ê³µìœ  ìë™ ì „ì²´í™”ë©´ í‘œì‹œ');
            toast('í™”ë©´ê³µìœ ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
          }
          
        } else if (!isScreenTrack) {
          // ì¹´ë©”ë¼ íŠ¸ë™ - playerì— í‘œì‹œ (í™”ë©´ê³µìœ ê°€ ì—†ì„ ë•Œ)
          const cameraLabel = track.label || `ì¹´ë©”ë¼ ${broadcastAllCameras.size + 1}`;
          broadcastAllCameras.set(track.id, { track, label: cameraLabel });
          log(`[Student] ì¹´ë©”ë¼ íŠ¸ë™ ìˆ˜ì‹ : label="${cameraLabel}" (ì´ ${broadcastAllCameras.size}ê°œ)`);
          
          // í™”ë©´ê³µìœ ê°€ ì—†ìœ¼ë©´ ì¹´ë©”ë¼ë¥¼ playerì— í‘œì‹œ
          if (!broadcastScreenTrack) {
            const cameraStream = new MediaStream([track]);
            player.srcObject = cameraStream;
            player.classList.remove('hidden');
            (async ()=>{ try{ 
              player.setAttribute('playsinline',''); 
              player.setAttribute('webkit-playsinline',''); 
              await player.play(); 
            }catch(e){} })();
            
            // ì˜¤ë””ì˜¤ íŠ¸ë™ë„ í•¨ê»˜ ì²˜ë¦¬
            const audioTracks = stream.getAudioTracks();
            if (audioTracks.length > 0) {
              audioMirror.srcObject = stream;
            }
            log('[Student] êµìˆ˜ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ playerì— í‘œì‹œ');
          }
          
          // íŠ¸ë™ ì¢…ë£Œ ì‹œ ì²˜ë¦¬
          track.onended = () => {
            broadcastAllCameras.delete(track.id);
            log(`[Student] ì¹´ë©”ë¼ íŠ¸ë™ ì¢…ë£Œ: ${cameraLabel}`);
          };
        } else if (!broadcastScreenTrack && !broadcastCameraTrack) {
          // labelë¡œ êµ¬ë¶„ì´ ì•ˆ ë˜ëŠ” ê²½ìš° ìˆœì„œ ê¸°ë°˜ ì²˜ë¦¬ (ì²« ë²ˆì§¸ëŠ” í™”ë©´ê³µìœ ë¡œ ê°€ì •)
          broadcastScreenTrack = track;
          const mainStream = new MediaStream([track]);
          if (player.srcObject !== mainStream) {
            player.srcObject = mainStream;
            (async ()=>{ try{ 
              player.setAttribute('playsinline',''); 
              player.setAttribute('webkit-playsinline',''); 
              await player.play(); 
            }catch(e){} })();
          }
          const audioTracks = stream.getAudioTracks();
          if (audioTracks.length > 0) {
            audioMirror.srcObject = stream;
          }
          log('[Student] ì²« ë²ˆì§¸ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  (í™”ë©´ê³µìœ ë¡œ ê°€ì •, label: ' + track.label + ')');
          
          // ì¹´ë©”ë¼ íŠ¸ë™ì´ ì´ë¯¸ ìˆ˜ì‹ ëœ ê²½ìš° PiP í‘œì‹œ
          if (broadcastCameraTrack) {
            const cameraStream = new MediaStream([broadcastCameraTrack]);
            pipVideo.srcObject = cameraStream;
            pipOverlay.classList.add('show');
            
            if (fullscreenPipVideo) {
              const fullscreenCameraStream = new MediaStream([broadcastCameraTrack]);
              fullscreenPipVideo.srcObject = fullscreenCameraStream;
              if (fullscreenVideo.classList.contains('show')) {
                fullscreenPipOverlay.classList.add('show');
              }
            }
            
            const playPipVideo = async () => {
              try {
                pipVideo.setAttribute('playsinline', '');
                pipVideo.setAttribute('webkit-playsinline', '');
                pipVideo.muted = true;
                await pipVideo.play();
                
                if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                  fullscreenPipVideo.setAttribute('playsinline', '');
                  fullscreenPipVideo.setAttribute('webkit-playsinline', '');
                  fullscreenPipVideo.muted = true;
                  await fullscreenPipVideo.play();
                }
                
                log('[Student] í™”ë©´ê³µìœ  ìˆ˜ì‹  í›„ ì¹´ë©”ë¼ PiP í‘œì‹œ (ìˆœì„œ ê¸°ë°˜)');
              } catch(e) {
                console.warn('PiP video play failed:', e);
                setTimeout(() => {
                  if (pipVideo.srcObject && broadcastCameraTrack) {
                    pipVideo.play().catch(e2 => {});
                  }
                  if (fullscreenPipVideo && fullscreenPipVideo.srcObject) {
                    fullscreenPipVideo.play().catch(e2 => {});
                  }
                }, 500);
              }
            };
            playPipVideo();
          }
        } else if (!isScreenTrack) {
          // ì¹´ë©”ë¼ íŠ¸ë™ - ëª¨ë“  ì¹´ë©”ë¼ë¥¼ ì €ì¥í•˜ê³  í‘œì‹œ (ì¤‘ë³µ ì œê±°: ê·¸ë¦¬ë“œì—ë§Œ í‘œì‹œ)
          const cameraLabel = track.label || `ì¹´ë©”ë¼ ${broadcastAllCameras.size + 1}`;
          broadcastAllCameras.set(track.id, { track, label: cameraLabel });
          log(`[Student] ì¹´ë©”ë¼ íŠ¸ë™ ìˆ˜ì‹ : label="${cameraLabel}" (ì´ ${broadcastAllCameras.size}ê°œ)`);
          
          // ëª¨ë“  ì¹´ë©”ë¼ë¥¼ ê·¸ë¦¬ë“œë¡œ í‘œì‹œ
          displayStudentAllCameras();
          
          // íŠ¸ë™ ì¢…ë£Œ ì‹œ ì²˜ë¦¬
          track.onended = () => {
            broadcastAllCameras.delete(track.id);
            displayStudentAllCameras(); // ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
            log(`[Student] ì¹´ë©”ë¼ íŠ¸ë™ ì¢…ë£Œ: ${cameraLabel}`);
          };
        } else {
          log(`[Student] ë¹„ë””ì˜¤ íŠ¸ë™ ë¬´ì‹œë¨ (ì´ë¯¸ ì²˜ë¦¬ë¨): label=${track.label}`);
        }
      } else if (track.kind === 'audio') {
        // ì˜¤ë””ì˜¤ íŠ¸ë™ ì²˜ë¦¬
        if (player.srcObject) {
          // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ì— ì˜¤ë””ì˜¤ íŠ¸ë™ ì¶”ê°€
          const currentStream = player.srcObject;
          if (!currentStream.getAudioTracks().length) {
            currentStream.addTrack(track);
            audioMirror.srcObject = currentStream;
          }
        } else {
          audioMirror.srcObject = stream;
        }
      }
      
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }else{
      // ë¯¸íŒ… ëª¨ë“œ: êµìˆ˜ì˜ ì¹´ë©”ë¼/í™”ë©´ê³µìœ ë¥¼ í‘œì‹œ
      if (track.kind === 'video') {
        const trackLabel = (track.label || '').toLowerCase();
        const isScreenTrack = trackLabel.includes('screen') || 
                              trackLabel.includes('í™”ë©´') ||
                              trackLabel.includes('display') ||
                              trackLabel.includes('monitor') ||
                              trackLabel.includes('window') ||
                              trackLabel.includes('desktop');
        
        if (isScreenTrack) {
          // í™”ë©´ê³µìœ  íŠ¸ë™ - ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ
          log('[Student] ë¯¸íŒ… ëª¨ë“œ - í™”ë©´ê³µìœ  íŠ¸ë™ ìˆ˜ì‹ ');
          
          if (fsVideo && fullscreenVideo) {
            const fullscreenStream = new MediaStream([track]);
            fsVideo.srcObject = fullscreenStream;
            fullscreenVideo.classList.add('show');
            if (fullscreenQuestionBtn) {
              fullscreenQuestionBtn.style.display = 'block';
            }
            fsVideo.setAttribute('playsinline', '');
            fsVideo.setAttribute('webkit-playsinline', '');
            fsVideo.play().catch(e => {
              console.warn('ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', e);
            });
            log('[Student] ë¯¸íŒ… ëª¨ë“œ - í™”ë©´ê³µìœ  ìë™ ì „ì²´í™”ë©´ í‘œì‹œ');
            toast('í™”ë©´ê³µìœ ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
          }
          
          // íŠ¸ë™ ì¢…ë£Œ ì‹œ ì „ì²´í™”ë©´ ë‹«ê¸°
          track.onended = () => {
            if (fullscreenVideo) {
              fullscreenVideo.classList.remove('show');
            }
            log('[Student] ë¯¸íŒ… ëª¨ë“œ - í™”ë©´ê³µìœ  ì¢…ë£Œ');
            toast('í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
          };
        } else {
          // ì¹´ë©”ë¼ íŠ¸ë™ - ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œì— í‘œì‹œ
          const cameraLabel = track.label || `êµìˆ˜ ì¹´ë©”ë¼`;
          const professorVideoId = 'professor-camera-' + track.id.substring(0, 8);
          
          // ì¤‘ë³µ ì²´í¬
          if (document.getElementById(`remote-video-${professorVideoId}`)) {
            log(`[Student] ë¯¸íŒ… ëª¨ë“œ - ì¤‘ë³µ ì¹´ë©”ë¼ íŠ¸ë™ ë¬´ì‹œ: ${cameraLabel}`);
            return;
          }
          
          broadcastAllCameras.set(track.id, { track, label: cameraLabel });
          log(`[Student] ë¯¸íŒ… ëª¨ë“œ - êµìˆ˜ ì¹´ë©”ë¼ íŠ¸ë™ ìˆ˜ì‹ : label="${cameraLabel}"`);
          
          // êµìˆ˜ ì¹´ë©”ë¼ë¥¼ ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œì— ì¶”ê°€
          const video = createRemoteVideoElement(professorVideoId, 'êµìˆ˜');
          if (video) {
            const cameraStream = new MediaStream([track]);
            video.srcObject = cameraStream;
            video.play().catch(e => {
              console.warn('êµìˆ˜ ì¹´ë©”ë¼ ì¬ìƒ ì‹¤íŒ¨:', e);
            });
            meetingVideos.classList.remove('hidden');
            log('[Student] ë¯¸íŒ… ëª¨ë“œ - êµìˆ˜ ì¹´ë©”ë¼ë¥¼ ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œì— í‘œì‹œ');
          }
          
          // íŠ¸ë™ ì¢…ë£Œ ì‹œ ì²˜ë¦¬
          track.onended = () => {
            broadcastAllCameras.delete(track.id);
            const videoWrapper = document.getElementById(`remote-video-${professorVideoId}`);
            if (videoWrapper) videoWrapper.remove();
            log(`[Student] ë¯¸íŒ… ëª¨ë“œ - êµìˆ˜ ì¹´ë©”ë¼ íŠ¸ë™ ì¢…ë£Œ: ${cameraLabel}`);
          };
        }
      } else if (track.kind === 'audio') {
        // ì˜¤ë””ì˜¤ íŠ¸ë™ ì²˜ë¦¬
        audioMirror.srcObject = stream;
        if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
      }
    }
    log(`[${role}] tracks: ` + stream.getTracks().map(t=>t.kind).join(', '));
  };

  // ICE
  const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/student`);
  pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };
  const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/professor`);
  firebaseListeners.candidates[viewerId] = remoteCandidatesRef;
  remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)); });

  // SDP - offerOptionsë¡œ ë¹ ë¥¸ ì—°ê²° ì„¤ì •
  preferH264(pc);
  const offerOptions = {
    offerToReceiveAudio: true,
    offerToReceiveVideo: true,
    iceRestart: false
  };
  const offer = await pc.createOffer(offerOptions);
  await pc.setLocalDescription(offer);
  
  // í•™ìƒëª…ë‹¨ í™•ì¸ (ì…ì‹¤ ì „)
  const studentName = userNameInput ? userNameInput.value.trim() : '';
  
  // ë¨¼ì € í•´ë‹¹ ê³¼ëª©ì— í•™ìƒëª…ë‹¨ì´ ìˆëŠ”ì§€ í™•ì¸
  const hasStudentList = await checkIfStudentListExists(roomId);
  
  if (hasStudentList) {
    // í•™ìƒëª…ë‹¨ì´ ìˆëŠ” ê³¼ëª©ì˜ ê²½ìš°: ì´ë¦„ í•„ìˆ˜ ì…ë ¥ ë° ëª…ë‹¨ í™•ì¸
    if (!studentName) {
      toast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. í•™ìƒëª…ë‹¨ì— ë“±ë¡ëœ ì´ë¦„ìœ¼ë¡œ ì…ì‹¤í•´ì•¼ í•©ë‹ˆë‹¤.');
      log(`[Student] í•™ìƒëª…ë‹¨ì´ ìˆëŠ” ê³¼ëª© - ì´ë¦„ ë¯¸ì…ë ¥ìœ¼ë¡œ ì…ì‹¤ ê±°ì ˆ`);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      isRunning = false;
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      if (pc) {
        try {
          pc.close();
        } catch(e2) {}
        pc = null;
      }
      throw new Error('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
    }
    
    const isInList = await checkStudentInList(studentName);
    if (!isInList) {
      toast('í•™ìƒëª…ë‹¨ì— ì—†ëŠ” í•™ìƒì…ë‹ˆë‹¤. ì…ì‹¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      log(`[Student] í•™ìƒëª…ë‹¨ì— ì—†ì–´ ì…ì‹¤ ê±°ì ˆ: ${studentName}`);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      isRunning = false;
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      if (pc) {
        try {
          pc.close();
        } catch(e2) {}
        pc = null;
      }
      throw new Error('í•™ìƒëª…ë‹¨ì— ì—†ëŠ” í•™ìƒì…ë‹ˆë‹¤');
    }
    log(`[Student] í•™ìƒëª…ë‹¨ í™•ì¸ ì™„ë£Œ: ${studentName}`);
  }
  
  const offerRef = db.ref(`rooms/${roomId}/offers/${viewerId}`);
  await offerRef.set({ 
    sdp: offer.sdp, 
    ts: Date.now(),
    userName: studentName || viewerId.substring(0,6) // í•™ìƒ ì´ë¦„ë„ í•¨ê»˜ ì „ì†¡
  }).catch(e=>{ alert('ì˜¤í¼ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message); });

  const answersRef = db.ref(`rooms/${roomId}/answers/${viewerId}`);
  firebaseListeners.answers = answersRef;
  answersRef.on('value', async snap=>{
    const val = snap.val();
    if(val && val.sdp && pc.signalingState === 'have-local-offer'){
      await pc.setRemoteDescription(new RTCSessionDescription({ type:'answer', sdp: val.sdp }));
      logStatus(comm==='broadcast' ? 'ì‹œì²­ ì¤‘â€¦' : 'ë¯¸íŒ… ì—°ê²°ë¨');
      toast('ì—°ê²° ì„±ê³µ. ì†Œë¦¬ê°€ ì•ˆ ë“¤ë¦¬ë©´ ğŸ”Š ë²„íŠ¼ ë˜ëŠ” í™”ë©´ íƒ­');
    }
  });

    startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
    
    // í•™ìƒ ì…ì‹¤ ì‹œ ì…ì‹¤ ì‹œê°„ ê¸°ë¡
    if (studentName) {
      await recordStudentEntry(studentName);
    }
    
    // í•™ìƒ ì…ì‹¤ ì‹œ ì¶œì„í™•ì¸ ë²„íŠ¼ í‘œì‹œ
    if (attendanceCheckBtn) {
      attendanceCheckBtn.style.display = 'inline-block';
    }
    
    // ì‹œì‘ í›„ UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í‘œì‹œ ë“±)
    refreshUIByMode();
    
    logStatus(`ì ‘ì† ìš”ì²­ ì™„ë£Œ. êµìˆ˜ ìŠ¹ì¸ ëŒ€ê¸°â€¦ (ë‚´ ID: ${viewerId})`);
    
    // ì±„íŒ… ì´ˆê¸°í™”
    chatMessages.innerHTML = '';
    initChat();
  } catch(e) {
    log('[Student] ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('í•™ìƒ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    startBtn.disabled = false;
    stopBtn.disabled = true;
    isRunning = false;
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    if (pc) {
      try {
        pc.close();
      } catch(e2) {}
      pc = null;
    }
    throw e;
  }
}

/* ---------------- Controls ---------------- */
if (startBtn) startBtn.addEventListener('click', async ()=>{
  try{
    if (role==='professor') await startProfessor(); else await startStudent();
  }catch(e){ alert('ì‹œì‘ ì‹¤íŒ¨: '+e.message); }
});
if (stopBtn) stopBtn.addEventListener('click', async ()=>{
  // í•™ìƒ í‡´ì‹¤ ì‹œ í‡´ì‹¤ ì‹œê°„ ê¸°ë¡
  if (role === 'student' && studentEntryTime) {
    await recordStudentExit();
  }
  // êµìˆ˜ í‡´ì‹¤ ì‹œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  if (role === 'professor') {
    if (classStartBtn) classStartBtn.style.display = 'none';
    if (classEndBtn) classEndBtn.style.display = 'none';
    if (studentListBtn) studentListBtn.style.display = 'none';
    if (attendanceCheckBtn) attendanceCheckBtn.style.display = 'none';
  } else {
    if (attendanceCheckBtn) attendanceCheckBtn.style.display = 'none';
  }
  await cleanup();
});

// ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë° ì±„íŒ… ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼
const showChatBtn = document.getElementById('showChatBtn');
if (showChatBtn) showChatBtn.addEventListener('click', showChatModal);
window.addEventListener('DOMContentLoaded', ()=>{
  const p = new URLSearchParams(location.search);
  const mode = p.get('mode');
  const r = p.get('role'), c=p.get('comm'), room=p.get('room'), a=p.get('autostart');
  
  // Viewer ëª¨ë“œ: ì¹´ë©”ë¼ ì˜ìƒë§Œ í‘œì‹œí•˜ëŠ” ê°„ë‹¨í•œ ë·°ì–´
  if (mode === 'viewer') {
    const viewerRoomId = p.get('room');
    const viewerType = p.get('type'); // 'camera' or 'screen'
    
    // UI ìˆ¨ê¸°ê¸°
    document.querySelector('header').style.display = 'none';
    document.querySelector('main').style.display = 'none';
    document.querySelector('footer').style.display = 'none';
    document.querySelector('aside').style.display = 'none';
    
    // Viewer ì „ìš© ìŠ¤íƒ€ì¼
    document.body.style.background = '#000';
    document.body.style.margin = '0';
    document.body.style.padding = '0';
    document.body.style.overflow = 'hidden';
    
    // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ë¥¼ ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œ
    player.style.position = 'fixed';
    player.style.top = '0';
    player.style.left = '0';
    player.style.width = '100vw';
    player.style.height = '100vh';
    player.style.objectFit = 'contain';
    player.style.background = '#000';
    player.classList.remove('hidden');
    player.controls = true;
    
    // Viewer ëª¨ë“œë¡œ í•™ìƒ ì—°ê²°
    if (viewerRoomId) {
      role = 'student';
      comm = 'broadcast';
      if (roomIdInput) roomIdInput.value = viewerRoomId;
      
      // ìë™ìœ¼ë¡œ í•™ìƒ ì—°ê²° ì‹œì‘
      setTimeout(async () => {
        try {
          await startStudent();
          log('[Viewer] Viewer ëª¨ë“œë¡œ ì—°ê²° ì‹œì‘');
        } catch(e) {
          console.error('Viewer ì—°ê²° ì‹¤íŒ¨:', e);
          log('[Viewer] ì—°ê²° ì‹¤íŒ¨: ' + e.message);
        }
      }, 500);
    }
    
    return; // Viewer ëª¨ë“œì—ì„œëŠ” ì¼ë°˜ ì´ˆê¸°í™” ìŠ¤í‚µ
  }
  
  // ì¼ë°˜ ëª¨ë“œ
  if (r && ['professor','student'].includes(r)) { const roleInput = document.querySelector(`input[name="role"][value="${r}"]`); if(roleInput) roleInput.checked=true; role=r; }
  if (c && ['broadcast','meeting'].includes(c)) { const commInput = document.querySelector(`input[name="comm"][value="${c}"]`); if(commInput) commInput.checked=true; comm=c; }
  if (room && roomIdInput) roomIdInput.value=room;
  refreshUIByMode();
  if (a==='1' && startBtn) setTimeout(()=>startBtn.click(), 400);
});

/* ---------------- Cleanup ---------------- */
async function cleanup(){
  try{
    // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
    if (firebaseListeners.offers) {
      firebaseListeners.offers.off();
      firebaseListeners.offers = null;
    }
    if (firebaseListeners.answers) {
      firebaseListeners.answers.off();
      firebaseListeners.answers = null;
    }
    if (firebaseListeners.chat) {
      firebaseListeners.chat.off();
      firebaseListeners.chat = null;
    }
    Object.values(firebaseListeners.candidates).forEach(ref => {
      if (ref) ref.off();
    });
    firebaseListeners.candidates = {};

    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    if(pc){ 
      pc.getSenders().forEach(s=>s.track && s.track.stop()); 
      pc.close(); 
      pc=null; 
    }
    
    // êµìˆ˜: ëª¨ë“  í•™ìƒ ì—°ê²° ì •ë¦¬
    if (role==='professor' && roomId) {
      peerConnections.forEach((_pc, vid) => {
        try {
          _pc.getSenders().forEach(s => s.track && s.track.stop());
          _pc.close();
          // Firebase ë°ì´í„° ì •ë¦¬
          db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(e => {});
          db.ref(`rooms/${roomId}/offers/${vid}`).remove().catch(e => {});
          db.ref(`rooms/${roomId}/answers/${vid}`).remove().catch(e => {});
        } catch(e) {}
      });
      peerConnections.clear();
      
      // ëª¨ë“  ì›ê²© ë¹„ë””ì˜¤ ì œê±°
      remoteVideos.forEach((video, vid) => {
        removeRemoteVideoElement(vid);
      });
    }
    
    // í•™ìƒ: ìì‹ ì˜ ë°ì´í„°ë§Œ ì •ë¦¬
    if(roomId && role==='student' && viewerId){
      await db.ref(`rooms/${roomId}/offers/${viewerId}`).remove().catch(e => {});
      await db.ref(`rooms/${roomId}/answers/${viewerId}`).remove().catch(e => {});
      await db.ref(`rooms/${roomId}/candidates/${viewerId}`).remove().catch(e => {});
    }
  }catch(e){
    console.error('Cleanup error:', e);
    log('[Error] Cleanup: ' + e.message);
  }
  isRunning=false; startBtn.disabled=false; stopBtn.disabled=true;
  player.srcObject=null; localPreview.srcObject=null;
  remoteVideosGrid.innerHTML='';
  remoteVideos.clear();
  pendingEl.innerHTML=''; logStatus('ëŒ€ê¸° ì¤‘â€¦'); unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
  showLocalPreview = true;  // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹ (í‘œì‹œ)
  if (localPreviewWrapper) {
    localPreviewWrapper.style.display = 'block';
  }
  togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
  chatMessages.innerHTML = '';
  chatInput.value = '';
  myUserId = '';
  viewerId = '';  // í•™ìƒ ID ë¦¬ì…‹
  roomId = '';  // ê³¼ëª©ëª… ë¦¬ì…‹
  if (infoEl) infoEl.textContent = '-';  // ì—°ê²° ì •ë³´ ì´ˆê¸°í™”
  
  // í™”ë©´ê³µìœ  ì •ë¦¬
  if (isScreenSharing) {
    if (screenShareStream) {
      screenShareStream.getTracks().forEach(t => t.stop());
      screenShareStream = null;
    }
    isScreenSharing = false;
    shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
    shareScreenBtn.style.background = '';
  }
  
  // êµìˆ˜ ì¹´ë©”ë¼ ë³„ë„ ì°½ ë‹«ê¸°
  closeProfessorCameraWindow();
  
  // ëª¨ë“  ì¹´ë©”ë¼ ì •ë¦¬
  cleanupAllCameras();
  
  // PiP ì •ë¦¬
  if (professorCameraStream) {
    professorCameraStream.getTracks().forEach(t => t.stop());
    professorCameraStream = null;
  }
  showProfessorCameraPip = false;
  pipOverlay.classList.remove('show');
  pipVideo.srcObject = null;
  
  // ë°©ì†¡ ëª¨ë“œ ë¹„ë””ì˜¤ íŠ¸ë™ ì¶”ì  ì´ˆê¸°í™”
  broadcastVideoTracks = [];
  broadcastScreenTrack = null;
  broadcastCameraTrack = null;
  if (broadcastAllCameras) {
    broadcastAllCameras.clear();
  }
  
  // í•™ìƒ ì¹´ë©”ë¼ ì»¨í…Œì´ë„ˆ ì œê±°
  const studentCamerasContainer = document.getElementById('studentAllCamerasContainer');
  if (studentCamerasContainer) {
    studentCamerasContainer.remove();
  }
  
  // ì „ì²´í™”ë©´ ì •ë¦¬
  fullscreenVideo.classList.remove('show');
  fsVideo.srcObject = null;
  if (fullscreenPipOverlay) {
    fullscreenPipOverlay.classList.remove('show');
    if (fullscreenPipVideo) fullscreenPipVideo.srcObject = null;
  }
  
  // Audio Context ì •ë¦¬
  if (audioCtx && audioCtx.state !== 'closed') {
    try {
      audioCtx.close().catch(() => {});
    } catch(e) {}
    audioCtx = null;
    gainNode = null;
  }
  if (viewerAudioCtx && viewerAudioCtx.state !== 'closed') {
    try {
      viewerAudioCtx.close().catch(() => {});
    } catch(e) {}
    viewerAudioCtx = null;
  }
}

/* ---------------- Error log ---------------- */
window.addEventListener('error', e=> log('[Error] ' + e.message));
</script>
</body>
</html>
