<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ìŠ¹ì¸ì œ WebRTC (ë°©ì†¡/ë¯¸íŒ…)</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1000px 700px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr 360px}
    .card{background:rgba(16,24,58,.8);border:1px solid #22306b;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block;margin-top:8px;font-size:14px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2b5bd1,#2048a8)}
    button.danger{background:linear-gradient(180deg,#c24,#932)}
    small{color:var(--muted)}
    video{width:100%;background:#000;border-radius:12px}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li{padding:10px;border:1px solid #2a3a77;border-radius:12px;background:#0f173b;display:flex;justify-content:space-between;align-items:center}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#1b285c;color:#cfe0ff;border:1px solid #2a3a77}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#a7b3d4}
    footer{padding:10px 16px;color:#a7b3d4;font-size:12px;text-align:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid-2h{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0d1433;border:1px solid #2a3a77;color:#eaf0ff;padding:10px 14px;border-radius:12px;display:none}
    .hidden{display:none!important}
  </style>
</head>
<body>
<header>
  <h1>ìŠ¹ì¸ì œ WebRTC (ë°©ì†¡/ë¯¸íŒ…)</h1>
  <div class="row">
    <span class="tag">P2P</span>
    <span class="tag">Firebase RTDB</span>
    <span class="tag">ìµëª… ì¸ì¦</span>
  </div>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 8px 0">ë¼ì´ë¸Œ</h2>

    <!-- ë°©ì†¡ ëª¨ë“œ: ë‹¨ì¼ í”Œë ˆì´ì–´ -->
    <video id="player" class="" autoplay playsinline webkit-playsinline muted controls></video>

    <!-- ë¯¸íŒ… ëª¨ë“œ: ì›ê²©/ë‚´ë¯¸ë¦¬ë³´ê¸° 2ë¶„í•  -->
    <div id="meetingVideos" class="grid-2h hidden">
      <div>
        <small class="muted">ìƒëŒ€(ì›ê²©)</small>
        <video id="remoteVideo" autoplay playsinline webkit-playsinline controls></video>
      </div>
      <div>
        <small class="muted">ë‚˜(ë¯¸ë¦¬ë³´ê¸° Â· í•­ìƒ ìŒì†Œê±°)</small>
        <video id="localPreview" autoplay playsinline webkit-playsinline muted controls></video>
      </div>
    </div>

    <audio id="audiomirror" autoplay playsinline webkit-playsinline style="display:none"></audio>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label>ì—­í• </label>
        <div class="row">
          <label class="row"><input type="radio" name="role" value="host" checked> ì†¡ì¶œì(í˜¸ìŠ¤íŠ¸)</label>
          <label class="row"><input type="radio" name="role" value="guest"> ì‹œì²­ì/ê²ŒìŠ¤íŠ¸</label>
        </div>
      </div>
      <div>
        <label>ë°© ì½”ë“œ(Room ID)</label>
        <input id="roomId" type="text" placeholder="ì˜ˆ: rm-k3G7a9fQ2" />
        <small class="hint">ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìë™ ìƒì„±</small>
      </div>
    </div>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label>í†µì‹  ëª¨ë“œ</label>
        <div class="row" id="commRow">
          <label class="row"><input type="radio" name="comm" value="broadcast" checked> ë°©ì†¡(ë‹¨ë°©í–¥)</label>
          <label class="row"><input type="radio" name="comm" value="meeting"> ë¯¸íŒ…(ì–‘ë°©í–¥)</label>
        </div>
      </div>
      <div id="sourceWrap">
        <label>ì†ŒìŠ¤ ì„ íƒ(ë°©ì†¡ ëª¨ë“œ)</label>
        <div class="row" id="sourceRow">
          <label class="row"><input type="radio" name="source" value="screen" checked> í™”ë©´ê³µìœ </label>
          <label class="row"><input type="radio" name="source" value="camera"> ì¹´ë©”ë¼</label>
        </div>
      </div>
    </div>

    <!-- ì¹´ë©”ë¼ ì œì–´ -->
    <div class="row" id="cameraCtrl" style="margin-top:10px; display:none">
      <button id="switchCamBtn">ì „/í›„ë©´ ì „í™˜</button>
      <button id="muteMicBtn">ë§ˆì´í¬ ìŒì†Œê±°</button>
      <button id="muteCamBtn">ì¹´ë©”ë¼ ë„ê¸°</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="genRoom">ë°© ì½”ë“œ ìë™ìƒì„±</button>
      <button class="primary" id="startBtn">ì‹œì‘</button>
      <button class="danger" id="stopBtn" disabled>ì¢…ë£Œ</button>
      <button id="unmuteBtn" style="display:none">ğŸ”Š ì†Œë¦¬ ì¼œê¸°</button>
    </div>

    <!-- ì˜¤ë””ì˜¤ ì¦í­(ë°©ì†¡ ëª¨ë“œì—ì„œ ì†¡ì¶œìë§Œ í‘œì‹œ) -->
    <div id="gainRow" class="row" style="margin-top:8px; display:none">
      <small class="muted">ì˜¤ë””ì˜¤ ì¦í­:</small>
      <input id="gainSlider" type="range" min="1" max="3" step="0.1" value="2" />
      <small class="muted"><span id="gainVal">2.0</span>x</small>
    </div>

    <div style="margin-top:6px"><small id="status" class="muted">ëŒ€ê¸° ì¤‘â€¦</small></div>
    <div id="presenterHints" style="margin-top:12px;display:none">
      <small class="hint">* iPadëŠ” ì²« ì¬ìƒ ì‹œ ğŸ”Š ë²„íŠ¼(ë˜ëŠ” í™”ë©´ íƒ­)ìœ¼ë¡œ ìŒì†Œê±° í•´ì œê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
    </div>
  </section>

  <aside class="card">
    <h3 style="margin-top:0">ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡(í˜¸ìŠ¤íŠ¸ ì „ìš©)</h3>
    <ul id="pending"></ul>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ì—°ê²° ì •ë³´</h3>
      <div id="info" class="hint">-</div>
    </div>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ë¡œê·¸</h3>
      <pre id="log" class="hint" style="white-space:pre-wrap;max-height:220px;overflow:auto"></pre>
    </div>
  </aside>
</main>

<footer>
  ëŒ€ê·œëª¨/ë‹¤ìê°„ì€ SFU ê¶Œì¥(LiveKit/Janus/mediasoup). TURN ì¶”ê°€ ì‹œ ì—°ê²°ë¥ â†‘
</footer>

<div id="toast"></div>

<!-- iOSìš© ì–¸ë®¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
<div id="tapUnmuteOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center;">
  <button id="tapUnmuteBtn" style="font-size:18px;padding:14px 18px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer">
    ğŸ”Š íƒ­í•˜ì—¬ ì†Œë¦¬ ì¼œê¸°
  </button>
</div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-007jMq4dO7M6t6wn5vR_PZW9Gg1n0LM",
  authDomain: "webboard-ea2c4.firebaseapp.com",
  databaseURL: "https://webboard-ea2c4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webboard-ea2c4",
  storageBucket: "webboard-ea2c4.firebasestorage.app",
  messagingSenderId: "1063560565058",
  appId: "1:1063560565058:web:bd9b57bef6dd649f67f8db",
  measurementId: "G-NTQGQJVW8E"
};
firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously().catch(err=>{ console.error('Auth failed:', err); alert('Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message); });
const db = firebase.database();

/* ---------------- UI refs ---------------- */
const player = document.getElementById('player');                 // ë°©ì†¡ ëª¨ë“œ í”Œë ˆì´ì–´
const meetingVideos = document.getElementById('meetingVideos');   // ë¯¸íŒ… ëª¨ë“œ ì»¨í…Œì´ë„ˆ
const remoteVideo = document.getElementById('remoteVideo');
const localPreview = document.getElementById('localPreview');
const audioMirror = document.getElementById('audiomirror');
const roomIdInput = document.getElementById('roomId');
const statusEl = document.getElementById('status');
const pendingEl = document.getElementById('pending');
const infoEl = document.getElementById('info');
const logEl = document.getElementById('log');
const presenterHints = document.getElementById('presenterHints');
const unmuteBtn = document.getElementById('unmuteBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const genRoom  = document.getElementById('genRoom');
const toastEl  = document.getElementById('toast');
const tapUnmuteOverlay = document.getElementById('tapUnmuteOverlay');
const tapUnmuteBtn = document.getElementById('tapUnmuteBtn');
const gainRow    = document.getElementById('gainRow');
const gainSlider = document.getElementById('gainSlider');
const gainVal    = document.getElementById('gainVal');
const switchCamBtn = document.getElementById('switchCamBtn');
const muteMicBtn   = document.getElementById('muteMicBtn');
const muteCamBtn   = document.getElementById('muteCamBtn');
const cameraCtrl   = document.getElementById('cameraCtrl');
const sourceWrap   = document.getElementById('sourceWrap');

/* ---------------- State ---------------- */
let role = 'host';                 // 'host' | 'guest'
let comm = 'broadcast';            // 'broadcast' | 'meeting'
let sourceMode = 'screen';         // ë°©ì†¡ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©: 'screen' | 'camera'
let facingMode = 'user';           // ì¹´ë©”ë¼ ì „/í›„ë©´
let roomId = '';
let viewerId = '';
let isRunning = false;
let pc = null;
let localStream = null;            // ë‚´ê°€ ë³´ë‚´ëŠ” ìŠ¤íŠ¸ë¦¼(ëª¨ë“œë³„ êµ¬ì„±)
let audioCtx = null, gainNode = null, viewerAudioCtx = null;

/* ---------------- Utils ---------------- */
// ê°•ì œ ì¬ìƒ ë³´ì¡°(ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ ìš°íšŒ)
async function forcePlay(el){
  if(!el) return;
  try{
    el.muted = true;                    // ìë™ì¬ìƒ ë³´ì¡°
    el.setAttribute('muted','');        // iOS ë³´ì¡°
    el.setAttribute('playsinline','');  // iOS ë³´ì¡°
    el.setAttribute('webkit-playsinline','');
    await el.play();
  }catch(e){
    console.warn('forcePlay blocked:', e);
  }
}

function logStatus(msg){ statusEl.textContent = msg; }
function log(msg){ console.log(msg); logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; }
function toast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1800); }
function randomId(len=10){ const c='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789'; let s=''; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
const isiOS = (() => { const ua = navigator.userAgent||''; const iOS=/iPad|iPhone|iPod/.test(ua); const iPadOS13Plus=navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1; return iOS||iPadOS13Plus; })();
player.volume = 1.0; remoteVideo.volume = 1.0;

/* ---------------- UI bindings ---------------- */
document.querySelectorAll('input[name="role"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    role = document.querySelector('input[name="role"]:checked').value;
    refreshUIByMode();
  });
});
document.querySelectorAll('input[name="comm"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    comm = document.querySelector('input[name="comm"]:checked').value;
    refreshUIByMode();
  });
});
document.querySelectorAll('input[name="source"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    sourceMode = document.querySelector('input[name="source"]:checked').value;
  });
});
function refreshUIByMode(){
  const isHost = role==='host';
  const isMeeting = comm==='meeting';

  presenterHints.style.display = isHost ? 'block' : 'none';
  gainRow.style.display = (isHost && comm==='broadcast') ? 'flex' : 'none';
  sourceWrap.style.display = (comm==='broadcast') ? 'block' : 'none';

  // í”Œë ˆì´ì–´ í‘œì‹œ ì „í™˜
  if (isMeeting){
    player.classList.add('hidden');
    meetingVideos.classList.remove('hidden');
    cameraCtrl.style.display = 'flex'; // ë¯¸íŒ…ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì¹´ë©”ë¼/ë§ˆì´í¬ ì»¨íŠ¸ë¡¤ ë…¸ì¶œ
  }else{
    meetingVideos.classList.add('hidden');
    player.classList.remove('hidden');
    cameraCtrl.style.display = (isHost && sourceMode==='camera') ? 'flex' : 'none';
  }
  if (!isMeeting && role==='guest' && isiOS) showIOSUnmuteOverlayIfNeeded();
}
refreshUIByMode();

switchCamBtn.addEventListener('click', async ()=>{
  facingMode = (facingMode==='user')?'environment':'user';
  toast(`ì¹´ë©”ë¼ ì „í™˜: ${facingMode==='user'?'ì „ë©´':'í›„ë©´'}`);
  if (!localStream) return;
  await replaceVideoTrack();
});

muteMicBtn.addEventListener('click', ()=>{
  const t = localStream?.getAudioTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  muteMicBtn.textContent = t.enabled ? 'ë§ˆì´í¬ ìŒì†Œê±°' : 'ë§ˆì´í¬ ì¼œê¸°';
});

muteCamBtn.addEventListener('click', ()=>{
  const t = localStream?.getVideoTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  muteCamBtn.textContent = t.enabled ? 'ì¹´ë©”ë¼ ë„ê¸°' : 'ì¹´ë©”ë¼ ì¼œê¸°';
});

if (gainSlider) {
  gainSlider.addEventListener('input', () => {
    if (gainNode) {
      const v = parseFloat(gainSlider.value);
      gainNode.gain.value = v;
      gainVal.textContent = v.toFixed(1);
    }
  });
}

/* ---------------- WebRTC helpers ---------------- */
const iceServers = [{ urls: ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] }];
function createPeer(){
  const _pc = new RTCPeerConnection({ iceServers });
  _pc.oniceconnectionstatechange = () => { infoEl.textContent = 'ICE: ' + _pc.iceConnectionState; };
  _pc.onconnectionstatechange = () => { infoEl.textContent += ' | PC: ' + _pc.connectionState; };
  return _pc;
}
function preferH264(pc){
  try{
    const txs = typeof pc.getTransceivers === 'function' ? pc.getTransceivers() : [];
    const caps = RTCRtpSender.getCapabilities ? RTCRtpSender.getCapabilities('video') : null;
    if (!caps || !caps.codecs) return;
    const h264 = caps.codecs.filter(c => /H264/i.test(c.mimeType));
    if (!h264.length) return;
    txs.forEach(t => {
      const kind = t?.sender?.track?.kind || t?.kind;
      if (kind === 'video' && typeof t.setCodecPreferences === 'function') {
        const others = caps.codecs.filter(c => !/H264/i.test(c.mimeType));
        t.setCodecPreferences(h264.concat(others));
      }
    });
  }catch(e){ console.warn('preferH264 failed:', e); }
}
async function enableAudioPlayback(){
  try{
    const els = comm==='meeting' ? [remoteVideo, audioMirror] : [player, audioMirror];
    els.forEach(el=>{ if(!el) return; el.muted=false; el.removeAttribute('muted'); el.volume=1.0; el.setAttribute('playsinline',''); el.setAttribute('webkit-playsinline',''); });
    if (isiOS){
      if (!viewerAudioCtx) viewerAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (viewerAudioCtx.state!=='running'){ try{ await viewerAudioCtx.resume(); }catch(_){} }
      const sink = comm==='meeting' ? remoteVideo : player;
      if (audioMirror && audioMirror.srcObject && viewerAudioCtx.state==='running'){
        try{
          const src = viewerAudioCtx.createMediaStreamSource(audioMirror.srcObject);
          const gain = viewerAudioCtx.createGain(); gain.gain.value = 1.0;
          src.connect(gain).connect(viewerAudioCtx.destination);
        }catch(_){}
      }
      try{ await sink.play(); }catch(e){}
    }else{
      try{ await (comm==='meeting'?remoteVideo:player).play(); }catch(e){}
    }
    unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
  }catch(e){ console.warn('enableAudioPlayback failed:', e); }
}
function showIOSUnmuteOverlayIfNeeded() {
  if (isiOS) {
    tapUnmuteOverlay.style.display = 'flex';
    unmuteBtn.style.display = 'none';
  }
}
tapUnmuteBtn.addEventListener('click', enableAudioPlayback);
unmuteBtn.addEventListener('click', enableAudioPlayback);

/* ---------------- Media Builders ---------------- */
async function getCameraStream(){
  return await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode,
      width:  { ideal: 1280, max: 1920 },
      height: { ideal: 720,  max: 1080 },
      frameRate: { ideal: 30, max: 60 }
    },
    audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
  });
}

async function getScreenStream(){
  try{
    return await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch(e){
    log('[Host] getDisplayMedia with audio failed, retry video-only');
    return await navigator.mediaDevices.getDisplayMedia({ video:true }); // ì¬ì‹œë„
  }
}

async function makeAmplifiedStreamFrom(sourceStream, fallbackUseMic=true){
  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  const initialGain = parseFloat(gainSlider?.value || '2') || 2.0;
  gainNode.gain.value = initialGain;
  if (gainVal) gainVal.textContent = initialGain.toFixed(1);

  const videoTracks = sourceStream.getVideoTracks();
  const inAudioTracks = sourceStream.getAudioTracks();
  let outputAudioTrack = null;

  if (inAudioTracks.length){
    const src = audioCtx.createMediaStreamSource(sourceStream);
    const dest = audioCtx.createMediaStreamDestination();
    src.connect(gainNode).connect(dest);
    outputAudioTrack = dest.stream.getAudioTracks()[0];
  } else if (fallbackUseMic){
    try{
      const mic = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } });
      const src = audioCtx.createMediaStreamSource(mic);
      const dest = audioCtx.createMediaStreamDestination();
      src.connect(gainNode).connect(dest);
      outputAudioTrack = dest.stream.getAudioTracks()[0];
    }catch(e){ log('[Audio] ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: '+e.message); }
  }

  return outputAudioTrack ? new MediaStream([...videoTracks, outputAudioTrack]) : new MediaStream([...videoTracks]);
}
async function buildLocalStreamForCurrentMode(){
  if (comm==='broadcast'){
    if (role!=='host'){
      // ê²ŒìŠ¤íŠ¸ëŠ” ì˜ìƒ ì•ˆ ë³´ëƒ„(ìˆ˜ì‹ ë§Œ)
      return null;
    }
    const raw = (sourceMode==='screen') ? await getScreenStream() : await getCameraStream();
    const amplified = await makeAmplifiedStreamFrom(raw, sourceMode==='screen');
    return amplified;
  }else{ // meeting
    const cam = await getCameraStream();
    // ë¯¸íŒ…ì€ ì¦í­ ë¶ˆí•„ìš”(ì—ì½” ìœ„í—˜). ì›ë³¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    return cam;
  }
}
async function replaceVideoTrack(){
  if (!pc || !localStream) return;

  // ìƒˆ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
  const newStream = await getCameraStream();
  const newTrack = newStream.getVideoTracks()[0];
  const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');

  if (sender && newTrack){
    try{
      await sender.replaceTrack(newTrack);
    }catch(e){
      console.warn('replaceTrack failed, renegotiate fallback:', e);
      try{
        const old = sender.track;
        if (old) old.stop();
        await sender.replaceTrack(null);
        pc.addTrack(newTrack, localStream);
        // (ê°„ë‹¨ ëŒ€ì•ˆ) ì¬í˜‘ìƒ ë¡œì§ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ offer/answer ë‹¤ì‹œ ë§Œë“¤ë„ë¡ í™•ì¥ ê°€ëŠ¥
      }catch(e2){ console.warn('fallback failed:', e2); }
    }

    // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ê°±ì‹  + í”„ë¦¬ë·° ê°±ì‹ 
    localStream.getVideoTracks().forEach(t=>t.stop());
    localStream = new MediaStream([ newTrack, ...localStream.getAudioTracks() ]);

    if (comm==='meeting'){
      localPreview.srcObject = localStream;
      await forcePlay(localPreview);
    }else{
      player.srcObject = localStream;
      await forcePlay(player);
    }
  }
}


/* ---------------- Signaling: Host / Guest ---------------- */
function addPending(vid, data){
  const li = document.createElement('li');
  li.id = `pending-${vid}`;
  li.innerHTML = `
    <div>
      <div><b>ê²ŒìŠ¤íŠ¸</b> <span class="tag">${vid}</span></div>
      <div class="muted" style="font-size:12px">ì˜¤í¼ ìˆ˜ì‹ </div>
    </div>
    <div class="row">
      <button class="primary">í—ˆìš©</button>
      <button class="danger">ê±°ì ˆ</button>
    </div>
  `;
  const [allowBtn, denyBtn] = li.querySelectorAll('button');
  allowBtn.onclick = () => acceptGuest(vid, data, li);
  denyBtn.onclick  = () => denyGuest(vid, li);
  pendingEl.appendChild(li);
}
function denyGuest(vid, li){
  db.ref(`rooms/${roomId}/offers/${vid}`).remove();
  db.ref(`rooms/${roomId}/candidates/${vid}`).remove();
  li.remove();
}

async function startHost(){
  roomId = (roomIdInput.value||'').replace(/\s+/g,''); if(!roomId){ roomId='rm-'+randomId(9); roomIdInput.value=roomId; }
  localStream = await buildLocalStreamForCurrentMode();
  const vTrack = localStream?.getVideoTracks?.()[0];
  if (vTrack) {
    vTrack.onended = () => {
      log('[Host] video track ended (ì°½ ë‹«í˜/ìµœì†Œí™” ë“±). ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
      toast('ê³µìœ  í™”ë©´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. [ì‹œì‘]ìœ¼ë¡œ ë‹¤ì‹œ ê³µìœ í•˜ì„¸ìš”.');
      // í•„ìš”í•˜ë©´ ìë™ ì¬ì‹œì‘:
      // startBtn.click();
    };
  }


  if (comm==='broadcast'){
    if (localStream) {
      player.srcObject = localStream;
      await forcePlay(player);
      try{ player.muted=true; player.setAttribute('muted',''); player.setAttribute('playsinline',''); player.setAttribute('webkit-playsinline',''); await player.play(); }catch(e){}
    }
  }else{ // meeting
    // ë¯¸ë¦¬ë³´ê¸°/ì›ê²© UI
    localPreview.srcObject = localStream;
    await forcePlay(localPreview);
    try{ localPreview.setAttribute('playsinline',''); localPreview.setAttribute('webkit-playsinline',''); await localPreview.play(); }catch(e){}
  }

  // ê²ŒìŠ¤íŠ¸ ì˜¤í¼ ëŒ€ê¸°
  const offersRef = db.ref(`rooms/${roomId}/offers`);
  offersRef.on('child_added', async snap=>{
    const vid = snap.key; const data = snap.val();
    if(!data || !data.sdp) return;
    addPending(vid, data);
    log('[Host] offer arrived from: ' + vid);
  });

  startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
  logStatus(`í˜¸ìŠ¤íŠ¸ ëŒ€ê¸°/ì†¡ì¶œ ì¤‘â€¦ ë°© ì½”ë“œ: ${roomId} Â· ëª¨ë“œ: ${comm}`);
  toast('ê²ŒìŠ¤íŠ¸ì—ê²Œ ë°© ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”');
}

async function acceptGuest(vid, data, li){
  try{
    const _pc = createPeer();

    // ë‚´ íŠ¸ë™ ì¶”ê°€(ë°©ì†¡: í˜¸ìŠ¤íŠ¸ íŠ¸ë™ë§Œ / ë¯¸íŒ…: í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼)
    if (localStream) localStream.getTracks().forEach(t=>_pc.addTrack(t, localStream));
    preferH264(_pc);

    // remote ICE (guest)
    const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/guest`);
    remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) _pc.addIceCandidate(new RTCIceCandidate(c)); });

    // my ICE (host)
    const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/host`);
    _pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };

    // ì›ê²© íŠ¸ë™ ìˆ˜ì‹  ì²˜ë¦¬
    _pc.ontrack = (ev)=>{
      const stream = ev.streams[0];
      if (comm==='broadcast'){
        // ë°©ì†¡ì—ì„œ í˜¸ìŠ¤íŠ¸ëŠ” ê²ŒìŠ¤íŠ¸ ì˜ìƒì„ êµ³ì´ ë³¼ í•„ìš” ì—†ìŒ(ì›í•˜ë©´ playerì— ë¶™ì¼ ìˆ˜ ìˆìŒ)
      }else{
        // ë¯¸íŒ…: ìƒëŒ€ ì˜ìƒ í‘œì‹œ
        if (remoteVideo.srcObject !== stream){
          remoteVideo.srcObject = stream;
          (async ()=>{ try{ remoteVideo.setAttribute('playsinline',''); remoteVideo.setAttribute('webkit-playsinline',''); await remoteVideo.play(); }catch(e){} })();
          audioMirror.srcObject = stream; // iOS ë³´ì¡°
        }
      }
    };

    // SDP ì²˜ë¦¬
    await _pc.setRemoteDescription(new RTCSessionDescription({ type:'offer', sdp:data.sdp }));
    const answer = await _pc.createAnswer();
    await _pc.setLocalDescription(answer);
    await db.ref(`rooms/${roomId}/answers/${vid}`).set({ sdp: answer.sdp, ts: Date.now() });

    li.querySelector('.muted').textContent = 'ì—°ê²° ì§„í–‰ ì¤‘â€¦';
    li.style.opacity = .7;
    log('[Host] answered to ' + vid);
  }catch(e){ alert('ì—°ê²° ì‹¤íŒ¨: ' + e.message); }
}

async function startGuest(){
  roomId = (roomIdInput.value||'').replace(/\s+/g,''); if(!roomId){ alert('ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  viewerId = randomId(8);
  pc = createPeer();

  // íŠ¸ëœì‹œë²„/ë¡œì»¬ íŠ¸ë™ êµ¬ì„±
  if (comm==='broadcast'){
    // ìˆ˜ì‹  ì „ìš©
    pc.addTransceiver('video', { direction:'recvonly' });
    pc.addTransceiver('audio', { direction:'recvonly' });
  }else{
    // ë¯¸íŒ…: ë¡œì»¬ ì¹´ë©”ë¼ ìº¡ì²˜ í›„ ì „ì†¡
    localStream = await getCameraStream();
    localPreview.srcObject = localStream;
    try{ localPreview.setAttribute('playsinline',''); localPreview.setAttribute('webkit-playsinline',''); await localPreview.play(); }catch(e){}
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
  }

  pc.ontrack = (ev)=>{
    const stream = ev.streams[0];
    if (comm==='broadcast'){
      if (player.srcObject !== stream){
        player.srcObject = stream;
        
        (async ()=>{ try{ 
          player.setAttribute('playsinline',''); 
          player.setAttribute('webkit-playsinline',''); 
          await player.play(); 
        }catch(e){} })();
        audioMirror.srcObject = stream;
      }
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }else{
      if (remoteVideo.srcObject !== stream){
        remoteVideo.srcObject = stream;
        (async ()=>{ try{ 
          remoteVideo.setAttribute('playsinline',''); 
          remoteVideo.setAttribute('webkit-playsinline',''); 
          await remoteVideo.play(); 
        }catch(e){} })();
        audioMirror.srcObject = stream;
      }
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }
    log(`[${role}] tracks: ` + stream.getTracks().map(t=>t.kind).join(', '));
  };

  // ICE
  const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/guest`);
  pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };
  const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/host`);
  remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)); });

  // SDP
  preferH264(pc);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  const offerRef = db.ref(`rooms/${roomId}/offers/${viewerId}`);
  await offerRef.set({ sdp: offer.sdp, ts: Date.now() }).catch(e=>{ alert('ì˜¤í¼ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message); });

  db.ref(`rooms/${roomId}/answers/${viewerId}`).on('value', async snap=>{
    const val = snap.val();
    if(val && val.sdp && pc.signalingState === 'have-local-offer'){
      await pc.setRemoteDescription(new RTCSessionDescription({ type:'answer', sdp: val.sdp }));
      logStatus(comm==='broadcast' ? 'ì‹œì²­ ì¤‘â€¦' : 'ë¯¸íŒ… ì—°ê²°ë¨');
      toast('ì—°ê²° ì„±ê³µ. ì†Œë¦¬ê°€ ì•ˆ ë“¤ë¦¬ë©´ ğŸ”Š ë²„íŠ¼ ë˜ëŠ” í™”ë©´ íƒ­');
    }
  });

  startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
  logStatus(`ì ‘ì† ìš”ì²­ ì™„ë£Œ. í˜¸ìŠ¤íŠ¸ ìŠ¹ì¸ ëŒ€ê¸°â€¦ (ë‚´ ID: ${viewerId})`);
}

/* ---------------- Controls ---------------- */
startBtn.addEventListener('click', async ()=>{
  try{
    if (role==='host') await startHost(); else await startGuest();
  }catch(e){ alert('ì‹œì‘ ì‹¤íŒ¨: '+e.message); }
});
stopBtn.addEventListener('click', async ()=>{ await cleanup(); });
genRoom.addEventListener('click', ()=>{ roomIdInput.value = `rm-${randomId(9)}`; });
window.addEventListener('DOMContentLoaded', ()=>{
  const p = new URLSearchParams(location.search);
  const r = p.get('role'), c=p.get('comm'), room=p.get('room'), a=p.get('autostart');
  if (r && ['host','guest'].includes(r)) { document.querySelector(`input[name="role"][value="${r}"]`).checked=true; role=r; }
  if (c && ['broadcast','meeting'].includes(c)) { document.querySelector(`input[name="comm"][value="${c}"]`).checked=true; comm=c; }
  if (room) roomIdInput.value=room;
  refreshUIByMode();
  if (a==='1') setTimeout(()=>startBtn.click(), 400);
});

/* ---------------- Cleanup ---------------- */
async function cleanup(){
  try{
    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    if(pc){ pc.getSenders().forEach(s=>s.track && s.track.stop()); pc.close(); pc=null; }
    if(roomId && role==='guest' && viewerId){
      await db.ref(`rooms/${roomId}/offers/${viewerId}`).remove();
      await db.ref(`rooms/${roomId}/answers/${viewerId}`).remove();
      await db.ref(`rooms/${roomId}/candidates/${viewerId}`).remove();
    }
  }catch(e){}
  isRunning=false; startBtn.disabled=false; stopBtn.disabled=true;
  player.srcObject=null; remoteVideo.srcObject=null; localPreview.srcObject=null;
  pendingEl.innerHTML=''; logStatus('ëŒ€ê¸° ì¤‘â€¦'); unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
}

/* ---------------- Error log ---------------- */
window.addEventListener('error', e=> log('[Error] ' + e.message));
</script>
</body>
</html>
