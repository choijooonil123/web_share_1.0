<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>í™”ë©´ê³µìœ  ì›¹(ìŠ¹ì¸ì œ Â· WebRTC)</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1000px 700px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr 360px}
    .card{background:rgba(16,24,58,.8);border:1px solid #22306b;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block;margin-top:8px;font-size:14px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2b5bd1,#2048a8)}
    button.danger{background:linear-gradient(180deg,#c24,#932)}
    small{color:var(--muted)}
    video{width:100%;background:#000;border-radius:12px}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li{padding:10px;border:1px solid #2a3a77;border-radius:12px;background:#0f173b;display:flex;justify-content:space-between;align-items:center}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#1b285c;color:#cfe0ff;border:1px solid #2a3a77}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#a7b3d4}
    footer{padding:10px 16px;color:#a7b3d4;font-size:12px;text-align:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0d1433;border:1px solid #2a3a77;color:#eaf0ff;padding:10px 14px;border-radius:12px;display:none}
  </style>
</head>
<body>
<header>
  <h1>í™”ë©´ê³µìœ  ì›¹(ìŠ¹ì¸ì œ Â· WebRTC)</h1>
  <div class="row">
    <span class="tag">P2P ì†Œê·œëª¨</span>
    <span class="tag">Firebase RTDB</span>
    <span class="tag">ìµëª… ì¸ì¦</span>
  </div>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 8px 0">ë¼ì´ë¸Œ</h2>
    <!-- iOS ìë™ì¬ìƒ ì •ì±… ëŒ€ì‘: mutedë¡œ ì‹œì‘ í›„ ë²„íŠ¼ìœ¼ë¡œ í•´ì œ -->
    <video id="player" autoplay playsinline muted controls></video>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label>ëª¨ë“œ ì„ íƒ</label>
        <div class="row">
          <label class="row"><input type="radio" name="mode" value="presenter" checked> ì†¡ì¶œì</label>
          <label class="row"><input type="radio" name="mode" value="viewer"> ì‹œì²­ì</label>
        </div>
      </div>
      <div>
        <label>ë°© ì½”ë“œ(Room ID)</label>
        <input id="roomId" type="text" placeholder="ì˜ˆ: rm-k3G7a9fQ2" />
        <small class="hint">ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìë™ ìƒì„±</small>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="genRoom">ë°© ì½”ë“œ ìë™ìƒì„±</button>
      <button class="primary" id="startBtn">ì‹œì‘</button>
      <button class="danger" id="stopBtn" disabled>ì¢…ë£Œ</button>
      <button id="unmuteBtn" style="display:none">ğŸ”Š ì†Œë¦¬ ì¼œê¸°</button>
    </div>

    <!-- ì†¡ì¶œì ì˜¤ë””ì˜¤ ì¦í­ ì»¨íŠ¸ë¡¤ -->
    <div id="gainRow" class="row" style="margin-top:8px; display:none">
      <small class="muted">ì˜¤ë””ì˜¤ ì¦í­:</small>
      <input id="gainSlider" type="range" min="1" max="3" step="0.1" value="2" />
      <small class="muted"><span id="gainVal">2.0</span>x</small>
    </div>

    <div style="margin-top:6px">
      <small id="status" class="muted">ëŒ€ê¸° ì¤‘â€¦</small>
    </div>

    <div id="presenterHints" style="margin-top:12px;display:none">
      <small class="hint">
        * iPad ì‹œì²­ ê°€ëŠ¥. Safari/Chromeì—ì„œ ğŸ”Š ë²„íŠ¼ìœ¼ë¡œ ìŒì†Œê±° í•´ì œê°€ í•„ìš”í•©ë‹ˆë‹¤. H.264 ìš°ì„  í˜‘ìƒ ì ìš©ë¨.
      </small>
    </div>
  </section>

  <aside class="card">
    <h3 style="margin-top:0">ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡(ì†¡ì¶œì ì „ìš©)</h3>
    <ul id="pending"></ul>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ì—°ê²° ì •ë³´</h3>
      <div id="info" class="hint">-</div>
    </div>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ë¡œê·¸</h3>
      <pre id="log" class="hint" style="white-space:pre-wrap;max-height:220px;overflow:auto"></pre>
    </div>
  </aside>
</main>

<footer>
  ëŒ€ê·œëª¨ ì†¡ì¶œì€ SFU(LiveKit/Janus/mediasoup ë“±) ê¶Œì¥ Â· TURN ì„œë²„ ì¶”ê°€ ì‹œ ì—°ê²° ì„±ê³µë¥ â†‘
</footer>

<div id="toast"></div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

<script>
/** Firebase ì„¤ì •(ì‚¬ìš©ì ì œê³µ ê°’) */
const firebaseConfig = {
  apiKey: "AIzaSyA-007jMq4dO7M6t6wn5vR_PZW9Gg1n0LM",
  authDomain: "webboard-ea2c4.firebaseapp.com",
  databaseURL: "https://webboard-ea2c4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webboard-ea2c4",
  storageBucket: "webboard-ea2c4.firebasestorage.app",
  messagingSenderId: "1063560565058",
  appId: "1:1063560565058:web:bd9b57bef6dd649f67f8db",
  measurementId: "G-NTQGQJVW8E"
};
firebase.initializeApp(firebaseConfig);

// ìµëª… ë¡œê·¸ì¸ (ê·œì¹™ì´ auth != null ì¸ ê²½ìš° í•„ìˆ˜)
firebase.auth().signInAnonymously().catch(err=>{
  console.error('Auth failed:', err);
  alert('Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message);
});

const db = firebase.database();

/** UI refs */
const player = document.getElementById('player');
const roomIdInput = document.getElementById('roomId');
const statusEl = document.getElementById('status');
const pendingEl = document.getElementById('pending');
const infoEl = document.getElementById('info');
const logEl = document.getElementById('log');
const presenterHints = document.getElementById('presenterHints');
const unmuteBtn = document.getElementById('unmuteBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const genRoom  = document.getElementById('genRoom');
const toastEl  = document.getElementById('toast');

// ì¦í­ ì»¨íŠ¸ë¡¤
const gainRow    = document.getElementById('gainRow');
const gainSlider = document.getElementById('gainSlider');
const gainVal    = document.getElementById('gainVal');

let mode = 'presenter';
let localStream = null;
let pc = null; // viewer side
let roomId = '';
let viewerId = '';
let isRunning = false;
let audioCtx = null;
let gainNode = null;

/** helpers */
function logStatus(msg){ statusEl.textContent = msg; }
function log(msg){ console.log(msg); logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; }
function toast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1800); }
function randomId(len=10){ const c='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789'; let s=''; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }

/** ê¸°ë³¸ ë³¼ë¥¨ ìµœëŒ€ë¡œ (ì‹œì²­ìì¸¡) */
player.volume = 1.0;

/** ëª¨ë“œ í† ê¸€ + ì¦í­ UI í‘œì‹œ */
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    mode = document.querySelector('input[name="mode"]:checked').value;
    presenterHints.style.display = (mode==='presenter') ? 'block' : 'none';
    gainRow.style.display = (mode==='presenter') ? 'flex' : 'none';
  });
});
presenterHints.style.display = 'block';
gainRow.style.display = 'flex';

/** ìŠ¬ë¼ì´ë” ì‹¤ì‹œê°„ ë°˜ì˜ */
if (gainSlider) {
  gainSlider.addEventListener('input', () => {
    if (gainNode) {
      const v = parseFloat(gainSlider.value);
      gainNode.gain.value = v;
      gainVal.textContent = v.toFixed(1);
    }
  });
}

/** ICE servers */
const iceServers = [{ urls: ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] }];
function createPeer(){
  const _pc = new RTCPeerConnection({ iceServers });
  _pc.oniceconnectionstatechange = () => { infoEl.textContent = 'ICE: ' + _pc.iceConnectionState; };
  _pc.onconnectionstatechange = () => { infoEl.textContent += ' | PC: ' + _pc.connectionState; };
  return _pc;
}

/** URL params: ?mode=viewer&room=XXXX&autostart=1 */
window.addEventListener('DOMContentLoaded', ()=>{
  const p = new URLSearchParams(location.search);
  const m = p.get('mode'); const r = p.get('room'); const a = p.get('autostart');
  if(m==='viewer'){ document.querySelector('input[name="mode"][value="viewer"]').checked = true; presenterHints.style.display = 'none'; gainRow.style.display='none'; mode='viewer'; }
  if(r){ roomIdInput.value = r; }
  if(a==='1'){ setTimeout(()=>startBtn.click(), 400); }
});

/** autoplay policy helper (iPad ë“±) */
function enableAudioPlayback(){
  try{
    player.muted = false; // ìŒì†Œê±° í•´ì œ
    const p = player.play();
    if(p && typeof p.then === 'function') p.catch(()=>{});
    unmuteBtn.style.display='none';
  }catch(e){}
}
unmuteBtn.addEventListener('click', enableAudioPlayback);

/** H.264 ìš°ì„  í˜‘ìƒ (iPad í˜¸í™˜) */
function preferH264(pc){
  try{
    const txs = typeof pc.getTransceivers === 'function' ? pc.getTransceivers() : [];
    const caps = RTCRtpSender.getCapabilities ? RTCRtpSender.getCapabilities('video') : null;
    if (!caps || !caps.codecs) return;
    const h264 = caps.codecs.filter(c => /H264/i.test(c.mimeType));
    if (!h264.length) return;
    txs.forEach(t => {
      const kind = t?.mid ? t?.receiver?.track?.kind : (t?.sender?.track?.kind || t?.kind);
      if (kind === 'video' && typeof t.setCodecPreferences === 'function') {
        const others = caps.codecs.filter(c => !/H264/i.test(c.mimeType));
        t.setCodecPreferences(h264.concat(others));
      }
    });
  }catch(e){ console.warn('preferH264 failed:', e); }
}

/** ì†¡ì¶œì */
async function startPresenter(){
  roomId = (roomIdInput.value || '').replace(/\s+/g,''); // ê³µë°± ì œê±°
  if(!roomId){ roomId = 'rm-' + randomId(9); roomIdInput.value = roomId; }

  let screenStream;
  try{
    screenStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch(e){
    alert('í™”ë©´ ê³µìœ  ê¶Œí•œ í•„ìš”: ' + e.message); return;
  }

  // Web Audio ì¤€ë¹„ + Gain
  audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  const initialGain = parseFloat(gainSlider?.value || '2') || 2.0;
  gainNode.gain.value = initialGain;
  if (gainVal) gainVal.textContent = initialGain.toFixed(1);

  const videoTracks = screenStream.getVideoTracks();
  const screenAudioTracks = screenStream.getAudioTracks();
  let outputAudioTrack = null;

  if (screenAudioTracks.length) {
    // ì‹œìŠ¤í…œ/íƒ­ ì˜¤ë””ì˜¤ â†’ ì¦í­
    const src = audioCtx.createMediaStreamSource(screenStream);
    const dest = audioCtx.createMediaStreamDestination();
    src.connect(gainNode).connect(dest);
    outputAudioTrack = dest.stream.getAudioTracks()[0];
  } else {
    // ì˜¤ë””ì˜¤ê°€ ì—†ìœ¼ë©´ ë§ˆì´í¬ ë³´ì¡° + ì¦í­
    try {
      const mic = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });
      const src = audioCtx.createMediaStreamSource(mic);
      const dest = audioCtx.createMediaStreamDestination();
      src.connect(gainNode).connect(dest);
      outputAudioTrack = dest.stream.getAudioTracks()[0];
      log('[Presenter] ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ì—†ìŒ â†’ ë§ˆì´í¬ ë³´ì¡° ì‚¬ìš©');
    } catch (e) {
      log('[Presenter] ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: ' + e.message);
    }
  }

  // ìµœì¢… localStream
  if (outputAudioTrack) {
    localStream = new MediaStream([...videoTracks, outputAudioTrack]);
  } else {
    localStream = new MediaStream([...videoTracks]); // ì˜ìƒë§Œ
  }

  log('[Presenter] audio track:', localStream.getAudioTracks().map(t=>t.label).join(', ') || '(ì—†ìŒ)');
  player.srcObject = localStream;

  // ì‹œì²­ì Offer ëŒ€ê¸°
  const offersRef = db.ref(`rooms/${roomId}/offers`);
  offersRef.on('child_added', async snap=>{
    const vid = snap.key; const data = snap.val();
    if(!data || !data.sdp) return;
    addPending(vid, data);
    log('[Presenter] offer arrived from: ' + vid);
  });

  isRunning = true;
  startBtn.disabled = true; stopBtn.disabled = false;
  logStatus(`ì†¡ì¶œ ì¤‘â€¦ ë°© ì½”ë“œ: ${roomId}`);
  toast('ì‹œì²­ìì—ê²Œ ë°© ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”');
}

/** ëŒ€ê¸°ì—´ UI */
function addPending(vid, data){
  const li = document.createElement('li');
  li.id = `pending-${vid}`;
  li.innerHTML = `
    <div>
      <div><b>ì‹œì²­ì</b> <span class="tag">${vid}</span></div>
      <div class="muted" style="font-size:12px">ì˜¤í¼ ìˆ˜ì‹ </div>
    </div>
    <div class="row">
      <button class="primary">í—ˆìš©</button>
      <button class="danger">ê±°ì ˆ</button>
    </div>
  `;
  const [allowBtn, denyBtn] = li.querySelectorAll('button');
  allowBtn.onclick = () => acceptViewer(vid, data, li);
  denyBtn.onclick  = () => denyViewer(vid, li);
  pendingEl.appendChild(li);
}

/** ì‹œì²­ì í—ˆìš© â†’ Answer ìƒì„± (iPad í˜¸í™˜: H.264 ìš°ì„ ) */
async function acceptViewer(vid, data, li){
  try{
    const _pc = createPeer();

    // ì†¡ì¶œ íŠ¸ë™ ì¶”ê°€
    localStream.getTracks().forEach(t => _pc.addTrack(t, localStream));

    // iPad í˜¸í™˜: H.264 ìš°ì„ 
    preferH264(_pc);

    // remote ICE (viewer)
    const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/viewer`);
    remoteCandidatesRef.on('child_added', s => {
      const c = s.val(); if(c) _pc.addIceCandidate(new RTCIceCandidate(c));
    });

    // my ICE (presenter)
    const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/presenter`);
    _pc.onicecandidate = (ev) => { if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };

    await _pc.setRemoteDescription(new RTCSessionDescription({ type:'offer', sdp:data.sdp }));
    const answer = await _pc.createAnswer();
    await _pc.setLocalDescription(answer);

    await db.ref(`rooms/${roomId}/answers/${vid}`).set({ sdp: answer.sdp, ts: Date.now() });

    li.querySelector('.muted').textContent = 'ì—°ê²° ì§„í–‰ ì¤‘â€¦';
    li.style.opacity = .7;
    log('[Presenter] answered to ' + vid);
  }catch(e){ alert('ì—°ê²° ì‹¤íŒ¨: ' + e.message); }
}

function denyViewer(vid, li){
  db.ref(`rooms/${roomId}/offers/${vid}`).remove();
  db.ref(`rooms/${roomId}/candidates/${vid}`).remove();
  li.remove();
}

/** ì‹œì²­ì */
async function startViewer(){
  roomId = (roomIdInput.value || '').replace(/\s+/g,'');
  if(!roomId){ alert('ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  viewerId = randomId(8);
  pc = createPeer();

  // recvonly transceivers
  pc.addTransceiver('video', { direction:'recvonly' });
  pc.addTransceiver('audio', { direction:'recvonly' });

  pc.ontrack = (ev)=>{
    if(player.srcObject !== ev.streams[0]) player.srcObject = ev.streams[0];
    unmuteBtn.style.display = 'inline-block'; // ì‚¬ìš©ì í´ë¦­ ìœ ë„ (iOS)
    log('[Viewer] ontrack: ' + ev.track.kind);
  };

  // my ICE (viewer)
  const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/viewer`);
  pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };

  // remote ICE (presenter)
  const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/presenter`);
  remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)); });

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // ì—…ë¡œë“œ ì—ëŸ¬ í•¸ë“¤ë§
  const offerRef = db.ref(`rooms/${roomId}/offers/${viewerId}`);
  offerRef.set({ sdp: offer.sdp, ts: Date.now() })
    .then(()=> log('[Viewer] offer uploaded') )
    .catch(e => { console.error('Offer upload failed:', e); alert('ì˜¤í¼ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message+'\nê·œì¹™/ì¸ì¦/URL í™•ì¸'); });

  // answer wait
  db.ref(`rooms/${roomId}/answers/${viewerId}`).on('value', async snap=>{
    const val = snap.val();
    if(val && val.sdp && pc.signalingState === 'have-local-offer'){
      await pc.setRemoteDescription(new RTCSessionDescription({ type:'answer', sdp: val.sdp }));
      logStatus('ì‹œì²­ ì¤‘â€¦ (ì†Œë¦¬: ğŸ”Š ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”)');
      toast('ì˜¤ë””ì˜¤ê°€ ì•ˆ ë“¤ë¦¬ë©´ ğŸ”Š ë²„íŠ¼ í´ë¦­');
    }
  });

  isRunning = true; startBtn.disabled = true; stopBtn.disabled = false;
  logStatus(`ì ‘ì† ìš”ì²­ ì™„ë£Œ. ì†¡ì¶œì ìŠ¹ì¸ ëŒ€ê¸°â€¦ (ë‚´ ID: ${viewerId})`);
}

/** controls */
startBtn.addEventListener('click', async ()=>{
  const m = document.querySelector('input[name="mode"]:checked').value;
  if(m==='presenter') await startPresenter(); else await startViewer();
});

stopBtn.addEventListener('click', async ()=>{ await cleanup(); });

genRoom.addEventListener('click', ()=>{ roomIdInput.value = `rm-${randomId(9)}`; });

async function cleanup(){
  try{
    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    if(pc){ pc.getSenders().forEach(s=>s.track && s.track.stop()); pc.close(); pc=null; }
    if(roomId && mode==='viewer' && viewerId){
      await db.ref(`rooms/${roomId}/offers/${viewerId}`).remove();
      await db.ref(`rooms/${roomId}/answers/${viewerId}`).remove();
      await db.ref(`rooms/${roomId}/candidates/${viewerId}`).remove();
    }
  }catch(e){}
  isRunning=false; startBtn.disabled=false; stopBtn.disabled=true; player.srcObject=null; pendingEl.innerHTML=''; logStatus('ëŒ€ê¸° ì¤‘â€¦'); unmuteBtn.style.display='none';
}

/** Dev logs */
window.addEventListener('error', e=> log('[Error] ' + e.message));
</script>
</body>
</html>
