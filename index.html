<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ìŠ¹ì¸ì œ WebRTC (ë°©ì†¡/ë¯¸íŒ…)</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1000px 700px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr 360px}
    .card{background:rgba(16,24,58,.8);border:1px solid #22306b;border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block;margin-top:8px;font-size:14px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2b5bd1,#2048a8)}
    button.danger{background:linear-gradient(180deg,#c24,#932)}
    small{color:var(--muted)}
    video{width:100%;background:#000;border-radius:12px}
    ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    li{padding:10px;border:1px solid #2a3a77;border-radius:12px;background:#0f173b;display:flex;justify-content:space-between;align-items:center}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#1b285c;color:#cfe0ff;border:1px solid #2a3a77}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:#a7b3d4}
    footer{padding:10px 16px;color:#a7b3d4;font-size:12px;text-align:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid-2h{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .meeting-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:10px;margin-top:10px}
    .remote-video-wrapper{position:relative}
    .remote-video-wrapper small{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.6);padding:4px 8px;border-radius:6px;z-index:1}
    .local-preview-wrapper{position:relative;display:none}
    .local-preview-wrapper.show{display:block}
    #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0d1433;border:1px solid #2a3a77;color:#eaf0ff;padding:10px 14px;border-radius:12px;display:none}
    .hidden{display:none!important}
    .pip-overlay{position:fixed;top:20px;right:20px;width:240px;z-index:1000;background:rgba(16,24,58,.95);border:2px solid #22306b;border-radius:12px;padding:8px;box-shadow:0 8px 30px rgba(0,0,0,.5);display:none}
    .pip-overlay.show{display:block}
    .pip-overlay video{width:100%;border-radius:8px;background:#000}
    .pip-overlay .pip-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pip-overlay .pip-title{font-size:12px;color:#a7b3d4;font-weight:bold}
    .pip-overlay .pip-close{width:24px;height:24px;border-radius:50%;border:none;background:#ff6a6a;color:#fff;cursor:pointer;font-size:14px;line-height:1;padding:0;display:flex;align-items:center;justify-content:center}
    .pip-overlay .pip-close:hover{background:#ff4a4a}
    .fullscreen-video{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none}
    .fullscreen-video.show{display:block}
    .fullscreen-video video{width:100%;height:100%;object-fit:contain}
    .fullscreen-video .fs-close{position:absolute;top:20px;right:20px;width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,106,106,.9);color:#fff;cursor:pointer;font-size:20px;z-index:2001;display:flex;align-items:center;justify-content:center}
    .fullscreen-video .fs-close:hover{background:rgba(255,74,74,.9)}
    .video-fullscreen-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.6);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;z-index:2}
    .video-fullscreen-btn:hover{background:rgba(0,0,0,.8)}
    .chat-container{display:flex;flex-direction:column;height:300px}
    .chat-messages{flex:1;overflow-y:auto;padding:8px;background:#0d1433;border-radius:8px;margin-bottom:8px;max-height:250px}
    .chat-message{padding:6px 8px;margin-bottom:6px;border-radius:6px;font-size:13px;word-wrap:break-word}
    .chat-message.own{background:#1b285c;text-align:right}
    .chat-message.other{background:#0f173b}
    .chat-message .sender{font-size:11px;color:#a7b3d4;margin-bottom:2px}
    .chat-message .time{font-size:10px;color:#6aa6ff;margin-left:6px}
    .chat-input-row{display:flex;gap:6px}
    .chat-input-row input{flex:1;padding:8px;border-radius:8px;border:1px solid #2a3a77;background:#0d1433;color:#eaf0ff;font-size:13px}
    .chat-input-row button{padding:8px 12px}
  </style>
</head>
<body>
<header>
  <h1>ìŠ¹ì¸ì œ WebRTC (ë°©ì†¡/ë¯¸íŒ…-1.4)</h1>
  <div class="row">
    <span class="tag">P2P</span>
    <span class="tag">Firebase RTDB</span>
    <span class="tag">ìµëª… ì¸ì¦</span>
  </div>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 8px 0">ë¼ì´ë¸Œ</h2>

    <!-- ë°©ì†¡ ëª¨ë“œ: ë‹¨ì¼ í”Œë ˆì´ì–´ -->
    <video id="player" class="" autoplay playsinline webkit-playsinline muted controls></video>

    <!-- ë¯¸íŒ… ëª¨ë“œ: ë‹¤ìê°„ ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ -->
    <div id="meetingVideos" class="hidden">
      <div class="meeting-grid" id="remoteVideosGrid"></div>
      <div class="local-preview-wrapper" id="localPreviewWrapper">
        <small class="muted">ë‚˜(ë¯¸ë¦¬ë³´ê¸° Â· í•­ìƒ ìŒì†Œê±°)</small>
        <video id="localPreview" autoplay playsinline webkit-playsinline muted controls></video>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="togglePreviewBtn">ë‚´ í™”ë©´ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
      </div>
    </div>

    <!-- PiP ì˜¤ë²„ë ˆì´ (í™”ë©´ê³µìœ  ì¤‘ í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼) -->
    <div id="pipOverlay" class="pip-overlay">
      <div class="pip-header">
        <span class="pip-title">í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼</span>
        <button class="pip-close" id="pipCloseBtn">Ã—</button>
      </div>
      <video id="pipVideo" autoplay playsinline webkit-playsinline muted></video>
    </div>

    <!-- ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ -->
    <div id="fullscreenVideo" class="fullscreen-video">
      <button class="fs-close" id="fsCloseBtn">Ã—</button>
      <video id="fsVideo" autoplay playsinline webkit-playsinline controls></video>
    </div>

    <audio id="audiomirror" autoplay playsinline webkit-playsinline style="display:none"></audio>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label>ì—­í• </label>
        <div class="row">
          <label class="row"><input type="radio" name="role" value="host" checked> ì†¡ì¶œì(í˜¸ìŠ¤íŠ¸)</label>
          <label class="row"><input type="radio" name="role" value="guest"> ì‹œì²­ì/ê²ŒìŠ¤íŠ¸</label>
        </div>
      </div>
      <div>
        <label>ë°© ì½”ë“œ(Room ID)</label>
        <input id="roomId" type="text" placeholder="ì˜ˆ: RM-20241225" />
        <small class="hint">ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìë™ ìƒì„± (RM-ë‚ ì§œ í˜•ì‹)</small>
      </div>
    </div>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label>í†µì‹  ëª¨ë“œ</label>
        <div class="row" id="commRow">
          <label class="row"><input type="radio" name="comm" value="broadcast" checked> ë°©ì†¡(ë‹¨ë°©í–¥)</label>
          <label class="row"><input type="radio" name="comm" value="meeting"> ë¯¸íŒ…(ì–‘ë°©í–¥)</label>
        </div>
      </div>
      <div id="sourceWrap">
        <label>ì†ŒìŠ¤ ì„ íƒ(ë°©ì†¡ ëª¨ë“œ)</label>
        <div class="row" id="sourceRow">
          <label class="row"><input type="radio" name="source" value="screen" checked> í™”ë©´ê³µìœ </label>
          <label class="row"><input type="radio" name="source" value="camera"> ì¹´ë©”ë¼</label>
        </div>
      </div>
    </div>

    <!-- ì¹´ë©”ë¼ ì œì–´ -->
    <div class="row" id="cameraCtrl" style="margin-top:10px; display:none">
      <button id="switchCamBtn">ì „/í›„ë©´ ì „í™˜</button>
      <button id="muteMicBtn">ë§ˆì´í¬ ìŒì†Œê±°</button>
      <button id="muteCamBtn">ì¹´ë©”ë¼ ë„ê¸°</button>
      <button id="shareScreenBtn" style="display:none">í™”ë©´ê³µìœ  ì‹œì‘</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="genRoom">ë°© ì½”ë“œ ìë™ìƒì„±</button>
      <button class="primary" id="startBtn">ì‹œì‘</button>
      <button class="danger" id="stopBtn" disabled>ì¢…ë£Œ</button>
      <button id="unmuteBtn" style="display:none">ğŸ”Š ì†Œë¦¬ ì¼œê¸°</button>
    </div>

    <!-- ì˜¤ë””ì˜¤ ì¦í­(ë°©ì†¡ ëª¨ë“œì—ì„œ ì†¡ì¶œìë§Œ í‘œì‹œ) -->
    <div id="gainRow" class="row" style="margin-top:8px; display:none">
      <small class="muted">ì˜¤ë””ì˜¤ ì¦í­:</small>
      <input id="gainSlider" type="range" min="1" max="3" step="0.1" value="2" />
      <small class="muted"><span id="gainVal">2.0</span>x</small>
    </div>

    <div style="margin-top:6px"><small id="status" class="muted">ëŒ€ê¸° ì¤‘â€¦</small></div>
    <div id="presenterHints" style="margin-top:12px;display:none">
      <small class="hint">* iPadëŠ” ì²« ì¬ìƒ ì‹œ ğŸ”Š ë²„íŠ¼(ë˜ëŠ” í™”ë©´ íƒ­)ìœ¼ë¡œ ìŒì†Œê±° í•´ì œê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
    </div>
  </section>

  <aside class="card">
    <h3 style="margin-top:0">ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡(í˜¸ìŠ¤íŠ¸ ì „ìš©)</h3>
    <ul id="pending"></ul>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ì—°ê²° ì •ë³´</h3>
      <div id="info" class="hint">-</div>
    </div>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ì±„íŒ…</h3>
      <div class="chat-container">
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-row">
          <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="200" />
          <button id="chatSendBtn">ì „ì†¡</button>
        </div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ì—°ê²° ì •ë³´</h3>
      <div id="info" class="hint">-</div>
    </div>
    <hr style="border:none;border-top:1px solid #2a3a77;margin:12px 0"/>
    <div>
      <h3 style="margin:0 0 8px 0">ë¡œê·¸</h3>
      <pre id="log" class="hint" style="white-space:pre-wrap;max-height:150px;overflow:auto"></pre>
    </div>
  </aside>
</main>

<footer>
  ëŒ€ê·œëª¨/ë‹¤ìê°„ì€ SFU ê¶Œì¥(LiveKit/Janus/mediasoup). TURN ì¶”ê°€ ì‹œ ì—°ê²°ë¥ â†‘
</footer>

<div id="toast"></div>

<!-- iOSìš© ì–¸ë®¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
<div id="tapUnmuteOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center;">
  <button id="tapUnmuteBtn" style="font-size:18px;padding:14px 18px;border-radius:12px;border:1px solid #2a3a77;background:#101a45;color:#eaf0ff;cursor:pointer">
    ğŸ”Š íƒ­í•˜ì—¬ ì†Œë¦¬ ì¼œê¸°
  </button>
</div>

<!-- Firebase SDK (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA-007jMq4dO7M6t6wn5vR_PZW9Gg1n0LM",
  authDomain: "webboard-ea2c4.firebaseapp.com",
  databaseURL: "https://webboard-ea2c4-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webboard-ea2c4",
  storageBucket: "webboard-ea2c4.firebasestorage.app",
  messagingSenderId: "1063560565058",
  appId: "1:1063560565058:web:bd9b57bef6dd649f67f8db",
  measurementId: "G-NTQGQJVW8E"
};
firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously().catch(err=>{ console.error('Auth failed:', err); alert('Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message); });
const db = firebase.database();

/* ---------------- UI refs ---------------- */
const player = document.getElementById('player');                 // ë°©ì†¡ ëª¨ë“œ í”Œë ˆì´ì–´
const meetingVideos = document.getElementById('meetingVideos');   // ë¯¸íŒ… ëª¨ë“œ ì»¨í…Œì´ë„ˆ
const localPreview = document.getElementById('localPreview');
const audioMirror = document.getElementById('audiomirror');
const roomIdInput = document.getElementById('roomId');
const statusEl = document.getElementById('status');
const pendingEl = document.getElementById('pending');
const infoEl = document.getElementById('info');
const logEl = document.getElementById('log');
const presenterHints = document.getElementById('presenterHints');
const unmuteBtn = document.getElementById('unmuteBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const genRoom  = document.getElementById('genRoom');
const toastEl  = document.getElementById('toast');
const tapUnmuteOverlay = document.getElementById('tapUnmuteOverlay');
const tapUnmuteBtn = document.getElementById('tapUnmuteBtn');
const gainRow    = document.getElementById('gainRow');
const gainSlider = document.getElementById('gainSlider');
const gainVal    = document.getElementById('gainVal');
const switchCamBtn = document.getElementById('switchCamBtn');
const muteMicBtn   = document.getElementById('muteMicBtn');
const muteCamBtn   = document.getElementById('muteCamBtn');
const shareScreenBtn = document.getElementById('shareScreenBtn');
const cameraCtrl   = document.getElementById('cameraCtrl');
const sourceWrap   = document.getElementById('sourceWrap');
const remoteVideosGrid = document.getElementById('remoteVideosGrid');
const localPreviewWrapper = document.getElementById('localPreviewWrapper');
const togglePreviewBtn = document.getElementById('togglePreviewBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const pipOverlay = document.getElementById('pipOverlay');
const pipVideo = document.getElementById('pipVideo');
const pipCloseBtn = document.getElementById('pipCloseBtn');
const fullscreenVideo = document.getElementById('fullscreenVideo');
const fsVideo = document.getElementById('fsVideo');
const fsCloseBtn = document.getElementById('fsCloseBtn');

/* ---------------- State ---------------- */
let role = 'host';                 // 'host' | 'guest'
let comm = 'broadcast';            // 'broadcast' | 'meeting'
let sourceMode = 'screen';         // ë°©ì†¡ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©: 'screen' | 'camera'
let facingMode = 'user';           // ì¹´ë©”ë¼ ì „/í›„ë©´
let roomId = '';
let viewerId = '';
let isRunning = false;
let pc = null;                      // ê²ŒìŠ¤íŠ¸ìš© ë‹¨ì¼ ì—°ê²°
let peerConnections = new Map();    // í˜¸ìŠ¤íŠ¸ìš©: ê²ŒìŠ¤íŠ¸ ID -> PeerConnection
let remoteVideos = new Map();       // ê²ŒìŠ¤íŠ¸ ID -> video ì—˜ë¦¬ë¨¼íŠ¸
let localStream = null;            // ë‚´ê°€ ë³´ë‚´ëŠ” ìŠ¤íŠ¸ë¦¼(ëª¨ë“œë³„ êµ¬ì„±)
let audioCtx = null, gainNode = null, viewerAudioCtx = null;
let showLocalPreview = false;       // ë‚´ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ì—¬ë¶€
let isScreenSharing = false;       // í™”ë©´ê³µìœ  ì¤‘ ì—¬ë¶€
let screenShareStream = null;       // í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ (ì¢…ë£Œ ê°ì§€ìš©)
let hostCameraStream = null;        // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ (PiPìš©)
let showHostCameraPip = false;      // í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼ PiP í‘œì‹œ ì—¬ë¶€
let firebaseListeners = {           // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ë¥¼ ìœ„í•œ ì°¸ì¡°
  offers: null,
  answers: null,
  candidates: {},
  chat: null
};
let myUserId = '';                  // ë‚´ ì‚¬ìš©ì ID (ì±„íŒ…ìš©)

/* ---------------- Utils ---------------- */
// ê°•ì œ ì¬ìƒ ë³´ì¡°(ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ ìš°íšŒ)
async function forcePlay(el){
  if(!el) return;
  try{
    el.muted = true;                    // ìë™ì¬ìƒ ë³´ì¡°
    el.setAttribute('muted','');        // iOS ë³´ì¡°
    el.setAttribute('playsinline','');  // iOS ë³´ì¡°
    el.setAttribute('webkit-playsinline','');
    await el.play();
  }catch(e){
    console.warn('forcePlay blocked:', e);
  }
}

function logStatus(msg){ statusEl.textContent = msg; }
function log(msg){ console.log(msg); logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; }
function toast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1800); }
function randomId(len=10){ const c='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789'; let s=''; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function generateRoomId(){ const d=new Date(); const year=d.getFullYear(); const month=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `RM-${year}${month}${day}`; }
const isiOS = (() => { const ua = navigator.userAgent||''; const iOS=/iPad|iPhone|iPod/.test(ua); const iPadOS13Plus=navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1; return iOS||iPadOS13Plus; })();
player.volume = 1.0;

/* ---------------- UI bindings ---------------- */
document.querySelectorAll('input[name="role"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    role = document.querySelector('input[name="role"]:checked').value;
    refreshUIByMode();
  });
});
document.querySelectorAll('input[name="comm"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    comm = document.querySelector('input[name="comm"]:checked').value;
    refreshUIByMode();
  });
});
document.querySelectorAll('input[name="source"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    sourceMode = document.querySelector('input[name="source"]:checked').value;
  });
});
function refreshUIByMode(){
  const isHost = role==='host';
  const isMeeting = comm==='meeting';

  presenterHints.style.display = isHost ? 'block' : 'none';
  gainRow.style.display = (isHost && comm==='broadcast') ? 'flex' : 'none';
  sourceWrap.style.display = (comm==='broadcast') ? 'block' : 'none';

  // í”Œë ˆì´ì–´ í‘œì‹œ ì „í™˜
  if (isMeeting){
    player.classList.add('hidden');
    meetingVideos.classList.remove('hidden');
    cameraCtrl.style.display = 'flex'; // ë¯¸íŒ…ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì¹´ë©”ë¼/ë§ˆì´í¬ ì»¨íŠ¸ë¡¤ ë…¸ì¶œ
    shareScreenBtn.style.display = 'inline-block'; // ë¯¸íŒ… ëª¨ë“œì—ì„œ í™”ë©´ê³µìœ  ë²„íŠ¼ í‘œì‹œ
  }else{
    meetingVideos.classList.add('hidden');
    player.classList.remove('hidden');
    cameraCtrl.style.display = (isHost && sourceMode==='camera') ? 'flex' : 'none';
    shareScreenBtn.style.display = 'none';
  }
  if (!isMeeting && role==='guest' && isiOS) showIOSUnmuteOverlayIfNeeded();
}
refreshUIByMode();

switchCamBtn.addEventListener('click', async ()=>{
  facingMode = (facingMode==='user')?'environment':'user';
  toast(`ì¹´ë©”ë¼ ì „í™˜: ${facingMode==='user'?'ì „ë©´':'í›„ë©´'}`);
  if (!localStream) return;
  await replaceVideoTrack();
});

muteMicBtn.addEventListener('click', ()=>{
  const t = localStream?.getAudioTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  muteMicBtn.textContent = t.enabled ? 'ë§ˆì´í¬ ìŒì†Œê±°' : 'ë§ˆì´í¬ ì¼œê¸°';
});

muteCamBtn.addEventListener('click', ()=>{
  const t = localStream?.getVideoTracks?.()[0];
  if(!t) return;
  t.enabled = !t.enabled;
  muteCamBtn.textContent = t.enabled ? 'ì¹´ë©”ë¼ ë„ê¸°' : 'ì¹´ë©”ë¼ ì¼œê¸°';
});

// í™”ë©´ê³µìœ  ì‹œì‘/ì¢…ë£Œ
shareScreenBtn.addEventListener('click', async ()=>{
  if (isScreenSharing) {
    await stopScreenShare();
  } else {
    await startScreenShare();
  }
});

if (gainSlider) {
  gainSlider.addEventListener('input', () => {
    if (gainNode) {
      const v = parseFloat(gainSlider.value);
      gainNode.gain.value = v;
      gainVal.textContent = v.toFixed(1);
    }
  });
}

/* ---------------- WebRTC helpers ---------------- */
const iceServers = [{ urls: ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] }];
function createPeer(customHandlers = {}){
  const _pc = new RTCPeerConnection({ iceServers });
  _pc.oniceconnectionstatechange = customHandlers.oniceconnectionstatechange || (() => { 
    if (infoEl) infoEl.textContent = 'ICE: ' + _pc.iceConnectionState; 
  });
  _pc.onconnectionstatechange = customHandlers.onconnectionstatechange || (() => { 
    if (infoEl) infoEl.textContent += ' | PC: ' + _pc.connectionState; 
  });
  return _pc;
}
function preferH264(pc){
  try{
    const txs = typeof pc.getTransceivers === 'function' ? pc.getTransceivers() : [];
    const caps = RTCRtpSender.getCapabilities ? RTCRtpSender.getCapabilities('video') : null;
    if (!caps || !caps.codecs) return;
    const h264 = caps.codecs.filter(c => /H264/i.test(c.mimeType));
    if (!h264.length) return;
    txs.forEach(t => {
      const kind = t?.sender?.track?.kind || t?.kind;
      if (kind === 'video' && typeof t.setCodecPreferences === 'function') {
        const others = caps.codecs.filter(c => !/H264/i.test(c.mimeType));
        t.setCodecPreferences(h264.concat(others));
      }
    });
  }catch(e){ console.warn('preferH264 failed:', e); }
}
async function enableAudioPlayback(){
  try{
    if (comm==='meeting') {
      // ë¯¸íŒ… ëª¨ë“œ: ëª¨ë“  ì›ê²© ë¹„ë””ì˜¤ì˜ ìŒì†Œê±° í•´ì œ
      remoteVideos.forEach(video => {
        if (video) {
          video.muted = false;
          video.removeAttribute('muted');
          video.volume = 1.0;
          video.setAttribute('playsinline','');
          video.setAttribute('webkit-playsinline','');
          video.play().catch(e => {});
        }
      });
      if (audioMirror && audioMirror.srcObject) {
        audioMirror.muted = false;
        audioMirror.removeAttribute('muted');
      }
    } else {
      // ë°©ì†¡ ëª¨ë“œ
      if (player) {
        player.muted = false;
        player.removeAttribute('muted');
        player.volume = 1.0;
        player.setAttribute('playsinline','');
        player.setAttribute('webkit-playsinline','');
      }
      if (audioMirror) {
        audioMirror.muted = false;
        audioMirror.removeAttribute('muted');
      }
    }
    
    if (isiOS){
      if (!viewerAudioCtx) viewerAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (viewerAudioCtx.state!=='running'){ try{ await viewerAudioCtx.resume(); }catch(_){} }
      if (audioMirror && audioMirror.srcObject && viewerAudioCtx.state==='running'){
        try{
          const src = viewerAudioCtx.createMediaStreamSource(audioMirror.srcObject);
          const gain = viewerAudioCtx.createGain(); gain.gain.value = 1.0;
          src.connect(gain).connect(viewerAudioCtx.destination);
        }catch(_){}
      }
      // ëª¨ë“  ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
      if (comm==='meeting') {
        remoteVideos.forEach(video => {
          if (video) video.play().catch(e => {});
        });
      } else {
        if (player) player.play().catch(e => {});
      }
    }else{
      if (comm==='meeting') {
        remoteVideos.forEach(video => {
          if (video) video.play().catch(e => {});
        });
      } else {
        if (player) player.play().catch(e => {});
      }
    }
    unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
  }catch(e){ console.warn('enableAudioPlayback failed:', e); }
}
function showIOSUnmuteOverlayIfNeeded() {
  if (isiOS) {
    tapUnmuteOverlay.style.display = 'flex';
    unmuteBtn.style.display = 'none';
  }
}
tapUnmuteBtn.addEventListener('click', enableAudioPlayback);
unmuteBtn.addEventListener('click', enableAudioPlayback);

// ë‚´ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
togglePreviewBtn.addEventListener('click', ()=>{
  showLocalPreview = !showLocalPreview;
  if (showLocalPreview) {
    localPreviewWrapper.classList.add('show');
    togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ìˆ¨ê¸°ê¸°';
  } else {
    localPreviewWrapper.classList.remove('show');
    togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ë³´ê¸°';
  }
});

/* ---------------- Chat Functions ---------------- */
function formatTime(timestamp){
  const d = new Date(timestamp);
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function addChatMessage(senderId, senderName, message, timestamp, isOwn = false){
  if (!chatMessages) return;
  
  const msgDiv = document.createElement('div');
  msgDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;
  
  const senderSpan = document.createElement('div');
  senderSpan.className = 'sender';
  senderSpan.textContent = isOwn ? 'ë‚˜' : (senderName || (senderId ? senderId.substring(0,6) : 'ì•Œ ìˆ˜ ì—†ìŒ'));
  
  const timeSpan = document.createElement('span');
  timeSpan.className = 'time';
  timeSpan.textContent = formatTime(timestamp || Date.now());
  
  const msgText = document.createElement('div');
  msgText.textContent = message || '';
  msgText.style.marginTop = '2px';
  msgText.style.wordBreak = 'break-word';
  
  senderSpan.appendChild(timeSpan);
  msgDiv.appendChild(senderSpan);
  msgDiv.appendChild(msgText);
  
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  // ë©”ì‹œì§€ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ë©”ì‹œì§€ ì œê±° (ë©”ëª¨ë¦¬ ê´€ë¦¬)
  const maxMessages = 100;
  while (chatMessages.children.length > maxMessages) {
    chatMessages.removeChild(chatMessages.firstChild);
  }
}

async function sendChatMessage(){
  const message = chatInput.value.trim();
  if (!message || !roomId || !myUserId || !isRunning) {
    if (!isRunning) toast('ë¨¼ì € ë°©ì— ì°¸ì—¬í•˜ì„¸ìš”');
    return;
  }
  
  // ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ (200ì)
  const trimmedMessage = message.substring(0, 200);
  
  const chatData = {
    senderId: myUserId,
    senderName: role === 'host' ? 'í˜¸ìŠ¤íŠ¸' : `ê²ŒìŠ¤íŠ¸ ${myUserId.substring(0,6)}`,
    message: trimmedMessage,
    timestamp: Date.now()
  };
  
  try {
    await db.ref(`rooms/${roomId}/chat`).push(chatData);
    chatInput.value = '';
  } catch(e) {
    log('[Chat] ì „ì†¡ ì‹¤íŒ¨: ' + e.message);
    toast('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
    console.error('Chat send error:', e);
  }
}

function initChat(){
  if (!roomId) return;
  
  // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
  if (firebaseListeners.chat) {
    firebaseListeners.chat.off();
  }
  
  // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
  const chatRef = db.ref(`rooms/${roomId}/chat`);
  firebaseListeners.chat = chatRef;
  
  chatRef.on('child_added', snap => {
    try {
      const data = snap.val();
      if (!data || !data.message || typeof data.message !== 'string') return;
      if (!data.senderId || !data.timestamp) return;
      const isOwn = data.senderId === myUserId;
      addChatMessage(data.senderId, data.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ', data.message, data.timestamp, isOwn);
    } catch(e) {
      console.warn('[Chat] ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
    }
  });
}

chatSendBtn.addEventListener('click', sendChatMessage);
chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendChatMessage();
  }
});

// PiP ë‹«ê¸° ë²„íŠ¼
pipCloseBtn.addEventListener('click', () => {
  try {
    showHostCameraPip = false;
    pipOverlay.classList.remove('show');
    if (hostCameraStream) {
      hostCameraStream.getTracks().forEach(t => {
        t.onended = null;
        t.stop();
      });
      hostCameraStream = null;
    }
    pipVideo.srcObject = null;
  } catch(e) {
    console.error('PiP close error:', e);
  }
});

// ì „ì²´í™”ë©´ ë‹«ê¸° ë²„íŠ¼
fsCloseBtn.addEventListener('click', () => {
  try {
    fullscreenVideo.classList.remove('show');
    fsVideo.srcObject = null;
    fsVideo.pause();
  } catch(e) {
    console.error('Fullscreen close error:', e);
  }
});

// ESC í‚¤ë¡œ ì „ì²´í™”ë©´ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && fullscreenVideo.classList.contains('show')) {
    fsCloseBtn.click();
  }
});

/* ---------------- Media Builders ---------------- */
async function getCameraStream(){
  return await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode,
      width:  { ideal: 1280, max: 1920 },
      height: { ideal: 720,  max: 1080 },
      frameRate: { ideal: 30, max: 60 }
    },
    audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
  });
}

async function getScreenStream(){
  try{
    return await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch(e){
    log('[Host] getDisplayMedia with audio failed, retry video-only');
    return await navigator.mediaDevices.getDisplayMedia({ video:true }); // ì¬ì‹œë„
  }
}

async function makeAmplifiedStreamFrom(sourceStream, fallbackUseMic=true){
  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  const initialGain = parseFloat(gainSlider?.value || '2') || 2.0;
  gainNode.gain.value = initialGain;
  if (gainVal) gainVal.textContent = initialGain.toFixed(1);

  const videoTracks = sourceStream.getVideoTracks();
  const inAudioTracks = sourceStream.getAudioTracks();
  let outputAudioTrack = null;

  if (inAudioTracks.length){
    const src = audioCtx.createMediaStreamSource(sourceStream);
    const dest = audioCtx.createMediaStreamDestination();
    src.connect(gainNode).connect(dest);
    outputAudioTrack = dest.stream.getAudioTracks()[0];
  } else if (fallbackUseMic){
    try{
      const mic = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } });
      const src = audioCtx.createMediaStreamSource(mic);
      const dest = audioCtx.createMediaStreamDestination();
      src.connect(gainNode).connect(dest);
      outputAudioTrack = dest.stream.getAudioTracks()[0];
    }catch(e){ log('[Audio] ë§ˆì´í¬ íšë“ ì‹¤íŒ¨: '+e.message); }
  }

  return outputAudioTrack ? new MediaStream([...videoTracks, outputAudioTrack]) : new MediaStream([...videoTracks]);
}
async function buildLocalStreamForCurrentMode(){
  if (comm==='broadcast'){
    if (role!=='host'){
      // ê²ŒìŠ¤íŠ¸ëŠ” ì˜ìƒ ì•ˆ ë³´ëƒ„(ìˆ˜ì‹ ë§Œ)
      return null;
    }
    const raw = (sourceMode==='screen') ? await getScreenStream() : await getCameraStream();
    const amplified = await makeAmplifiedStreamFrom(raw, sourceMode==='screen');
    return amplified;
  }else{ // meeting
    const cam = await getCameraStream();
    // ë¯¸íŒ…ì€ ì¦í­ ë¶ˆí•„ìš”(ì—ì½” ìœ„í—˜). ì›ë³¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    return cam;
  }
}
async function replaceVideoTrack(){
  if (!localStream) return;

  // ìƒˆ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
  const newStream = await getCameraStream();
  const newTrack = newStream.getVideoTracks()[0];

  // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ê°±ì‹ 
  localStream.getVideoTracks().forEach(t=>t.stop());
  localStream = new MediaStream([ newTrack, ...localStream.getAudioTracks() ]);

  if (role === 'host' && comm === 'meeting') {
    // í˜¸ìŠ¤íŠ¸ ë¯¸íŒ… ëª¨ë“œ: ëª¨ë“  ê²ŒìŠ¤íŠ¸ ì—°ê²°ì— íŠ¸ë™ êµì²´
    peerConnections.forEach((_pc, vid) => {
      const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender && newTrack) {
        sender.replaceTrack(newTrack).catch(e => {
          console.warn(`[Host] replaceTrack failed for ${vid}:`, e);
        });
      }
    });
  } else if (pc) {
    // ê²ŒìŠ¤íŠ¸ ë˜ëŠ” í˜¸ìŠ¤íŠ¸ ë°©ì†¡ ëª¨ë“œ
    const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
    if (sender && newTrack){
      try{
        await sender.replaceTrack(newTrack);
      }catch(e){
        console.warn('replaceTrack failed, renegotiate fallback:', e);
        try{
          const old = sender.track;
          if (old) old.stop();
          await sender.replaceTrack(null);
          pc.addTrack(newTrack, localStream);
        }catch(e2){ console.warn('fallback failed:', e2); }
      }
    }
  }

  // í”„ë¦¬ë·° ê°±ì‹ 
  if (comm==='meeting'){
    if (showLocalPreview) {
      localPreview.srcObject = localStream;
      await forcePlay(localPreview);
    }
  }else{
    player.srcObject = localStream;
    await forcePlay(player);
  }
}

// í™”ë©´ê³µìœ  ì‹œì‘
async function startScreenShare(){
  if (!localStream || comm !== 'meeting') {
    if (comm !== 'meeting') toast('ë¯¸íŒ… ëª¨ë“œì—ì„œë§Œ í™”ë©´ê³µìœ ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
    return;
  }
  
  if (isScreenSharing) {
    log('[Screen] ì´ë¯¸ í™”ë©´ê³µìœ  ì¤‘ì…ë‹ˆë‹¤');
    return;
  }
  
  try {
    const screenStream = await getScreenStream();
    const screenTrack = screenStream.getVideoTracks()[0];
    
    if (!screenTrack) {
      toast('í™”ë©´ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      log('[Screen] í™”ë©´ê³µìœ  íŠ¸ë™ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    // í™”ë©´ê³µìœ  ì¢…ë£Œ ê°ì§€
    screenTrack.onended = async () => {
      log('[Screen] í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
      toast('í™”ë©´ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤');
      await stopScreenShare();
    };
    
    screenShareStream = screenStream;
    isScreenSharing = true;
    
    // ê¸°ì¡´ ë¹„ë””ì˜¤ íŠ¸ë™ ì €ì¥ (PiPìš©)
    const oldVideoTrack = localStream.getVideoTracks()[0];
    let cameraTrackForPip = null;
    
    if (oldVideoTrack && role === 'host') {
      // í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš° ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ ë³„ë„ë¡œ ìœ ì§€ (PiPìš©)
      try {
        const cameraStream = await getCameraStream();
        cameraTrackForPip = cameraStream.getVideoTracks()[0];
        if (cameraTrackForPip) {
          hostCameraStream = new MediaStream([cameraTrackForPip]);
          // PiP í‘œì‹œ
          showHostCameraPip = true;
          pipVideo.srcObject = hostCameraStream;
          pipOverlay.classList.add('show');
          pipVideo.play().catch(e => {});
        }
      } catch(e) {
        console.warn('[Screen] ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì‹¤íŒ¨ (PiPìš©):', e);
      }
      
      // ê¸°ì¡´ íŠ¸ë™ ì œê±°
      oldVideoTrack.stop();
      localStream.removeTrack(oldVideoTrack);
    } else if (oldVideoTrack) {
      oldVideoTrack.stop();
      localStream.removeTrack(oldVideoTrack);
    }
    
    // í™”ë©´ê³µìœ  íŠ¸ë™ ì¶”ê°€
    localStream.addTrack(screenTrack);
    
    // ëª¨ë“  ì—°ê²°ì— íŠ¸ë™ êµì²´
    if (role === 'host' && comm === 'meeting') {
      peerConnections.forEach((_pc, vid) => {
        const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender && screenTrack) {
          sender.replaceTrack(screenTrack).catch(e => {
            console.warn(`[Host] í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì‹¤íŒ¨ (${vid}):`, e);
          });
        }
      });
    } else if (pc) {
      const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
      if (sender && screenTrack) {
        try {
          await sender.replaceTrack(screenTrack);
        } catch(e) {
          console.warn('í™”ë©´ê³µìœ  íŠ¸ë™ êµì²´ ì‹¤íŒ¨:', e);
        }
      }
    }
    
    // í”„ë¦¬ë·° ê°±ì‹ 
    if (showLocalPreview) {
      localPreview.srcObject = localStream;
      await forcePlay(localPreview);
    }
    
    shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì¢…ë£Œ';
    shareScreenBtn.style.background = 'linear-gradient(180deg,#c24,#932)';
    toast('í™”ë©´ê³µìœ ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
    log('[Screen] í™”ë©´ê³µìœ  ì‹œì‘');
  } catch(e) {
    log('[Screen] í™”ë©´ê³µìœ  ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
    toast('í™”ë©´ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    console.error('Screen share error:', e);
  }
}

// í™”ë©´ê³µìœ  ì¢…ë£Œ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
async function stopScreenShare(){
  if (!isScreenSharing || !localStream) return;
  
  // ì¬ê·€ í˜¸ì¶œ ë°©ì§€
  isScreenSharing = false;
  
  try {
    // í™”ë©´ê³µìœ  íŠ¸ë™ ì œê±°
    const screenTrack = localStream.getVideoTracks().find(t => t.label.includes('screen') || t.label.includes('í™”ë©´'));
    if (screenTrack) {
      // onended í•¸ë“¤ëŸ¬ ì œê±° (ì¬ê·€ í˜¸ì¶œ ë°©ì§€)
      screenTrack.onended = null;
      screenTrack.stop();
      localStream.removeTrack(screenTrack);
    }
    
    // í™”ë©´ê³µìœ  ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
    if (screenShareStream) {
      screenShareStream.getTracks().forEach(t => {
        t.onended = null; // í•¸ë“¤ëŸ¬ ì œê±°
        t.stop();
      });
      screenShareStream = null;
    }
    
    // PiP ì •ë¦¬
    if (hostCameraStream) {
      hostCameraStream.getTracks().forEach(t => t.stop());
      hostCameraStream = null;
    }
    showHostCameraPip = false;
    pipOverlay.classList.remove('show');
    pipVideo.srcObject = null;
    
    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“
    try {
      const cameraStream = await getCameraStream();
      const cameraTrack = cameraStream.getVideoTracks()[0];
      
      if (cameraTrack) {
        localStream.addTrack(cameraTrack);
        
        // ëª¨ë“  ì—°ê²°ì— ì¹´ë©”ë¼ íŠ¸ë™ êµì²´
        if (role === 'host' && comm === 'meeting') {
          peerConnections.forEach((_pc, vid) => {
            const sender = _pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender && cameraTrack) {
              sender.replaceTrack(cameraTrack).catch(e => {
                console.warn(`[Host] ì¹´ë©”ë¼ íŠ¸ë™ êµì²´ ì‹¤íŒ¨ (${vid}):`, e);
              });
            }
          });
        } else if (pc) {
          const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
          if (sender && cameraTrack) {
            try {
              await sender.replaceTrack(cameraTrack);
            } catch(e) {
              console.warn('ì¹´ë©”ë¼ íŠ¸ë™ êµì²´ ì‹¤íŒ¨:', e);
            }
          }
        }
        
        // í”„ë¦¬ë·° ê°±ì‹ 
        if (showLocalPreview) {
          localPreview.srcObject = localStream;
          await forcePlay(localPreview);
        }
        
        shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
        shareScreenBtn.style.background = '';
        toast('ì¹´ë©”ë¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
        log('[Screen] í™”ë©´ê³µìœ  ì¢…ë£Œ, ì¹´ë©”ë¼ë¡œ ë³µê·€');
      } else {
        throw new Error('ì¹´ë©”ë¼ íŠ¸ë™ì„ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    } catch(e) {
      log('[Screen] ì¹´ë©”ë¼ë¡œ ì „í™˜ ì‹¤íŒ¨: ' + e.message);
      toast('ì¹´ë©”ë¼ë¡œ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”');
      console.error('Camera switch error:', e);
      // UIëŠ” ë³µêµ¬
      shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
      shareScreenBtn.style.background = '';
    }
  } catch(e) {
    log('[Screen] í™”ë©´ê³µìœ  ì¢…ë£Œ ì‹¤íŒ¨: ' + e.message);
    toast('ì¹´ë©”ë¼ë¡œ ì „í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    console.error('Stop screen share error:', e);
  }
}


/* ---------------- Signaling: Host / Guest ---------------- */
function addPending(vid, data){
  const li = document.createElement('li');
  li.id = `pending-${vid}`;
  li.innerHTML = `
    <div>
      <div><b>ê²ŒìŠ¤íŠ¸</b> <span class="tag">${vid}</span></div>
      <div class="muted" style="font-size:12px">ì˜¤í¼ ìˆ˜ì‹ </div>
    </div>
    <div class="row">
      <button class="primary">í—ˆìš©</button>
      <button class="danger">ê±°ì ˆ</button>
    </div>
  `;
  const [allowBtn, denyBtn] = li.querySelectorAll('button');
  allowBtn.onclick = () => acceptGuest(vid, data, li);
  denyBtn.onclick  = () => denyGuest(vid, li);
  pendingEl.appendChild(li);
}
function denyGuest(vid, li){
  db.ref(`rooms/${roomId}/offers/${vid}`).remove();
  db.ref(`rooms/${roomId}/candidates/${vid}`).remove();
  db.ref(`rooms/${roomId}/answers/${vid}`).remove();
  
  // ì—°ê²°ì´ ì´ë¯¸ ë˜ì–´ìˆë‹¤ë©´ ì •ë¦¬
  const _pc = peerConnections.get(vid);
  if (_pc) {
    try {
      _pc.getSenders().forEach(s => s.track && s.track.stop());
      _pc.close();
    } catch(e) {}
    peerConnections.delete(vid);
  }
  removeRemoteVideoElement(vid);
  li.remove();
}

async function startHost(){
  roomId = (roomIdInput.value||'').replace(/\s+/g,''); if(!roomId){ roomId=generateRoomId(); roomIdInput.value=roomId; }
  myUserId = 'host-' + randomId(6);
  localStream = await buildLocalStreamForCurrentMode();
  const vTrack = localStream?.getVideoTracks?.()[0];
  if (vTrack) {
    vTrack.onended = () => {
      log('[Host] video track ended (ì°½ ë‹«í˜/ìµœì†Œí™” ë“±). ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
      toast('ê³µìœ  í™”ë©´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. [ì‹œì‘]ìœ¼ë¡œ ë‹¤ì‹œ ê³µìœ í•˜ì„¸ìš”.');
      // í•„ìš”í•˜ë©´ ìë™ ì¬ì‹œì‘:
      // startBtn.click();
    };
  }


  if (comm==='broadcast'){
    if (localStream) {
      player.srcObject = localStream;
      await forcePlay(player);
      try{ player.muted=true; player.setAttribute('muted',''); player.setAttribute('playsinline',''); player.setAttribute('webkit-playsinline',''); await player.play(); }catch(e){}
    }
  }else{ // meeting
    // ë¯¸ë¦¬ë³´ê¸° UI (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€)
    if (showLocalPreview) {
      localPreview.srcObject = localStream;
      await forcePlay(localPreview);
      try{ localPreview.setAttribute('playsinline',''); localPreview.setAttribute('webkit-playsinline',''); await localPreview.play(); }catch(e){}
    }
  }

  // ê²ŒìŠ¤íŠ¸ ì˜¤í¼ ëŒ€ê¸°
  const offersRef = db.ref(`rooms/${roomId}/offers`);
  firebaseListeners.offers = offersRef;
  offersRef.on('child_added', async snap=>{
    const vid = snap.key; const data = snap.val();
    if(!data || !data.sdp) return;
    addPending(vid, data);
    log('[Host] offer arrived from: ' + vid);
  });

  startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
  logStatus(`í˜¸ìŠ¤íŠ¸ ëŒ€ê¸°/ì†¡ì¶œ ì¤‘â€¦ ë°© ì½”ë“œ: ${roomId} Â· ëª¨ë“œ: ${comm}`);
  toast('ê²ŒìŠ¤íŠ¸ì—ê²Œ ë°© ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”');
  
  // ì±„íŒ… ì´ˆê¸°í™”
  chatMessages.innerHTML = '';
  initChat();
}

// ì›ê²© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
function createRemoteVideoElement(vid, label=''){
  const wrapper = document.createElement('div');
  wrapper.className = 'remote-video-wrapper';
  wrapper.id = `remote-video-${vid}`;
  
  const labelEl = document.createElement('small');
  labelEl.className = 'muted';
  labelEl.textContent = label || `ì°¸ê°€ì ${vid.substring(0,6)}`;
  
  const video = document.createElement('video');
  video.id = `video-${vid}`;
  video.autoplay = true;
  video.playsInline = true;
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.controls = true;
  video.style.width = '100%';
  video.style.background = '#000';
  video.style.borderRadius = '12px';
  
  // ì „ì²´í™”ë©´ ë²„íŠ¼ ì¶”ê°€
  const fullscreenBtn = document.createElement('button');
  fullscreenBtn.className = 'video-fullscreen-btn';
  fullscreenBtn.textContent = 'â›¶ ì „ì²´í™”ë©´';
  fullscreenBtn.onclick = () => {
    try {
      if (!video.srcObject) {
        toast('ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      fsVideo.srcObject = video.srcObject;
      fullscreenVideo.classList.add('show');
      fsVideo.play().catch(e => {
        console.warn('Fullscreen video play failed:', e);
      });
    } catch(e) {
      console.error('Fullscreen error:', e);
      toast('ì „ì²´í™”ë©´ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  };
  
  wrapper.appendChild(labelEl);
  wrapper.appendChild(video);
  wrapper.appendChild(fullscreenBtn);
  remoteVideosGrid.appendChild(wrapper);
  
  return video;
}

// ì›ê²© ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì œê±°
function removeRemoteVideoElement(vid){
  const wrapper = document.getElementById(`remote-video-${vid}`);
  if (wrapper) {
    const video = wrapper.querySelector('video');
    if (video && video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    wrapper.remove();
  }
  remoteVideos.delete(vid);
}

async function acceptGuest(vid, data, li){
  try{
    // ì—°ê²° ì¢…ë£Œ í•¸ë“¤ëŸ¬
    const connectionStateHandler = () => {
      if (_pc.connectionState === 'closed' || _pc.connectionState === 'failed' || _pc.connectionState === 'disconnected') {
        log(`[Host] ì—°ê²° ì¢…ë£Œ: ${vid}`);
        removeRemoteVideoElement(vid);
        peerConnections.delete(vid);
        // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        if (remoteCandidatesRef) remoteCandidatesRef.off();
        if (myCandidatesRef) myCandidatesRef.off();
      }
      // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
      if (infoEl) infoEl.textContent += ' | PC: ' + _pc.connectionState;
    };

    const _pc = createPeer({ onconnectionstatechange: connectionStateHandler });
    peerConnections.set(vid, _pc);

    // ë‚´ íŠ¸ë™ ì¶”ê°€(ë°©ì†¡: í˜¸ìŠ¤íŠ¸ íŠ¸ë™ë§Œ / ë¯¸íŒ…: í˜¸ìŠ¤íŠ¸ ì¹´ë©”ë¼)
    if (localStream) localStream.getTracks().forEach(t=>_pc.addTrack(t, localStream));
    preferH264(_pc);

    // remote ICE (guest)
    const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/guest`);
    remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) _pc.addIceCandidate(new RTCIceCandidate(c)); });

    // my ICE (host)
    const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${vid}/host`);
    _pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };

    // ì›ê²© íŠ¸ë™ ìˆ˜ì‹  ì²˜ë¦¬
    _pc.ontrack = (ev)=>{
      const stream = ev.streams[0];
      if (comm==='broadcast'){
        // ë°©ì†¡ì—ì„œ í˜¸ìŠ¤íŠ¸ëŠ” ê²ŒìŠ¤íŠ¸ ì˜ìƒì„ êµ³ì´ ë³¼ í•„ìš” ì—†ìŒ
      }else{
        // ë¯¸íŒ…: ê° ê²ŒìŠ¤íŠ¸ë§ˆë‹¤ ë³„ë„ ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        let videoEl = remoteVideos.get(vid);
        if (!videoEl) {
          videoEl = createRemoteVideoElement(vid, `ê²ŒìŠ¤íŠ¸ ${vid.substring(0,6)}`);
          remoteVideos.set(vid, videoEl);
        }
        if (videoEl.srcObject !== stream) {
          videoEl.srcObject = stream;
          (async ()=>{ 
            try{ 
              videoEl.setAttribute('playsinline',''); 
              videoEl.setAttribute('webkit-playsinline',''); 
              await videoEl.play(); 
            }catch(e){} 
          })();
        }
      }
    };

    // SDP ì²˜ë¦¬
    await _pc.setRemoteDescription(new RTCSessionDescription({ type:'offer', sdp:data.sdp }));
    const answer = await _pc.createAnswer();
    await _pc.setLocalDescription(answer);
    await db.ref(`rooms/${roomId}/answers/${vid}`).set({ sdp: answer.sdp, ts: Date.now() });

    li.querySelector('.muted').textContent = 'ì—°ê²° ì§„í–‰ ì¤‘â€¦';
    li.style.opacity = .7;
    log('[Host] answered to ' + vid);
  }catch(e){ 
    alert('ì—°ê²° ì‹¤íŒ¨: ' + e.message); 
    peerConnections.delete(vid);
    removeRemoteVideoElement(vid);
  }
}

async function startGuest(){
  roomId = (roomIdInput.value||'').replace(/\s+/g,''); if(!roomId){ alert('ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  viewerId = randomId(8);
  myUserId = viewerId;
  pc = createPeer();

  // íŠ¸ëœì‹œë²„/ë¡œì»¬ íŠ¸ë™ êµ¬ì„±
  if (comm==='broadcast'){
    // ìˆ˜ì‹  ì „ìš©
    pc.addTransceiver('video', { direction:'recvonly' });
    pc.addTransceiver('audio', { direction:'recvonly' });
  }else{
    // ë¯¸íŒ…: ë¡œì»¬ ì¹´ë©”ë¼ ìº¡ì²˜ í›„ ì „ì†¡
    localStream = await getCameraStream();
    // ë¯¸ë¦¬ë³´ê¸°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€
    if (showLocalPreview) {
      localPreview.srcObject = localStream;
      try{ localPreview.setAttribute('playsinline',''); localPreview.setAttribute('webkit-playsinline',''); await localPreview.play(); }catch(e){}
    }
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
  }

  pc.ontrack = (ev)=>{
    const stream = ev.streams[0];
    if (comm==='broadcast'){
      if (player.srcObject !== stream){
        player.srcObject = stream;
        
        (async ()=>{ try{ 
          player.setAttribute('playsinline',''); 
          player.setAttribute('webkit-playsinline',''); 
          await player.play(); 
        }catch(e){} })();
        audioMirror.srcObject = stream;
      }
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }else{
      // ë¯¸íŒ… ëª¨ë“œ: í˜¸ìŠ¤íŠ¸ì˜ ìŠ¤íŠ¸ë¦¼ì„ í‘œì‹œ
      // ê²ŒìŠ¤íŠ¸ëŠ” í˜¸ìŠ¤íŠ¸ì™€ë§Œ ì—°ê²°ë˜ë¯€ë¡œ í•˜ë‚˜ì˜ ë¹„ë””ì˜¤ë§Œ í‘œì‹œ
      const hostVideoId = 'host';
      let videoEl = remoteVideos.get(hostVideoId);
      if (!videoEl) {
        videoEl = createRemoteVideoElement(hostVideoId, 'í˜¸ìŠ¤íŠ¸');
        remoteVideos.set(hostVideoId, videoEl);
      }
      if (videoEl.srcObject !== stream) {
        videoEl.srcObject = stream;
        (async ()=>{ try{ 
          videoEl.setAttribute('playsinline',''); 
          videoEl.setAttribute('webkit-playsinline',''); 
          await videoEl.play(); 
        }catch(e){} })();
        audioMirror.srcObject = stream;
      }
      if (isiOS) showIOSUnmuteOverlayIfNeeded(); else unmuteBtn.style.display='inline-block';
    }
    log(`[${role}] tracks: ` + stream.getTracks().map(t=>t.kind).join(', '));
  };

  // ICE
  const myCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/guest`);
  pc.onicecandidate = (ev)=>{ if(ev.candidate){ myCandidatesRef.push(ev.candidate.toJSON()); } };
  const remoteCandidatesRef = db.ref(`rooms/${roomId}/candidates/${viewerId}/host`);
  firebaseListeners.candidates[viewerId] = remoteCandidatesRef;
  remoteCandidatesRef.on('child_added', s=>{ const c=s.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)); });

  // SDP
  preferH264(pc);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  const offerRef = db.ref(`rooms/${roomId}/offers/${viewerId}`);
  await offerRef.set({ sdp: offer.sdp, ts: Date.now() }).catch(e=>{ alert('ì˜¤í¼ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message); });

  const answersRef = db.ref(`rooms/${roomId}/answers/${viewerId}`);
  firebaseListeners.answers = answersRef;
  answersRef.on('value', async snap=>{
    const val = snap.val();
    if(val && val.sdp && pc.signalingState === 'have-local-offer'){
      await pc.setRemoteDescription(new RTCSessionDescription({ type:'answer', sdp: val.sdp }));
      logStatus(comm==='broadcast' ? 'ì‹œì²­ ì¤‘â€¦' : 'ë¯¸íŒ… ì—°ê²°ë¨');
      toast('ì—°ê²° ì„±ê³µ. ì†Œë¦¬ê°€ ì•ˆ ë“¤ë¦¬ë©´ ğŸ”Š ë²„íŠ¼ ë˜ëŠ” í™”ë©´ íƒ­');
    }
  });

  startBtn.disabled = true; stopBtn.disabled = false; isRunning=true;
  logStatus(`ì ‘ì† ìš”ì²­ ì™„ë£Œ. í˜¸ìŠ¤íŠ¸ ìŠ¹ì¸ ëŒ€ê¸°â€¦ (ë‚´ ID: ${viewerId})`);
  
  // ì±„íŒ… ì´ˆê¸°í™”
  chatMessages.innerHTML = '';
  initChat();
}

/* ---------------- Controls ---------------- */
startBtn.addEventListener('click', async ()=>{
  try{
    if (role==='host') await startHost(); else await startGuest();
  }catch(e){ alert('ì‹œì‘ ì‹¤íŒ¨: '+e.message); }
});
stopBtn.addEventListener('click', async ()=>{ await cleanup(); });
genRoom.addEventListener('click', ()=>{ roomIdInput.value = generateRoomId(); });
window.addEventListener('DOMContentLoaded', ()=>{
  const p = new URLSearchParams(location.search);
  const r = p.get('role'), c=p.get('comm'), room=p.get('room'), a=p.get('autostart');
  if (r && ['host','guest'].includes(r)) { document.querySelector(`input[name="role"][value="${r}"]`).checked=true; role=r; }
  if (c && ['broadcast','meeting'].includes(c)) { document.querySelector(`input[name="comm"][value="${c}"]`).checked=true; comm=c; }
  if (room) roomIdInput.value=room;
  refreshUIByMode();
  if (a==='1') setTimeout(()=>startBtn.click(), 400);
});

/* ---------------- Cleanup ---------------- */
async function cleanup(){
  try{
    // Firebase ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
    if (firebaseListeners.offers) {
      firebaseListeners.offers.off();
      firebaseListeners.offers = null;
    }
    if (firebaseListeners.answers) {
      firebaseListeners.answers.off();
      firebaseListeners.answers = null;
    }
    if (firebaseListeners.chat) {
      firebaseListeners.chat.off();
      firebaseListeners.chat = null;
    }
    Object.values(firebaseListeners.candidates).forEach(ref => {
      if (ref) ref.off();
    });
    firebaseListeners.candidates = {};

    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    if(pc){ 
      pc.getSenders().forEach(s=>s.track && s.track.stop()); 
      pc.close(); 
      pc=null; 
    }
    
    // í˜¸ìŠ¤íŠ¸: ëª¨ë“  ê²ŒìŠ¤íŠ¸ ì—°ê²° ì •ë¦¬
    if (role==='host' && roomId) {
      peerConnections.forEach((_pc, vid) => {
        try {
          _pc.getSenders().forEach(s => s.track && s.track.stop());
          _pc.close();
          // Firebase ë°ì´í„° ì •ë¦¬
          db.ref(`rooms/${roomId}/candidates/${vid}`).remove().catch(e => {});
        } catch(e) {}
      });
      peerConnections.clear();
      
      // ëª¨ë“  ì›ê²© ë¹„ë””ì˜¤ ì œê±°
      remoteVideos.forEach((video, vid) => {
        removeRemoteVideoElement(vid);
      });
    }
    
    // ê²ŒìŠ¤íŠ¸: ìì‹ ì˜ ë°ì´í„°ë§Œ ì •ë¦¬
    if(roomId && role==='guest' && viewerId){
      await db.ref(`rooms/${roomId}/offers/${viewerId}`).remove().catch(e => {});
      await db.ref(`rooms/${roomId}/answers/${viewerId}`).remove().catch(e => {});
      await db.ref(`rooms/${roomId}/candidates/${viewerId}`).remove().catch(e => {});
    }
  }catch(e){
    console.error('Cleanup error:', e);
    log('[Error] Cleanup: ' + e.message);
  }
  isRunning=false; startBtn.disabled=false; stopBtn.disabled=true;
  player.srcObject=null; localPreview.srcObject=null;
  remoteVideosGrid.innerHTML='';
  remoteVideos.clear();
  pendingEl.innerHTML=''; logStatus('ëŒ€ê¸° ì¤‘â€¦'); unmuteBtn.style.display='none'; tapUnmuteOverlay.style.display='none';
  showLocalPreview = false;
  localPreviewWrapper.classList.remove('show');
  togglePreviewBtn.textContent = 'ë‚´ í™”ë©´ ë³´ê¸°';
  chatMessages.innerHTML = '';
  chatInput.value = '';
  myUserId = '';
  
  // í™”ë©´ê³µìœ  ì •ë¦¬
  if (isScreenSharing) {
    if (screenShareStream) {
      screenShareStream.getTracks().forEach(t => t.stop());
      screenShareStream = null;
    }
    isScreenSharing = false;
    shareScreenBtn.textContent = 'í™”ë©´ê³µìœ  ì‹œì‘';
    shareScreenBtn.style.background = '';
  }
  
  // PiP ì •ë¦¬
  if (hostCameraStream) {
    hostCameraStream.getTracks().forEach(t => t.stop());
    hostCameraStream = null;
  }
  showHostCameraPip = false;
  pipOverlay.classList.remove('show');
  pipVideo.srcObject = null;
  
  // ì „ì²´í™”ë©´ ì •ë¦¬
  fullscreenVideo.classList.remove('show');
  fsVideo.srcObject = null;
}

/* ---------------- Error log ---------------- */
window.addEventListener('error', e=> log('[Error] ' + e.message));
</script>
</body>
</html>
